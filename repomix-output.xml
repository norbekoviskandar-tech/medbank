This file is a merged representation of a subset of the codebase, containing specifically included files and files not matching ignore patterns, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of a subset of the repository's contents that is considered the most important context.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Only files matching these patterns are included: src/**, public/*.json, *.config.*, package.json
- Files matching these patterns are excluded: node_modules, dist, build, *.log, *.png, *.jpg, *.mp4
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
eslint.config.mjs
next.config.mjs
package.json
postcss.config.mjs
src/app/api/analytics/route.js
src/app/api/auth/login/route.js
src/app/api/auth/register/route.js
src/app/api/author-portal/analytics/universe/route.js
src/app/api/author-portal/forensics/session/[id]/route.js
src/app/api/notifications/route.js
src/app/api/products/route.js
src/app/api/questions/[id]/route.js
src/app/api/questions/governance/history/route.js
src/app/api/questions/governance/route.js
src/app/api/questions/publish/route.js
src/app/api/questions/revise/route.js
src/app/api/questions/route.js
src/app/api/questions/stats/route.js
src/app/api/questions/user-sandbox/route.js
src/app/api/questions/user/route.js
src/app/api/student/stats/route.js
src/app/api/subscriptions/purchase/route.js
src/app/api/tests/[id]/route.js
src/app/api/tests/attempts/[id]/route.js
src/app/api/tests/pool/route.js
src/app/api/tests/route.js
src/app/api/users/route.js
src/app/api/users/subscriptions/route.js
src/app/auth/AuthComponent.jsx
src/app/auth/page.jsx
src/app/author/activity/page.jsx
src/app/author/create-question/page.jsx
src/app/author/layout.jsx
src/app/author/login/AuthorLoginComponent.jsx
src/app/author/login/page.jsx
src/app/author/manage-products/[id]/page.jsx
src/app/author/manage-products/page.jsx
src/app/author/manage-questions/page.jsx
src/app/author/page.jsx
src/app/author/settings/page.jsx
src/app/author/tools/page.jsx
src/app/author/users/page.jsx
src/app/checkout/page.jsx
src/app/globals.css
src/app/layout.jsx
src/app/page.jsx
src/app/products/[id]/page.js
src/app/products/page.jsx
src/app/student/(dashboard)/account/page.jsx
src/app/student/(dashboard)/dashboard/page.jsx
src/app/student/(dashboard)/layout.jsx
src/app/student/(dashboard)/performance/page.jsx
src/app/student/(dashboard)/planner/page.jsx
src/app/student/(dashboard)/qbank/create-test/CreateTestTemplateA.jsx
src/app/student/(dashboard)/qbank/create-test/CreateTestTemplateB.jsx
src/app/student/(dashboard)/qbank/create-test/page.jsx
src/app/student/(dashboard)/qbank/page.jsx
src/app/student/(dashboard)/qbank/take-test/page.jsx
src/app/student/(dashboard)/qbank/test-summary/page.jsx
src/app/student/(dashboard)/tests/page.jsx
src/app/student/portal/page.jsx
src/auth/auth.guard.js
src/auth/auth.logic.js
src/components/author/AuthorHeader.jsx
src/components/author/BottomStats.jsx
src/components/author/DashboardCharts.jsx
src/components/author/KPICard.jsx
src/components/author/question/ExplanationEditor.jsx
src/components/author/question/GovernanceTimeline.jsx
src/components/author/question/MetadataPanel.jsx
src/components/author/question/OptionEditor.jsx
src/components/author/question/StemEditor.jsx
src/components/author/QuestionForm.jsx
src/components/author/QuestionList.jsx
src/components/author/QuickInsights.jsx
src/components/author/UserProfileModal.jsx
src/components/student/exam/AnswerOptions.jsx
src/components/student/exam/ExamFooter.jsx
src/components/student/exam/ExamHeader.jsx
src/components/student/exam/ExamModal.jsx
src/components/student/exam/QuestionNavigator.jsx
src/components/student/exam/QuestionViewer.jsx
src/components/student/exam/RationalesPanel.jsx
src/components/student/layout/AccountDropdown.jsx
src/components/student/layout/CartDropdown.jsx
src/components/student/layout/ProductStreamHeader.jsx
src/components/student/layout/Sidebar.jsx
src/components/ThemeWrapper.jsx
src/components/ui/ConfirmModal.jsx
src/components/ui/LogoutModal.jsx
src/context/AppContext.js
src/context/ExamContext.js
src/docs/DELETE_FUNCTIONALITY.md
src/hooks/author/useQuestionEditor.js
src/hooks/exam/useExamEngine.js
src/hooks/exam/useTimer.js
src/hooks/useDeleteItem.js
src/lib/cognition-engine.js
src/lib/db.js
src/lib/local.db
src/lib/server-db.js
src/models/planner.model.js
src/models/question.model.js
src/models/test.model.js
src/models/user.model.js
src/services/analytics.service.js
src/services/communications.service.js
src/services/performance.service.js
src/services/product.service.js
src/services/question.service.js
src/services/test.service.js
src/services/user.service.js
src/utils/createTestHelpers.js
src/utils/crypto.js
src/utils/deleteUtils.js
src/utils/helpers.js
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="eslint.config.mjs">
import { defineConfig, globalIgnores } from "eslint/config";
import nextVitals from "eslint-config-next/core-web-vitals";

const eslintConfig = defineConfig([
  ...nextVitals,
  // Override default ignores of eslint-config-next.
  globalIgnores([
    // Default ignores of eslint-config-next:
    ".next/**",
    "out/**",
    "build/**",
    "next-env.d.ts",
  ]),
]);

export default eslintConfig;
</file>

<file path="postcss.config.mjs">
const config = {
  plugins: {
    "@tailwindcss/postcss": {},
  },
};

export default config;
</file>

<file path="src/app/api/analytics/route.js">
import { NextResponse } from 'next/server';
import { getGlobalStats, getEngagementData, getDb } from '@/lib/server-db';

export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const type = searchParams.get('type') || 'dashboard';
    const packageId = searchParams.get('packageId');

    // Enforce product-scoping for all analytics (no global stats allowed)
    if (!packageId) {
      return NextResponse.json({ error: 'packageId required - analytics must be product-scoped' }, { status: 400 });
    }

    if (type === 'engagement') {
      const data = getEngagementData(packageId);
      return NextResponse.json(data);
    }

    if (type === 'cognition') {
      const userId = searchParams.get('userId');
      if (!userId || !packageId) return NextResponse.json({ error: 'Missing userId or packageId' }, { status: 400 });
      
      const db = getDb();
      const profile = db.prepare('SELECT * FROM student_cognition_profiles WHERE userId = ? AND packageId = ?')
        .get(userId, packageId.toString());
      
      return NextResponse.json(profile || { readinessScore: 0, overthinkingIndex: 0, impulsivityIndex: 0, fatigueFactor: 0 });
    }

    // Default to dashboard stats
    const stats = getGlobalStats(packageId);
    return NextResponse.json(stats);
  } catch (error) {
    console.error('Analytics error:', error);
    return NextResponse.json({ error: 'Failed to fetch analytics' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/auth/login/route.js">
import { NextResponse } from 'next/server';

import { getUserByEmail } from '@/lib/server-db';

import crypto from 'crypto';



function hashPassword(password) {

  return crypto.createHash('sha256').update(password).digest('hex');

}



export async function POST(request) {

  try {

    const { email, password } = await request.json();

    console.log('[API Login] attempting login for:', email);



    if (!email || !password) {

      return NextResponse.json({ error: 'Missing credentials' }, { status: 400 });

    }



    const user = await getUserByEmail(email);

    console.log('[API Login] query result for', email, ':', user ? 'Found' : 'Not Found');

    

    if (!user) {

      // Log all users to see what's in there

      try {

        const { getAllUsers } = await import('@/lib/server-db');

        const allUsers = await getAllUsers();

        console.log('[API Login] Current users in DB:', allUsers.map(u => u.email));

      } catch (e) {}

      

      return NextResponse.json({ error: 'User not found' }, { status: 404 });

    }



    const hash = hashPassword(password);

    if (hash !== user.passwordHash) {

      return NextResponse.json({ error: 'Invalid password' }, { status: 401 });

    }



    if (user.isBanned) {

        return NextResponse.json({ error: 'Access Denied: Account Suspended' }, { status: 403 });

    }



    // Don't send passwordHash to client

    const { passwordHash: _, ...safeUser } = user;

    return NextResponse.json(safeUser);

  } catch (error) {

    console.error('Login error:', error);

    return NextResponse.json({ error: 'Login failed' }, { status: 500 });

  }

}
</file>

<file path="src/app/api/auth/register/route.js">
import { NextResponse } from 'next/server';
import { getUserByEmail, createUser, createNotification } from '@/lib/server-db';
import crypto from 'crypto';

// Simple hash function (same as client-side for compatibility)
function hashPassword(password) {
  return crypto.createHash('sha256').update(password).digest('hex');
}

export async function POST(request) {
  try {
    const { name, email, password, role = 'student' } = await request.json();

    if (!name || !email || !password) {
      return NextResponse.json({ error: 'Missing required fields' }, { status: 400 });
    }

    // Check if user exists
    const existing = getUserByEmail(email);
    if (existing) {
      return NextResponse.json({ error: 'User already exists' }, { status: 409 });
    }

    const passwordHash = hashPassword(password);
    const user = createUser({
      id: crypto.randomUUID(),
      name,
      email,
      passwordHash,
      role,
      subscriptionStatus: 'inactive',
      createdAt: new Date().toISOString(),
      stats: { attempted: 0, correct: 0, tests: 0 }
    });

    // Notify administrators
    createNotification(
      'registration',
      `New student enrollment: ${name} (${email})`,
      user.id,
      { email, name }
    );

    // Don't send passwordHash to client
    const { passwordHash: _, ...safeUser } = user;
    return NextResponse.json(safeUser, { status: 201 });
  } catch (error) {
    console.error('Register error:', error);
    return NextResponse.json({ error: 'Registration failed' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/author-portal/analytics/universe/route.js">
import { NextResponse } from 'next/server';
import { getProductUniverseAnalytics } from '@/lib/server-db';

export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const packageId = searchParams.get('packageId');
    
    if (!packageId) {
      return NextResponse.json({ error: 'packageId required' }, { status: 400 });
    }
    
    const analytics = getProductUniverseAnalytics(packageId);
    return NextResponse.json(analytics);
  } catch (error) {
    console.error('Universe analytics error:', error);
    return NextResponse.json({ error: 'Failed to fetch universe analytics' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/author-portal/forensics/session/[id]/route.js">
import { NextResponse } from "next/server";
import { getTestById } from "@/lib/server-db";

export async function GET(req, { params }) {
    const { id: testId } = await params;
    const { searchParams } = new URL(req.url);
    const productId = searchParams.get('productId') || searchParams.get('packageId');
    
    if (!productId) {
        return NextResponse.json({ error: "productId is required" }, { status: 400 });
    }
    
    try {
        const test = getTestById(testId, productId);
        if (!test) return NextResponse.json({ error: "Session not found" }, { status: 404 });

        // Forensics Replay requires the sessionState logs
        const logs = test.sessionState?.logs || [];
        
        // Enrich logs with question content if needed for replay
        const forensicData = {
            testId: test.testId,
            userId: test.userId,
            packageName: test.packageName,
            mode: test.mode,
            createdAt: test.createdAt,
            totalTime: test.elapsedTime,
            logs: logs,
            questions: test.questions.map(q => ({
                id: q.id,
                correct: q.correct,
                subject: q.subject,
                system: q.system
            }))
        };

        return NextResponse.json(forensicData);
    } catch (e) {
        console.error("Forensics API Error:", e);
        return NextResponse.json({ error: "Failed to fetch forensic data" }, { status: 500 });
    }
}
</file>

<file path="src/app/api/notifications/route.js">
import { NextResponse } from 'next/server';
import { getNotifications, markNotificationRead } from '@/lib/server-db';

export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const limit = parseInt(searchParams.get('limit') || '50');
    const onlyUnread = searchParams.get('unread') === 'true';
    
    const notifications = getNotifications(limit, onlyUnread);
    return NextResponse.json(notifications);
  } catch (error) {
    console.error('API: Get notifications error:', error);
    return NextResponse.json({ error: 'Failed to fetch notifications' }, { status: 500 });
  }
}

export async function PUT(request) {
  try {
    const { id } = await request.json();
    if (!id) return NextResponse.json({ error: 'Notification ID required' }, { status: 400 });
    
    const success = markNotificationRead(id);
    return NextResponse.json({ success });
  } catch (error) {
    console.error('API: Update notification error:', error);
    return NextResponse.json({ error: 'Failed to update notification' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/products/route.js">
import { NextResponse } from 'next/server';
import * as db from '@/lib/server-db';

export const dynamic = 'force-dynamic';

export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const type = searchParams.get('type') || 'all';
    const includeDeleted = searchParams.get('includeDeleted') === 'true';
    
    console.log(`[API Products] GET type=${type}, includeDeleted=${includeDeleted}`);
    const id = searchParams.get('id');
    
    if (id) {
      const product = includeDeleted ? db.getProductByIdIncludeDeleted(id) : db.getProductById(id);
      if (!product) return NextResponse.json({ error: 'Product not found' }, { status: 404 });
      return NextResponse.json(product);
    }
    
    let products;
    if (type === 'published') {
      products = db.getPublishedProducts();
    } else {
      products = db.getAllProducts();
    }
    
    console.log(`[API Products] Found ${products?.length} products`);
    return NextResponse.json(products);
  } catch (error) {
    console.error('[API Products] GET error:', error);
    // Try to get path from the module if possible
    return NextResponse.json({ 
      error: 'Failed to fetch products', 
      details: error.message,
      stack: error.stack,
      dbPath: db.DB_PATH
    }, { status: 500 });
  }
}

export async function POST(request) {
  try {
    const body = await request.json();
    console.log('[API Products] POST body:', body);
    const product = db.createProduct(body);
    return NextResponse.json(product);
  } catch (error) {
    console.error('[API Products] POST error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function PUT(request) {
  try {
    const body = await request.json();
    console.log('[API Products] PUT body:', body);
    const product = db.updateProduct(body);
    return NextResponse.json(product);
  } catch (error) {
    console.error('[API Products] PUT error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function DELETE(request) {
  try {
    const { id } = await request.json();
    console.log('[API Products] DELETE id:', id);
    const success = db.deleteProduct(id);
    return NextResponse.json({ success });
  } catch (error) {
    console.error('[API Products] DELETE error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/[id]/route.js">
import { NextResponse } from 'next/server';
import { getQuestionById } from '@/lib/server-db';

export async function GET(request, { params }) {
  try {
    const { id } = await params;
    const question = getQuestionById(id);
    
    if (!question) {
      return NextResponse.json({ error: 'Question not found' }, { status: 404 });
    }
    
    return NextResponse.json(question);
  } catch (error) {
    console.error('Get question by ID error:', error);
    return NextResponse.json({ error: 'Failed to get question' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/governance/history/route.js">
import { NextResponse } from 'next/server';
import { getGovernanceHistory } from '@/lib/server-db';

export async function GET(request) {
    try {
        const { searchParams } = new URL(request.url);
        const versionId = searchParams.get('versionId');
        const conceptId = searchParams.get('conceptId');

        if (!versionId && !conceptId) {
            return NextResponse.json({ error: 'versionId or conceptId is required' }, { status: 400 });
        }

        const history = getGovernanceHistory(versionId, conceptId);
        return NextResponse.json(history);
    } catch (error) {
        console.error('Governance History API Error:', error);
        return NextResponse.json({ error: error.message }, { status: 500 });
    }
}
</file>

<file path="src/app/api/questions/governance/route.js">
import { NextResponse } from 'next/server';
import { 
    submitQuestionForReview, 
    approveQuestion, 
    publishQuestion, 
    deprecateQuestion,
    getQuestionById
} from '@/lib/server-db';

/**
 * Unified POST endpoint for all question governance state transitions.
 * Body: { action, versionId, userId, notes }
 */
export async function POST(request) {

    // ‚úÖ Define action in outer scope so catch can safely access it
    let action = "UNKNOWN";

    try {
        const body = await request.json();
        const { versionId, userId, notes } = body;
        action = body.action;

        if (!action || !versionId) {
            return NextResponse.json(
                { error: 'action and versionId are required' }, 
                { status: 400 }
            );
        }

        // Validate userId for governance actions
        if (!userId) {
            console.warn(`Governance API: Missing userId for action '${action}' on version ${versionId}`);
            return NextResponse.json(
                { error: 'userId is required for governance actions' }, 
                { status: 400 }
            );
        }

        const question = getQuestionById(versionId);
        if (!question) {
            return NextResponse.json(
                { error: 'Question version not found' }, 
                { status: 404 }
            );
        }

        let result = false;

        switch (action) {
            case 'submit':
                result = submitQuestionForReview(versionId, userId, notes);
                break;

            case 'approve':
                result = approveQuestion(versionId, userId, notes);
                break;

            case 'publish':
                result = publishQuestion(versionId, userId, notes);
                break;

            case 'deprecate':
                result = deprecateQuestion(versionId, userId, notes);
                break;

            case 'archive':
                return NextResponse.json(
                    { error: 'Archival is handled automatically via publication logic' }, 
                    { status: 400 }
                );

            default:
                return NextResponse.json(
                    { error: `Invalid governance action: ${action}` }, 
                    { status: 400 }
                );
        }

        // Optional safety check
        if (!result) {
            throw new Error(`Governance action failed: ${action}`);
        }

        return NextResponse.json({ 
            success: true, 
            action, 
            versionId 
        });

    } catch (error) {

        // ‚úÖ Will never crash again
        console.error(`Governance API Error [${action}]:`, error);

        return NextResponse.json(
            { error: error.message || 'Governance API failure' }, 
            { status: 500 }
        );
    }
}
</file>

<file path="src/app/api/questions/publish/route.js">
import { NextResponse } from 'next/server';
import { publishQuestion } from '@/lib/server-db';

export async function POST(request) {
  try {
    const { versionId } = await request.json();
    if (!versionId) return NextResponse.json({ error: 'versionId required' }, { status: 400 });

    publishQuestion(versionId);
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Publish question error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/revise/route.js">
import { NextResponse } from 'next/server';
import { reviseQuestion } from '@/lib/server-db';

export async function POST(request) {
  try {
    const { versionId, userId, notes } = await request.json();
    if (!versionId) return NextResponse.json({ error: 'versionId required' }, { status: 400 });

    const newDraft = reviseQuestion(versionId, userId, notes);
    return NextResponse.json(newDraft);
  } catch (error) {
    console.error('Revise question error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/route.js">
import { NextResponse } from 'next/server';
import { safeGetDb, getAllQuestions, updateQuestion, deleteQuestion } from '@/lib/server-db';

// GET /api/questions?packageId=xxx - Get questions
export async function GET(request) {
  console.log("\n==============================");
  console.log("‚û°Ô∏è /api/questions GET HIT");
  try {
    const { searchParams } = new URL(request.url);
    const productId = searchParams.get('productId') || searchParams.get('packageId');
    const includeUnpublished = searchParams.get('includeUnpublished') !== 'false';
    
    console.log("üì¶ GET params:", { productId, includeUnpublished });
    
    const questions = getAllQuestions(productId, includeUnpublished);
    console.log(`‚úÖ Returning ${questions.length} questions`);
    return NextResponse.json(questions);
  } catch (error) {
    console.error('üî• QUESTION GET CRASH:');
    console.error(error);
    console.error(error.stack);
    return NextResponse.json({ success: false, error: error.message }, { status: 500 });
  }
}

// POST /api/questions - Create a new question
export async function POST(req) {
  console.log("\n==============================");
  console.log("‚û°Ô∏è /api/questions POST HIT");

  let body;

  try {
    body = await req.json();
    console.log("üì¶ BODY RECEIVED:", {
      id: body.id,
      productId: body.productId,
      packageId: body.packageId,
      system: body.system,
      subject: body.subject,
      topic: body.topic,
      hasChoices: Array.isArray(body.choices),
      choicesCount: body.choices?.length,
      status: body.status
    });
  } catch (e) {
    console.error("‚ùå JSON PARSE ERROR:", e);
    return Response.json({ error: "Invalid JSON" }, { status: 400 });
  }

  try {
    console.log("üß† LOADING DB...");
    const db = safeGetDb();
    console.log("‚úÖ DB LOADED");

    const { 
      id, stem, stemImage, choices, correct, 
      explanationCorrect, explanationCorrectImage,
      explanationWrong, explanationWrongImage,
      summary, summaryImage,
      system, subject, topic, 
      packageId, productId, status, versionNumber,
      stemImageMode, explanationImageMode,
      references, tags, conceptId
    } = body;

    console.log("üîç FIELDS:", {
      id: !!id,
      stem: !!stem,
      choices: Array.isArray(choices),
      correct,
      system,
      subject,
      topic,
      packageId,
      status
    });

    // Validation
    const effectiveProductId = productId || packageId;
    if (!effectiveProductId) throw new Error("Missing productId/packageId - questions must belong to a product");
    if (!stem) throw new Error("Missing stem");
    if (!Array.isArray(choices)) throw new Error("Choices must be an array");
    if (!system) throw new Error("Missing system");
    if (!subject) throw new Error("Missing subject");

    console.log("‚úÖ VALIDATION OK");

    // Generate ID if missing
    const questionId = id || crypto.randomUUID();
    const now = new Date().toISOString();
    const effectiveConceptId = conceptId || `concept_${questionId}`;

    console.log("üÜî Question ID:", questionId);
    console.log("üîó Concept ID:", effectiveConceptId);

    // First, ensure the concept exists
    try {
      console.log("üìù Creating concept entry...");
      const conceptSql = `
        INSERT OR IGNORE INTO question_concepts (id, productId, packageId, system, subject, topic, tags, createdAt)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `;
      db.prepare(conceptSql).run(
        effectiveConceptId,
        effectiveProductId.toString(),
        effectiveProductId.toString(),
        system,
        subject,
        topic || 'Mixed',
        JSON.stringify(tags || []),
        now
      );
      console.log("‚úÖ Concept ready");
    } catch (conceptErr) {
      console.warn("‚ö†Ô∏è Concept creation warning (may already exist):", conceptErr.message);
    }

    // Now insert the question version - simplified approach
    const sql = `
      INSERT INTO questions (
        id, stem, choices, correct, subject, system, topic, 
        status, published, createdAt, updatedAt, packageId, productId, conceptId, isLatest
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `;

    console.log("üßæ SQL READY");
    const stmt = db.prepare(sql);
    console.log("üß© RUNNING INSERT...");

    const result = stmt.run(
      questionId,
      stem,
      JSON.stringify(choices),
      correct || 'A',
      subject,
      system,
      topic || 'Mixed',
      status || 'draft',
      body.published || 0,
      now,
      now,
      effectiveProductId.toString(),
      effectiveProductId.toString(),
      effectiveConceptId,
      1 // isLatest
    );

    console.log("üéâ INSERT SUCCESS:", result);

    // Log governance history
    try {
      console.log("üìú Logging governance history...");
      db.prepare(`
        INSERT INTO governance_history (versionId, conceptId, fromState, toState, performedBy, performedAt, notes)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `).run(
        questionId,
        effectiveConceptId,
        null,
        status || 'draft',
        'author',
        now,
        'Author manual entry'
      );
      console.log("‚úÖ Governance logged");
    } catch (govErr) {
      console.warn("‚ö†Ô∏è Governance log warning:", govErr.message);
    }

    return Response.json({ 
      success: true, 
      id: questionId,
      conceptId: effectiveConceptId
    }, { status: 201 });

  } catch (err) {
    console.error("üî• QUESTION PIPELINE CRASH:");
    console.error(err);
    console.error(err.stack);

    return Response.json(
      { success: false, error: err.message },
      { status: 500 }
    );
  }
}

// PUT /api/questions - Update a question
export async function PUT(request) {
  console.log("\n==============================");
  console.log("‚û°Ô∏è /api/questions PUT HIT");

  let body;

  try {
    body = await request.json();
    console.log("üì¶ UPDATE BODY:", {
      id: body.id,
      packageId: body.packageId,
      system: body.system,
      subject: body.subject,
      status: body.status
    });
  } catch (e) {
    console.error("‚ùå JSON PARSE ERROR:", e);
    return NextResponse.json({ success: false, error: "Invalid JSON" }, { status: 400 });
  }

  try {
    if (!body.id) throw new Error("Missing id for update");
    if (!body.packageId) throw new Error("Missing packageId");
    if (!body.system) throw new Error("Missing system");
    if (!body.subject) throw new Error("Missing subject");

    console.log("‚úÖ VALIDATION OK");
    console.log("üíæ Calling updateQuestion...");
    
    const updated = updateQuestion(body.id, body);
    
    console.log("üéâ UPDATE SUCCESS:", body.id);
    return NextResponse.json({ success: true, ...updated });

  } catch (err) {
    console.error("üî• QUESTION UPDATE CRASH:");
    console.error(err);
    console.error(err.stack);
    return NextResponse.json(
      { success: false, error: err.message },
      { status: 500 }
    );
  }
}

// DELETE /api/questions - Delete a question
export async function DELETE(request) {
  console.log("\n==============================");
  console.log("‚û°Ô∏è /api/questions DELETE HIT");

  try {
    const { id } = await request.json();
    
    if (!id) {
      console.error("‚ùå VALIDATION FAILED: Missing id");
      return NextResponse.json({ success: false, error: "id required" }, { status: 400 });
    }

    console.log("üóëÔ∏è Deleting question:", id);
    deleteQuestion(id);
    console.log("‚úÖ DELETE SUCCESS:", id);
    return NextResponse.json({ success: true });

  } catch (err) {
    console.error("üî• QUESTION DELETE CRASH:");
    console.error(err);
    console.error(err.stack);
    return NextResponse.json(
      { success: false, error: err.message },
      { status: 500 }
    );
  }
}
</file>

<file path="src/app/api/questions/stats/route.js">
import { NextResponse } from 'next/server';
import { updateQuestionStats, getDb } from '@/lib/server-db';

// GET /api/questions/stats?packageId=xxx&ids=... - Return product-scoped per-question stats
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const packageId = searchParams.get('packageId');
    const ids = searchParams.get('ids')?.split(',').filter(Boolean);
    if (!packageId || !ids || ids.length === 0) {
      return NextResponse.json({ error: 'packageId and ids required' }, { status: 400 });
    }

    const db = getDb();
    const placeholders = ids.map(() => '?').join(',');
    const rows = db.prepare(`
      SELECT 
        q.id,
        COUNT(uq.id) as attempts,
        SUM(CASE WHEN uq.status = 'correct' THEN 1 ELSE 0 END) as correct
      FROM questions q
      LEFT JOIN user_questions uq ON q.id = uq.questionId 
        AND uq.packageId = ? 
        AND uq.totalAttempts > 0
      WHERE q.id IN (${placeholders}) AND q.packageId = ?
      GROUP BY q.id
    `).all(packageId.toString(), ...ids, packageId.toString());

    const stats = {};
    rows.forEach(row => {
      stats[row.id] = {
        attempts: row.attempts,
        correct: row.correct || 0
      };
    });
    // Ensure all requested IDs have an entry (even if 0 attempts)
    ids.forEach(id => {
      if (!stats[id]) stats[id] = { attempts: 0, correct: 0 };
    });

    return NextResponse.json(stats);
  } catch (error) {
    console.error('Get stats error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}

export async function POST(request) {
  try {
    const { versionId, stats } = await request.json();
    if (!versionId) return NextResponse.json({ error: 'versionId required' }, { status: 400 });

    updateQuestionStats(versionId, stats);
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Update stats error:', error);
    return NextResponse.json({ error: error.message }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/user-sandbox/route.js">
import { NextResponse } from 'next/server';
import { getUserQuestions, resetUserQuestions } from '@/lib/server-db';

// GET /api/questions/user-sandbox?userId=xxx&packageId=xxx - Sandbox progress retrieval
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');
    const packageId = searchParams.get('packageId');
    
    if (!userId || !packageId) {
      return NextResponse.json({ error: 'userId and packageId required' }, { status: 400 });
    }
    
    const questions = getUserQuestions(userId, packageId);
    return NextResponse.json(questions);
  } catch (error) {
    console.error('Get sandbox user questions error:', error);
    return NextResponse.json({ error: 'Failed to get sandbox questions' }, { status: 500 });
  }
}

// PUT /api/questions/user-sandbox - Sandbox progress update
export async function PUT(request) {
  try {
    // STRICT ARCHITECTURE: sandbox endpoint is kept for compatibility but does not persist.
    const body = await request.json().catch(() => ({}));
    console.warn('[DEPRECATED] PUT /api/questions/user-sandbox called. No-op under attempt-based architecture.', {
      userId: body?.userId,
      questionId: body?.questionId,
      packageId: body?.packageId
    });
    return NextResponse.json({ success: true, deprecated: true });
  } catch (error) {
    console.error('Update sandbox question error:', error);
    return NextResponse.json({ error: 'Failed to update' }, { status: 500 });
  }
}

// DELETE /api/questions/user-sandbox - Sandbox progress reset
export async function DELETE(request) {
  try {
    const { userId } = await request.json();
    
    if (!userId) {
      return NextResponse.json({ error: 'userId required' }, { status: 400 });
    }
    
    resetUserQuestions(userId);
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Reset sandbox user questions error:', error);
    return NextResponse.json({ error: 'Failed to reset sandbox' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/questions/user/route.js">
import { NextResponse } from 'next/server';
import { getUserQuestions, resetUserQuestions } from '@/lib/server-db';

// GET /api/questions/user?userId=xxx&packageId=xxx - Get questions with user progress
// packageId can be: a number (product id), 'default' (standard qbank), or omitted (standard qbank)
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');
    const productId = searchParams.get('productId') || searchParams.get('packageId');
    
    if (!userId) {
      return NextResponse.json({ error: 'userId required' }, { status: 400 });
    }
    
    // Pass productId to filter questions by product
    const questions = getUserQuestions(userId, productId);
    return NextResponse.json(questions);
  } catch (error) {
    console.error('Get user questions error:', error);
    return NextResponse.json({ error: 'Failed to get questions' }, { status: 500 });
  }
}

// PUT /api/questions/user - Update user's question progress
export async function PUT(request) {
  try {
    // STRICT ARCHITECTURE:
    // Attempt is the single source of truth. This endpoint is kept for backward compatibility,
    // but does not persist any permanent status/answer/flag.
    const body = await request.json().catch(() => ({}));
    console.warn('[DEPRECATED] PUT /api/questions/user called. No-op under attempt-based architecture.', {
      userId: body?.userId,
      questionId: body?.questionId,
      productId: body?.productId || body?.packageId,
      hasStatus: body?.status !== undefined,
      hasAnswer: body?.userAnswer !== undefined,
      hasMark: body?.isMarked !== undefined
    });
    return NextResponse.json({ success: true, deprecated: true });
  } catch (error) {
    console.error('Update user question error:', error?.message || error);
    return NextResponse.json(
      { error: error?.message || 'Failed to update' },
      { status: 500 }
    );
  }
}

// DELETE /api/questions/user - Reset all user question progress
export async function DELETE(request) {
  try {
    const { userId } = await request.json();
    
    if (!userId) {
      return NextResponse.json({ error: 'userId required' }, { status: 400 });
    }
    
    resetUserQuestions(userId);
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Reset user questions error:', error);
    return NextResponse.json({ error: 'Failed to reset' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/student/stats/route.js">
import { NextResponse } from 'next/server';
import { getUserProductStats } from '@/lib/server-db';

// GET /api/student/stats?userId=xxx&packageId=xxx
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');
    const packageId = searchParams.get('packageId');

    if (!userId || !packageId) {
      return NextResponse.json({ error: 'userId and packageId are required' }, { status: 400 });
    }

    const stats = getUserProductStats(userId, packageId);
    return NextResponse.json(stats);
  } catch (error) {
    console.error('Get student stats error:', error);
    return NextResponse.json({ error: 'Failed to fetch student statistics' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/subscriptions/purchase/route.js">
import { NextResponse } from 'next/server';
import { createUserSubscription, activateSubscription, getActiveSubscriptionByUserAndProduct, extendSubscription } from '@/lib/server-db';

// POST /api/subscriptions/purchase
// Body: { userId: 'xxx', cart: [{ id: packageId, title: 'Name', duration: 90, ... }] }
export async function POST(request) {
  try {
    const { userId, cart } = await request.json();

    if (!userId || !cart || !Array.isArray(cart)) {
      return NextResponse.json({ error: 'userId and cart are required' }, { status: 400 });
    }

    const results = [];

    for (const item of cart) {
      const packageId = item.id;
      const durationDays = item.duration || 90;
      const productName = item.title || 'Medical QBank';

      console.log(`[Purchase API] Processing item: packageId=${packageId}, duration=${durationDays}`);

      // Check for existing active subscription
      const existingSubscription = getActiveSubscriptionByUserAndProduct(userId, packageId);
      
      if (existingSubscription) {
        console.log(`[Purchase API] Found existing active subscription ${existingSubscription.id}, extending`);
        
        // Extend existing subscription
        const extendedSub = extendSubscription(existingSubscription.id, durationDays);
        results.push({
          ...extendedSub,
          action: 'extended',
          message: 'Subscription extended successfully'
        });
      } else {
        console.log(`[Purchase API] No existing subscription, creating new one`);
        
        // Create new subscription
        const sub = createUserSubscription({
          userId,
          packageId,
          durationDays,
          productName
        });

        // In this sandbox environment, we activate it immediately
        const activeSub = activateSubscription(sub.id);
        results.push({
          ...activeSub,
          action: 'created',
          message: 'Subscription created successfully'
        });
      }
    }

    return NextResponse.json({ success: true, subscriptions: results });
  } catch (error) {
    console.error('Purchase API error:', error);
    return NextResponse.json({ error: 'Failed to process purchase' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/tests/attempts/[id]/route.js">
import { NextResponse } from 'next/server';
import { updateAttemptAnswer, updateAttemptFlag, snapshotAttempt, finishAttempt } from '@/lib/server-db';

export async function PATCH(request, { params }) {
  try {
    const { id } = await params;
    const body = await request.json();
    const { type, questionId, selectedOption, isFlagged } = body;

    if (type === 'answer') {
      if (!questionId) return NextResponse.json({ error: 'questionId required' }, { status: 400 });
      updateAttemptAnswer(id, questionId, selectedOption);
      return NextResponse.json({ success: true });
    }

    if (type === 'flag') {
      if (!questionId) return NextResponse.json({ error: 'questionId required' }, { status: 400 });
      updateAttemptFlag(id, questionId, isFlagged);
      return NextResponse.json({ success: true });
    }

    return NextResponse.json({ error: 'Invalid update type' }, { status: 400 });
  } catch (error) {
    console.error('Update attempt error:', error);
    return NextResponse.json({ error: 'Failed to update attempt' }, { status: 500 });
  }
}

export async function POST(request, { params }) {
  try {
    const { id } = await params;
    const body = await request.json();
    const { type, snapshot } = body || {};

    if (type === 'snapshot') {
      if (!snapshot) return NextResponse.json({ error: 'snapshot required' }, { status: 400 });
      snapshotAttempt(id, snapshot);
      return NextResponse.json({ success: true });
    }

    if (type === 'finish') {
      if (!snapshot) {
        return NextResponse.json({ error: 'snapshot required before finish' }, { status: 400 });
      }

      snapshotAttempt(id, snapshot);
      finishAttempt(id);
      return NextResponse.json({ success: true });
    }

    return NextResponse.json({ error: 'Invalid operation' }, { status: 400 });
  } catch (error) {
    console.error('Post attempt error:', error);
    return NextResponse.json({ error: 'Failed to process attempt operation' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/tests/pool/route.js">
import { NextResponse } from 'next/server';
import { getEligiblePool, getUniverseSize } from '@/lib/server-db';

/**
 * GET /api/tests/pool?userId=...&packageId=...&filters=...
 * Real-time calculation of eligible question pool before test creation.
 */
export async function POST(request) {
  try {
    const { userId, packageId, filters } = await request.json();
    
    if (!userId || !packageId) {
      return NextResponse.json({ error: 'userId and packageId required' }, { status: 400 });
    }

    const universeSize = getUniverseSize(packageId);
    const pool = getEligiblePool(userId, packageId, filters);
    
    return NextResponse.json({
      universeSize,
      eligiblePoolSize: pool.length,
      pool: pool // Return the IDs so the client can preview if needed, or just for count
    });
  } catch (error) {
    console.error('Pool calculation error:', error);
    return NextResponse.json({ error: 'Failed to calculate pool' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/tests/route.js">
import { NextResponse } from 'next/server';
import { getUserTests, saveTest, deleteTest, clearUserTests, getEligiblePool, getUniverseSize, getQuestionById } from '@/lib/server-db';

// GET /api/tests?userId=xxx - Get all tests for a user
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');
    const packageId = searchParams.get('packageId');
    
    if (!userId || !packageId) {
      return NextResponse.json({ error: 'userId and packageId required' }, { status: 400 });
    }
    
    const tests = getUserTests(userId, packageId);
    return NextResponse.json(tests);
  } catch (error) {
    console.error('Get tests error:', {
      message: error.message,
      stack: error.stack,
      userId: new URL(request.url).searchParams.get('userId'),
      packageId: new URL(request.url).searchParams.get('packageId')
    });
    return NextResponse.json({ error: 'Failed to get tests: ' + error.message }, { status: 500 });
  }
}

// POST /api/tests - Assemble and Save a test
export async function POST(request) {
  try {
    const data = await request.json();
    
    if (!data.userId || !data.packageId) {
      return NextResponse.json({ error: 'userId and packageId required' }, { status: 400 });
    }

    // 1. Check if we need to ASSEMBLE the test on the server (Preferred)
    let questions = data.questions;
    let universeSize = data.universeSize;
    let eligiblePoolSize = data.eligiblePoolSize;

    if (!questions && data.poolLogic && data.count) {
      // ASSEMBLY ENGINE TRIGGERED
      console.log('Test Assembly Engine: Creating new block...', data.poolLogic);
      
      universeSize = getUniverseSize(data.packageId);
      const eligibleIds = getEligiblePool(data.userId, data.packageId, data.poolLogic, data.count);
      eligiblePoolSize = eligibleIds.length;
      
      if (eligiblePoolSize === 0) {
        return NextResponse.json({ error: 'No questions matching these filters are available in your universe.' }, { status: 400 });
      }

      // Snapshot the IDs into the question list
      // For now, we store the full question objects in the 'questions' JSON blob to ensure immutability
      // even if the question is deleted or changed in the main library (snapshotting).
      questions = eligibleIds.map(id => getQuestionById(id));
      
      // Adjust count if universe was smaller than requested
      if (questions.length < data.count) {
        console.warn(`Requested ${data.count} but only found ${questions.length}`);
      }
    }

    if (!questions || !data.testId) {
      return NextResponse.json({ error: 'testId and question list (or assembly logic) required' }, { status: 400 });
    }

    const testToSave = {
      ...data,
      questions,
      universeSize,
      eligiblePoolSize,
      poolLogic: data.poolLogic || {},
      createdAt: new Date().toISOString()
    };
    
    const saved = saveTest(testToSave);

    return NextResponse.json(saved);
  } catch (error) {
    console.error('Save test error:', error);
    return NextResponse.json({ error: 'Failed to create test: ' + error.message }, { status: 500 });
  }
}

// DELETE /api/tests - Delete a test or clear all user tests
export async function DELETE(request) {
  try {
    const { testId, userId, clearAll } = await request.json();
    
    if (clearAll && userId) {
      clearUserTests(userId);
    } else if (testId) {
      deleteTest(testId);
    } else {
      return NextResponse.json({ error: 'testId or userId+clearAll required' }, { status: 400 });
    }
    
    return NextResponse.json({ success: true });
  } catch (error) {
    console.error('Delete test error:', error);
    return NextResponse.json({ error: 'Failed to delete' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/users/subscriptions/route.js">
import { NextResponse } from 'next/server';
import { getUserSubscriptions, createUserSubscription, activateSubscription, getActiveSubscriptionByUserAndProduct, extendSubscription } from '@/lib/server-db';

// GET /api/users/subscriptions?userId=xxx
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const userId = searchParams.get('userId');

    if (!userId) {
      return NextResponse.json({ error: 'userId is required' }, { status: 400 });
    }

    const subscriptions = getUserSubscriptions(userId);
    return NextResponse.json(subscriptions);
  } catch (error) {
    console.error('Get subscriptions error:', error);
    return NextResponse.json({ error: 'Failed to fetch subscriptions' }, { status: 500 });
  }
}

// POST /api/users/subscriptions
export async function POST(request) {
  try {
    const { userId, productId, durationDays, productName, amount, paymentToken } = await request.json();

    if (!userId || !productId || !durationDays) {
      return NextResponse.json({ error: 'userId, productId, and durationDays are required' }, { status: 400 });
    }

    console.log(`[API] Creating/extending subscription for user ${userId}, product ${productId}, amount ${amount}`);

    // Check for existing active subscription
    const existingSubscription = getActiveSubscriptionByUserAndProduct(userId, productId);
    
    if (existingSubscription) {
      console.log(`[API] Found existing active subscription ${existingSubscription.id}, extending duration by ${durationDays} days`);
      
      // Extend existing subscription
      const extendedSub = extendSubscription(existingSubscription.id, durationDays);
      
      return NextResponse.json({
        ...extendedSub,
        message: 'Subscription extended successfully',
        action: 'extended'
      });
    }

    // No existing subscription, create new one
    console.log(`[API] No existing subscription found, creating new subscription`);
    
    const activeSub = createUserSubscription({
      userId,
      packageId: productId,
      durationDays: Number(durationDays),
      productName: productName || 'Medical QBank',
      amount: amount || 0,
      status: 'active'
    });

    // Return full subscription object (including purchaseDate) on success
    return NextResponse.json({
      ...activeSub,
      message: 'Subscription created successfully',
      action: 'created'
    });
  } catch (error) {
    console.error('Create subscription error:', error);
    return NextResponse.json({ 
      error: 'Failed to create subscription',
      message: error.message 
    }, { status: 500 });
  }
}
</file>

<file path="src/app/auth/AuthComponent.jsx">
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { useRouter, useSearchParams } from "next/navigation";
import { loginUser, registerUser } from "@/auth/auth.logic";
import { Mail, Lock, User, Eye, EyeOff, AlertCircle, CheckCircle2 } from "lucide-react";

export default function AuthComponent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectPath = searchParams.get("redirect");
  const [ready, setReady] = useState(false);

  useEffect(() => {
    setReady(true);
  }, []);

  // Login state
  const [loginEmail, setLoginEmail] = useState("");
  const [loginPassword, setLoginPassword] = useState("");
  const [loginError, setLoginError] = useState("");
  const [loginLoading, setLoginLoading] = useState(false);
  const [showLoginPassword, setShowLoginPassword] = useState(false);

  // Register state
  const [registerName, setRegisterName] = useState("");
  const [registerEmail, setRegisterEmail] = useState("");
  const [registerPassword, setRegisterPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [registerError, setRegisterError] = useState("");
  const [registerLoading, setRegisterLoading] = useState(false);
  const [registerSuccess, setRegisterSuccess] = useState(false);
  const [showRegisterPassword, setShowRegisterPassword] = useState(false);
  const [showConfirmPassword, setShowConfirmPassword] = useState(false);
  const [showForgotPassword, setShowForgotPassword] = useState(false);
  const [forgotEmail, setForgotEmail] = useState("");
  const [forgotError, setForgotError] = useState("");
  const [forgotSuccess, setForgotSuccess] = useState(false);
  const [forgotLoading, setForgotLoading] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoginLoading(true);
    setLoginError("");

    try {
      const user = await loginUser(loginEmail, loginPassword);

      if (!user) {
        setLoginError("Invalid email or password. Please try again.");
        setLoginLoading(false);
        return;
      }

      const userRole = (user.role || '').toLowerCase().trim();
      console.log('Login success - received user:', { id: user.id, role: userRole });

      if (redirectPath) {
        console.log('Redirecting to manual redirect path:', redirectPath);
        router.push(redirectPath);
        return;
      }

      if (userRole === 'author') {
        console.log('Redirecting to Author Portal...');
        router.push("/author");
      } else {
        console.log('Redirecting to Student Portal...');
        router.push("/student/portal");
      }
    } catch (err) {
      console.error('Login handle error:', err);
      // Use the specific error message from the API/Logic if available
      setLoginError(err || "An unexpected error occurred. Please try again.");
      setLoginLoading(false);
    }
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    setRegisterLoading(true);
    setRegisterError("");

    if (registerPassword !== confirmPassword) {
      setRegisterError("Passwords do not match");
      setRegisterLoading(false);
      return;
    }

    if (registerPassword.length < 6) {
      setRegisterError("Password must be at least 6 characters");
      setRegisterLoading(false);
      return;
    }

    try {
      await registerUser(registerName, registerEmail, registerPassword);
      setRegisterSuccess(true);
      setTimeout(() => {
        // Auto-login after registration
        loginUser(registerEmail, registerPassword).then((user) => {
          if (redirectPath) {
            router.push(redirectPath);
          } else {
            router.push("/student/portal");
          }
        });
      }, 1500);
    } catch (err) {
      setRegisterError(err?.message || err || "Failed to create account. Please try again.");
      setRegisterLoading(false);
    }
  };

  const handleForgotPassword = async (e) => {
    e.preventDefault();
    setForgotLoading(true);
    setForgotError("");
    
    try {
      const { getUserByEmail } = await import("@/services/user.service");
      const user = await getUserByEmail(forgotEmail);
      
      if (!user) {
        setForgotError("Email address not found in our records.");
        setForgotLoading(false);
        return;
      }
      
      // Email matches found user info, proceed with instructions
      setForgotSuccess(true);
      // In a real app, this would trigger an actual email service
      console.log(`Password reset instructions sent to ${forgotEmail}`);
      
    } catch (err) {
      setForgotError("An error occurred. Please try again later.");
    } finally {
      setForgotLoading(false);
    }
  };

  if (!ready) return null;

  return (
    <div className="min-h-screen bg-[#fcfdfe] flex flex-col">
      {/* Header */}
      <header className="bg-white border-b border-slate-100 py-4 px-6">
        <div className="max-w-7xl mx-auto flex items-center justify-between">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => router.push('/')}>
            <div className="flex items-center">
              <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
              <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
              </div>
            </div>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="flex-1 flex items-center justify-center px-6 py-12">
        <div className="w-full max-w-6xl grid grid-cols-1 lg:grid-cols-2 gap-12">
          
          {/* Login Section */}
          <div className="bg-white rounded-[2.5rem] p-10 shadow-xl border-2 border-slate-100">
            <h2 className="text-3xl font-black text-slate-900 mb-2">Login</h2>
            <p className="text-slate-500 text-sm mb-8">Sign in using your IskyMD account</p>

            <form onSubmit={handleLogin} className="space-y-6">
              <div>
                <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Email</label>
                <div className="relative">
                  <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                  <input
                    type="email"
                    value={loginEmail}
                    onChange={(e) => setLoginEmail(e.target.value)}
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-4 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                    placeholder="Enter your email"
                    required
                  />
                </div>
              </div>

              <div>
                <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Password</label>
                <div className="relative">
                  <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                  <input
                    type={showLoginPassword ? "text" : "password"}
                    value={loginPassword}
                    onChange={(e) => setLoginPassword(e.target.value)}
                    className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-12 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                    placeholder="Enter your password"
                    required
                  />
                  <button
                    type="button"
                    onClick={() => setShowLoginPassword(!showLoginPassword)}
                    className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500"
                  >
                    {showLoginPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                  </button>
                </div>
              </div>

              <div className="flex items-center justify-between text-sm">
                <div className="flex flex-col gap-2">
                  <label className="flex items-center gap-2 cursor-pointer group">
                    <input type="checkbox" className="w-4 h-4 rounded border-slate-300 accent-[#1d46af]" />
                    <span className="text-slate-500 font-medium group-hover:text-slate-700 transition-colors">Remember me</span>
                  </label>
                  <label className="flex items-center gap-2 cursor-pointer group">
                    <input
                      type="checkbox"
                      checked={showLoginPassword}
                      onChange={() => setShowLoginPassword(!showLoginPassword)}
                      className="w-4 h-4 rounded border-slate-300 accent-[#1d46af]"
                    />
                    <span className="text-slate-500 font-medium group-hover:text-slate-700 transition-colors">Show password</span>
                  </label>
                </div>
                <button 
                  type="button"
                  onClick={() => setShowForgotPassword(true)}
                  className="text-[#1d46af] font-bold hover:underline self-start"
                >
                  Forgot Password?
                </button>
              </div>

              {loginError && (
                <div className="p-3 bg-red-50 border border-red-100 rounded-xl flex items-center gap-2 text-red-600 text-sm font-medium">
                  <AlertCircle size={16} />
                  {loginError}
                </div>
              )}

              <button
                type="submit"
                disabled={loginLoading}
                className="w-full py-4 bg-[#1d46af] text-white text-sm font-black rounded-xl hover:bg-[#16368a] transition-all shadow-xl shadow-blue-500/20 active:scale-95 disabled:opacity-50"
              >
                {loginLoading ? "SIGNING IN..." : "LOGIN"}
              </button>
            </form>
          </div>

          {/* Register Section */}
          <div className="bg-white rounded-[2.5rem] p-10 shadow-xl border-2 border-slate-100">
            <h2 className="text-3xl font-black text-slate-900 mb-2">Register</h2>
            <p className="text-slate-500 text-sm mb-8">Create your IskyMD account</p>

            {registerSuccess ? (
              <div className="py-12 text-center">
                <div className="w-20 h-20 rounded-full bg-emerald-50 flex items-center justify-center mx-auto mb-4">
                  <CheckCircle2 size={40} className="text-emerald-500" />
                </div>
                <h3 className="text-xl font-black text-slate-900 mb-2">Account Created!</h3>
                <p className="text-slate-500 font-medium">Redirecting you to your portal...</p>
              </div>
            ) : (
              <form onSubmit={handleRegister} className="space-y-6">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">First Name</label>
                    <div className="relative">
                      <User className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                      <input
                        type="text"
                        value={registerName}
                        onChange={(e) => setRegisterName(e.target.value)}
                        className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-4 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                        placeholder="First name"
                        required
                      />
                    </div>
                  </div>
                  <div>
                    <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Last Name</label>
                    <input
                      type="text"
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 px-4 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                      placeholder="Last name"
                    />
                  </div>
                </div>

                <div>
                  <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Email</label>
                  <div className="relative">
                    <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type="email"
                      value={registerEmail}
                      onChange={(e) => setRegisterEmail(e.target.value)}
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-4 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                      placeholder="Enter your email"
                      required
                    />
                  </div>
                </div>

                <div>
                  <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Password</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type={showRegisterPassword ? "text" : "password"}
                      value={registerPassword}
                      onChange={(e) => setRegisterPassword(e.target.value)}
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-12 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                      placeholder="Create password"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowRegisterPassword(!showRegisterPassword)}
                      className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500"
                    >
                      {showRegisterPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                    </button>
                  </div>
                </div>

                <div>
                  <label className="text-xs font-black text-slate-500 uppercase tracking-widest block mb-2">Confirm Password</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type={showConfirmPassword ? "text" : "password"}
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      className="w-full bg-slate-50 border-2 border-slate-100 rounded-xl py-3.5 pl-12 pr-12 text-sm font-bold text-black focus:outline-none focus:border-[#1d46af] transition-colors"
                      placeholder="Confirm password"
                      required
                    />
                    <button
                      type="button"
                      onClick={() => setShowConfirmPassword(!showConfirmPassword)}
                      className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-300 hover:text-slate-500"
                    >
                      {showConfirmPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                    </button>
                  </div>
                </div>

                <div className="text-xs text-slate-500">
                  By clicking &quot;Register&quot;, I confirm that I am over the age of 13 and agree to IskyMD&apos;s{" "}
                  <a href="#" className="text-[#1d46af] font-bold hover:underline">Terms of Use</a> and{" "}
                  <a href="#" className="text-[#1d46af] font-bold hover:underline">Privacy Policy</a>.
                </div>

                {registerError && (
                  <div className="p-3 bg-red-50 border border-red-100 rounded-xl flex items-center gap-2 text-red-600 text-sm font-medium">
                    <AlertCircle size={16} />
                    {registerError}
                  </div>
                )}

                <button
                  type="submit"
                  disabled={registerLoading}
                  className="w-full py-4 bg-[#1d46af] text-white text-sm font-black rounded-xl hover:bg-[#16368a] transition-all shadow-xl shadow-blue-500/20 active:scale-95 disabled:opacity-50"
                >
                  {registerLoading ? "CREATING ACCOUNT..." : "REGISTER"}
                </button>
              </form>
            )}
          </div>
        </div>

        {/* Forgot Password Modal */}
        {showForgotPassword && (
          <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-6 animate-in fade-in duration-300">
            <div className="bg-white rounded-[2.5rem] w-full max-w-md p-10 shadow-2xl border border-slate-100 animate-in zoom-in-95 duration-300">
              <div className="w-16 h-16 rounded-2xl bg-blue-50 flex items-center justify-center mb-6 mx-auto border border-blue-100 text-[#1d46af]">
                <Mail size={32} />
              </div>
              
              <h3 className="text-2xl font-black text-slate-900 text-center mb-2 tracking-tight">Recover Password</h3>
              <p className="text-center text-slate-500 text-sm font-medium mb-8">
                Enter your registered email address to receive password reset instructions.
              </p>

              {forgotSuccess ? (
                <div className="text-center py-6 animate-in zoom-in duration-300">
                  <div className="w-16 h-16 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center mb-4 mx-auto">
                    <CheckCircle2 size={32} />
                  </div>
                  <h4 className="text-lg font-bold text-slate-900">Email Sent!</h4>
                  <p className="text-sm text-slate-500 mt-2">
                    Check your inbox at <span className="font-bold text-slate-700">{forgotEmail}</span> for instructions to reset your password.
                  </p>
                  <button 
                    onClick={() => {
                      setShowForgotPassword(false);
                      setForgotSuccess(false);
                      setForgotEmail("");
                    }}
                    className="mt-8 w-full py-4 bg-slate-900 text-white text-sm font-black rounded-xl hover:bg-slate-800 transition-all active:scale-95"
                  >
                    BACK TO LOGIN
                  </button>
                </div>
              ) : (
                <form onSubmit={handleForgotPassword} className="space-y-6">
                  {forgotError && (
                    <div className="p-3 bg-red-50 border border-red-100 rounded-xl flex items-center gap-2 text-red-600 text-sm font-medium animate-in shake duration-300">
                      <AlertCircle size={16} />
                      {forgotError}
                    </div>
                  )}

                  <div>
                    <label className="text-[10px] font-black text-slate-500 uppercase tracking-widest ml-1 block mb-2">Registration Email</label>
                    <div className="relative">
                      <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                      <input
                        type="email"
                        required
                        value={forgotEmail}
                        onChange={(e) => setForgotEmail(e.target.value)}
                        placeholder="e.g. name@example.com"
                        className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 pl-11 pr-4 text-sm font-bold text-black focus:bg-white focus:ring-4 focus:ring-blue-500/5 focus:border-[#1d46af]/30 transition-all outline-none"
                      />
                    </div>
                  </div>

                  <div className="flex flex-col gap-3 pt-4">
                    <button 
                      type="submit"
                      disabled={forgotLoading}
                      className="w-full py-4 bg-[#1d46af] text-white text-sm font-black rounded-xl hover:bg-[#16368a] transition-all shadow-xl shadow-blue-500/20 active:scale-95 disabled:opacity-50"
                    >
                      {forgotLoading ? "VERIFYING..." : "SEND INSTRUCTIONS"}
                    </button>
                    <button 
                      type="button"
                      onClick={() => setShowForgotPassword(false)}
                      className="w-full py-4 bg-white text-slate-400 text-sm font-black rounded-xl hover:bg-slate-50 transition-all active:scale-95"
                    >
                      CANCEL
                    </button>
                  </div>
                </form>
              )}
            </div>
          </div>
        )}
      </main>

      {/* Footer */}
      <footer className="bg-slate-800 text-white py-16 px-6">
        <div className="max-w-7xl mx-auto">
          <div className="text-center mb-12">
            <h2 className="text-3xl font-black mb-3">Explore All IskyMD Products</h2>
            <p className="text-slate-300 font-medium">Choose your exam</p>
          </div>
          
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-w-4xl mx-auto">
            {/* ECG Qbank */}
            <Link href="/products" className="bg-slate-700/50 hover:bg-slate-700 rounded-2xl p-6 transition-all border border-slate-600 hover:border-[#1d46af] group">
              <div className="w-12 h-12 rounded-xl bg-rose-500 flex items-center justify-center mb-4 group-hover:scale-110 transition-transform">
                <svg className="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
              </div>
              <h3 className="text-lg font-black mb-2">ECG Qbank</h3>
              <p className="text-sm text-slate-300 font-medium">Master ECG interpretation with 2,000+ rhythm strips</p>
            </Link>

            {/* Coming Soon Products */}
            <div className="bg-slate-700/30 rounded-2xl p-6 border border-slate-600 opacity-60">
              <div className="w-12 h-12 rounded-xl bg-slate-600 flex items-center justify-center mb-4">
                <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                </svg>
              </div>
              <h3 className="text-lg font-black mb-2">Clinical Qbank</h3>
              <p className="text-sm text-slate-400 font-medium">Coming Soon</p>
            </div>

            <div className="bg-slate-700/30 rounded-2xl p-6 border border-slate-600 opacity-60">
              <div className="w-12 h-12 rounded-xl bg-slate-600 flex items-center justify-center mb-4">
                <svg className="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
                </svg>
              </div>
              <h3 className="text-lg font-black mb-2">Practice Exams</h3>
              <p className="text-sm text-slate-400 font-medium">Coming Soon</p>
            </div>
          </div>

          <div className="mt-12 pt-8 border-t border-slate-700 text-center">
            <p className="text-sm text-slate-400 font-medium">¬© 2026 IskyMD. All rights reserved.</p>
          </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="src/app/auth/page.jsx">
"use client";

import dynamic from "next/dynamic";

const AuthComponent = dynamic(() => import("./AuthComponent"), {
  ssr: false,
});

export default function AuthPage() {
  return <AuthComponent />;
}
</file>

<file path="src/app/author/activity/page.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { Search, Filter, MessageSquare, Shield, Clock, BookOpen, ChevronRight, User, DollarSign, Activity } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

export default function ActivityFeedPage() {
    const router = useRouter();
    const [ok, setOk] = useState(false);
    const [notifications, setNotifications] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [filterType, setFilterType] = useState(""); // registration, purchase
    const [searchQuery, setSearchQuery] = useState("");

    // Auth check
    useEffect(() => {
        // Legacy Password Check Removed: Authorization now handled by AuthorLayout
        setOk(true);
    }, [router]);

    useEffect(() => {
        if (ok) loadActivity();
    }, [ok]);

    const loadActivity = async () => {
        setIsLoading(true);
        try {
            const res = await fetch('/api/notifications?limit=100');
            const data = await res.json();
            setNotifications(data);
        } catch (err) {
            console.error(err);
        } finally {
            setIsLoading(false);
        }
    };

    const filtered = notifications.filter(n => {
        const matchesFilter = !filterType || n.type === filterType;
        const matchesSearch = !searchQuery || n.message.toLowerCase().includes(searchQuery.toLowerCase());
        return matchesFilter && matchesSearch;
    });

    if (!ok) return null;

    return (
        <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#0066CC]/5 pointer-events-none" />
            
            <main className="max-w-[1200px] mx-auto px-6 py-8 relative z-10">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                    <div>
                        <h1 className="text-4xl font-heading font-black tracking-tighter text-[#1B263B] uppercase italic flex items-center gap-3">
                            <Activity className="text-[#0066CC]" size={36} /> System <span className="text-[#0066CC]">Activity</span>
                        </h1>
                        <p className="text-slate-500 mt-2 text-sm font-semibold tracking-tight uppercase">Master Ledger of Student Uplinks and Transactions</p>
                    </div>
                </div>

                {/* Filters */}
                <div className="flex flex-wrap gap-4 mb-8">
                    <div className="flex-1 min-w-[300px] relative">
                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground" size={18} />
                        <input
                            placeholder="Find event or student identifier..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full bg-white/90 backdrop-blur-sm border border-slate-200 pl-12 pr-4 py-4 rounded-[24px] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all font-black shadow-sm text-[#1B263B] uppercase tracking-tight"
                        />
                    </div>

                    <select
                        value={filterType}
                        onChange={(e) => setFilterType(e.target.value)}
                        className="bg-white/90 backdrop-blur-sm text-[#1B263B] border border-slate-200 px-8 py-4 rounded-[24px] text-xs font-black uppercase tracking-widest focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all cursor-pointer hover:bg-slate-50 shadow-sm"
                    >
                        <option value="">All Events</option>
                        <option value="registration">Registrations</option>
                        <option value="purchase">Paid Activations</option>
                    </select>

                    <button
                        onClick={loadActivity}
                        className="p-4 bg-white/90 backdrop-blur-sm border border-slate-200 text-[#1B263B] hover:bg-slate-50 rounded-[24px] transition-all shadow-sm active:scale-95"
                        title="Reload Ledger"
                    >
                        <Clock size={20} />
                    </button>
                </div>

                {isLoading ? (
                    <div className="flex flex-col items-center justify-center py-20 gap-4">
                        <div className="w-10 h-10 border-4 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin"></div>
                        <p className="text-slate-400 font-mono text-[10px] font-black uppercase tracking-[0.3em]">Querying_Database_Archives...</p>
                    </div>
                ) : filtered.length === 0 ? (
                    <div className="p-20 bg-white/80 backdrop-blur-md rounded-[40px] border border-slate-200 text-center shadow-lg">
                        <div className="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <Activity size={40} className="text-slate-300" />
                        </div>
                        <h3 className="font-heading font-black text-2xl mb-2 text-[#1B263B] uppercase italic">Zero Activity Detected</h3>
                        <p className="text-slate-500 text-sm font-semibold max-w-xs mx-auto">The system ledger is currently empty for the selected filters.</p>
                    </div>
                ) : (
                    <div className="space-y-4">
                        {filtered.map((n, idx) => (
                            <motion.div
                                initial={{ opacity: 0, y: 10 }}
                                animate={{ opacity: 1, y: 0 }}
                                transition={{ delay: idx * 0.03 }}
                                key={n.id}
                                className="bg-white/90 backdrop-blur-sm border border-slate-200 p-6 rounded-[32px] shadow-sm hover:shadow-md transition-all flex items-center gap-6"
                            >
                                <div className={`w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 shadow-inner ${
                                    n.type === 'purchase' 
                                        ? 'bg-emerald-100 text-emerald-600 border border-emerald-200' 
                                        : 'bg-blue-100 text-blue-600 border border-blue-200'
                                }`}>
                                    {n.type === 'purchase' ? <DollarSign size={24} /> : <User size={24} />}
                                </div>
                                <div className="flex-1">
                                    <div className="flex items-center gap-2 mb-1">
                                        <span className={`text-[9px] font-black uppercase py-0.5 px-2 rounded-full border ${
                                             n.type === 'purchase' ? 'bg-emerald-50 text-white border-emerald-600' : 'bg-blue-600 text-white border-blue-700'
                                        }`}>
                                            {n.type === 'purchase' ? 'FINANCIAL' : 'PERSONNEL'}
                                        </span>
                                        <span className="text-[10px] font-mono text-slate-400 font-bold uppercase tracking-tighter">
                                            {new Date(n.createdAt).toLocaleString()}
                                        </span>
                                    </div>
                                    <h4 className="text-lg font-black text-[#1B263B] uppercase tracking-tight italic leading-none">{n.message}</h4>
                                    <p className="text-[10px] font-bold text-slate-400 uppercase tracking-widest mt-1">Status: Logged_Success // Archive_ID: {n.id}</p>
                                </div>
                                <div className="hidden md:flex flex-col items-end gap-2 pr-4">
                                    <button 
                                      onClick={() => router.push(`/author/users?search=${n.metadata?.email || ''}`)}
                                      className="flex items-center gap-2 text-[10px] font-black uppercase tracking-widest text-[#0066CC] hover:underline"
                                    >
                                        Inspect Identity <ChevronRight size={12} />
                                    </button>
                                </div>
                            </motion.div>
                        ))}
                    </div>
                )}
            </main>
        </div>
    );
}
</file>

<file path="src/app/author/create-question/page.jsx">
"use client";

import React, { Suspense } from "react";
import { useQuestionEditor } from "@/hooks/author/useQuestionEditor";
import MetadataPanel from "@/components/author/question/MetadataPanel";
import StemEditor from "@/components/author/question/StemEditor";
import OptionEditor from "@/components/author/question/OptionEditor";
import ExplanationEditor from "@/components/author/question/ExplanationEditor";

function CreateQuestionPageInner() {
  const editor = useQuestionEditor();
  const { isAuthorized, loading, loadError } = editor;

  if (!isAuthorized) return null;
  if (loading) return <div className="p-10 text-center text-xl font-bold text-slate-400">Loading question...</div>;
  if (loadError) return <div className="p-10 text-center text-xl text-red-600 font-bold">{loadError}</div>;

  return (
    <div className="p-2">
      <form onSubmit={(e) => e.preventDefault()} className="grid grid-cols-1 xl:grid-cols-[380px_1fr] gap-4">
        {/* LEFT PANEL: METADATA & ACTIONS */}
        <MetadataPanel editor={editor} />

        {/* MAIN CONTENT: EDITORS */}
        <fieldset className="space-y-4">
          <StemEditor editor={editor} />
          <OptionEditor editor={editor} />
          <ExplanationEditor editor={editor} />
        </fieldset>
      </form>
    </div>
  );
}

export default function CreateQuestionPage() {
  return (
    <Suspense fallback={<div className="p-10 text-center text-xl font-bold text-slate-400">Loading question...</div>}>
      <CreateQuestionPageInner />
    </Suspense>
  );
}
</file>

<file path="src/app/author/login/AuthorLoginComponent.jsx">
"use client";

import { useState, useEffect } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { loginUser } from "@/auth/auth.logic";
import { Mail, Lock, Eye, EyeOff, AlertCircle, Shield, Terminal } from "lucide-react";

export default function AuthorLoginComponent() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const redirectPath = searchParams.get("redirect");
  const [ready, setReady] = useState(false);

  useEffect(() => {
    queueMicrotask(() => setReady(true));
  }, []);

  // Login state
  const [loginEmail, setLoginEmail] = useState("");
  const [loginPassword, setLoginPassword] = useState("");
  const [loginError, setLoginError] = useState("");
  const [loginLoading, setLoginLoading] = useState(false);
  const [showLoginPassword, setShowLoginPassword] = useState(false);

  const handleLogin = async (e) => {
    e.preventDefault();
    setLoginLoading(true);
    setLoginError("");

    try {
      const user = await loginUser(loginEmail, loginPassword);

      if (!user) {
        setLoginError("Access Denied: Invalid credentials");
        setLoginLoading(false);
        return;
      }

      // Verify admin role
      const userRole = (user.role || '').toLowerCase().trim();
      console.log('Author login - received user:', { id: user.id, role: userRole, email: user.email });

      // Only allow admin/author users or specific email
      if (userRole !== 'admin' && userRole !== 'author' && user.email !== 'norbekoviskandar@gmail.com') {
        setLoginError("Access Denied: Author privileges required");
        setLoginLoading(false);
        // Clear the logged in session
        localStorage.removeItem("medbank_user");
        return;
      }

      // Success - redirect to author portal
      console.log('Admin access granted. Redirecting to Author Portal...');
      if (redirectPath) {
        router.push(redirectPath);
      } else {
        router.push("/author");
      }
    } catch (err) {
      console.error('Author login error:', err);
      setLoginError(err || "Authentication failed. Please try again.");
      setLoginLoading(false);
    }
  };

  if (!ready) return null;

  return (
    <div className="min-h-screen cyber-theme cyber-mesh flex items-center justify-center p-6">
      {/* Animated background elements */}
      <div className="absolute inset-0 overflow-hidden pointer-events-none">
        <div className="absolute top-20 left-20 w-64 h-64 bg-[#005EB8]/10 rounded-full blur-3xl animate-pulse"></div>
        <div className="absolute bottom-20 right-20 w-96 h-96 bg-[#0D9488]/10 rounded-full blur-3xl animate-pulse" style={{animationDelay: '1s'}}></div>
      </div>

      {/* Login Card */}
      <div className="relative w-full max-w-md">
        {/* Glowing border effect */}
        <div className="absolute inset-0 bg-gradient-to-br from-[#005EB8] to-[#0D9488] rounded-3xl blur-xl opacity-20"></div>
        
        <div className="relative bg-[#1B263B] border-2 border-[#2D3A54] rounded-3xl p-10 shadow-2xl">
          {/* Logo/Header */}
          <div className="text-center mb-8">
            <div className="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-tr from-[#005EB8] to-[#0D9488] p-[2px] shadow-[0_4px_30px_rgba(0,94,184,0.4)] mb-4">
              <div className="w-full h-full rounded-2xl bg-[#1B263B] flex items-center justify-center">
                <Shield className="text-white w-10 h-10" />
              </div>
            </div>
            <h1 className="font-heading font-black text-3xl text-white tracking-widest uppercase mb-2">
              Admin<span className="text-[#00CCFF]">Vault</span>
            </h1>
            <div className="flex items-center justify-center gap-2 mb-4">
              <Terminal size={14} className="text-[#00CCFF]" />
              <p className="text-xs font-mono text-slate-400 uppercase tracking-[0.3em]">Secure Access Portal</p>
            </div>
            <div className="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-[#005EB8]/20 border border-[#005EB8]/30">
              <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
              <span className="text-[10px] font-mono text-green-400 uppercase tracking-wider">System Online</span>
            </div>
          </div>

          {/* Login Form */}
          <form onSubmit={handleLogin} className="space-y-6">
            <div>
              <label className="text-[10px] font-black text-[#00CCFF] uppercase tracking-[0.2em] block mb-2 ml-1">
                Administrator Email
              </label>
              <div className="relative group">
                <Mail className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-[#00CCFF] transition-colors" size={18} />
                <input
                  type="email"
                  value={loginEmail}
                  onChange={(e) => setLoginEmail(e.target.value)}
                  className="w-full bg-[#0F1729] border-2 border-[#2D3A54] rounded-xl py-3.5 pl-12 pr-4 text-sm font-mono text-white focus:outline-none focus:border-[#005EB8] focus:bg-[#1B263B] transition-all placeholder:text-slate-600"
                  placeholder="admin@system.vault"
                  required
                />
              </div>
            </div>

            <div>
              <label className="text-[10px] font-black text-[#00CCFF] uppercase tracking-[0.2em] block mb-2 ml-1">
                Authorization Key
              </label>
              <div className="relative group">
                <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-500 group-focus-within:text-[#00CCFF] transition-colors" size={18} />
                <input
                  type={showLoginPassword ? "text" : "password"}
                  value={loginPassword}
                  onChange={(e) => setLoginPassword(e.target.value)}
                  className="w-full bg-[#0F1729] border-2 border-[#2D3A54] rounded-xl py-3.5 pl-12 pr-12 text-sm font-mono text-white focus:outline-none focus:border-[#005EB8] focus:bg-[#1B263B] transition-all placeholder:text-slate-600"
                  placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                  required
                />
                <button
                  type="button"
                  onClick={() => setShowLoginPassword(!showLoginPassword)}
                  className="absolute right-4 top-1/2 -translate-y-1/2 text-slate-500 hover:text-[#00CCFF] transition-colors"
                >
                  {showLoginPassword ? <EyeOff size={18} /> : <Eye size={18} />}
                </button>
              </div>
            </div>

            <div className="flex items-center gap-2">
              <input
                type="checkbox"
                checked={showLoginPassword}
                onChange={() => setShowLoginPassword(!showLoginPassword)}
                className="w-4 h-4 rounded border-[#2D3A54] bg-[#0F1729] accent-[#005EB8] cursor-pointer"
                id="show-password"
              />
              <label htmlFor="show-password" className="text-xs text-slate-400 font-medium cursor-pointer hover:text-slate-300 transition-colors">
                Show authorization key
              </label>
            </div>

            {loginError && (
              <div className="p-4 bg-red-950/50 border-2 border-red-900/50 rounded-xl flex items-start gap-3 animate-in fade-in slide-in-from-top-2 duration-300">
                <AlertCircle size={18} className="text-red-400 flex-shrink-0 mt-0.5" />
                <div className="flex-1">
                  <p className="text-sm font-bold text-red-400 mb-1">Authentication Error</p>
                  <p className="text-xs text-red-300/80 font-mono">{loginError}</p>
                </div>
              </div>
            )}

            <button
              type="submit"
              disabled={loginLoading}
              className="w-full py-4 bg-gradient-to-r from-[#005EB8] to-[#0066CC] text-white text-sm font-black uppercase tracking-[0.2em] rounded-xl hover:from-[#0066CC] hover:to-[#005EB8] transition-all shadow-[0_4px_20px_rgba(0,94,184,0.3)] hover:shadow-[0_4px_30px_rgba(0,94,184,0.5)] active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed relative overflow-hidden group"
            >
              <span className="relative z-10">
                {loginLoading ? "AUTHENTICATING..." : "ACCESS VAULT"}
              </span>
              <div className="absolute inset-0 bg-gradient-to-r from-transparent via-white/10 to-transparent translate-x-[-200%] group-hover:translate-x-[200%] transition-transform duration-1000"></div>
            </button>
          </form>

          {/* Footer */}
          <div className="mt-8 pt-6 border-t border-[#2D3A54]">
            <p className="text-center text-[10px] font-mono text-slate-500 uppercase tracking-wider">
              Authorized Personnel Only
            </p>
            <p className="text-center text-[9px] font-mono text-slate-600 mt-1">
              All access attempts are monitored and logged
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/app/author/login/page.jsx">
import { Suspense } from "react";
import AuthorLoginComponent from "./AuthorLoginComponent";

export const metadata = {
  title: "Admin Login - IskyMD",
  description: "Secure access portal for administrators",
};

export default function AuthorLoginPage() {
  return (
    <Suspense fallback={
      <div className="min-h-screen cyber-theme cyber-mesh flex items-center justify-center">
        <div className="text-[#00CCFF] font-mono text-xl animate-pulse tracking-[0.5em] font-bold">
          LOADING...
        </div>
      </div>
    }>
      <AuthorLoginComponent />
    </Suspense>
  );
}
</file>

<file path="src/app/author/manage-products/[id]/page.jsx">
"use client";

import { useEffect, useState, use } from "react";
import { useRouter } from "next/navigation";
import { getProductById, updateProduct } from "@/services/product.service";
import { getAllQuestions, deleteQuestion, updateQuestion } from "@/services/question.service";
import { Package, ArrowLeft, Plus, Settings2, Database, Trash2, Edit2, Eye, Filter, Check, X, Shield, LayoutGrid, Layers } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

export default function ProductDetailsPage({ params }) {
    const router = useRouter();
    const { id } = use(params);
    const [ok, setOk] = useState(false);
    const [product, setProduct] = useState(null);
    const [questions, setQuestions] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // Taxonomy Management state
    const [newSystem, setNewSystem] = useState("");
    const [newSubject, setNewSubject] = useState("");
    const [isSavingTaxonomy, setIsSavingTaxonomy] = useState(false);

    // Auth check
    useEffect(() => {
        // Legacy Password Check Removed: Authorization now handled by AuthorLayout
        setOk(true);
    }, [router]);

    useEffect(() => {
        if (ok && id) {
            loadInitialData();
        }
    }, [ok, id]);

    const loadInitialData = async () => {
        setIsLoading(true);
        setError(null);
        try {
            const [p, allQs] = await Promise.all([
                getProductById(id),
                getAllQuestions()
            ]);
            
            if (!p) throw new Error("Product focus lost. Identifying sequence failed.");
            
            setProduct(p);
            // Filter questions by this packageId
            setQuestions(allQs.filter(q => q.packageId?.toString() === id.toString()));
        } catch (err) {
            console.error(err);
            setError(err.message);
        } finally {
            setIsLoading(false);
        }
    };

    const handleAddSystem = async () => {
        if (!newSystem.trim()) return;
        const updatedSystems = [...(product.systems || []), newSystem.trim()];
        const updatedProduct = { ...product, systems: updatedSystems };
        await saveTaxonomy(updatedProduct);
        setNewSystem("");
    };

    const handleRemoveSystem = async (sys) => {
        const updatedSystems = product.systems.filter(s => s !== sys);
        await saveTaxonomy({ ...product, systems: updatedSystems });
    };

    const handleAddSubject = async () => {
        if (!newSubject.trim()) return;
        const updatedSubjects = [...(product.subjects || []), newSubject.trim()];
        const updatedProduct = { ...product, subjects: updatedSubjects };
        await saveTaxonomy(updatedProduct);
        setNewSubject("");
    };

    const handleRemoveSubject = async (sub) => {
        const updatedSubjects = product.subjects.filter(s => s !== sub);
        await saveTaxonomy({ ...product, subjects: updatedSubjects });
    };

    const saveTaxonomy = async (updatedProduct) => {
        setIsSavingTaxonomy(true);
        try {
            await updateProduct(updatedProduct);
            setProduct(updatedProduct);
        } catch (err) {
            alert("Uplink failed: Could not synchronize taxonomy.");
        } finally {
            setIsSavingTaxonomy(false);
        }
    };

    const handleDeleteQuestion = async (qId) => {
        if (!confirm("Confirm data erasure? This question will be permanently purged from the vault.")) return;
        try {
            await deleteQuestion(qId);
            setQuestions(prev => prev.filter(q => q.id !== qId));
        } catch (err) {
            alert("Deletion protocol failed.");
        }
    };

    if (!ok) return null;
    if (isLoading) return (
        <div className="min-h-screen bg-[#F1F4F7] flex flex-col items-center justify-center p-10">
            <div className="w-12 h-12 border-4 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin mb-4" />
            <p className="text-slate-400 font-mono text-xs uppercase tracking-[0.3em]">Querying_Product_Archives...</p>
        </div>
    );
    if (error) return (
        <div className="min-h-screen bg-[#F1F4F7] flex flex-col items-center justify-center p-10 text-center">
            <Shield size={64} className="text-red-500 mb-6 opacity-30" />
            <h2 className="text-2xl font-black text-[#1B263B] uppercase italic mb-2">Protocol Error</h2>
            <p className="text-slate-500 max-w-md font-medium">{error}</p>
            <button onClick={() => router.push('/author/manage-products')} className="mt-8 px-6 py-3 bg-[#1B263B] text-white rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">Restore UI State</button>
        </div>
    );

    return (
        <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#0066CC]/5 pointer-events-none" />
            
            <main className="max-w-[1400px] mx-auto px-6 py-8 relative z-10">
                {/* Header Sub-Bar */}
                <div className="flex items-center gap-4 mb-8">
                    <button 
                        onClick={() => router.push('/author/manage-products')}
                        className="p-3 bg-white border border-slate-200 rounded-2xl hover:bg-slate-50 transition-all text-[#1B263B] shadow-sm group"
                    >
                        <ArrowLeft size={20} className="group-hover:-translate-x-1 transition-transform" />
                    </button>
                    <div>
                        <div className="flex items-center gap-3">
                            <h1 className="text-3xl font-heading font-black tracking-tight text-[#1B263B] uppercase italic">{product.name}</h1>
                            <span className={`px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${product.is_published ? 'bg-emerald-500/10 text-emerald-600 border border-emerald-500/20' : 'bg-amber-500/10 text-amber-600 border border-amber-500/20'}`}>
                                {product.is_published ? 'Live_Stream' : 'Archived'}
                            </span>
                        </div>
                        <p className="text-slate-500 text-sm font-medium mt-1">Focusing Package ID: <span className="font-mono text-xs opacity-70 underline decoration-slate-300">{id}</span></p>
                    </div>
                    <div className="ml-auto flex gap-3">
                        <button 
                            onClick={() => router.push(`/author/create-question?packageId=${id}`)}
                            className="px-6 py-3 bg-[#0066CC] text-white rounded-2xl hover:bg-[#0052A3] text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-[#0066CC]/20 flex items-center gap-2 active:scale-95"
                        >
                            <Plus size={16} /> New Question
                        </button>
                    </div>
                </div>

                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    {/* Sidebar: Taxonomy Control */}
                    <div className="space-y-6">
                        {/* Systems Management */}
                        <section className="bg-white border border-slate-200 rounded-[32px] p-6 shadow-sm relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-1 h-full bg-[#0066CC]" />
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B] flex items-center gap-2">
                                    <Layers size={14} className="text-[#0066CC]" /> Medical Systems
                                </h2>
                                {isSavingTaxonomy && <div className="w-4 h-4 border-2 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin" />}
                            </div>
                            
                            <div className="flex gap-2 mb-4">
                                <input 
                                    value={newSystem}
                                    onChange={e => setNewSystem(e.target.value)}
                                    placeholder="Add system..."
                                    className="bg-slate-50 border border-slate-200 px-4 py-2.5 rounded-xl flex-1 text-xs font-bold focus:ring-4 focus:ring-[#0066CC]/5 focus:border-[#0066CC] outline-none transition-all"
                                    onKeyDown={e => e.key === 'Enter' && handleAddSystem()}
                                />
                                <button onClick={handleAddSystem} className="p-2.5 bg-[#0066CC] text-white rounded-xl hover:bg-[#0052A3] transition-all">
                                    <Check size={16} />
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                {product.systems?.length === 0 ? (
                                    <div className="w-full py-6 text-center border-2 border-dashed border-slate-100 rounded-2xl">
                                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">No Systems Defined</p>
                                    </div>
                                ) : (
                                    product.systems?.map(sys => (
                                        <div key={sys} className="flex items-center gap-2 bg-[#F8FAFC] border border-slate-200 px-3 py-1.5 rounded-full text-[10px] font-black text-[#1B263B] uppercase tracking-tight group hover:border-[#0066CC]/30 transition-all">
                                            {sys}
                                            <button onClick={() => handleRemoveSystem(sys)} className="hover:text-red-500 transition-colors">
                                                <X size={10} />
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </section>

                        {/* Subjects Management */}
                        <section className="bg-white border border-slate-200 rounded-[32px] p-6 shadow-sm relative overflow-hidden">
                            <div className="absolute top-0 left-0 w-1 h-full bg-[#0891B2]" />
                            <div className="flex items-center justify-between mb-6">
                                <h2 className="text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B] flex items-center gap-2">
                                    <LayoutGrid size={14} className="text-[#0891B2]" /> Categories / Subjects
                                </h2>
                            </div>

                            <div className="flex gap-2 mb-4">
                                <input 
                                    value={newSubject}
                                    onChange={e => setNewSubject(e.target.value)}
                                    placeholder="Add subject..."
                                    className="bg-slate-50 border border-slate-200 px-4 py-2.5 rounded-xl flex-1 text-xs font-bold focus:ring-4 focus:ring-[#0891B2]/5 focus:border-[#0891B2] outline-none transition-all"
                                    onKeyDown={e => e.key === 'Enter' && handleAddSubject()}
                                />
                                <button onClick={handleAddSubject} className="p-2.5 bg-[#0891B2] text-white rounded-xl hover:bg-[#0e7490] transition-all">
                                    <Check size={16} />
                                </button>
                            </div>

                            <div className="flex flex-wrap gap-2 max-h-[300px] overflow-y-auto pr-2 custom-scrollbar">
                                {product.subjects?.length === 0 ? (
                                    <div className="w-full py-6 text-center border-2 border-dashed border-slate-100 rounded-2xl">
                                        <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">No Subjects Defined</p>
                                    </div>
                                ) : (
                                    product.subjects?.map(sub => (
                                        <div key={sub} className="flex items-center gap-2 bg-[#F8FAFC] border border-slate-200 px-3 py-1.5 rounded-full text-[10px] font-black text-[#1B263B] uppercase tracking-tight group hover:border-[#0891B2]/30 transition-all">
                                            {sub}
                                            <button onClick={() => handleRemoveSubject(sub)} className="hover:text-red-500 transition-colors">
                                                <X size={10} />
                                            </button>
                                        </div>
                                    ))
                                )}
                            </div>
                        </section>
                    </div>

                    {/* Main Content: Question List */}
                    <div className="lg:col-span-2">
                        <section className="bg-white border border-slate-200 rounded-[40px] shadow-sm overflow-hidden min-h-[600px] flex flex-col">
                            <div className="p-8 border-b border-slate-100 flex items-center justify-between bg-[#F8FAFC]/50">
                                <div>
                                    <h2 className="text-xl font-heading font-black text-[#1B263B] uppercase italic flex items-center gap-2">
                                        <Database className="text-[#0066CC]" size={20} /> Question <span className="text-[#0066CC]">Portfolio</span>
                                    </h2>
                                    <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Uplink Status: {questions.length} Content Blocks Syncronized</p>
                                </div>
                            </div>

                            {questions.length === 0 ? (
                                <div className="flex-1 flex flex-col items-center justify-center p-20 text-center">
                                    <div className="w-24 h-24 bg-slate-50 rounded-[32px] flex items-center justify-center mb-6">
                                        <Database size={40} className="text-slate-200" />
                                    </div>
                                    <h3 className="text-xl font-black text-[#1B263B] uppercase italic mb-2">Portfolio Empty</h3>
                                    <p className="text-slate-500 text-sm max-w-xs font-semibold">No questions have been deployed to this product stream yet.</p>
                                    <button 
                                        onClick={() => router.push(`/author/create-question?packageId=${id}`)}
                                        className="mt-6 text-[#0066CC] font-black uppercase text-[10px] tracking-[0.2em] hover:underline"
                                    >
                                        Initialize First Content Block ‚Üí
                                    </button>
                                </div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="w-full text-left">
                                        <thead>
                                            <tr className="bg-slate-50 text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">
                                                <th className="px-8 py-5">Classification</th>
                                                <th className="px-8 py-5">Stem Reference</th>
                                                <th className="px-8 py-5">Status</th>
                                                <th className="px-8 py-5 text-right">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-50">
                                            {questions.map((q, idx) => (
                                                <motion.tr 
                                                    initial={{ opacity: 0 }}
                                                    animate={{ opacity: 1 }}
                                                    transition={{ delay: idx * 0.05 }}
                                                    key={q.id} 
                                                    className="hover:bg-slate-50/50 transition-colors group"
                                                >
                                                    <td className="px-8 py-6">
                                                        <div className="flex flex-col gap-1">
                                                            <span className="text-[10px] font-black text-[#1B263B] uppercase leading-none">{q.system || 'Unclassified'}</span>
                                                            <span className="text-[9px] font-bold text-slate-400 uppercase tracking-tighter">{q.subject}</span>
                                                        </div>
                                                    </td>
                                                    <td className="px-8 py-6 max-w-xs">
                                                        <p className="text-xs font-medium text-slate-600 line-clamp-1 group-hover:text-[#1B263B] transition-colors">{q.stem}</p>
                                                        <span className="text-[9px] font-mono text-slate-300 mt-1 block uppercase">ID: {q.id.substring(0,8)}</span>
                                                    </td>
                                                    <td className="px-8 py-6">
                                                        <span className={`text-[9px] font-black px-2 py-0.5 rounded-full border ${q.published ? 'bg-emerald-50 text-emerald-600 border-emerald-200' : 'bg-slate-50 text-slate-400 border-slate-200'}`}>
                                                            {q.published ? 'LIVE' : 'DRAFT'}
                                                        </span>
                                                    </td>
                                                    <td className="px-8 py-6 text-right">
                                                        <div className="flex justify-end gap-2">
                                                            <button 
                                                                onClick={() => router.push(`/author/create-question?id=${q.id}`)}
                                                                className="p-2.5 rounded-xl bg-slate-50 text-slate-400 hover:bg-[#0066CC] hover:text-white transition-all border border-slate-200"
                                                                title="Edit Logic"
                                                            >
                                                                <Edit2 size={14} />
                                                            </button>
                                                            <button 
                                                                onClick={() => handleDeleteQuestion(q.id)}
                                                                className="p-2.5 rounded-xl bg-slate-50 text-slate-400 hover:bg-red-500 hover:text-white transition-all border border-slate-200"
                                                                title="Purge Object"
                                                            >
                                                                <Trash2 size={14} />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </motion.tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </section>
                    </div>
                </div>
            </main>
        </div>
    );
}
</file>

<file path="src/app/author/settings/page.jsx">
"use client";
import React, { useContext } from 'react';
import { motion } from 'framer-motion';
import { Settings, User, Bell, Shield, Moon, Sun, Monitor, LogOut, Database, Save } from 'lucide-react';
import { AppContext } from '@/context/AppContext';
import { useRouter } from 'next/navigation';

export default function SettingsPage() {
    const { theme, toggleTheme } = useContext(AppContext);
    const router = useRouter();

    const handleLogout = () => {
        if (confirm("Disconnect from Author Vault?")) {
            router.push("/student/portal");
        }
    };

    return (
        <div className="p-6 max-w-[1000px] mx-auto space-y-8">
            <header>
                <h1 className="text-3xl font-heading font-bold tracking-tight text-foreground">Platform <span className="text-primary">Settings</span></h1>
                <p className="text-muted-foreground mt-2">Manage your administrative preferences and security</p>
            </header>

            <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                {/* NAV */}
                <div className="space-y-1">
                    <SettingsTab label="General" icon={Settings} active />
                    <SettingsTab label="Account Profile" icon={User} />
                    <SettingsTab label="Notifications" icon={Bell} />
                    <SettingsTab label="Security & API" icon={Shield} />
                    <SettingsTab label="Data Management" icon={Database} />
                </div>

                {/* CONTENT */}
                <div className="md:col-span-2 space-y-6">
                    <section className="bg-card p-6 rounded-3xl border border-border shadow-sm space-y-6">
                        <h3 className="font-bold flex items-center gap-2 text-foreground">
                            <Monitor size={18} className="text-primary" />
                            Interface Preferences
                        </h3>

                        <div className="flex items-center justify-between p-4 bg-panel/30 rounded-2xl border border-border">
                            <div>
                                <p className="text-sm font-bold text-foreground">Color Scheme</p>
                                <p className="text-xs text-muted-foreground">Switch between light and dark mode</p>
                            </div>
                            <button 
                                onClick={toggleTheme}
                                className="flex items-center gap-2 px-4 py-2 bg-background border border-border rounded-xl text-xs font-bold hover:bg-panel transition-all"
                            >
                                {theme === 'dark' ? <Sun size={14} /> : <Moon size={14} />}
                                {theme === 'dark' ? 'Light Mode' : 'Dark Mode'}
                            </button>
                        </div>

                        <div className="flex items-center justify-between p-4 bg-panel/30 rounded-2xl border border-border opacity-50">
                            <div>
                                <p className="text-sm font-bold text-foreground">Compact Sidebar</p>
                                <p className="text-xs text-muted-foreground">Maximize workspace display area</p>
                            </div>
                            <div className="w-10 h-5 bg-border rounded-full relative">
                                <div className="absolute left-1 top-1 w-3 h-3 bg-white rounded-full shadow" />
                            </div>
                        </div>
                    </section>

                    <section className="bg-card p-6 rounded-3xl border border-border shadow-sm space-y-6">
                        <h3 className="font-bold flex items-center gap-2 text-foreground">
                            <Shield size={18} className="text-primary" />
                            Session Management
                        </h3>
                        <p className="text-xs text-muted-foreground px-1">Your authorization key is stored locally for this browser session.</p>
                        
                        <button 
                            onClick={handleLogout}
                            className="w-full flex items-center justify-center gap-2 p-4 bg-red-50 text-red-600 border border-red-100 rounded-2xl text-sm font-bold hover:bg-red-100 transition-all"
                        >
                            <LogOut size={18} />
                            Log out of Author Dashboard
                        </button>
                    </section>

                    <div className="flex justify-end gap-3">
                        <button className="px-6 py-2.5 rounded-xl text-sm font-bold text-muted-foreground hover:bg-panel transition-all">
                            Discard
                        </button>
                        <button className="flex items-center gap-2 px-8 py-2.5 bg-primary text-white rounded-xl text-sm font-bold shadow-lg shadow-primary/20 hover:opacity-90 transition-all">
                            <Save size={18} />
                            Save Changes
                        </button>
                    </div>
                </div>
            </div>
        </div>
    );
}

function SettingsTab({ label, icon: Icon, active = false }) {
    return (
        <button className={`w-full flex items-center gap-3 px-4 py-3 rounded-2xl text-sm font-bold transition-all ${active ? 'bg-primary text-white shadow-lg shadow-primary/10' : 'text-muted-foreground hover:bg-panel hover:text-foreground'}`}>
            <Icon size={18} />
            {label}
        </button>
    );
}
</file>

<file path="src/app/author/tools/page.jsx">
"use client";
import React, { useState, useEffect } from 'react';
import { motion } from 'framer-motion';
import { 
    Wrench, 
    Database, 
    Shield, 
    RefreshCcw, 
    Download, 
    Upload, 
    Trash2, 
    AlertTriangle,
    CheckCircle2,
    Activity
} from 'lucide-react';
import { getAllQuestions, updateQuestion } from '@/services/question.service';
import { getAllUsers } from '@/services/user.service';

export default function ToolsPage() {
    const [isLoading, setIsLoading] = useState(false);
    const [status, setStatus] = useState(null);
    const [stats, setStats] = useState({ questions: 0, drafts: 0, users: 0 });

    useEffect(() => {
        loadStats();
    }, []);

    const loadStats = async () => {
        try {
            const [qs, us] = await Promise.all([getAllQuestions(), getAllUsers()]);
            setStats({
                questions: qs.length,
                drafts: qs.filter(q => !q.published).length,
                users: us.length
            });
        } catch (err) {
            console.error(err);
        }
    };

    const handleAction = async (action, logic) => {
        if (!confirm(`Are you sure you want to perform: ${action}?`)) return;
        
        setIsLoading(true);
        setStatus({ type: 'info', message: `Executing ${action}...` });
        
        try {
            await logic();
            setStatus({ type: 'success', message: `${action} complete.` });
            loadStats();
        } catch (err) {
            setStatus({ type: 'error', message: `${action} failed: ${err.message}` });
        } finally {
            setIsLoading(false);
        }
    };

    const bulkPublishAll = async () => {
        const qs = await getAllQuestions();
        const drafts = qs.filter(q => !q.published);
        if (drafts.length === 0) throw new Error("No drafts to publish");
        await Promise.all(drafts.map(q => updateQuestion({ ...q, published: true })));
    };

    const bulkUnpublishAll = async () => {
        const qs = await getAllQuestions();
        const published = qs.filter(q => q.published);
        if (published.length === 0) throw new Error("No published questions to unpublish");
        await Promise.all(published.map(q => updateQuestion({ ...q, published: false })));
    };

    return (
        <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#4F46E5]/5 pointer-events-none" />
            <div className="p-8 max-w-6xl mx-auto space-y-8 relative z-10">
            <header className="flex justify-between items-end">
                <div>
                    <h1 className="text-3xl font-heading font-black tracking-tight text-[#1B263B] uppercase italic">
                        System <span className="text-[#0066CC]">Tools</span>
                    </h1>
                    <p className="text-slate-500 mt-2 font-medium">Advanced administrative utilities and maintenance protocols</p>
                </div>
                <div className="flex items-center gap-3 bg-white border border-slate-200 px-4 py-2 rounded-2xl shadow-sm">
                    <Activity size={16} className="text-[#0066CC] animate-pulse" />
                    <span className="text-[10px] font-black uppercase tracking-widest text-[#1B263B]">System Status: Optimal</span>
                </div>
            </header>

            {status && (
                <motion.div
                    initial={{ opacity: 0, y: -20 }}
                    animate={{ opacity: 1, y: 0 }}
                    className={`p-4 rounded-2xl border flex items-center gap-3 ${
                        status.type === 'success' ? 'bg-emerald-500/10 border-emerald-500/20 text-emerald-600' :
                        status.type === 'error' ? 'bg-red-500/10 border-red-500/20 text-red-600' :
                        'bg-blue-500/10 border-blue-500/20 text-blue-600'
                    }`}
                >
                    {status.type === 'success' ? <CheckCircle2 size={18} /> : 
                     status.type === 'error' ? <AlertTriangle size={18} /> : <RefreshCcw size={18} className="animate-spin" />}
                    <span className="text-sm font-bold">{status.message}</span>
                    <button onClick={() => setStatus(null)} className="ml-auto opacity-50 hover:opacity-100">√ó</button>
                </motion.div>
            )}

            <div className="grid grid-cols-1 md:grid-cols-2 gap-8">
                {/* MAINTENANCE */}
                <section className="space-y-4">
                    <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground ml-1">Database Maintenance</h3>
                    <div className="grid gap-4">
                        <ToolCard 
                            icon={Database}
                            title="Database Optimization"
                            description="Clean up orphaned records and optimize indexes. Recommended after bulk imports."
                            actionLabel="Run Optimizer"
                            onAction={() => handleAction("Database Optimization", async () => new Promise(r => setTimeout(r, 2000)))}
                            loading={isLoading}
                        />
                        <ToolCard 
                            icon={RefreshCcw}
                            title="Recalculate Stats"
                            description="Force rebuild user progress statistics and dashboard metrics cache."
                            actionLabel="Rebuild Cache"
                            onAction={() => handleAction("Stats Rebuild", async () => new Promise(r => setTimeout(r, 1500)))}
                            loading={isLoading}
                        />
                    </div>
                </section>

                {/* BULK ACTIONS */}
                <section className="space-y-4">
                    <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground ml-1">Critical Bulk Actions</h3>
                    <div className="grid gap-4">
                        <ToolCard 
                            icon={Shield}
                            title="Global Publish"
                            description={`Publish all current drafts (${stats.drafts} items). Warning: This action is immediate.`}
                            actionLabel="Publish All"
                            onAction={() => handleAction("Global Publish", bulkPublishAll)}
                            variant="primary"
                            loading={isLoading}
                        />
                        <ToolCard 
                            icon={Trash2}
                            title="Global Unpublish"
                            description="Retract all live questions to draft status. Useful for system-wide auditing."
                            actionLabel="Unpublish All"
                            onAction={() => handleAction("Global Unpublish", bulkUnpublishAll)}
                            variant="danger"
                            loading={isLoading}
                        />
                    </div>
                </section>
            </div>

            <section className="space-y-4">
                <h3 className="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground ml-1">Data Transfer Protocols</h3>
                <div className="bg-white border border-slate-200 p-8 rounded-[32px] shadow-[0_8px_30px_rgba(0,0,0,0.03)] flex flex-col md:flex-row gap-8 items-center justify-between">
                    <div className="space-y-2 text-center md:text-left">
                        <h4 className="font-heading font-black text-xl text-[#1B263B]">Master Question Registry</h4>
                        <p className="text-sm text-slate-500 max-w-md">Import or export the entire question database in high-fidelity JSON format for backup or migration purposes.</p>
                    </div>
                    <div className="flex gap-4">
                        <button className="flex items-center gap-2 px-6 py-3 bg-slate-50 border border-slate-200 rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-100 transition-all text-[#1B263B]">
                            <Download size={16} /> Export Registry
                        </button>
                        <button className="flex items-center gap-2 px-6 py-3 bg-[#0066CC] text-white rounded-2xl text-[10px] font-black uppercase tracking-widest hover:bg-[#004C99] shadow-lg shadow-[#0066CC]/20 transition-all">
                            <Upload size={16} /> Import Registry
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </div>
    );
}

function ToolCard({ icon: Icon, title, description, actionLabel, onAction, variant = "default", loading = false }) {
    return (
        <div className="bg-white border border-slate-200 p-6 rounded-[24px] shadow-[0_4px_15px_rgba(0,0,0,0.02)] hover:border-[#0066CC]/20 transition-all group">
            <div className="flex gap-4">
                <div className={`w-12 h-12 rounded-2xl flex items-center justify-center flex-shrink-0 transition-all ${
                    variant === 'primary' ? 'bg-[#0066CC]/10 text-[#0066CC] group-hover:bg-[#0066CC] group-hover:text-white' :
                    variant === 'danger' ? 'bg-red-500/10 text-red-600 group-hover:bg-red-500 group-hover:text-white' :
                    'bg-slate-50 text-slate-400 group-hover:text-[#1B263B]'
                }`}>
                    <Icon size={24} />
                </div>
                <div className="flex-1 space-y-4">
                    <div className="space-y-1">
                        <h4 className="font-bold text-[#1B263B] text-sm">{title}</h4>
                        <p className="text-xs text-slate-500 leading-relaxed">{description}</p>
                    </div>
                    <button 
                        onClick={onAction}
                        disabled={loading}
                        className={`w-full py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all ${
                            variant === 'primary' ? 'bg-[#0066CC]/10 text-[#0066CC] hover:bg-[#0066CC] hover:text-white' :
                            variant === 'danger' ? 'bg-red-500/10 text-red-600 hover:bg-red-500 hover:text-white' :
                            'bg-slate-50 text-[#1B263B] hover:bg-slate-100'
                        } disabled:opacity-50`}
                    >
                        {loading ? 'Processing...' : actionLabel}
                    </button>
                </div>
            </div>
        </div>
    );
}
</file>

<file path="src/app/checkout/page.jsx">
"use client";

import { useState, useEffect, useContext } from "react";
import { useRouter } from "next/navigation";
import { AppContext } from "@/context/AppContext";
import { 
  CreditCard, 
  ShieldCheck, 
  ChevronRight, 
  Activity,
  ArrowRight,
  Lock,
  RefreshCw,
  CheckCircle2
} from "lucide-react";
import { getUserById, updateUser, renewUserSubscription } from "@/services/user.service";

export default function CheckoutPage() {
  const router = useRouter();
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [isProcessing, setIsProcessing] = useState(false);
  const [isSuccess, setIsSuccess] = useState(false);
  const [error, setError] = useState(null);
  const { cart, setCart } = useContext(AppContext);

  useEffect(() => {
    const userId = localStorage.getItem("medbank_user");
    if (!userId) {
      router.push("/auth?redirect=/checkout");
      return;
    }

    getUserById(userId).then(userData => {
      if (userData) {
        setUser(userData);
      }
      setLoading(false);
    });
  }, [router]);

  const handlePurchase = async () => {
    if (!user) return;
    setIsProcessing(true);
    // Simulate payment gateway delay
    await new Promise(resolve => setTimeout(resolve, 2000));

    try {
      // Simulate payment gateway response
      const paymentResponse = { token: 'tok_' + Math.random().toString(36).substr(2, 9) };

      // Loop through cart items and create subscriptions for each
      for (const item of cart) {
        // 1. Before calling /api/users/subscriptions, check if item.id exists and user.id exists.
        if (!item.id || !user.id) {
          throw new Error("Product ID or User ID is missing");
        }

        const res = await fetch('/api/users/subscriptions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userId: user.id,
            productId: item.id,
            // 2. Ensure durationDays is a number
            durationDays: Number(item.duration || 90),
            // 3. Include paymentToken from payment processor
            paymentToken: paymentResponse.token,
            amount: item.price || 0,
            startDate: new Date().toISOString()
          })
        });

        const data = await res.json();
        // 4. Wrap POST request in try/catch and log full response
        if (!res.ok) {
          throw new Error(data.message || data.error || "Unknown API error");
        }
      }

      // 5. Only after successful API response, clear cart and show success message.
      setCart([]);
      localStorage.removeItem("medbank_cart");

      // Update local user state from server
      const freshUser = await getUserById(user.id);
      setUser(freshUser);
      setIsSuccess(true);
      
      setTimeout(() => {
        router.push("/student/portal");
      }, 2000);
    } catch (err) {
      console.error("Subscription creation failed:", err);
      setError("Subscription creation failed. Please contact support.");
      setIsProcessing(false);
    }
  };

  if (loading) {
    return (
      <div className="h-screen w-full flex items-center justify-center bg-[#f8fafc]">
        <RefreshCw size={24} className="animate-spin text-[#1d46af]" />
      </div>
    );
  }

  const subtotal = cart.reduce((acc, item) => acc + ((item.price || 0) * (item.quantity || 1)), 0);

  return (
    <div className="min-h-screen bg-[#fcfdfe] flex flex-col">
      <nav className="fixed top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div className="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => router.push('/')}>
            <div className="flex items-center">
              <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
              <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
              </div>
            </div>
          </div>
          <div className="text-sm font-bold text-slate-400">Secure Checkout</div>
        </div>
      </nav>

      <main className="flex-1 pt-32 pb-24 px-6">
        <div className="mx-auto max-w-4xl grid grid-cols-1 lg:grid-cols-2 gap-12">
          
          {/* Left Side: Product Info */}
          <div>
            <h1 className="text-4xl font-black text-slate-900 tracking-tight mb-8">Review Order</h1>
            
            <div className="bg-white rounded-[2.5rem] border border-slate-100 p-8 shadow-xl shadow-blue-500/5 mb-8">
              <div className="space-y-6 mb-6 max-h-[400px] overflow-y-auto">
                {cart.map((item, index) => (
                  <div key={index} className="flex items-center gap-4">
                    <div className="w-14 h-14 rounded-2xl bg-rose-500 flex items-center justify-center text-white shadow-lg shadow-rose-500/20 shrink-0">
                      <Activity size={28} />
                    </div>
                    <div className="flex-1 min-w-0">
                      <h3 className="text-xl font-black text-slate-900 leading-tight truncate">{item.title}</h3>
                      <p className="text-sm font-bold text-slate-400">
                        {item.duration || 90}-Day Access {(item.quantity || 1) > 1 && `(x${item.quantity})`}
                      </p>
                    </div>
                    <div className="text-xl font-black text-slate-900 absolute right-8 sm:static">
                      ${((item.price || 0) * (item.quantity || 1)).toFixed(0)}
                    </div>
                  </div>
                ))}
              </div>

              <div className="space-y-4 border-t border-slate-50 pt-6">
                <div className="flex justify-between text-sm font-bold">
                  <span className="text-slate-400">Subtotal</span>
                  <span className="text-slate-900">${subtotal.toFixed(2)}</span>
                </div>
                <div className="flex justify-between text-sm font-bold">
                  <span className="text-slate-400">Tax</span>
                  <span className="text-slate-900">$0.00</span>
                </div>
                <div className="flex justify-between text-2xl font-black pt-4 border-t border-slate-50">
                  <span className="text-slate-900">Total</span>
                  <span className="text-[#1d46af]">${subtotal.toFixed(2)}</span>
                </div>
              </div>
            </div>

            <div className="flex items-center gap-3 text-slate-400">
              <ShieldCheck size={18} className="text-emerald-500" />
              <p className="text-xs font-bold uppercase tracking-widest">Bank-Level Security Guaranteed</p>
            </div>
          </div>

          {/* Right Side: Payment Form (Placeholder) */}
          <div className="relative">
            {isSuccess ? (
              <div className="h-full bg-white rounded-[3rem] p-12 border-2 border-emerald-100 shadow-2xl flex flex-col items-center justify-center text-center animate-in zoom-in-95 duration-500">
                <div className="w-24 h-24 rounded-full bg-emerald-50 text-emerald-500 flex items-center justify-center mb-6 shadow-inner">
                  <CheckCircle2 size={48} />
                </div>
                 <h2 className="text-3xl font-[1000] text-slate-900 mb-2">
                  {user.purchased && user.activatedByPurchase ? "Subscription Renewed" : "Payment Confirmed"}
                </h2>
                <p className="text-slate-500 font-medium mb-8">
                  {user.purchased && user.activatedByPurchase 
                    ? "Your access has been extended. Redirecting you now..."
                    : "Your medical training assets have been added to your portal. Redirecting you now..."}
                </p>
                <div className="w-full h-1 bg-slate-100 rounded-full overflow-hidden">
                  <div className="h-full bg-emerald-500 animate-progress origin-left"></div>
                </div>
              </div>
            ) : (
              <div className="bg-white rounded-[3rem] p-10 border border-slate-100 shadow-2xl">
                <div className="flex items-center gap-2 mb-8">
                  <Lock size={16} className="text-slate-300" />
                  <h2 className="text-lg font-black text-slate-800 uppercase tracking-tight">Payment Detail</h2>
                </div>

                <div className="space-y-6">
                  {/* Mock Credit Card Form */}
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Card Number</label>
                    <div className="relative">
                      <CreditCard className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                      <input 
                        disabled 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚Ä¢‚Ä¢‚Ä¢‚Ä¢ 4242" 
                        className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 pl-11 pr-4 text-sm font-bold text-slate-400"
                      />
                    </div>
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Expiry</label>
                      <input 
                        disabled 
                        placeholder="MM/YY" 
                        className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 px-4 text-sm font-bold text-slate-400"
                      />
                    </div>
                    <div className="space-y-2">
                      <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">CVC</label>
                      <input 
                        disabled 
                        placeholder="‚Ä¢‚Ä¢‚Ä¢" 
                        className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 px-4 text-sm font-bold text-slate-400"
                      />
                    </div>
                  </div>

                  {error && (
                    <div className="p-4 bg-red-50 border border-red-100 rounded-2xl">
                      <p className="text-xs font-bold text-red-600 leading-relaxed text-center">
                        {error}
                      </p>
                    </div>
                  )}

                  <div className="p-5 bg-amber-50 rounded-2xl border border-amber-100">
                    <p className="text-xs font-bold text-amber-700 leading-relaxed">
                      Payment integration is currently in Sandbox Mode. Clicking the button below will simulate a successful transaction.
                    </p>
                  </div>

                  <button 
                    onClick={handlePurchase}
                    disabled={isProcessing}
                    className="w-full py-5 bg-blue-50 text-[#1d46af] border-2 border-[#1d46af]/30 text-lg font-black rounded-2xl hover:bg-blue-100 transition-all active:scale-95 flex items-center justify-center gap-3 disabled:opacity-70"
                  >
                    {isProcessing ? (
                      <>
                        <RefreshCw size={20} className="animate-spin" />
                        PROCESSING...
                      </>
                    ) : (
                      <>
                        COMPLETE PURCHASE
                        <ArrowRight size={20} />
                      </>
                    )}
                  </button>
                </div>
              </div>
            )}
          </div>
        </div>
      </main>
      
      <style jsx>{`
        @keyframes progress {
          0% { transform: scaleX(0); }
          100% { transform: scaleX(1); }
        }
        .animate-progress {
          animation: progress 2s linear forwards;
        }
      `}</style>
    </div>
  );
}
</file>

<file path="src/app/layout.jsx">
import { Outfit, Inter, JetBrains_Mono } from "next/font/google";
import "./globals.css";
import AppProvider from "@/context/AppContext";
import ThemeWrapper from "@/components/ThemeWrapper";

const outfit = Outfit({
  variable: "--font-outfit",
  subsets: ["latin"],
});

const inter = Inter({
  variable: "--font-inter",
  subsets: ["latin"],
});

const jetbrains = JetBrains_Mono({
  variable: "--font-jetbrains",
  subsets: ["latin"],
});

export const metadata = {
  title: "IskyMD | The Precision Standard in Medical Education",
  description: "The clinical mastery suite engineered for excellence.",
};

export default function RootLayout({ children }) {
  return (
    <html lang="en" className="dark" style={{ colorScheme: 'dark' }} suppressHydrationWarning>
      <body
        className={`${outfit.variable} ${inter.variable} ${jetbrains.variable} antialiased`}
        suppressHydrationWarning
      >
        <AppProvider>
          <ThemeWrapper>
            {children}
          </ThemeWrapper>
        </AppProvider>
      </body>
    </html>
  );
}
</file>

<file path="src/app/page.jsx">
"use client";

import { useContext } from "react";
import Link from "next/link";
import { AppContext } from "@/context/AppContext";
import CartDropdown from "@/components/student/layout/CartDropdown";
import {
  ArrowRight,
  ShoppingCart,
  User
} from "lucide-react";

export default function Home() {
  const { cart, isCartOpen, setIsCartOpen } = useContext(AppContext);

  return (
    <div className="flex min-h-screen flex-col bg-[#fcfdfe]">
      {/* Navigation */}
      <nav className="fixed top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div className="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.location.href = '/'}>
            <div className="flex items-center">
              <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
              <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
              </div>
            </div>
          </div>
          
          <div className="hidden items-center gap-10 md:flex">
            <Link href="/products" className="text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors">Products</Link>
            <a href="#solutions" className="text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors">Solutions</a>
            <div className="relative">
              <button 
                onClick={() => setIsCartOpen(!isCartOpen)} 
                className="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors relative"
              >
                <div className="relative">
                  <ShoppingCart size={18} />
                  {cart.length > 0 && (
                    <span className="absolute -top-2 -right-2 w-5 h-5 bg-[#1d46af] text-white text-[10px] font-black rounded-full flex items-center justify-center border-2 border-white">
                      {cart.length}
                    </span>
                  )}
                </div>
                Cart
              </button>
              <CartDropdown />
            </div>
            <div className="flex items-center">
              <Link href="/auth" className="group flex items-center justify-center rounded-full bg-blue-50 w-11 h-11 text-[#1d46af] shadow-lg shadow-blue-500/5 hover:bg-blue-100 transition-all active:scale-95 border-2 border-[#1d46af]/30 hover:border-[#1d46af]/50">
                <User size={18} className="transition-transform group-hover:scale-110" />
              </Link>
            </div>
          </div>
        </div>
      </nav>

      <main className="flex-1">
        {/* Hero Section */}
        <section className="relative pt-48 pb-24 px-6 overflow-hidden">
          <div className="absolute top-0 left-1/2 -z-10 h-[800px] w-[1000px] -translate-x-1/2 rounded-full bg-blue-50/50 blur-3xl opacity-60" />
          
          <div className="mx-auto max-w-6xl text-center">
            <div className="mb-8 inline-flex items-center gap-3 rounded-full bg-white border border-slate-100 px-5 py-2 text-xs font-black uppercase tracking-widest text-[#1d46af] shadow-sm animate-in fade-in slide-in-from-top-4 duration-1000">
              <span className="flex h-2 w-2 rounded-full bg-[#1d46af]" />
              Leading Medical Education Platform
            </div>

            <h1 className="mb-8 text-6xl font-[1000] text-slate-900 tracking-tighter leading-[1.05] sm:text-8xl animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-100">
              Transform Your <br />
              <span className="text-transparent bg-clip-text bg-gradient-to-r from-[#1d46af] to-[#3b82f6]">Clinical Journey.</span>
            </h1>

            <p className="mx-auto mb-12 max-w-2xl text-lg text-slate-500 font-medium leading-relaxed sm:text-xl animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-200">
              The professional-grade suite for medical clinical mastery. High-yield content, rigorous accuracy, and elite performance.
            </p>

            <div className="flex flex-col items-center justify-center gap-5 sm:flex-row animate-in fade-in slide-in-from-bottom-8 duration-1000 delay-300">
              <Link href="/products" className="w-full sm:w-auto h-16 flex items-center justify-center gap-3 rounded-2xl bg-[#1d46af] px-10 text-lg font-black text-white shadow-2xl shadow-blue-500/30 hover:bg-[#16368a] transition-all hover:-translate-y-1 active:scale-95 group">
                Explore Products
                <ArrowRight size={20} className="group-hover:translate-x-1 transition-transform" />
              </Link>
            </div>
          </div>
        </section>
      </main>

      {/* Footer */}
      <footer className="bg-white border-t border-slate-100 py-20 px-6">
        <div className="mx-auto max-w-7xl">
          <div className="flex flex-col md:flex-row justify-between items-start gap-12 border-b border-slate-100 pb-16 mb-10">
             <div>
                <div className="flex items-center cursor-pointer" onClick={() => window.location.href = '/'}>
                  <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
                  <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                    <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                    <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                    <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                    <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                    <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
                  </div>
                </div>
                <p className="mt-4 text-slate-500 text-sm max-w-xs font-medium leading-relaxed">
                   The precision standard in clinical question systems. Engineered for students who demand excellence.
                </p>
             </div>
             <div className="grid grid-cols-2 sm:grid-cols-3 gap-12">
                <div className="flex flex-col gap-4">
                   <span className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Product</span>
                   <a href="#" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Clinical QBank</a>
                   <a href="#" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Pricing</a>
                   <Link href="/products" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Features</Link>
                </div>
                <div className="flex flex-col gap-4">
                   <span className="text-[10px] font-black uppercase tracking-[0.2em] text-slate-400">Support</span>
                   <a href="#" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Contact</a>
                   <a href="#" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Knowledge Base</a>
                   <a href="#" className="text-sm font-bold text-slate-700 hover:text-[#1d46af] transition-colors">Offline Guide</a>
                </div>
             </div>
          </div>
          <div className="flex flex-col sm:flex-row justify-between items-center gap-6">
             <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest leading-loose">
               ¬© 2026 IskyMD Universal Systems. All rights reserved.
             </span>
             <div className="flex gap-8">
                <a href="#" className="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors">Privacy</a>
                <a href="#" className="text-[10px] font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors">Terms</a>
             </div>
          </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="src/app/products/[id]/page.js">
"use client";

import { useState, useEffect, useContext, use } from "react";
import { useRouter } from "next/navigation";
import { AppContext } from "@/context/AppContext";
import { getProductById } from "@/services/product.service";
import CartDropdown from "@/components/student/layout/CartDropdown";
import { 
    ChevronLeft, 
    ShieldCheck, 
    Zap, 
    Activity, 
    Clock, 
    CreditCard, 
    ShoppingCart, 
    User,
    CheckCircle2,
    Lock
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

export default function ProductDetailPage({ params }) {
    const { id } = use(params);
    const router = useRouter();
    const { addToCart, cart, isCartOpen, setIsCartOpen } = useContext(AppContext);
    
    const [product, setProduct] = useState(null);
    const [loading, setLoading] = useState(true);
    const [isLoggedIn, setIsLoggedIn] = useState(false);
    const [error, setError] = useState(null);
    const [showToast, setShowToast] = useState(false);
    const [toastMessage, setToastMessage] = useState('');

    useEffect(() => {
        const userId = localStorage.getItem("medbank_user");
        setIsLoggedIn(!!userId);
        loadProduct();
    }, [id]);

    const loadProduct = async () => {
        setLoading(true);
        try {
            const data = await getProductById(id);
            if (!data) throw new Error("Product focus lost.");
            setProduct(data);
        } catch (err) {
            console.error(err);
            setError("Could not retrieve product sequence.");
        } finally {
            setLoading(false);
        }
    };

    const handleAddToCart = (name, price, days, isBase = false) => {
        addToCart({
            id: isBase ? product.id : `${product.id}-${days}`,
            title: `${product.name} (${days} Days)`,
            price: price,
            duration: days,
            color: "bg-rose-500"
        });
        setToastMessage(`Added to Cart: ${days} Days Access`);
        setShowToast(true);
        setTimeout(() => setShowToast(false), 3000);
        setTimeout(() => setIsCartOpen(true), 300);
    };

    if (loading) {
        return (
            <div className="min-h-screen bg-[#fcfdfe] flex flex-col items-center justify-center">
                <div className="w-12 h-12 border-4 border-blue-100 border-t-[#1d46af] rounded-full animate-spin mb-4" />
                <p className="text-slate-400 font-mono text-[10px] uppercase tracking-[0.3em]">Synching_Product_Stream...</p>
            </div>
        );
    }

    if (error || !product) {
        return (
            <div className="min-h-screen bg-[#fcfdfe] flex flex-col items-center justify-center p-10 text-center">
                <Lock size={64} className="text-slate-200 mb-6" />
                <h2 className="text-2xl font-black text-slate-900 uppercase italic">Access Error</h2>
                <p className="text-slate-500 mt-2 font-medium">{error || "Product not found."}</p>
                <button 
                    onClick={() => router.push('/products')}
                    className="mt-8 px-8 py-3 bg-[#1d46af] text-white rounded-2xl font-black text-xs tracking-widest active:scale-95 transition-all"
                >
                    RETURN TO CATALOG
                </button>
            </div>
        );
    }

    // Combine primary tier with additional plans
    const allPlans = [
        { days: product.duration_days, price: product.price, isBase: true },
        ...(product.plans || [])
    ].sort((a, b) => a.days - b.days);

    return (
        <div className="min-h-screen bg-[#fcfdfe] flex flex-col">
            {/* Navigation (Simplified) */}
            <nav className="fixed top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-100">
                <div className="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
                    <button 
                        onClick={() => router.push('/products')}
                        className="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors"
                    >
                        <ChevronLeft size={20} />
                        Catalog
                    </button>
                    
                    <div className="flex items-center gap-6">
                        <div className="relative">
                            <button 
                                onClick={() => setIsCartOpen(!isCartOpen)} 
                                className="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors relative"
                            >
                                <ShoppingCart size={20} />
                                {cart.length > 0 && (
                                    <span className="absolute -top-2 -right-2 w-5 h-5 bg-[#1d46af] text-white text-[10px] font-black rounded-full flex items-center justify-center border-2 border-white">
                                        {cart.length}
                                    </span>
                                )}
                            </button>
                            <CartDropdown />
                        </div>
                        {isLoggedIn ? (
                             <button onClick={() => router.push('/student/portal')} className="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center text-[#1d46af] border border-blue-100">
                                <User size={20} />
                             </button>
                        ) : (
                            <button onClick={() => router.push('/auth')} className="px-5 py-2 bg-[#1d46af] text-white rounded-xl text-xs font-black tracking-widest hover:bg-[#16368a] transition-all">
                                LOG IN
                            </button>
                        )}
                    </div>
                </div>
            </nav>

            {/* Toast */}
            <AnimatePresence>
                {showToast && (
                    <motion.div 
                        initial={{ y: 50, opacity: 0 }}
                        animate={{ y: 0, opacity: 1 }}
                        exit={{ y: 50, opacity: 0 }}
                        className="fixed bottom-8 right-8 z-[100] bg-emerald-500 text-white px-6 py-4 rounded-2xl shadow-2xl font-bold flex items-center gap-3"
                    >
                        <CheckCircle2 size={20} />
                        {toastMessage}
                    </motion.div>
                )}
            </AnimatePresence>

            <main className="flex-1 pt-32 pb-24 px-6">
                <div className="mx-auto max-w-5xl">
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-16 items-start">
                        
                        {/* Branding & Info */}
                        <div className="lg:col-span-7 space-y-8">
                            <div className="inline-flex h-16 w-16 items-center justify-center rounded-[2rem] bg-rose-500 shadow-xl shadow-rose-500/20 text-white">
                                <Activity size={32} />
                            </div>

                            <div className="space-y-4">
                                <h1 className="text-6xl font-[1000] text-slate-900 tracking-tighter leading-none">
                                    {product.name}
                                </h1>
                                <p className="text-xl text-slate-500 font-medium leading-relaxed">
                                    {product.description || "The definitive medical training sequence. Synchronized with actual board requirements and residency benchmarks."}
                                </p>
                            </div>

                            <div className="grid grid-cols-2 gap-6 pt-4">
                                <div className="p-6 bg-white border border-slate-100 rounded-[2rem] shadow-sm">
                                    <div className="w-10 h-10 rounded-xl bg-blue-50 text-[#1d46af] flex items-center justify-center mb-4">
                                        <Zap size={20} />
                                    </div>
                                    <h4 className="font-black text-slate-900 uppercase text-xs tracking-widest mb-1">Instant Activation</h4>
                                    <p className="text-xs text-slate-400 font-bold uppercase">Uplink starts immediately</p>
                                </div>
                                <div className="p-6 bg-white border border-slate-100 rounded-[2rem] shadow-sm">
                                    <div className="w-10 h-10 rounded-xl bg-emerald-50 text-emerald-500 flex items-center justify-center mb-4">
                                        <ShieldCheck size={20} />
                                    </div>
                                    <h4 className="font-black text-slate-900 uppercase text-xs tracking-widest mb-1">Data Integrity</h4>
                                    <p className="text-xs text-slate-400 font-bold uppercase">Verified Clinical Source</p>
                                </div>
                            </div>

                            <div className="pt-8 border-t border-slate-100/50">
                                <h3 className="text-[10px] font-[1000] text-slate-400 uppercase tracking-[0.4em] mb-6">Course Syllabus Coverate</h3>
                                <div className="flex flex-wrap gap-2">
                                    {product.systems?.map(s => (
                                        <span key={s} className="px-4 py-2 bg-slate-50 border border-slate-100 rounded-full text-[10px] font-black text-slate-600 uppercase tracking-tight">{s}</span>
                                    ))}
                                    {(!product.systems || product.systems.length === 0) && (
                                        <span className="text-xs font-bold text-slate-300 italic uppercase">Universal Access Sequence Active</span>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Pricing Selection */}
                        <div className="lg:col-span-5">
                            <div className="bg-white border border-slate-100 rounded-[3rem] p-10 shadow-2xl shadow-blue-500/5 sticky top-32">
                                <div className="mb-10 text-center">
                                    <h2 className="text-xl font-[1000] text-slate-900 uppercase tracking-tighter italic">Select Access <span className="text-[#1d46af]">Variant</span></h2>
                                    <div className="h-1 w-12 bg-blue-100 mx-auto mt-4 rounded-full" />
                                </div>

                                <div className="space-y-4">
                                    {allPlans.map((plan, idx) => (
                                        <div 
                                            key={idx}
                                            className={`p-6 rounded-[2.5rem] border-2 transition-all group flex flex-col gap-4 ${
                                                plan.isBase 
                                                ? 'bg-blue-50/30 border-[#1d46af]/20 hover:border-[#1d46af]/50' 
                                                : 'bg-white border-slate-100 hover:border-blue-100'
                                            }`}
                                        >
                                            <div className="flex items-center justify-between w-full">
                                                <div className="flex items-center gap-4">
                                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center transition-colors ${
                                                        plan.isBase ? 'bg-[#1d46af] text-white shadow-lg shadow-blue-500/20' : 'bg-slate-50 text-slate-400 group-hover:bg-blue-50 group-hover:text-[#1d46af]'
                                                    }`}>
                                                        <Clock size={20} />
                                                    </div>
                                                    <div>
                                                        <div className="text-lg font-black text-slate-900 tracking-tight">{plan.days} Days</div>
                                                        <div className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Access Protocol</div>
                                                    </div>
                                                </div>
                                                <div className="text-2xl font-black text-slate-900">${plan.price}</div>
                                            </div>

                                            <div className="grid grid-cols-2 gap-3">
                                                <button 
                                                    onClick={() => handleAddToCart(product.name, plan.price, plan.days, plan.isBase)}
                                                    className="py-3.5 px-4 bg-white border-2 border-slate-100 text-slate-500 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-slate-50 transition-all flex items-center justify-center gap-2"
                                                >
                                                    Add <ShoppingCart size={14} />
                                                </button>
                                                <button 
                                                    onClick={() => {
                                                        handleAddToCart(product.name, plan.price, plan.days, plan.isBase);
                                                        router.push('/checkout');
                                                    }}
                                                    className="py-3.5 px-4 bg-[#1d46af] text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-[#16368a] transition-all flex items-center justify-center gap-2 shadow-lg shadow-blue-500/20"
                                                >
                                                    Checkout <CreditCard size={14} />
                                                </button>
                                            </div>
                                        </div>
                                    ))}
                                </div>

                                <div className="mt-10 pt-8 border-t border-slate-50 space-y-4">
                                    <div className="flex items-center justify-center gap-3 text-xs font-bold text-slate-400">
                                        <div className="w-2 h-2 rounded-full bg-emerald-500 animate-pulse" />
                                        Secure clinical payment processing active
                                    </div>
                                    <p className="text-[9px] text-slate-300 font-medium uppercase tracking-[0.1em] text-center italic">
                                        By confirming purchase you agree to the medical data sync protocol and institutional terms of service.
                                    </p>
                                </div>
                            </div>
                        </div>

                    </div>
                </div>
            </main>

            {/* Footer */}
            <footer className="bg-white border-t border-slate-100 py-20 px-6">
                <div className="mx-auto max-w-7xl text-center">
                    <p className="text-slate-400 text-xs font-bold uppercase tracking-[0.2em] mb-4">Institutional Protocol Active</p>
                    <p className="text-slate-400 text-sm font-medium">¬© 2026 IskyMD Universal Systems. Clinical Precision Guaranteed.</p>
                </div>
            </footer>
        </div>
    );
}
</file>

<file path="src/app/products/page.jsx">
"use client";
export const dynamic = 'force-dynamic';

import { useState, useEffect, useContext } from "react";
import { useRouter } from "next/navigation";
import Link from "next/link";
import { AppContext } from "@/context/AppContext";
import CartDropdown from "@/components/student/layout/CartDropdown";
import { 
  ChevronRight, 
  Zap, 
  ShieldCheck, 
  Activity,
  CreditCard,
  UserPlus,
  ShoppingCart,
  User
} from "lucide-react";
import { getPublishedProducts } from "@/services/product.service";

export default function ProductsPage() {
  const router = useRouter();
  const { addToCart, cart, isCartOpen, setIsCartOpen, clearCart } = useContext(AppContext);
  const [showAuthModal, setShowAuthModal] = useState(false);
  const [isLoggedIn, setIsLoggedIn] = useState(false);
  const [products, setProducts] = useState([]);
  const [loading, setLoading] = useState(true);
  const [showToast, setShowToast] = useState(false);
  const [toastMessage, setToastMessage] = useState('');

  useEffect(() => {
    const userId = localStorage.getItem("medbank_user");
    setIsLoggedIn(!!userId);
    loadProducts();
  }, []);

  // Helper function to generate dynamic description based on duration
  const generateDynamicDescription = (product) => {
    // If product has a custom description, use it
    if (product.description && product.description.trim()) {
      return product.description;
    }

    // Otherwise, generate dynamic description based on duration_days
    const days = product.duration_days;
    if (days <= 90) {
      return `Master the art of ECG interpretation with ${days}-day access to 2,000+ high-fidelity rhythm strips and real-time wave analysis.`;
    } else if (days <= 180) {
      return `Extended ${days}-day access for deep clinical mastery. Includes all premium modules, case studies, and advanced metrics.`;
    } else {
      return `Full ${days}-day access to precision medical training. The ultimate choice for residents and specialists seeking excellence.`;
    }
  };

  const loadProducts = async () => {
    try {
      const data = await getPublishedProducts();
      if (Array.isArray(data) && data.length > 0) {
        setProducts(data);
      } else {
        // No products in DB ‚Äì show empty state
        setProducts([]);
      }
    } catch (error) {
      console.error('Failed to load products:', error);
      setProducts([]);
    } finally {
      setLoading(false);
    }
  };

  const handleBuyNow = (p) => {
    // For now, Buy Now works via adding to cart and redirecting
    addToCart({
      id: p.id,
      title: p.name,
      price: p.price,
      duration: p.duration_days,
      color: "bg-rose-500"
    });

    if (!isLoggedIn) {
      setShowAuthModal(true);
    } else {
      router.push("/checkout");
    }
  };

  return (
    <div className="flex min-h-screen flex-col bg-[#fcfdfe]">
      {/* Navigation */}
      <nav className="fixed top-0 z-50 w-full bg-white/80 backdrop-blur-md border-b border-slate-100">
        <div className="mx-auto flex max-w-7xl items-center justify-between px-6 py-4">
          <div className="flex items-center gap-3 cursor-pointer" onClick={() => router.push('/')}>
            <div className="flex items-center">
              <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
              <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
                <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
              </div>
            </div>
          </div>
          
          <div className="hidden items-center gap-10 md:flex">
             <Link href="/" className="text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors">Home</Link>
             <div className="relative">
               <button 
                 onClick={() => setIsCartOpen(!isCartOpen)} 
                 className="flex items-center gap-2 text-sm font-bold text-slate-500 hover:text-[#1d46af] transition-colors relative"
               >
                 <div className="relative">
                   <ShoppingCart size={18} />
                   {cart.length > 0 && (
                     <span className="absolute -top-2 -right-2 w-5 h-5 bg-[#1d46af] text-white text-[10px] font-black rounded-full flex items-center justify-center border-2 border-white">
                       {cart.length}
                     </span>
                   )}
                 </div>
                 Cart
               </button>
               <CartDropdown />
             </div>
             <div className="flex items-center">
              {isLoggedIn ? (
                <button 
                  onClick={() => router.push('/student/portal')}
                  className="rounded-full bg-[#1d46af] px-6 py-2.5 text-sm font-bold text-white shadow-lg shadow-blue-500/20 hover:bg-[#16368a] transition-all active:scale-95"
                >
                  My Portal
                </button>
              ) : (
                  <Link href="/auth" className="group flex items-center justify-center rounded-full bg-blue-50 w-11 h-11 text-[#1d46af] shadow-lg shadow-blue-500/5 hover:bg-blue-100 transition-all active:scale-95 border-2 border-[#1d46af]/30 hover:border-[#1d46af]/50">
                    <User size={18} className="transition-transform group-hover:scale-110" />
                </Link>
              )}
            </div>
          </div>
        </div>
      </nav>

      {/* Toast Notification */}
      {showToast && (
        <div className="fixed bottom-8 right-8 z-50 bg-emerald-500 text-white px-6 py-4 rounded-2xl shadow-2xl animate-in slide-in-from-bottom-5 duration-300 font-bold">
          ‚úì {toastMessage}
        </div>
      )}

      <main className="flex-1 pt-32 pb-24 px-6">
        <div className="mx-auto max-w-6xl">
          <div className="mb-20 text-center">
            <h1 className="text-5xl font-[1000] text-slate-900 tracking-tighter mb-4">Precision Mastery.</h1>
            <p className="text-xl text-slate-500 font-medium max-w-2xl mx-auto">
              Unlock the next generation of medical training. Our ECG Qbank is engineered for clinical excellence.
            </p>
          </div>

          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {loading ? (
              Array(3).fill(0).map((_, i) => (
                <div key={i} className="bg-white border border-slate-100 p-8 rounded-[2.5rem] shadow-xl animate-pulse">
                  <div className="w-12 h-12 bg-slate-100 rounded-xl mb-6" />
                  <div className="h-6 bg-slate-100 rounded w-3/4 mb-4" />
                  <div className="h-4 bg-slate-100 rounded w-full mb-8" />
                  <div className="h-10 bg-slate-100 rounded-xl w-full" />
                </div>
              ))
            ) : products.map((p) => (
              <div
                key={p.id}
                onClick={() => router.push(`/products/${p.id}`)}
                className="group bg-white border border-slate-100 p-8 rounded-[2.5rem] shadow-xl hover:shadow-2xl transition-all duration-500 flex flex-col cursor-pointer relative overflow-hidden active:scale-[0.98]"
              >
                <div className="absolute top-0 right-0 p-6 opacity-0 group-hover:opacity-100 transition-opacity">
                  <ChevronRight className="text-[#1d46af]" size={24} />
                </div>

                <div className="mb-6 flex h-14 w-14 items-center justify-center rounded-2xl bg-rose-500 shadow-lg shadow-rose-500/20 text-white transition-transform group-hover:scale-110 duration-500">
                  <Activity size={24} />
                </div>

                <h3 className="mb-2 text-2xl font-black text-slate-900 tracking-tight group-hover:text-[#1d46af] transition-colors">{p.name}</h3>
                <p className="mb-6 text-slate-500 font-medium text-sm leading-relaxed flex-grow">
                  {generateDynamicDescription(p)}
                </p>

                <div className="space-y-4 mb-8">
                  <div className="flex items-center gap-3 text-xs font-bold text-slate-700">
                    <div className="flex h-5 w-5 items-center justify-center rounded-full bg-emerald-50 text-emerald-500">
                      <ShieldCheck size={12} strokeWidth={3} />
                    </div>
                    {p.plans?.length > 0 ? `${p.plans.length + 1} Subscription Options` : `Full access for ${p.duration_days} days`}
                  </div>
                  <div className="flex items-center gap-3 text-xs font-bold text-slate-700">
                    <div className="flex h-5 w-5 items-center justify-center rounded-full bg-rose-50 text-rose-500">
                      <Zap size={12} strokeWidth={3} />
                    </div>
                    2,000+ High-Fidelity Questions
                  </div>
                </div>

                <div className="mt-auto">
                  <div className="mb-6">
                    <div className="flex items-baseline gap-1">
                      <span className="text-3xl font-black text-slate-900">From ${p.price}</span>
                      <span className="text-xs font-bold text-slate-400">/ one-time</span>
                    </div>
                  </div>

                  <button 
                    onClick={(e) => {
                      e.stopPropagation();
                      router.push(`/products/${p.id}`);
                    }}
                    className="w-full py-4 bg-[#1d46af] text-white text-sm font-black rounded-2xl hover:bg-[#16368a] transition-all active:scale-95 flex items-center justify-center gap-3 mb-3 shadow-lg shadow-blue-500/20"
                  >
                    <CreditCard size={18} />
                    VIEW OPTIONS
                  </button>

                  <button 
                    onClick={(e) => {
                      e.stopPropagation();
                      addToCart({
                        id: p.id,
                        title: p.name,
                        price: p.price,
                        duration: p.duration_days,
                        color: "bg-rose-500"
                      });
                      setToastMessage(`Added Base Plan: ${p.name}`);
                      setShowToast(true);
                      setTimeout(() => setShowToast(false), 3000);
                    }}
                    className="w-full py-3 bg-white text-slate-400 border-2 border-slate-100 text-[10px] font-black uppercase tracking-widest rounded-xl hover:bg-slate-50 transition-all active:scale-95 flex items-center justify-center gap-2"
                  >
                    <ShoppingCart size={14} />
                    Quick Add Base
                  </button>
                </div>
              </div>
            ))}
          </div>
        </div>
      </main>

      {/* Auth Modal */}
      {showAuthModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm p-6 animate-in fade-in duration-300">
          <div className="bg-white rounded-[3rem] w-full max-w-md p-10 shadow-2xl border border-slate-100 animate-in zoom-in-95 duration-300 text-center">
            <div className="w-16 h-16 rounded-2xl bg-blue-50 flex items-center justify-center mb-6 mx-auto border border-blue-100 text-[#1d46af]">
              <UserPlus size={32} />
            </div>
            <h3 className="text-2xl font-[1000] text-slate-900 mb-2 tracking-tight">Create an Account</h3>
            <p className="text-slate-500 font-medium mb-8">
              To purchase the ECG Qbank and track your progress, you first need to create your medical profile.
            </p>
            <div className="flex flex-col gap-3">
              <button 
                onClick={() => router.push('/auth?redirect=/checkout')}
                className="w-full py-4 bg-[#1d46af]/10 text-[#1d46af] border-2 border-[#1d46af]/30 text-sm font-black rounded-xl hover:bg-[#1d46af]/20 transition-all active:scale-95"
              >
                SIGN UP NOW
              </button>
              <button 
                onClick={() => router.push('/auth?redirect=/checkout')}
                className="w-full py-4 bg-white text-slate-400 border-2 border-slate-100 text-sm font-black rounded-xl hover:bg-slate-50 transition-all active:scale-95"
              >
                ALREADY HAVE AN ACCOUNT?
              </button>
              <button 
                onClick={() => setShowAuthModal(false)}
                className="mt-4 text-xs font-bold text-slate-400 hover:text-slate-600 transition-colors"
              >
                CLOSE
              </button>
            </div>
          </div>
        </div>
      )}

      {/* Footer */}
      <footer className="bg-white border-t border-slate-100 py-20 px-6">
        <div className="mx-auto max-w-7xl text-center">
           <div className="inline-flex items-center mb-8">
              <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
              <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
                <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
                <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
                <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
              </div>
           </div>
           <p className="text-slate-400 text-sm font-medium mb-10">¬© 2026 IskyMD Universal Systems. All rights reserved.</p>
           <div className="flex justify-center gap-8">
              <a href="#" className="text-xs font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors">Privacy</a>
              <a href="#" className="text-xs font-black uppercase tracking-widest text-slate-400 hover:text-slate-600 transition-colors">Terms</a>
           </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/account/page.jsx">
export default function Account() {
  return (
    <div>
      <h1 className="text-3xl font-bold mb-4">Account Settings</h1>
      <p className="text-muted-foreground">Manage your account</p>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/dashboard/page.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { getAllQuestions } from "@/services/question.service";
import { getAllTests } from "@/services/test.service";
import { useContext } from "react";
import { AppContext } from "@/context/AppContext";



export default function Dashboard() {
  const router = useRouter();
  const { selectedStudentProduct } = useContext(AppContext);
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({ accuracy: 0, usage: 0, completedTests: 0 });
  const [latestSuspended, setLatestSuspended] = useState(null);

  // Reactivity to context already handled by useContext + useEffect[selectedStudentProduct]

  useEffect(() => {
    const userId = localStorage.getItem("medbank_user");
    
    const fetchData = () => {
      if (!userId) {
        setLoading(false);
        return;
      }

      setLoading(true);
      const pId = selectedStudentProduct?.id;

      Promise.all([
        import("@/services/user.service").then(m => m.getUserById(userId)),
        import("@/services/analytics.service").then(m => m.getUserProductStats(pId)),
        getAllTests(pId)
      ]).then(([userData, productStats, userHistory]) => {
        setUser(userData);
        setStats(productStats);
        
        const completedTests = userHistory.filter(t => !t.isSuspended);
        const suspendedTests = userHistory.filter(t => t.isSuspended);

        if (suspendedTests.length > 0) {
          const latest = [...suspendedTests].sort((a, b) => new Date(b.date) - new Date(a.date))[0];
          setLatestSuspended(latest);
        } else {
          setLatestSuspended(null);
        }

        setLoading(false);
      }).catch(err => {
        console.error("Dashboard load error:", err);
        setLoading(false);
      });
    };

    fetchData();

    // Listen for progress refresh events (e.g. after finishing a test)
    window.addEventListener("medbank_progress_refresh", fetchData);
    return () => window.removeEventListener("medbank_progress_refresh", fetchData);
  }, [selectedStudentProduct]);

  const handleResumeLatest = () => {
    if (!latestSuspended) return;

    const questions = latestSuspended.questions || [];
    const questionIds = questions.map(q => typeof q === 'string' ? q : q.id);

    localStorage.setItem("medbank_current_test", JSON.stringify({
      testId: latestSuspended.testId,
      testNumber: latestSuspended.testNumber,
      date: latestSuspended.date,
      questions: questionIds,
      mode: latestSuspended.mode,
      pool: latestSuspended.pool,
      resumeData: {
        originalTestId: latestSuspended.testId,
        answers: latestSuspended.answers || {},
        currentIndex: latestSuspended.currentIndex || 0,
        elapsedTime: latestSuspended.elapsedTime || 0,
        markedIds: latestSuspended.markedIds || [],
        isOmittedResume: false,
        isSuspended: true
      }
    }));

    router.push("/student/qbank/take-test");
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[50vh]">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-[#1d46af]"></div>
      </div>
    );
  }

  return (
    <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">

      <div className="bg-card p-6 md:p-12 border-b-2 border-primary shadow-sm rounded-2xl relative overflow-hidden transition-colors duration-300">
        <div className="relative z-10">
          <div className="flex flex-col md:flex-row md:items-center justify-between gap-6">
            <div>
              <h1 className="text-4xl font-light text-[#1e293b] dark:text-[#f8fafc]">
                Welcome, <span className="font-bold">{user?.name || "Student"}</span>
              </h1>
              <p className="text-[#64748b] dark:text-[#94a3b8] mt-4 text-lg">
                Ready to continue your medical journey?
              </p>
            </div>

            {latestSuspended && (
              <button
                onClick={handleResumeLatest}
                className="group flex items-center gap-3 bg-[#1d46af] hover:bg-[#16368a] text-white px-8 py-4 rounded-xl shadow-lg shadow-blue-500/20 transition-all active:scale-95"
              >
                <div className="flex flex-col items-start leading-tight">
                  <span className="text-[10px] font-black uppercase tracking-[0.2em] text-blue-200">Resume Progress</span>
                  <span className="text-sm font-bold">Test #{latestSuspended.testNumber}</span>
                </div>
                <div className="w-8 h-8 rounded-full bg-white/10 flex items-center justify-center transition-transform group-hover:translate-x-1">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round"><path d="m9 18 6-6-6-6" /></svg>
                </div>
              </button>
            )}
          </div>

          <div className="grid grid-cols-1 md:grid-cols-3 gap-8 mt-12 pt-12 border-t border-zinc-100 dark:border-zinc-800">
            <div className="flex flex-col">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#64748b] dark:text-[#94a3b8] mb-2">Overall Accuracy</span>
              <div className="flex items-baseline gap-2">
                <span className="text-4xl font-black text-[#1d46af] dark:text-[#3b82f6]">{stats.accuracy}%</span>
                <div className="h-1.5 w-24 bg-zinc-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                   <div className="h-full bg-[#1d46af]" style={{ width: `${stats.accuracy}%` }} />
                </div>
              </div>
            </div>

            <div className="flex flex-col">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#64748b] dark:text-[#94a3b8] mb-2">QBank Usage</span>
              <div className="flex items-baseline gap-2">
                <span className="text-4xl font-black text-[#10b981]">{stats.usage}%</span>
                <div className="h-1.5 w-24 bg-zinc-100 dark:bg-zinc-800 rounded-full overflow-hidden">
                   <div className="h-full bg-[#10b981]" style={{ width: `${stats.usage}%` }} />
                </div>
              </div>
            </div>

            <div className="flex flex-col">
              <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#64748b] dark:text-[#94a3b8] mb-2">Tests Completed</span>
              <div className="flex items-baseline gap-2">
                <span className="text-4xl font-black text-[#fbbf24]">{stats.completedTests}</span>
                <span className="text-xs font-bold text-zinc-400 dark:text-zinc-300 uppercase">Sessions</span>
              </div>
            </div>
          </div>
        </div>
        
        {/* Subtle background decoration */}
        <div className="absolute top-0 right-0 w-64 h-64 bg-[#1d46af]/5 -mr-32 -mt-32 rounded-full" />
      </div>

      <div className="px-4">
        <p className="text-[#94a3b8] text-sm font-medium italic">
          Tip: Consistent daily practice of at least 10 questions significantly improves board exam scores.
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/performance/page.jsx">
"use client";

import React, { useEffect, useState } from 'react';
import { 
  AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer,
  ReferenceDot, ReferenceLine
} from 'recharts';
import { Printer, Info } from 'lucide-react';
import { getAllQuestions } from "@/services/question.service";
import { getAllTests } from "@/services/test.service";
import { getStudentCognition } from "@/services/analytics.service";
import { useContext } from "react";
import { AppContext } from "@/context/AppContext";


export default function Performance() {
  const { selectedStudentProduct } = useContext(AppContext);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    correct: 0,
    incorrect: 0,
    omitted: 0,
    totalAnswered: 0,
    used: 0,
    unused: 0,
    totalQuestions: 0,
    testsCreated: 0,
    testsCompleted: 0,
    suspendedTests: 0,
    percentile: 0,
    readinessScore: 0,
    overthinkingIndex: 0,
    impulsivityIndex: 0,
    fatigueFactor: 0
  });

  const [hoveredScore, setHoveredScore] = useState(null); // 'correct', 'incorrect', 'omitted'

  // Mock bell curve data
  const bellCurveData = Array.from({ length: 100 }, (_, i) => {
    const x = i;
    const mean = 50;
    const stdDev = 15;
    const y = (1 / (stdDev * Math.sqrt(2 * Math.PI))) * Math.exp(-0.5 * Math.pow((x - mean) / stdDev, 2));
    return { x, y: y * 1000 }; // Scale y for better visibility
  });

  // Reactivity to context handled by useEffect[selectedStudentProduct]

  // Reactivity to context handled by useEffect[selectedStudentProduct]

  useEffect(() => {
    async function loadData() {
      setLoading(true);
      const pId = selectedStudentProduct?.id;
      try {
        const productStats = await import("@/services/analytics.service").then(m => m.getUserProductStats(pId));
        const allQuestions = await getAllQuestions(pId);
        const history = await getAllTests(pId);

        let corToInc = 0;
        let incToCor = 0;
        let incToInc = 0;
        let totalTime = 0;
        let totalQsForTime = 0;

        if (history) {
           history.forEach(test => {
             if (test.questions) {
               const firsts = test.firstAnswers || {};
               const finals = test.answers || {};

               test.questions.forEach(qItem => {
                 const id = typeof qItem === 'string' ? qItem : qItem.id;
                 const correctAns = qItem.correct;
                 const firstAns = firsts[id];
                 const finalAns = finals[id] || qItem.userAnswer;

                 // Logic for Answer Changes
                 if (firstAns && finalAns && firstAns !== finalAns) {
                   if (firstAns === correctAns && finalAns !== correctAns) corToInc++;
                   else if (firstAns !== correctAns && finalAns === correctAns) incToCor++;
                   else if (firstAns !== correctAns && finalAns !== correctAns) incToInc++;
                 }
               });

               // Time Stats (only from non-suspended tests)
               if (!test.isSuspended) {
                 totalTime += (test.elapsedTime || 0);
                 totalQsForTime += (test.questions.length || 0);
               }
             }
           });
        }

        const avgTime = totalQsForTime > 0 ? Math.round(totalTime / totalQsForTime) : 0;

        // Forensic Volatility Calculation
        let totalVolatilitySteps = 0;
        if (history) {
            history.forEach(test => {
                if (test.sessionState?.logs) {
                    const logs = test.sessionState.logs;
                    const answerChanges = logs.filter(l => l.action === 'select_answer' || l.action === 'deselect_answer');
                    totalVolatilitySteps += answerChanges.length;
                }
            });
        }

        const cognition = await getStudentCognition(pId);

        setStats({
          correct: productStats.correctAnswers,
          incorrect: productStats.incorrectAnswers,
          omitted: productStats.omittedAnswers,
          totalAnswered: productStats.totalAnswered,
          used: productStats.usedQuestions,
          unused: productStats.unusedQuestions,
          totalQuestions: productStats.totalQuestions,
          testsCreated: history.length,
          testsCompleted: history.filter(t => !t.isSuspended).length,
          suspendedTests: history.filter(t => t.isSuspended).length,
          corToInc,
          incToCor,
          incToInc,
          avgTime: avgTime,
          avgVolatility: (productStats.correctAnswers + productStats.incorrectAnswers) > 0 
            ? (totalVolatilitySteps / (productStats.correctAnswers + productStats.incorrectAnswers)).toFixed(1) 
            : 0,
          percentile: Math.min(99, Math.floor((productStats.correctAnswers / (productStats.correctAnswers + productStats.incorrectAnswers || 1)) * 100)),
          readinessScore: cognition?.readinessScore || 0,
          overthinkingIndex: (cognition?.overthinkingIndex * 10 || 0).toFixed(1),
          impulsivityIndex: (cognition?.impulsivityIndex * 10 || 0).toFixed(1),
          fatigueFactor: (cognition?.fatigueFactor * 100 || 0).toFixed(0)
        });
      } catch (err) {
        console.error(err);
      } finally {
        setLoading(false);
      }
    }
    loadData();

    // Listen for progress refresh events
    window.addEventListener("medbank_progress_refresh", loadData);
    return () => window.removeEventListener("medbank_progress_refresh", loadData);
  }, [selectedStudentProduct]);

  if (loading) return <div className="p-8">Loading stats...</div>;

  const total = stats.totalAnswered || 1;
  const pCorrect = Math.round((stats.correct / total) * 100) || 0;
  const pIncorrect = Math.round((stats.incorrect / total) * 100) || 0;
  const pOmitted = Math.max(0, 100 - pCorrect - pIncorrect);
  const usedPercentage = stats.totalQuestions > 0 ? Math.round(((stats.totalQuestions - stats.unused) / stats.totalQuestions) * 100) : 0;

  // Values for center display
  const displayValue = hoveredScore === 'incorrect' ? pIncorrect : hoveredScore === 'omitted' ? pOmitted : pCorrect;
  const displayLabel = hoveredScore === 'incorrect' ? "Incorrect" : hoveredScore === 'omitted' ? "Omitted" : "Correct";

  return (
    <div className="bg-background min-h-screen font-sans text-foreground transition-colors duration-300">

      {/* Header */}
      <div className="flex justify-between items-center border-b border-border pb-6 mb-8">
        <h1 className="text-3xl font-bold text-foreground">Performance Statistics</h1>
        <button 
          onClick={() => window.print()} 
          className="flex items-center gap-2 text-[#005eb8] hover:text-[#004e92] font-medium text-sm print:hidden"
        >
          <Printer size={16} />
          <span>Print</span>
        </button>
      </div>

      <div className="space-y-12">
        {/* Row 1: Score & Changes */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
           {/* Big Circle Chart */}
           <div className="lg:col-span-3 flex flex-col items-center justify-center">
            <div className="relative w-40 h-40 group cursor-default">
               <svg className="w-full h-full transform -rotate-90">
                {/* Background base */}
                <circle cx="80" cy="80" r="70" stroke="#f1f5f9" strokeWidth="12" fill="none" className="dark:stroke-zinc-800" />

                {/* Omitted Segment */}
                <circle
                  cx="80" cy="80" r="70"
                  stroke="#334155"
                  strokeWidth={hoveredScore === 'omitted' ? "16" : "12"}
                  fill="none"
                  strokeDasharray={440}
                  strokeDashoffset={440 - (440 * pOmitted / 100)}
                  className="transition-all duration-300 ease-out cursor-pointer"
                  onMouseEnter={() => setHoveredScore('omitted')}
                  onMouseLeave={() => setHoveredScore(null)}
                  style={{ transform: `rotate(${((pCorrect + pIncorrect) * 360 / 100)}deg)`, transformOrigin: '80px 80px' }}
                />

                {/* Incorrect Segment */}
                <circle
                  cx="80" cy="80" r="70"
                  stroke="#991b1b"
                  strokeWidth={hoveredScore === 'incorrect' ? "16" : "12"}
                  fill="none"
                  strokeDasharray={440}
                  strokeDashoffset={440 - (440 * pIncorrect / 100)}
                  className="transition-all duration-300 ease-out cursor-pointer"
                  onMouseEnter={() => setHoveredScore('incorrect')}
                  onMouseLeave={() => setHoveredScore(null)}
                  style={{ transform: `rotate(${(pCorrect * 360 / 100)}deg)`, transformOrigin: '80px 80px' }}
                />

                {/* Correct Segment */}
                 <circle 
                   cx="80" cy="80" r="70" 
                   stroke="#10b981" 
                  strokeWidth={hoveredScore === null || hoveredScore === 'correct' ? "16" : "12"} 
                   fill="none" 
                   strokeDasharray={440}
                  strokeDashoffset={440 - (440 * pCorrect / 100)}
                  className="transition-all duration-300 ease-out cursor-pointer"
                  onMouseEnter={() => setHoveredScore('correct')}
                  onMouseLeave={() => setHoveredScore(null)}
                 />
               </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                <span className="text-4xl font-black text-zinc-900 dark:text-zinc-100">{displayValue}%</span>
                <span className="text-[10px] font-black text-muted-foreground dark:text-zinc-300 uppercase tracking-widest">{displayLabel}</span>
               </div>
             </div>
           </div>

           {/* Tables */}
          <div className="lg:col-span-4 space-y-4">
            <h3 className="text-[#005eb8] dark:text-blue-400 font-bold text-xs uppercase tracking-widest">Your Score</h3>
            <div className="bg-card rounded-lg p-1 border border-border">
              <StatRow label="Total Correct" value={stats.correct} />
              <StatRow label="Total Incorrect" value={stats.incorrect} />
              <StatRow label="Total Omitted" value={stats.omitted} isLast />
            </div>
          </div>

          <div className="lg:col-span-5 space-y-4">
            <h3 className="text-[#005eb8] dark:text-blue-400 font-bold text-xs uppercase tracking-widest">Answer Changes & Volatility</h3>
            <div className="bg-card rounded-lg p-1 border border-border">
              <StatRow label="Correct to Incorrect (Second-Guess)" value={stats.corToInc} />
              <StatRow label="Incorrect to Correct (Recovery)" value={stats.incToCor} />
              <StatRow label="Avg Question Volatility" value={stats.avgVolatility} isLast />
            </div>
          </div>
        </div>

        {/* Row 2: Usage & Tests */}
        <div className="grid grid-cols-1 lg:grid-cols-12 gap-8 border-t border-border pt-8">
          {/* Big Circle Chart 2 */}
          <div className="lg:col-span-3 flex flex-col items-center justify-center">
            <div className="relative w-40 h-40">
              <svg className="w-full h-full transform -rotate-90">
                <circle cx="80" cy="80" r="70" stroke="#f1f5f9" strokeWidth="12" fill="none" className="dark:stroke-zinc-800" />
                <circle
                  cx="80" cy="80" r="70"
                  stroke="#0ea5e9"
                  strokeWidth="12"
                  fill="none"
                  strokeDasharray={440}
                  strokeDashoffset={440 - (440 * usedPercentage / 100)}
                  className="transition-all duration-1000 ease-out"
                />
              </svg>
              <div className="absolute inset-0 flex flex-col items-center justify-center">
                <span className="text-4xl font-black text-zinc-900 dark:text-zinc-100">{usedPercentage}%</span>
                <span className="text-[10px] font-black text-muted-foreground dark:text-zinc-300 uppercase tracking-widest">Used</span>
              </div>
            </div>
          </div>

          {/* Tables */}
          <div className="lg:col-span-4 space-y-4">
            <h3 className="text-[#005eb8] dark:text-blue-400 font-bold text-xs uppercase tracking-widest">QBank Usage</h3>
            <div className="bg-card rounded-lg p-1 border border-border">
              <StatRow label="Used Questions" value={stats.used} />
              <StatRow label="Total Questions" value={stats.totalQuestions} isLast />
            </div>
          </div>

          <div className="lg:col-span-5 space-y-4">
            <h3 className="text-[#005eb8] dark:text-blue-400 font-bold text-xs uppercase tracking-widest">Test Count</h3>
            <div className="bg-card rounded-lg p-1 border border-border">
              <StatRow label="Tests Created" value={stats.testsCreated} />
              <StatRow label="Tests Completed" value={stats.testsCompleted} />
              <StatRow label="Suspended Tests" value={stats.suspendedTests} isLast />
            </div>
          </div>
        </div>

        {/* Row 3: Cognition & Readiness */}
        <div className="pt-12 border-t border-border">
          <h2 className="text-2xl font-bold mb-8 text-foreground">Cognitive Intelligence & Readiness</h2>
          <div className="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            {/* Readiness Meter */}
            <div className="lg:col-span-4 bg-card rounded-2xl p-8 border border-border shadow-sm flex flex-col items-center justify-center relative overflow-hidden">
                <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-blue-500 to-emerald-500" />
                <span className="text-[11px] font-black uppercase tracking-widest text-muted-foreground mb-6">Exam Readiness</span>
                <div className="relative w-48 h-48">
                    <svg className="w-full h-full transform -rotate-90">
                        <circle cx="96" cy="96" r="88" stroke="#f1f5f9" strokeWidth="16" fill="none" className="dark:stroke-zinc-800" />
                        <circle
                            cx="96" cy="96" r="88"
                            stroke="url(#passGrad)"
                            strokeWidth="16"
                            fill="none"
                            strokeDasharray={552}
                            strokeDashoffset={552 - (552 * stats.readinessScore / 100)}
                            strokeLinecap="round"
                            className="transition-all duration-1000 ease-out"
                        />
                        <defs>
                            <linearGradient id="passGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                                <stop offset="0%" stopColor="#3b82f6" />
                                <stop offset="100%" stopColor="#10b981" />
                            </linearGradient>
                        </defs>
                    </svg>
                    <div className="absolute inset-0 flex flex-col items-center justify-center">
                        <span className="text-5xl font-black text-zinc-900 dark:text-zinc-100">{stats.readinessScore}%</span>
                        <span className="text-[10px] font-bold text-emerald-500 uppercase tracking-tighter">Pass Probability</span>
                    </div>
                </div>
                <p className="text-zinc-500 text-xs text-center mt-6 italic">Derived from accuracy, unique exposure, and performance stability.</p>
            </div>

            {/* Cognitive Indices */}
            <div className="lg:col-span-4 flex flex-col gap-4">
                <CognitionCard 
                    title="Overthinking Index" 
                    value={stats.overthinkingIndex} 
                    label="Right -> Wrong Changes"
                    color="text-amber-500"
                    desc="Frequent changes often indicate a lack of conceptual confidence."
                />
                <CognitionCard 
                    title="Impulsivity Index" 
                    value={stats.impulsivityIndex} 
                    label="Fast Incorrect Answers"
                    color="text-red-500"
                    desc="High impulsivity leads to &apos;silly mistakes&apos; on easy questions."
                />
                <CognitionCard 
                    title="Fatigue Factor" 
                    value={`${stats.fatigueFactor}%`} 
                    label="Late-Block Performance Decay"
                    color="text-purple-500"
                    desc="Measures your ability to maintain focus throughout long blocks."
                />
            </div>

            {/* Personalized Coaching */}
            <div className="lg:col-span-4 bg-[#1e1e24] dark:bg-zinc-900/50 rounded-2xl p-8 border border-zinc-700/30 text-white">
                <h3 className="text-blue-400 font-black text-xs uppercase tracking-widest mb-6 flex items-center gap-2">
                    <Info size={14} /> Cognitive Coaching
                </h3>
                <div className="space-y-6">
                    {stats.overthinkingIndex > 2 && (
                        <div className="space-y-1">
                            <span className="text-amber-400 text-sm font-bold">Trust your first instinct.</span>
                            <p className="text-zinc-400 text-xs leading-relaxed">You are frequently changing correct answers to incorrect ones. Stick to your first choice unless you find definitive evidence otherwise.</p>
                        </div>
                    )}
                    {stats.impulsivityIndex > 2 && (
                        <div className="space-y-1">
                            <span className="text-red-400 text-sm font-bold">Read the full stem.</span>
                            <p className="text-zinc-400 text-xs leading-relaxed">Your fast error rate is high. Focus on identifying the &apos;crucial finding&apos; in the stem before glancing at the options.</p>
                        </div>
                    )}
                    {stats.fatigueFactor > 15 && (
                        <div className="space-y-1">
                            <span className="text-purple-400 text-sm font-bold">Build endurance.</span>
                            <p className="text-zinc-400 text-xs leading-relaxed">Your performance drops significantly in the second half of tests. Practice longer blocks to build assessment stamina.</p>
                        </div>
                    )}
                    {stats.readinessScore > 75 ? (
                        <div className="pt-4 border-t border-zinc-700/50">
                            <span className="text-emerald-400 text-sm font-bold">Target Exam Readiness Reached.</span>
                            <p className="text-zinc-400 text-xs leading-relaxed">Your stability and accuracy suggest a high probability of success. Focus on maintaining current standards.</p>
                        </div>
                    ) : (
                        <div className="pt-4 border-t border-zinc-700/50">
                            <span className="text-blue-400 text-sm font-bold">Expansion Required.</span>
                            <p className="text-zinc-400 text-xs leading-relaxed">Continue utilizing the QBank to increase unique question exposure and stabilize your accuracy.</p>
                        </div>
                    )}
                </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  );
}

function CognitionCard({ title, value, label, color, desc }) {
    return (
        <div className="bg-card rounded-xl p-5 border border-border shadow-sm">
            <div className="flex justify-between items-start mb-2">
                <span className="text-[10px] font-black uppercase tracking-widest text-muted-foreground">{title}</span>
                <span className={`text-xl font-black ${color}`}>{value}</span>
            </div>
            <span className="text-xs font-bold text-foreground block mb-1">{label}</span>
            <p className="text-[11px] text-zinc-500 leading-tight">{desc}</p>
        </div>
    );
}

function StatRow({ label, value, isLast }) {
  return (
    <div className={`flex justify-between items-center p-3 ${!isLast ? 'border-b border-border' : ''}`}>
      <span className="text-sm text-zinc-700 dark:text-zinc-100 font-bold">{label}</span>
      <span className="text-sm font-black text-zinc-900 dark:text-zinc-100 bg-accent/30 dark:bg-zinc-800 px-4 py-1.5 rounded-full border border-border shadow-sm min-w-[4rem] text-center">
        {value}
      </span>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/planner/page.jsx">
export default function Planner() {
  return (
    <div>
      <h1 className="text-3xl font-bold mb-4">Study Planner</h1>
      <p className="text-muted-foreground">Manage your study schedule</p>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/qbank/create-test/CreateTestTemplateA.jsx">
"use client";

import { useState, useMemo, useEffect } from "react";
import { useRouter } from "next/navigation";
import { 
  Check, Info, ChevronUp, ChevronDown, Plus, 
  HelpCircle, Clock 
} from "lucide-react";
import { getAllQuestions } from "@/services/question.service";
import { getAllTests, saveTest } from "@/services/test.service";
import { SUBJECTS, SYSTEMS, STATUS_FILTERS, selectRandomQuestions, getPersistentTestId } from "@/utils/createTestHelpers";

export default function CreateTestTemplateA({ questions, userId }) {
  const router = useRouter();
  const [selectedSubjects, setSelectedSubjects] = useState([]);
  const [selectedSystems, setSelectedSystems] = useState([]);
  const [activeFilters, setActiveFilters] = useState([]);
  const [numQuestions, setNumQuestions] = useState(0);
  const [mode, setMode] = useState("tutor");
  const [questionMode, setQuestionMode] = useState("Standard");

  // Collapse states
  const [isTestModeOpen, setIsTestModeOpen] = useState(true);
  const [isQuestionModeOpen, setIsQuestionModeOpen] = useState(true);
  const [isSubjectsOpen, setIsSubjectsOpen] = useState(true);
  const [isSystemsOpen, setIsSystemsOpen] = useState(true);
  const [isNoQuestionsOpen, setIsNoQuestionsOpen] = useState(true);

  console.log("[TemplateA] Rendering with questions:", questions.length);

  const subjectOptions = useMemo(() => {
    const fromQuestions = questions.map(q => q.subject).filter(Boolean);
    return [...new Set([...SUBJECTS, ...fromQuestions])].sort();
  }, [questions]);

  const systemOptions = useMemo(() => {
    const fromQuestions = questions.map(q => q.system).filter(Boolean);
    return [...new Set([...SYSTEMS, ...fromQuestions])].sort();
  }, [questions]);

  const filterCounts = useMemo(() => {
    const counts = { Unused: 0, Incorrect: 0, Marked: 0, Omitted: 0, Correct: 0 };
    questions.forEach(q => {
      const qStatus = q.status === null ? 'omitted' : (q.status || 'unused');
      if (qStatus === "unused") counts.Unused++;
      else if (qStatus === "incorrect") counts.Incorrect++;
      else if (qStatus === "omitted") counts.Omitted++;
      else if (qStatus === "correct") counts.Correct++;
      if (q.isMarked) counts.Marked++;
    });
    return counts;
  }, [questions]);

  const getFilteredQuestions = useMemo(() => {
    if (activeFilters.length === 0) return questions;
    return questions.filter(q => {
      let statusMatch = false;
      const qStatus = q.status === null ? 'omitted' : (q.status || 'unused');
      if (activeFilters.includes("Unused") && qStatus === "unused") statusMatch = true;
      if (activeFilters.includes("Incorrect") && qStatus === "incorrect") statusMatch = true;
      if (activeFilters.includes("Marked") && q.isMarked) statusMatch = true;
      if (activeFilters.includes("Omitted") && qStatus === "omitted") statusMatch = true;
      if (activeFilters.includes("Correct") && qStatus === "correct") statusMatch = true;
      return statusMatch;
    });
  }, [questions, activeFilters]);

  const selectedPool = useMemo(() => {
    if (selectedSubjects.length === 0 || selectedSystems.length === 0) return [];
    return getFilteredQuestions.filter(q => {
      return selectedSubjects.includes(q.subject) && selectedSystems.includes(q.system);
    });
  }, [getFilteredQuestions, selectedSubjects, selectedSystems]);

  const maxAllowed = Math.min(selectedPool.length, 40);
  const isFormValid = selectedSubjects.length > 0 && selectedSystems.length > 0 && numQuestions > 0 && numQuestions <= maxAllowed;

  const toggleSubject = (s) => {
    const count = questions.filter(q => q.subject === s && getFilteredQuestions.includes(q)).length;
    if (count === 0) return;
    setSelectedSubjects(prev => prev.includes(s) ? prev.filter(x => x !== s) : [...prev, s]);
  };

  const toggleSystem = (s) => {
    const count = questions.filter(q => q.system === s && getFilteredQuestions.includes(q)).length;
    if (count === 0) return;
    setSelectedSystems(prev => prev.includes(s) ? prev.filter(x => x !== s) : [...prev, s]);
  };

  const toggleFilter = (f) => {
    setActiveFilters(prev => prev.includes(f) ? prev.filter(x => x !== f) : [...prev, f]);
  };

  const subjectCounts = useMemo(() => {
    const counts = {};
    subjectOptions.forEach(s => { counts[s] = 0; });
    const modeFiltered = (activeFilters.length === 0) ? [] : getFilteredQuestions;
    modeFiltered.forEach(q => {
      if (!q.subject) return;
      counts[q.subject] = (counts[q.subject] || 0) + 1;
    });
    return counts;
  }, [getFilteredQuestions, subjectOptions, activeFilters]);

  const systemCounts = useMemo(() => {
    const counts = {};
    systemOptions.forEach(s => { counts[s] = 0; });
    if (activeFilters.length === 0 || selectedSubjects.length === 0) return counts;
    const subjectFiltered = getFilteredQuestions.filter(q => selectedSubjects.includes(q.subject));
    subjectFiltered.forEach(q => {
      if (!q.system) return;
      counts[q.system] = (counts[q.system] || 0) + 1;
    });
    return counts;
  }, [getFilteredQuestions, systemOptions, selectedSubjects, activeFilters]);

  async function handleStartTest() {
    if (!isFormValid) return;
    const finalSet = selectRandomQuestions(selectedPool, numQuestions);
    const testId = getPersistentTestId(userId);

    const packageId = localStorage.getItem("medbank_selected_package");
    const packageName = localStorage.getItem("medbank_selected_package_name") || "Standard QBank";
    
    const history = await getAllTests(packageId);
    const testNumber = history.length + 1;

    const testPayload = {
      testId,
      testNumber,
      userId,
      packageId,
      packageName,
      questions: finalSet,
      mode,
      pool: activeFilters,
      date: new Date().toISOString(),
      universeSize: questions.length,
      eligiblePoolSize: selectedPool.length,
      poolLogic: {
        systems: selectedSystems,
        subjects: selectedSubjects,
        usageState: activeFilters.length > 0 ? activeFilters[0].toLowerCase() : "all"
      }
    };

    const saved = await saveTest(testPayload);
    const testAttemptId = saved?.testAttemptId || saved?.latestAttemptId || null;
    localStorage.setItem("medbank_current_test", JSON.stringify({ ...testPayload, ...(saved || {}), testAttemptId }));
    router.push("/student/qbank/take-test");
  }

  const SubjectsBlock = (
    <div className="border-b border-zinc-800/50">
      <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsSubjectsOpen(!isSubjectsOpen)}>
        <div className="flex items-center gap-2">
          <div onClick={(e) => {
            e.stopPropagation();
            const selectable = subjectOptions.filter(s => (subjectCounts[s] || 0) > 0);
            setSelectedSubjects(selectedSubjects.length === selectable.length && selectable.length > 0 ? [] : selectable);
          }} className={`w-4 h-4 rounded border flex items-center justify-center transition-all mr-2 ${selectedSubjects.length > 0 && selectedSubjects.every(s => (subjectCounts[s] || 0) > 0) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
            {selectedSubjects.length > 0 && selectedSubjects.every(s => (subjectCounts[s] || 0) > 0) && <Check size={10} className="text-white" strokeWidth={4} />}
          </div>
          <h2 className="text-[14px] font-bold text-zinc-300">Subjects</h2>
          <span className="text-[10px] text-zinc-500 font-medium uppercase tracking-wider">(Select All)</span>
        </div>
        {isSubjectsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
      </div>
      {isSubjectsOpen && (
        <div className="pb-8 grid grid-cols-2 gap-x-20 gap-y-2">
          {subjectOptions.map(s => {
            const count = subjectCounts[s] || 0;
            const isDisabled = count === 0 && !selectedSubjects.includes(s);
            return (
              <label key={s} className={`flex items-center gap-2 ${isDisabled ? 'opacity-20 cursor-not-allowed' : 'cursor-pointer group'}`}>
                <div onClick={() => !isDisabled && toggleSubject(s)} className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${selectedSubjects.includes(s) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
                  {selectedSubjects.includes(s) && <Check size={10} className="text-white" strokeWidth={4} />}
                </div>
                <span className={`text-[12px] ${selectedSubjects.includes(s) ? "text-zinc-300" : "text-zinc-500"}`}>{s}</span>
                <div className="px-1.5 py-0.5 bg-zinc-800/30 rounded-full text-[10px] text-zinc-600 font-bold">{count}</div>
              </label>
            );
          })}
        </div>
      )}
    </div>
  );

  const SystemsBlock = (
    <div className={`border-b border-zinc-800/50 ${selectedSubjects.length === 0 ? 'opacity-40 grayscale pointer-events-none' : ''}`}>
      <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => selectedSubjects.length > 0 && setIsSystemsOpen(!isSystemsOpen)}>
        <div className="flex items-center gap-2">
          <div onClick={(e) => {
            e.stopPropagation();
            const selectable = systemOptions.filter(s => (systemCounts[s] || 0) > 0);
            setSelectedSystems(selectedSystems.length === selectable.length && selectable.length > 0 ? [] : selectable);
          }} className={`w-4 h-4 rounded border flex items-center justify-center transition-all mr-2 ${selectedSystems.length > 0 && selectedSystems.every(s => (systemCounts[s] || 0) > 0) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
            {selectedSystems.length > 0 && selectedSystems.every(s => (systemCounts[s] || 0) > 0) && <Check size={10} className="text-white" strokeWidth={4} />}
          </div>
          <h2 className="text-[14px] font-bold text-zinc-300">Systems</h2>
          <span className="text-[10px] text-zinc-500 font-medium uppercase tracking-wider">(Select All)</span>
        </div>
        {isSystemsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
      </div>
      {isSystemsOpen && (
        <div className="pb-8 grid grid-cols-2 gap-x-20 gap-y-2">
          {systemOptions.map(s => {
            const count = systemCounts[s] || 0;
            const isDisabled = count === 0 && !selectedSystems.includes(s);
            return (
              <label key={s} className={`flex items-center justify-between group pr-2 rounded transition-colors ${isDisabled ? 'opacity-20 cursor-not-allowed' : 'cursor-pointer hover:bg-white/[0.02]'}`}>
                <div className="flex items-center gap-2">
                  <div onClick={() => !isDisabled && toggleSystem(s)} className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${selectedSystems.includes(s) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
                    {selectedSystems.includes(s) && <Check size={10} className="text-white" strokeWidth={4} />}
                  </div>
                  <span className={`text-[12px] ${selectedSystems.includes(s) ? "text-zinc-300" : "text-zinc-500"}`}>{s}</span>
                  <div className="px-1.5 py-0.5 bg-zinc-800/30 rounded-full text-[10px] text-zinc-600 font-bold">{count}</div>
                </div>
                {!isDisabled && <Plus size={12} className="text-zinc-700 group-hover:text-zinc-500" />}
              </label>
            );
          })}
        </div>
      )}
    </div>
  );

  return (
    <div className="flex flex-col gap-1">
      {/* TEST MODE */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsTestModeOpen(!isTestModeOpen)}>
          <div className="flex items-center gap-2">
            <h2 className="text-[14px] font-bold text-zinc-300">Test Mode</h2>
            <Info size={14} className="text-[#3b82f6]" />
          </div>
          {isTestModeOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isTestModeOpen && (
          <div className="pb-6">
            <div className="flex bg-zinc-900/50 border border-zinc-800 p-1 rounded-full w-fit">
              {["tutor", "timed"].map(m => (
                <button key={m} onClick={() => setMode(m)} className={`px-8 py-1.5 rounded-full text-[12px] font-bold uppercase tracking-wider transition-all ${mode === m ? 'bg-[#3b82f6] text-white shadow-lg shadow-blue-500/20' : 'text-zinc-500 hover:text-zinc-400'}`}>
                  {m}
                  {m === "timed" && <Clock size={12} className="inline ml-2 mb-0.5" />}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* QUESTION MODE */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsQuestionModeOpen(!isQuestionModeOpen)}>
          <div className="flex items-center gap-3">
            <h2 className="text-[14px] font-bold text-zinc-300">Question Mode</h2>
            <div className="relative group/tooltip">
              <Info size={14} className="text-[#3b82f6] cursor-help" />
              <div className="absolute left-0 top-full mt-2 w-[480px] bg-[#16161a] border border-zinc-800 rounded shadow-2xl p-1 z-[100] opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none">
                <table className="w-full text-[12px] border-collapse">
                  <tbody>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200 w-[100px]">Unused</td>
                      <td className="p-3 text-zinc-400">Selects questions from a set of new/unseen questions</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Incorrect</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously answered incorrectly</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Marked</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously marked/flagged for review</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Omitted</td>
                      <td className="p-3 text-zinc-400">Selects questions that were omitted previously</td>
                    </tr>
                    <tr>
                      <td className="p-3 font-bold text-zinc-200">Correct</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously answered correctly</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div className="flex items-center gap-1.5 ml-2">
              <span className="text-[10px] uppercase font-bold text-zinc-500">Total Available</span>
              <div className="px-2 py-0.5 bg-zinc-800/80 rounded-full text-[10px] font-black text-[#3b82f6]">
                {questions.length}
              </div>
            </div>
          </div>
          {isQuestionModeOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isQuestionModeOpen && (
          <div className="pb-6 flex flex-col gap-6">
            <div className="flex gap-2">
              {["Standard", "Custom"].map(qm => (
                <button key={qm} onClick={() => setQuestionMode(qm)} className={`px-4 py-1 rounded-full text-[11px] font-bold transition-all border ${questionMode === qm ? "bg-zinc-800 border-zinc-700 text-zinc-200" : "bg-zinc-900 border-zinc-800 text-zinc-500"}`}>{qm}</button>
              ))}
            </div>
            <div className="flex items-center gap-8">
              {STATUS_FILTERS.map(f => (
                <label key={f} className={`flex items-center gap-2 ${filterCounts[f] === 0 ? 'opacity-20 cursor-not-allowed' : 'cursor-pointer group'}`}>
                  <div onClick={() => filterCounts[f] > 0 && toggleFilter(f)} className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${activeFilters.includes(f) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
                    {activeFilters.includes(f) && <Check size={10} className="text-white" strokeWidth={4} />}
                  </div>
                  <span className={`text-[12px] font-medium ${activeFilters.includes(f) ? "text-zinc-300" : "text-zinc-500"}`}>{f}</span>
                  <div className="px-1.5 py-0.5 bg-zinc-800/50 rounded-full text-[10px] font-bold text-zinc-500">{filterCounts[f]}</div>
                </label>
              ))}
            </div>
          </div>
        )}
      </div>

      {SubjectsBlock}
      {SystemsBlock}

      {/* NO. OF QUESTIONS */}
      <div>
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsNoQuestionsOpen(!isNoQuestionsOpen)}>
          <h2 className="text-[14px] font-bold text-zinc-300">No. of Questions</h2>
          {isNoQuestionsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isNoQuestionsOpen && (
          <div className="pb-8 flex flex-col gap-6">
            <div className="flex items-center gap-6">
              <input type="number" min={1} max={maxAllowed} value={numQuestions || ""} onChange={e => setNumQuestions(Math.min(maxAllowed, parseInt(e.target.value) || 0))} className="w-[50px] h-[35px] border border-zinc-700 bg-black/40 rounded text-[15px] font-bold text-zinc-100 text-center focus:border-[#3b82f6] outline-none transition-all" />
              <div className="flex items-center gap-3">
                <span className="text-[12px] text-zinc-500">Max allowed per block</span>
                <div className="px-2 py-0.5 bg-zinc-800/60 rounded-full text-[10px] font-black text-[#3b82f6]">{maxAllowed}</div>
              </div>
            </div>
            <div className="flex items-center gap-4 mt-4">
              <button onClick={handleStartTest} disabled={!isFormValid} className={`px-10 py-3 rounded font-bold uppercase tracking-wider text-[13px] transition-all shadow-lg ${isFormValid ? 'bg-[#3b82f6] hover:bg-[#2563eb] text-white active:scale-[0.98] shadow-blue-500/20' : 'bg-zinc-800/50 text-zinc-600 cursor-not-allowed'}`}>GENERATE TEST</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/qbank/create-test/CreateTestTemplateB.jsx">
"use client";

import { useState, useMemo, useEffect } from "react";
import { useRouter } from "next/navigation";
import { 
  Check, Info, ChevronUp, ChevronDown, Plus, 
  HelpCircle, Clock 
} from "lucide-react";
import { getAllQuestions } from "@/services/question.service";
import { getAllTests, saveTest } from "@/services/test.service";
import { STATUS_FILTERS, selectRandomQuestions, getPersistentTestId } from "@/utils/createTestHelpers";

export default function CreateTestTemplateB({ questions, userId, productConfig }) {
  const router = useRouter();
  const [selectedSubjects, setSelectedSubjects] = useState([]);
  const [selectedSystems, setSelectedSystems] = useState([]);
  const [activeFilters, setActiveFilters] = useState([]);
  const [numQuestions, setNumQuestions] = useState(0);
  const [mode, setMode] = useState("tutor");
  const [showSubjectWarning, setShowSubjectWarning] = useState(false);

  // Collapse states
  const [isTestModeOpen, setIsTestModeOpen] = useState(true);
  const [isQuestionModeOpen, setIsQuestionModeOpen] = useState(true);
  const [isSubjectsOpen, setIsSubjectsOpen] = useState(true);
  const [isSystemsOpen, setIsSystemsOpen] = useState(true);
  const [isNoQuestionsOpen, setIsNoQuestionsOpen] = useState(true);

  console.log("[TemplateB] Rendering with questions:", questions.length);

  const subjectOptions = useMemo(() => {
    return Array.isArray(productConfig?.subjects) ? productConfig.subjects : [];
  }, [productConfig]);

  const systemOptions = useMemo(() => {
    return Array.isArray(productConfig?.systems) ? productConfig.systems : [];
  }, [productConfig]);

  // Enforce system auto-selection if none selected
  useEffect(() => {
    if (systemOptions.length > 0 && selectedSystems.length === 0) {
      setSelectedSystems(systemOptions);
    }
  }, [systemOptions, selectedSystems]);

  const filterCounts = useMemo(() => {
    const counts = { Unused: 0, Incorrect: 0, Marked: 0, Omitted: 0, Correct: 0 };
    questions.forEach(q => {
      const qStatus = q.status === null ? 'omitted' : (q.status || 'unused');
      if (qStatus === "unused") counts.Unused++;
      else if (qStatus === "incorrect") counts.Incorrect++;
      else if (qStatus === "omitted") counts.Omitted++;
      else if (qStatus === "correct") counts.Correct++;
      if (q.isMarked) counts.Marked++;
    });
    return counts;
  }, [questions]);

  const getFilteredQuestions = useMemo(() => {
    if (activeFilters.length === 0) return questions;
    return questions.filter(q => {
      let statusMatch = false;
      const qStatus = q.status === null ? 'omitted' : (q.status || 'unused');
      if (activeFilters.includes("Unused") && qStatus === "unused") statusMatch = true;
      if (activeFilters.includes("Incorrect") && qStatus === "incorrect") statusMatch = true;
      if (activeFilters.includes("Marked") && q.isMarked) statusMatch = true;
      if (activeFilters.includes("Omitted") && qStatus === "omitted") statusMatch = true;
      if (activeFilters.includes("Correct") && qStatus === "correct") statusMatch = true;
      return statusMatch;
    });
  }, [questions, activeFilters]);

  const selectedPool = useMemo(() => {
    if (selectedSubjects.length === 0 || selectedSystems.length === 0) return [];
    return getFilteredQuestions.filter(q => {
      return selectedSubjects.includes(q.subject) && selectedSystems.includes(q.system);
    });
  }, [getFilteredQuestions, selectedSubjects, selectedSystems]);

  const maxAllowed = Math.min(selectedPool.length, 40);
  const isFormValid = selectedSubjects.length > 0 && selectedSystems.length > 0 && numQuestions > 0 && numQuestions <= maxAllowed;

  const toggleSubject = (s) => {
    setSelectedSubjects(prev => prev.includes(s) ? prev.filter(x => x !== s) : [...prev, s]);
  };

  const toggleFilter = (f) => {
    setActiveFilters(prev => prev.includes(f) ? prev.filter(x => x !== f) : [...prev, f]);
  };

  const handleSubjectClickWithoutPool = () => {
    if (activeFilters.length > 0) return false;
    setShowSubjectWarning(true);
    setTimeout(() => setShowSubjectWarning(false), 2500);
    return true;
  };

  const subjectCounts = useMemo(() => {
    const counts = {};
    subjectOptions.forEach(s => { counts[s] = 0; });
    const modeFiltered = (activeFilters.length === 0) ? [] : getFilteredQuestions;
    modeFiltered.forEach(q => {
      if (q.subject && counts.hasOwnProperty(q.subject)) {
        counts[q.subject] = (counts[q.subject] || 0) + 1;
      }
    });
    return counts;
  }, [getFilteredQuestions, subjectOptions, activeFilters]);

  async function handleStartTest() {
    if (!isFormValid) return;
    const finalSet = selectRandomQuestions(selectedPool, numQuestions);
    const testId = getPersistentTestId(userId);

    const packageId = localStorage.getItem("medbank_selected_package");
    const packageName = localStorage.getItem("medbank_selected_package_name") || "ECG Product";
    
    const history = await getAllTests(packageId);
    const testNumber = history.length + 1;

    const testPayload = {
      testId,
      testNumber,
      userId,
      packageId,
      packageName,
      questions: finalSet,
      mode,
      pool: activeFilters,
      date: new Date().toISOString(),
      universeSize: questions.length,
      eligiblePoolSize: selectedPool.length,
      poolLogic: {
        systems: selectedSystems,
        subjects: selectedSubjects,
        usageState: activeFilters.length > 0 ? activeFilters[0].toLowerCase() : "all"
      }
    };

    const saved = await saveTest(testPayload);
    const testAttemptId = saved?.testAttemptId || saved?.latestAttemptId || null;
    localStorage.setItem("medbank_current_test", JSON.stringify({ ...testPayload, ...(saved || {}), testAttemptId }));
    router.push("/student/qbank/take-test");
  }

  return (
    <div className="flex flex-col gap-1">
      {/* TEST MODE */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsTestModeOpen(!isTestModeOpen)}>
          <div className="flex items-center gap-2">
            <h2 className="text-[14px] font-bold text-zinc-300">Test Mode</h2>
            <Info size={14} className="text-[#3b82f6]" />
          </div>
          {isTestModeOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isTestModeOpen && (
          <div className="pb-6">
            <div className="flex bg-zinc-900/50 border border-zinc-800 p-1 rounded-full w-fit">
              {["tutor", "timed"].map(m => (
                <button key={m} onClick={() => setMode(m)} className={`px-8 py-1.5 rounded-full text-[12px] font-bold uppercase tracking-wider transition-all ${mode === m ? 'bg-[#3b82f6] text-white shadow-lg shadow-blue-500/20' : 'text-zinc-500 hover:text-zinc-400'}`}>
                  {m}
                  {m === "timed" && <Clock size={12} className="inline ml-2 mb-0.5" />}
                </button>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* QUESTION MODE */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsQuestionModeOpen(!isQuestionModeOpen)}>
          <div className="flex items-center gap-3">
            <h2 className="text-[14px] font-bold text-zinc-300">Question Mode</h2>
            <div className="relative group/tooltip">
              <Info size={14} className="text-[#3b82f6] cursor-help" />
              <div className="absolute left-0 top-full mt-2 w-[480px] bg-[#16161a] border border-zinc-800 rounded shadow-2xl p-1 z-[100] opacity-0 group-hover/tooltip:opacity-100 transition-opacity pointer-events-none">
                <table className="w-full text-[12px] border-collapse">
                  <tbody>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200 w-[100px]">Unused</td>
                      <td className="p-3 text-zinc-400">Selects questions from a set of new/unseen questions</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Incorrect</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously answered incorrectly</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Marked</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously marked/flagged for review</td>
                    </tr>
                    <tr className="border-b border-zinc-800/50">
                      <td className="p-3 font-bold text-zinc-200">Omitted</td>
                      <td className="p-3 text-zinc-400">Selects questions that were omitted previously</td>
                    </tr>
                    <tr>
                      <td className="p-3 font-bold text-zinc-200">Correct</td>
                      <td className="p-3 text-zinc-400">Selects questions that were previously answered correctly</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div className="flex items-center gap-1.5 ml-2">
              <span className="text-[10px] uppercase font-bold text-zinc-500">Total Available</span>
              <div className="px-2 py-0.5 bg-zinc-800/80 rounded-full text-[10px] font-black text-[#3b82f6]">
                {questions.length}
              </div>
            </div>
          </div>
          {isQuestionModeOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isQuestionModeOpen && (
          <div className="pb-6 flex flex-col gap-6">
            <div className="flex items-center gap-8">
              {STATUS_FILTERS.map(f => (
                <label key={f} className={`flex items-center gap-2 ${filterCounts[f] === 0 ? 'opacity-20 cursor-not-allowed' : 'cursor-pointer group'}`}>
                  <div onClick={() => filterCounts[f] > 0 && toggleFilter(f)} className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${activeFilters.includes(f) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
                    {activeFilters.includes(f) && <Check size={10} className="text-white" strokeWidth={4} />}
                  </div>
                  <span className={`text-[12px] font-medium ${activeFilters.includes(f) ? "text-zinc-300" : "text-zinc-500"}`}>{f}</span>
                  <div className="px-1.5 py-0.5 bg-zinc-800/50 rounded-full text-[10px] font-bold text-zinc-500">{filterCounts[f]}</div>
                </label>
              ))}
            </div>
          </div>
        )}
      </div>

      {/* SYSTEMS (Auto-selected, simplified for Template B) */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsSystemsOpen(!isSystemsOpen)}>
          <h2 className="text-[14px] font-bold text-zinc-300">Product Systems</h2>
          {isSystemsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isSystemsOpen && (
          <div className="pb-8 grid grid-cols-2 gap-x-20 gap-y-2">
            {systemOptions.map(s => (
              <label key={s} className="flex items-center justify-center text-center py-1.5 cursor-default">
                <span className="text-[11px] font-bold tracking-[0.08em] uppercase text-zinc-200">{s}</span>
              </label>
            ))}
          </div>
        )}
      </div>

      {/* SUBJECTS */}
      <div className="border-b border-zinc-800/50">
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsSubjectsOpen(!isSubjectsOpen)}>
          <div className="flex items-center gap-2">
            <div onClick={(e) => {
              e.stopPropagation();
              if (handleSubjectClickWithoutPool()) return;
              const selectable = subjectOptions.filter(s => (subjectCounts[s] || 0) > 0);
              setSelectedSubjects(selectedSubjects.length === selectable.length && selectable.length > 0 ? [] : selectable);
            }} className={`w-4 h-4 rounded border flex items-center justify-center transition-all mr-2 ${selectedSubjects.length > 0 && selectedSubjects.every(s => (subjectCounts[s] || 0) > 0) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
              {selectedSubjects.length > 0 && selectedSubjects.every(s => (subjectCounts[s] || 0) > 0) && <Check size={10} className="text-white" strokeWidth={4} />}
            </div>
            <h2 className="text-[14px] font-bold text-zinc-300">ECG Patterns</h2>
            <span className="text-[10px] text-zinc-500 font-medium uppercase tracking-wider">(Select All)</span>
            {showSubjectWarning && <span className="text-[11px] text-amber-400 font-medium ml-2">Choose a question pool first</span>}
          </div>
          {isSubjectsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isSubjectsOpen && (
          <div className="pb-8 grid grid-cols-2 gap-x-20 gap-y-2">
            {subjectOptions.map(s => {
              const count = subjectCounts[s] || 0;
              const isDisabled = count === 0 && !selectedSubjects.includes(s);
              return (
                <label key={s} className={`flex items-center gap-2 ${isDisabled ? 'opacity-20 cursor-not-allowed' : 'cursor-pointer group'}`}>
                  <div onClick={() => {
                    if (handleSubjectClickWithoutPool()) return;
                    if (!isDisabled) toggleSubject(s);
                  }} className={`w-4 h-4 rounded border flex items-center justify-center transition-all ${selectedSubjects.includes(s) ? "bg-[#3b82f6] border-[#3b82f6]" : "bg-transparent border-zinc-700 group-hover:border-zinc-500"}`}>
                    {selectedSubjects.includes(s) && <Check size={10} className="text-white" strokeWidth={4} />}
                  </div>
                  <span className={`text-[12px] ${selectedSubjects.includes(s) ? "text-zinc-300" : "text-zinc-500"}`}>{s}</span>
                  <div className="px-1.5 py-0.5 bg-zinc-800/30 rounded-full text-[10px] text-zinc-600 font-bold">{count}</div>
                </label>
              );
            })}
          </div>
        )}
      </div>

      {/* NO. OF QUESTIONS */}
      <div>
        <div className="flex items-center justify-between py-3 cursor-pointer group" onClick={() => setIsNoQuestionsOpen(!isNoQuestionsOpen)}>
          <h2 className="text-[14px] font-bold text-zinc-300">No. of Questions</h2>
          {isNoQuestionsOpen ? <ChevronUp size={16} /> : <ChevronDown size={16} />}
        </div>
        {isNoQuestionsOpen && (
          <div className="pb-8 flex flex-col gap-6">
            <div className="flex items-center gap-6">
              <input type="number" min={1} max={maxAllowed} value={numQuestions || ""} onChange={e => setNumQuestions(Math.min(maxAllowed, parseInt(e.target.value) || 0))} className="w-[50px] h-[35px] border border-zinc-700 bg-black/40 rounded text-[15px] font-bold text-zinc-100 text-center focus:border-[#3b82f6] outline-none transition-all" />
              <div className="flex items-center gap-3">
                <span className="text-[12px] text-zinc-500">Max allowed per block</span>
                <div className="px-2 py-0.5 bg-zinc-800/60 rounded-full text-[10px] font-black text-[#3b82f6]">{maxAllowed}</div>
              </div>
            </div>
            <div className="flex items-center gap-4 mt-4">
              <button onClick={handleStartTest} disabled={!isFormValid} className={`px-10 py-3 rounded font-bold uppercase tracking-wider text-[13px] transition-all shadow-lg ${isFormValid ? 'bg-[#3b82f6] hover:bg-[#2563eb] text-white active:scale-[0.98] shadow-blue-500/20' : 'bg-zinc-800/50 text-zinc-600 cursor-not-allowed'}`}>GENERATE TEST</button>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/qbank/page.jsx">
"use client";

import { useEffect } from "react";
import { useRouter } from "next/navigation";

export default function QBankPage() {
  const router = useRouter();

  useEffect(() => {
    router.replace("/student/qbank/create-test");
  }, [router]);

  return (
    <div className="flex items-center justify-center min-h-[60vh]">
      <p className="text-xs font-black text-slate-400 uppercase tracking-[0.3em]">Loading QBank...</p>
    </div>
  );
}
</file>

<file path="src/app/student/portal/page.jsx">
"use client";

import React, { useState, useEffect, useContext } from "react";
import { useRouter } from "next/navigation";
import { AppContext } from "@/context/AppContext";
import CartDropdown from "@/components/student/layout/CartDropdown";
import { 
  User, 
  CreditCard, 
  ChevronRight, 
  RefreshCw, 
  LogOut, 
  CheckCircle,
  Settings,
  Mail,
  ShieldCheck,
  Zap,
  Play,
  ArrowUpRight,
  ArrowRight,
  Activity,
  Key,
  Lock,
  AlertCircle,
  CheckCircle2,
  ShoppingCart
} from "lucide-react";
import { getUserById, activateUserSubscription, updateUser } from '@/services/user.service';
import { changeUserPassword } from "@/auth/auth.logic";

function NavItem({ icon, label, active, onClick }) {
  return (
    <button
      onClick={onClick}
      className={`w-full flex items-center justify-between px-6 py-4 transition-all duration-300 ${
        active 
          ? "bg-[#005eb8]/10 text-[#005eb8] border-r-4 border-[#005eb8]" 
          : "text-slate-500 hover:bg-slate-50"
      }`}
    >
      <div className="flex items-center gap-3">
        <span className={active ? "text-[#005eb8]" : "text-slate-400 group-hover:text-slate-600"}>
          {React.cloneElement(icon, { size: 18, strokeWidth: active ? 2.5 : 2 })}
        </span>
        <span className={`text-sm font-bold tracking-tight ${active ? "opacity-100" : "opacity-70 group-hover:opacity-100"}`}>
          {label}
        </span>
      </div>
      {active && <ChevronRight size={14} className="text-[#005eb8]" />}
    </button>
  );
}

export default function PortalPage() {
  const router = useRouter();
  const { cart, isCartOpen, setIsCartOpen, addToCart } = useContext(AppContext);
  const [activeTab, setActiveTab] = useState('subscriptions');
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [showConfirm, setShowConfirm] = useState(false);
  
  // Password Change State
  const [showPasswordModal, setShowPasswordModal] = useState(false);
  const [oldPassword, setOldPassword] = useState("");
  const [newPassword, setNewPassword] = useState("");
  const [confirmPassword, setConfirmPassword] = useState("");
  const [passwordError, setPasswordError] = useState("");
  const [passwordSuccess, setPasswordSuccess] = useState(false);
  const [isChanging, setIsChanging] = useState(false);

  // Real-time countdown timer state
  const [timeRemaining, setTimeRemaining] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });

  const [subscriptions, setSubscriptions] = useState([]);
  
  useEffect(() => {
    // Restore tab persistence
    const savedTab = sessionStorage.getItem('medbank_portal_active_tab');
    if (savedTab) setActiveTab(savedTab);

    const userId = localStorage.getItem("medbank_user");
    if (!userId) {
      router.push("/auth");
      return;
    }

    getUserById(userId).then(userData => {
      setUser(userData);
      import("@/services/user.service").then(m => {
        m.getUserSubscriptions(userId).then(subs => {
          setSubscriptions(subs);
          setLoading(false);
        });
      });
    });
  }, [router]);

  const handleTabChange = (tab) => {
    setActiveTab(tab);
    sessionStorage.setItem('medbank_portal_active_tab', tab);
  };

  const handleLogout = () => {
    localStorage.removeItem("medbank_user");
    router.push("/");
  };

  const { setGlobalStudentProduct } = useContext(AppContext);

  const handleLaunchSubscription = (sub) => {
    // Map subscription record to product context
    const productContext = {
      subscriptionId: sub.id,
      id: sub.packageId,
      name: sub.productName || 'Medical QBank',
      expiresAt: sub.expiresAt,
      durationDays: sub.durationDays
    };
    setGlobalStudentProduct(productContext);
    router.push('/student/dashboard');
  };


  const getDaysLeft = () => {
    if (!user?.expiresAt) return 0;
    const now = new Date();
    const expiry = new Date(user.expiresAt);
    const diff = expiry.getTime() - now.getTime();
    return Math.ceil(diff / (1000 * 60 * 60 * 24));
  };

  const daysLeft = getDaysLeft();

  // Renewal Logic: Check if within last 5 days
  const isRenewalTime = () => {
    // Suppress renewal warnings if we are in "Ready to Activate" state (pending purchase)
    if (user?.hasPendingPurchase || (user?.purchased && !user?.activatedByPurchase)) return false;

    if (!user?.activatedAt || !user?.expiresAt || user.subscriptionStatus !== 'active') return false;
    
    const end = new Date(user.expiresAt).getTime();
    const now = new Date().getTime();
    const remaining = end - now;
    
    // Show when 5 days or less remain (5 * 24 * 60 * 60 * 1000)
    const fiveDaysMs = 5 * 24 * 60 * 60 * 1000;
    
    return remaining > 0 && remaining <= fiveDaysMs;
  };

  const showRenew = isRenewalTime();

  // Real-time countdown effect & Renewal visibility trigger
  useEffect(() => {
    // If not active, don't bother
    if (user?.subscriptionStatus !== 'active' || !user?.expiresAt) return;

    const updateCountdown = () => {
      const now = new Date();
      const expiry = new Date(user.expiresAt);
      const diff = expiry - now;
      
      if (diff <= 0) {
        setTimeRemaining({ days: 0, hours: 0, minutes: 0, seconds: 0 });
      } else {
        setTimeRemaining({
          days: Math.floor(diff / (1000 * 60 * 60 * 24)),
          hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
          minutes: Math.floor((diff / 1000 / 60) % 60),
          seconds: Math.floor((diff / 1000) % 60)
        });
      }
    };

    updateCountdown(); 
    const interval = setInterval(updateCountdown, 1000);
    return () => clearInterval(interval);
  }, [user?.expiresAt, user?.subscriptionStatus, user?.activatedAt]);

  const handlePasswordChange = async (e) => {
    e.preventDefault();
    setPasswordError("");
    
    if (newPassword !== confirmPassword) {
      setPasswordError("New passwords do not match");
      return;
    }

    if (newPassword.length < 6) {
      setPasswordError("Password must be at least 6 characters long");
      return;
    }

    setIsChanging(true);
    try {
      await changeUserPassword(user.id, oldPassword, newPassword);
      setPasswordSuccess(true);
      setOldPassword("");
      setNewPassword("");
      setConfirmPassword("");
      setTimeout(() => {
        setShowPasswordModal(false);
        setPasswordSuccess(false);
      }, 2000);
    } catch (err) {
      setPasswordError(err?.message || err || "Failed to change password");
    } finally {
      setIsChanging(false);
    }
  };

  if (loading) {
    return (
      <div className="h-screen w-full flex items-center justify-center bg-[#f8fafc]">
        <RefreshCw size={24} className="animate-spin text-[#005eb8]" />
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-[#f8fafc] flex flex-col font-sans text-slate-900 selection:bg-[#005eb8]/10 relative">
      {/* Confirmation Modal */}

      {/* Change Password Modal */}
      {showPasswordModal && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center bg-slate-900/60 backdrop-blur-sm animate-in fade-in duration-300 p-6">
          <div className="bg-white rounded-[2.5rem] w-full max-w-md p-10 shadow-2xl border border-slate-100 animate-in zoom-in-95 duration-300">
            <div className="w-16 h-16 rounded-2xl bg-orange-50 flex items-center justify-center mb-6 mx-auto border border-orange-100 text-orange-600">
              <Key size={32} />
            </div>
            
            <h3 className="text-2xl font-black text-slate-800 text-center mb-2 tracking-tight">Security Update</h3>
            <p className="text-center text-slate-500 text-sm font-medium mb-8">Update your account password</p>

            {passwordSuccess ? (
              <div className="flex flex-col items-center justify-center py-6 text-center animate-in zoom-in duration-300">
                <div className="w-16 h-16 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center mb-4">
                  <CheckCircle2 size={32} />
                </div>
                <h4 className="text-lg font-bold text-slate-800">Password Updated!</h4>
                <p className="text-sm text-slate-500 mt-1">Your security has been updated successfully.</p>
              </div>
            ) : (
              <form onSubmit={handlePasswordChange} className="space-y-5">
                {passwordError && (
                  <div className="flex items-center gap-3 p-4 bg-red-50 text-red-600 rounded-2xl text-xs font-bold border border-red-100 animate-in shake duration-300">
                    <AlertCircle size={16} />
                    {passwordError}
                  </div>
                )}

                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Current Password</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type="password"
                      required
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      value={oldPassword}
                      onChange={(e) => setOldPassword(e.target.value)}
                      className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 pl-11 pr-4 text-sm font-bold focus:bg-white focus:ring-4 focus:ring-orange-500/5 focus:border-orange-500/30 transition-all outline-none"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">New Password</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type="password"
                      required
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      value={newPassword}
                      onChange={(e) => setNewPassword(e.target.value)}
                      className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 pl-11 pr-4 text-sm font-bold focus:bg-white focus:ring-4 focus:ring-orange-500/5 focus:border-orange-500/30 transition-all outline-none"
                    />
                  </div>
                </div>

                <div className="space-y-2">
                  <label className="text-[10px] font-black text-slate-400 uppercase tracking-widest ml-1">Confirm New Password</label>
                  <div className="relative">
                    <Lock className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-300" size={18} />
                    <input
                      type="password"
                      required
                      placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
                      value={confirmPassword}
                      onChange={(e) => setConfirmPassword(e.target.value)}
                      className="w-full bg-slate-50 border border-slate-100 rounded-xl py-3.5 pl-11 pr-4 text-sm font-bold focus:bg-white focus:ring-4 focus:ring-orange-500/5 focus:border-orange-500/30 transition-all outline-none"
                    />
                  </div>
                </div>

                <div className="flex flex-col gap-3 pt-4">
                  <button 
                    type="submit"
                    disabled={isChanging}
                    className="w-full py-4 bg-slate-900 text-white text-sm font-black rounded-xl hover:bg-slate-800 transition-all shadow-xl shadow-slate-900/10 active:scale-95 disabled:opacity-50"
                  >
                    {isChanging ? "UPDATING..." : "UPDATE PASSWORD"}
                  </button>
                  <button 
                    type="button"
                    onClick={() => setShowPasswordModal(false)}
                    className="w-full py-4 bg-white text-slate-400 text-sm font-black rounded-xl hover:bg-slate-50 transition-all active:scale-95"
                  >
                    CANCEL
                  </button>
                </div>
              </form>
            )}
          </div>
        </div>
      )}

      {/* Header */}
      <header className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-50 shadow-sm">
        <div className="flex items-center gap-3 cursor-pointer" onClick={() => window.location.reload()}>
          <div className="flex items-center">
            <span className="text-2xl font-black text-[#1d46af] tracking-tight">Isky</span>
            <div className="relative ml-2 w-10 h-10 flex items-center justify-center">
              <div className="absolute inset-0 rounded-full border-[2.5px] border-[#1d46af]"></div>
              <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
              <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
              <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
              <span className="text-[#1d46af] font-black text-[12px] tracking-tighter">MD</span>
            </div>
          </div>
        </div>
        
        <div className="flex items-center gap-4">
           <div className="relative">
             <button 
               onClick={() => setIsCartOpen(!isCartOpen)}
               className="flex items-center gap-2 p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-[#005eb8] relative"
             >
               <div className="relative">
                 <ShoppingCart size={18} />
                 {cart.length > 0 && (
                   <span className="absolute -top-2 -right-2 w-5 h-5 bg-[#1d46af] text-white text-[10px] font-black rounded-full flex items-center justify-center border-2 border-white">
                     {cart.length}
                   </span>
                 )}
               </div>
               <span className="hidden md:inline text-xs font-bold uppercase tracking-widest">Cart</span>
             </button>
             <CartDropdown />
           </div>
           <button 
             onClick={() => window.location.reload()}
             className="p-2 hover:bg-slate-100 rounded-full transition-colors text-slate-400 hover:text-[#005eb8]"
           >
             <RefreshCw size={18} />
           </button>
           <div className="h-8 w-px bg-slate-200" />
           <button 
             onClick={handleLogout}
             className="flex items-center gap-2 px-4 py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-all active:scale-95"
           >
             <LogOut size={16} />
             SIGN OUT
           </button>
        </div>
      </header>

      <div className="flex-1 flex overflow-hidden">
        {/* Management Sidebar */}
        <aside className="w-72 bg-white border-r border-slate-200 hidden md:flex flex-col flex-shrink-0 animate-in fade-in slide-in-from-left duration-500">
          <div className="p-8 pb-4">
            <p className="text-[10px] font-black uppercase tracking-[0.2em] text-[#005eb8]">Your Products</p>
          </div>
          
          <nav className="flex-1">
            <NavItem 
              icon={<CreditCard />} 
              label="Subscriptions" 
              active={activeTab === 'subscriptions'} 
              onClick={() => handleTabChange('subscriptions')}
            />
            <NavItem 
              icon={<User />} 
              label="Student Profile" 
              active={activeTab === 'profile'} 
              onClick={() => handleTabChange('profile')}
            />

          </nav>


        </aside>

        {/* Main Content Area */}
        <main className="flex-1 overflow-y-auto p-6 md:p-12 lg:p-16 scroll-smooth">
          <div className="max-w-4xl mx-auto">
            
            {/* Renewal Countdown Banner - Only show for paid subscribers with 10s delay */}
            {user?.subscriptionStatus === 'active' && user?.expiresAt && showRenew && (
               <div className="mb-8 w-full bg-[#2196f3] py-4 px-6 flex items-center justify-center animate-in slide-in-from-top-4 duration-500 shadow-lg rounded-2xl border-b border-white/10">
                 <div className="flex items-center gap-3 text-white font-extrabold text-[13px] md:text-sm tracking-tight text-center">
                   <span>You have</span>
                   <div className="flex items-center justify-center w-7 h-7 bg-zinc-900 rounded-full text-[12px] text-white shrink-0 shadow-lg">
                     {daysLeft}
                   </div>
                   {user?.activatedByPurchase || user?.purchased || user?.hasPendingPurchase ? (
                     <span>days left on your subscription. Renew today to keep your access.</span>
                   ) : (
                     <span>days left on your free trial. Upgrade today to unlock the full QBank.</span>
                   )}
                 </div>
               </div>
            )}

            {/* Content Tabs */}
            <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
              {activeTab === 'subscriptions' && (
                <div className="flex flex-col py-12 bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-100">
                    <div className="w-full max-w-3xl px-12">
                      {subscriptions.length > 0 ? (
                        <>
                          <div className="flex justify-between items-center mb-8 pl-1">
                            <div>
                              <h2 className="text-[22px] font-black text-slate-800 tracking-tight">Active Vaults</h2>
                              <p className="text-sm font-medium text-slate-400">Launch your products from here</p>
                            </div>
                            <button 
                              onClick={() => router.push('/products')}
                              className="h-10 px-5 bg-blue-50 text-[#1d46af] border border-blue-100 text-[11px] font-black uppercase tracking-widest rounded-full hover:bg-blue-100 transition-all flex items-center gap-2"
                            >
                              Browse More <ArrowUpRight size={16} />
                            </button>
                          </div>
                          
                          <div className="grid grid-cols-1 gap-4">
                            {subscriptions.map((sub) => {
                              const isActive = sub.status === 'active' && new Date(sub.expiresAt) > new Date();
                              const isExpired = sub.status === 'expired' || (sub.expiresAt && new Date(sub.expiresAt) <= new Date());
                              
                              return (
                                <div key={sub.id} className="bg-white rounded-2xl border border-slate-200 group hover:border-[#1d46af]/30 hover:shadow-lg hover:shadow-blue-500/5 transition-all p-6 flex flex-col md:flex-row justify-between items-center gap-6">
                                  <div className="flex items-center gap-4">
                                    <div className={`w-12 h-12 rounded-2xl ${isActive ? 'bg-blue-500' : 'bg-slate-200'} flex items-center justify-center text-white shrink-0 shadow-lg ${isActive ? 'shadow-blue-500/20' : ''}`}>
                                      <Activity size={24} />
                                    </div>
                                    <div className="flex flex-col">
                                      <div className="flex items-center gap-2">
                                        <h3 className="text-lg font-black text-slate-900 leading-tight">
                                          {sub.productName}
                                        </h3>
                                        {isActive && (
                                          <span className="text-[10px] font-black px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-600 border border-emerald-100 uppercase tracking-tight">
                                            Active
                                          </span>
                                        )}
                                        {isExpired && (
                                          <span className="text-[10px] font-black px-2 py-0.5 rounded-full bg-red-50 text-red-600 border border-red-100 uppercase tracking-tight">
                                            Expired
                                          </span>
                                        )}
                                      </div>
                                      <p className={`text-[13px] mt-0.5 font-bold ${isExpired ? 'text-red-400' : 'text-slate-400'}`}>
                                        {isActive 
                                          ? `Expires: ${new Date(sub.expiresAt).toLocaleDateString(undefined, { month: 'short', day: 'numeric', year: 'numeric' })}`
                                          : isExpired 
                                            ? 'Subscription expired'
                                            : 'Ready to Activate'}
                                      </p>
                                    </div>
                                  </div>

                                  <div className="flex items-center gap-3">
                                    {isActive ? (
                                      <button 
                                        onClick={() => handleLaunchSubscription(sub)}
                                        className="h-10 px-8 bg-[#1d46af] text-white text-[13px] font-black rounded-full hover:bg-[#16368a] transition-all shadow-lg shadow-blue-500/20 active:scale-95 flex items-center gap-2"
                                      >
                                        Launch <Play size={14} fill="white" />
                                      </button>
                                    ) : (
                                      <button 
                                        onClick={() => router.push('/products')}
                                        className="h-10 px-6 bg-slate-50 text-slate-400 text-[13px] font-black rounded-full border border-slate-200 hover:bg-slate-100 transition-all"
                                      >
                                        Renew Access
                                      </button>
                                    )}
                                  </div>
                                </div>
                              );
                            })}
                          </div>
                        </>
                      ) : (
                        <div className="flex flex-col items-center justify-center py-20 text-center animate-in fade-in zoom-in duration-700">
                          <div className="w-24 h-24 rounded-3xl bg-slate-50 border border-slate-100 flex items-center justify-center mb-8 text-slate-300">
                            <ShoppingCart size={40} />
                          </div>
                          <h3 className="text-2xl font-black text-slate-800 mb-3 tracking-tight">No Active Vaults</h3>
                          <p className="text-slate-500 text-sm max-w-sm mx-auto mb-10 font-medium leading-relaxed">
                            Your purchased medical QBanks will appear here. Explore our products to get started.
                          </p>
                          <button 
                            onClick={() => router.push('/products')}
                            className="h-16 px-10 bg-[#1d46af] text-white text-base font-black rounded-2xl hover:bg-[#16368a] transition-all shadow-xl shadow-blue-500/20 active:scale-95 flex items-center gap-3 group"
                          >
                            Explore Products <ArrowRight size={20} className="group-hover:translate-x-1 transition-transform" />
                          </button>
                        </div>
                      )}
                    </div>
                </div>
              )}


              {activeTab === 'profile' && (
                <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
                  <div className="bg-white rounded-[2rem] p-10 shadow-xl shadow-slate-200/50 border border-slate-100 max-w-2xl mx-auto">
                    <h2 className="text-2xl font-black text-slate-800 mb-8 border-b border-slate-100 pb-4">Personal Information</h2>
                    <div className="space-y-8">
                      <div>
                         <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] block mb-3">Student Name</label>
                         <div className="flex items-center gap-4 p-5 bg-slate-50 rounded-2xl border border-slate-100">
                            <div className="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-[#005eb8]">
                               <User size={20} />
                            </div>
                            <span className="text-lg font-bold text-slate-700">{user?.name || "Student User"}</span>
                         </div>
                      </div>
                      
                      <div>
                         <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] block mb-3">Email Address</label>
                         <div className="flex items-center gap-4 p-5 bg-slate-50 rounded-2xl border border-slate-100">
                            <div className="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-[#005eb8]">
                               <Mail size={20} />
                            </div>
                            <span className="text-lg font-bold text-slate-700">{user?.email}</span>
                         </div>
                      </div>

                      <div className="pt-2">
                         <label className="text-[10px] font-black text-slate-400 uppercase tracking-[0.2em] block mb-3">Security</label>
                         <button
                            onClick={() => setShowPasswordModal(true)}
                            className="w-full flex items-center justify-between p-5 bg-slate-50 rounded-2xl border border-slate-100 hover:bg-slate-100 transition-all group"
                         >
                            <div className="flex items-center gap-4">
                               <div className="w-10 h-10 rounded-xl bg-orange-50 flex items-center justify-center text-orange-600">
                                  <Key size={20} />
                               </div>
                               <span className="text-lg font-bold text-slate-700">Change Password</span>
                            </div>
                            <ChevronRight size={18} className="text-slate-300 group-hover:text-slate-400 transition-colors" />
                         </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}


            </div>
          </div>
        </main>
      </div>

      {/* Footer */}
      <footer className="bg-[#1e293b] text-slate-400 py-12 px-6 mt-12">
        <div className="max-w-6xl mx-auto text-center">
           <div className="flex flex-col md:flex-row justify-between items-center gap-6 text-[10px] font-bold uppercase tracking-widest border-t border-slate-700 pt-8">
             <span>¬© 2026 IskyMD Universal Systems. All rights reserved.</span>
             <div className="flex gap-4">
                <button className="px-3 py-1 bg-slate-700 rounded-full hover:bg-slate-600 transition-colors">Manage Cookies</button>
             </div>
           </div>
        </div>
      </footer>
    </div>
  );
}
</file>

<file path="src/components/author/AuthorHeader.jsx">
"use client";
import React, { useContext, useEffect, useState } from 'react';
import { usePathname, useRouter } from 'next/navigation';
import { Search, Bell, User, Sun, Moon, Menu, RefreshCw, DollarSign, Package } from 'lucide-react';
import { motion, AnimatePresence } from 'framer-motion';
import { AppContext } from '@/context/AppContext';
import { getAllProducts, getPublishedProducts } from '@/services/product.service';
import Link from 'next/link';

const AuthorHeader = () => {
    const { theme, toggleTheme, toggleSidebar, sidebarCollapsed, selectedAuthorProduct, setGlobalAuthorProduct } = useContext(AppContext);
    const pathname = usePathname();
    const router = useRouter();
    const [notifications, setNotifications] = useState([]);
    const [products, setProducts] = useState([]);
    const [showNotifications, setShowNotifications] = useState(false);
    const [unreadCount, setUnreadCount] = useState(0);
    const [user, setUser] = useState(null);

    const [showProductDropdown, setShowProductDropdown] = useState(false);

    // Close dropdown on click outside
    useEffect(() => {
        const h = () => setShowProductDropdown(false);
        if (showProductDropdown) window.addEventListener('click', h);
        return () => window.removeEventListener('click', h);
    }, [showProductDropdown]);

    // Load products for context switcher and enforce context selection
    useEffect(() => {
        getPublishedProducts().then(data => {
            setProducts(data || []);
            // STRICT MODE: Always force a product context if available
            if (!selectedAuthorProduct && data && data.length > 0) {
                setGlobalAuthorProduct(data[0]);
            }
        }).catch(console.error);
    }, [selectedAuthorProduct]);

    React.useEffect(() => {
        const fetchNotifications = async () => {
            try {
                const res = await fetch('/api/notifications?limit=5');
                const data = await res.json();
                if (Array.isArray(data)) {
                    setNotifications(data);
                    setUnreadCount(data.filter(n => !n.isRead).length);
                }
            } catch (err) {
                console.error("Failed to fetch notifications:", err);
            }
        };

        const fetchUser = async () => {
            const userId = localStorage.getItem("medbank_user");
            if (userId) {
                try {
                    const { getUserById } = await import("@/services/user.service");
                    const u = await getUserById(userId);
                    setUser(u);
                } catch (e) {}
            }
        };

        fetchNotifications();
        fetchUser();
        // Polling every 30 seconds for new activity
        const interval = setInterval(fetchNotifications, 30000);
        return () => clearInterval(interval);
    }, []);

    const markAllRead = async () => {
        setUnreadCount(0);
        // We could send updates to API here if we wanted to persist read state across sessions
    };

    return (
        <header className="sticky top-0 z-40 w-full bg-background/60 backdrop-blur-xl border-b border-border/50 px-8 py-4 flex items-center justify-between">
            <div className="flex items-center gap-4 cursor-pointer group">
                <button
                    onClick={toggleSidebar}
                    className={`p-2.5 rounded-2xl transition-all duration-500 border ${sidebarCollapsed
                        ? 'bg-[#0066CC] border-[#0066CC] text-white shadow-[0_0_20px_rgba(0,102,204,0.4)] animate-pulse'
                        : 'bg-panel border-border text-muted-foreground hover:text-[#0066CC] hover:border-[#0066CC]/30 hover:bg-white'
                        }`}
                    title={sidebarCollapsed ? "Expand Navigation" : "Collapse Navigation"}
                >
                    <Menu size={22} className={sidebarCollapsed ? 'scale-110' : ''} />
                </button>
                <div className="flex flex-col">
                    <span className="text-slate-400 font-mono text-[9px] uppercase tracking-[0.25em]">Context /</span>

                    <div className="relative" onClick={(e) => e.stopPropagation()}>
                        <button 
                            onClick={() => setShowProductDropdown(!showProductDropdown)}
                            className="flex items-center gap-2 text-[#1B263B] font-bold text-sm hover:text-[#0066CC] transition-colors"
                        >
                            <Package size={14} className="text-[#0066CC]" />
                            {selectedAuthorProduct ? selectedAuthorProduct.name : 'Select Vault context'}
                            <span className={`text-[9px] text-slate-400 transition-transform duration-300 ${showProductDropdown ? 'rotate-180' : ''}`}>‚ñº</span>
                        </button>

                        <AnimatePresence>
                            {showProductDropdown && (
                                <motion.div 
                                    initial={{ opacity: 0, y: 10 }}
                                    animate={{ opacity: 1, y: 0 }}
                                    exit={{ opacity: 0, y: 10 }}
                                    className="absolute top-full left-0 mt-2 w-64 bg-white border border-slate-200 rounded-2xl shadow-xl overflow-hidden z-50 animate-in fade-in slide-in-from-top-2"
                                >
                                    <div className="p-2 space-y-1">
                                        <div className="max-h-[200px] overflow-y-auto custom-scrollbar">
                                            {products.map(p => (
                                                <button
                                                    key={p.id}
                                                    onClick={() => {
                                                        setGlobalAuthorProduct(p);
                                                        setShowProductDropdown(false);
                                                    }}
                                                    className={`w-full text-left px-4 py-2.5 rounded-xl text-xs font-bold transition-all flex items-center gap-2 mb-1 ${selectedAuthorProduct?.id === p.id ? 'bg-[#0066CC]/10 text-[#0066CC]' : 'hover:bg-slate-50 text-slate-600'}`}
                                                >
                                                    <div className={`w-1.5 h-1.5 rounded-full ${selectedAuthorProduct?.id === p.id ? 'bg-[#0066CC]' : 'bg-slate-300'}`} />
                                                    {p.name}
                                                </button>
                                            ))}
                                        </div>
                                        <div className="h-[1px] bg-slate-100 my-1 mx-2" />
                                        <Link 
                                            href="/author/manage-products" 
                                            onClick={() => setShowProductDropdown(false)}
                                            className="flex items-center gap-2 px-4 py-2 text-[10px] font-black text-[#0066CC] uppercase tracking-widest hover:bg-[#0066CC]/5 rounded-xl transition-all"
                                        >
                                            Manage Streams ‚Üí
                                        </Link>
                                    </div>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>
                </div>
            </div>

            <div className="flex items-center gap-6">
                <div className="hidden lg:flex items-center gap-3 bg-white border border-slate-200 rounded-2xl px-4 py-2 hover:border-[#0066CC]/30 transition-all group shadow-sm">
                    <Search size={16} className="text-slate-400 group-hover:text-[#0066CC] transition-colors" />
                    <input
                        type="text"
                        placeholder="Search workspace..."
                        className="bg-transparent border-none outline-none text-xs text-foreground placeholder:text-muted-foreground w-48 focus:w-64 transition-all"
                    />
                </div>

                <div className="flex items-center gap-4">
                    {/* Theme Toggle */}
                    <button
                        onClick={toggleTheme}
                        className="p-2.5 rounded-2xl bg-panel hover:bg-border/50 text-muted-foreground hover:text-foreground transition-all border border-border"
                    >
                        {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
                    </button>

                    {/* Notification Bell */}
                    <div className="relative">
                        <button
                            onClick={() => {
                                setShowNotifications(!showNotifications);
                                if (!showNotifications) markAllRead();
                            }}
                            className="p-2.5 rounded-2xl bg-panel hover:bg-border/50 text-muted-foreground hover:text-foreground transition-all relative border border-border"
                        >
                            <Bell size={20} />
                            {unreadCount > 0 && (
                                <div className="absolute top-2.5 right-2.5 w-2.5 h-2.5 rounded-full bg-red-500 border-2 border-background animate-pulse"></div>
                            )}
                        </button>

                        <AnimatePresence>
                            {showNotifications && (
                                <motion.div
                                    initial={{ opacity: 0, y: 10, scale: 0.95 }}
                                    animate={{ opacity: 1, y: 0, scale: 1 }}
                                    exit={{ opacity: 0, y: 10, scale: 0.95 }}
                                    className="absolute right-0 mt-3 w-80 bg-white border border-slate-200 rounded-[32px] shadow-2xl overflow-hidden z-50 origin-top-right text-left"
                                >
                                    <div className="p-5 border-b border-slate-100 flex items-center justify-between bg-slate-50/50">
                                        <span className="text-[10px] font-black uppercase tracking-widest text-[#1B263B]">System Activity</span>
                                        <span className="bg-[#0066CC]/10 text-[#0066CC] text-[9px] px-2 py-0.5 rounded-full font-black uppercase">Latest_Uplinks</span>
                                    </div>
                                    <div className="max-h-[350px] overflow-y-auto">
                                        {notifications.length === 0 ? (
                                            <div className="p-8 text-center">
                                                <div className="text-slate-300 mb-2 font-black uppercase text-[10px]">No recent data</div>
                                                <p className="text-slate-400 text-[10px]">System monitoring is active.</p>
                                            </div>
                                        ) : (
                                            notifications.map((n, idx) => (
                                                <div key={idx} className="p-4 border-b border-slate-50 hover:bg-slate-50/50 transition-colors cursor-default">
                                                    <div className="flex gap-3">
                                                        <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 ${n.type === 'purchase' ? 'bg-emerald-100 text-emerald-600' : 'bg-blue-100 text-blue-600'
                                                            }`}>
                                                            {n.type === 'purchase' ? <DollarSign size={14} /> : <User size={14} />}
                                                        </div>
                                                        <div className="space-y-1">
                                                            <p className="text-[11px] font-bold text-[#1B263B] leading-tight">{n.message}</p>
                                                            <p className="text-[9px] font-mono text-slate-400 uppercase">{new Date(n.createdAt).toLocaleString()}</p>
                                                        </div>
                                                    </div>
                                                </div>
                                            ))
                                        )}
                                    </div>
                                    <Link
                                        href="/author/activity"
                                        onClick={() => setShowNotifications(false)}
                                        className="block p-4 text-center text-[10px] font-black uppercase tracking-widest text-[#0066CC] hover:bg-slate-50 transition-colors bg-white border-t border-slate-100"
                                    >
                                        View Master Logs <RefreshCw size={10} className="inline ml-1" />
                                    </Link>
                                </motion.div>
                            )}
                        </AnimatePresence>
                    </div>

                    <button 
                        onClick={() => window.location.reload()}
                        className="p-2.5 rounded-2xl bg-panel hover:bg-border/50 text-muted-foreground hover:text-foreground transition-all border border-border"
                        title="Refresh Page"
                    >
                        <RefreshCw size={20} />
                    </button>

                    <div className="h-8 w-[1px] bg-border/50 mx-2"></div>

                    <div className="flex items-center gap-3 pl-2">
                        <div className="text-right hidden sm:block">
                            <div className="text-xs font-bold text-foreground">{user?.name || 'MedBank Author'}</div>
                            <div className="text-[10px] font-mono text-gray-500 uppercase tracking-tighter">{user?.role === 'author' ? 'Master_Author' : 'Verified_Auth'}</div>
                        </div>
                        <motion.div
                            whileHover={{ scale: 1.05 }}
                            className="w-10 h-10 rounded-2xl bg-gradient-to-tr from-[#0066CC]/10 to-[#0891B2]/10 border border-[#0066CC]/20 flex items-center justify-center text-[#0066CC] overflow-hidden cursor-pointer shadow-sm"
                        >
                            <User size={20} />
                        </motion.div>
                    </div>
                </div>
            </div>
        </header>
    );
};

export default AuthorHeader;
</file>

<file path="src/components/author/BottomStats.jsx">
"use client";
import React from 'react';
import { ChevronUp, ChevronDown, Monitor, Clock } from 'lucide-react';

const TopEvents = ({ events = [] }) => {
    return (
        <div className="bg-card border border-border p-6 flex flex-col gap-4 rounded-3xl shadow-sm">
            <h3 className="text-foreground font-heading font-bold">Top Events This Week</h3>
            <div className="flex flex-col gap-3">
                {(events.length > 0 ? events : [
                    { name: "Page View", count: "45,678", trend: "up", change: "12%" },
                    { name: "Button Click", count: "12,345", trend: "up", change: "5%" },
                    { name: "Form Submit", count: "3,456", trend: "down", change: "2%" },
                ]).map((event, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 rounded-xl bg-panel border border-border/50 hover:border-primary/20 transition-all group">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-lg bg-background flex items-center justify-center text-muted-foreground group-hover:bg-primary/20 group-hover:text-primary transition-all">
                                <Monitor size={16} />
                            </div>
                            <span className="text-foreground text-sm font-bold">{event.name}</span>
                        </div>
                        <div className="flex items-center gap-4">
                            <span className="text-foreground font-mono font-bold text-sm">{event.count}</span>
                            <div className={`flex items-center text-[10px] font-bold ${event.trend === 'up' ? 'text-emerald-600' : 'text-red-600'}`}>
                                {event.trend === 'up' ? <ChevronUp size={12} /> : <ChevronDown size={12} />}
                                {event.change}
                            </div>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const ActivityFeed = ({ activities = [] }) => {
    return (
        <div className="bg-card border border-border p-6 flex flex-col gap-4 rounded-3xl shadow-sm">
            <div className="flex items-center justify-between">
                <h3 className="text-foreground font-heading font-bold">Real-time Activity</h3>
                <div className="flex items-center gap-2 px-2 py-1 rounded-full bg-emerald-500/10 border border-emerald-500/20">
                    <div className="w-2 h-2 rounded-full bg-emerald-500"></div>
                    <span className="text-[10px] font-bold text-emerald-600 uppercase tracking-widest">Live</span>
                </div>
            </div>
            <div className="flex flex-col gap-3">
                {(activities.length > 0 ? activities : [
                    { action: "Signed Up", user: "user_4921", time: "2m ago", status: "success" },
                    { action: "Completed Test", user: "user_1023", time: "5m ago", status: "info" },
                ]).map((activity, idx) => (
                    <div key={idx} className="flex items-center justify-between p-3 border-b border-border/50 last:border-0 hover:bg-panel transition-all rounded-lg">
                        <div className="flex items-center gap-3">
                            <div className="w-8 h-8 rounded-full bg-panel flex items-center justify-center text-muted-foreground">
                                <Clock size={14} />
                            </div>
                            <div className="flex flex-col">
                                <span className="text-foreground text-sm font-bold">{activity.action}</span>
                                <span className="text-[10px] text-muted-foreground font-mono">{activity.user}</span>
                            </div>
                        </div>
                        <span className="text-[10px] text-muted-foreground font-mono">{activity.time}</span>
                    </div>
                ))}
            </div>
        </div>
    );
};

const BottomStats = ({ topEvents, recentActivities }) => {
    return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full mt-6 mb-12">
            <TopEvents events={topEvents} />
            <ActivityFeed activities={recentActivities} />
        </div>
    );
};

export default BottomStats;
</file>

<file path="src/components/author/DashboardCharts.jsx">
"use client";
import React from 'react';
import { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar } from 'recharts';

const DashboardCharts = ({ engagementData, sessionData }) => {

    return (
        <div className="grid grid-cols-1 lg:grid-cols-2 gap-6 w-full mt-6">
            {/* Engagement Chart */}
            <div className="bg-card border border-border p-6 h-[400px] flex flex-col rounded-3xl shadow-sm">
                <h3 className="text-foreground font-heading font-bold mb-6">User Engagement Over Time</h3>
                <div className="flex-grow">
                    <ResponsiveContainer width="100%" height="100%">
                        <AreaChart data={engagementData}>
                            <defs>
                                <linearGradient id="colorEngagement" x1="0" y1="0" x2="0" y2="1">
                                    <stop offset="5%" stopColor="#0066CC" stopOpacity={0.25} />
                                    <stop offset="95%" stopColor="#0066CC" stopOpacity={0} />
                                </linearGradient>
                            </defs>
                            <CartesianGrid strokeDasharray="3 3" stroke="rgba(0,0,0,0.03)" vertical={false} />
                            <XAxis dataKey="name" stroke="var(--cyber-gray)" opacity={0.5} fontSize={10} tickLine={false} axisLine={false} />
                            <YAxis stroke="var(--cyber-gray)" opacity={0.5} fontSize={10} tickLine={false} axisLine={false} />
                            <Tooltip
                                contentStyle={{ backgroundColor: '#ffffff', border: '1px solid #e2e8f0', borderRadius: '12px', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.05)' }}
                                itemStyle={{ color: '#005EB8', fontWeight: 'bold' }}
                            />
                            <Area
                                type="monotone"
                                dataKey="val"
                                stroke="#0066CC"
                                strokeWidth={3}
                                fillOpacity={1}
                                fill="url(#colorEngagement)"
                                dot={{ fill: '#0066CC', strokeWidth: 2, r: 4, stroke: '#fff' }}
                                activeDot={{ r: 6, strokeWidth: 0 }}
                            />
                        </AreaChart>
                    </ResponsiveContainer>
                </div>
            </div>

            {/* Session Chart */}
            <div className="bg-card border border-border p-6 h-[400px] flex flex-col rounded-3xl shadow-sm">
                <h3 className="text-foreground font-heading font-bold mb-6">Question Distribution by System</h3>
                <div className="flex-grow">
                    <ResponsiveContainer width="100%" height="100%">
                        <BarChart data={sessionData}>
                            <CartesianGrid strokeDasharray="3 3" stroke="rgba(0,0,0,0.03)" vertical={false} />
                            <XAxis dataKey="name" stroke="var(--cyber-gray)" opacity={0.5} fontSize={10} tickLine={false} axisLine={false} />
                            <YAxis stroke="var(--cyber-gray)" opacity={0.5} fontSize={10} tickLine={false} axisLine={false} />
                            <Tooltip
                                cursor={{ fill: 'rgba(0,0,0,0.02)' }}
                                contentStyle={{ backgroundColor: '#ffffff', border: '1px solid #e2e8f0', borderRadius: '12px', boxShadow: '0 10px 15px -3px rgba(0,0,0,0.05)' }}
                                itemStyle={{ color: '#0D9488', fontWeight: 'bold' }}
                            />
                            <Bar
                                dataKey="val"
                                fill="#0891B2"
                                radius={[6, 6, 0, 0]}
                                barSize={40}
                                activeBar={{ fill: '#0066CC', strokeWidth: 0 }}
                            />
                        </BarChart>
                    </ResponsiveContainer>
                </div>
            </div>
        </div>
    );
};

export default DashboardCharts;
</file>

<file path="src/components/author/KPICard.jsx">
"use client";
import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { TrendingUp, TrendingDown, ChevronDown, ChevronUp } from 'lucide-react';

const KPICard = ({
    title,
    value,
    secondaryValue,
    trend,
    trendData = [],
    icon: Icon,
    color = "text-primary",
    insight = "Performance steady",
    benchmark = "Above industry avg"
}) => {
    const [isExpanded, setIsExpanded] = useState(false);
    const isPositive = !trend.startsWith('-');

    // Custom Sparkline Logic
    const generateSparklinePath = (data) => {
        if (!data || data.length === 0) return "";
        const width = 80;
        const height = 30;
        const padding = 2;

        const min = Math.min(...data);
        const max = Math.max(...data);
        const range = max - min || 1;

        const points = data.map((val, i) => {
            const x = (i / (data.length - 1)) * width;
            const y = height - ((val - min) / range) * (height - padding * 2) - padding;
            return `${x},${y}`;
        });

        return `M ${points.join(' L ')}`;
    };

    // Color map based on specified themes
    const themeColors = {
        "text-[#8B5CF6]": { hex: "#7C3AED", bg: "bg-[#7C3AED]/10", border: "border-[#7C3AED]/20" },
        "text-[#06B6D4]": { hex: "#0284C7", bg: "bg-[#0284C7]/10", border: "border-[#0284C7]/20" },
        "text-[#10B981]": { hex: "#059669", bg: "bg-[#059669]/10", border: "border-[#059669]/20" },
        "text-[#F59E0B]": { hex: "#D97706", bg: "bg-[#D97706]/10", border: "border-[#D97706]/20" },
    };

    const currentTheme = themeColors[color] || { hex: "#8B5CF6", bg: "bg-primary/10", border: "border-primary/20" };

    return (
        <motion.div
            layout
            onClick={() => setIsExpanded(!isExpanded)}
            whileHover={{ y: -4, scale: 1.005 }}
            className={`bg-[#FDFDFD] p-6 flex flex-col gap-4 group cursor-pointer border ${isExpanded ? currentTheme.border : 'border-slate-200'} rounded-3xl shadow-[0_4px_12px_rgba(0,0,0,0.02)] hover:shadow-[0_8px_20px_rgba(0,0,0,0.05)] transition-all duration-300`}
        >
            <div className="flex items-center justify-between">
                <motion.div
                    whileHover={{ rotate: [-10, 10, -10] }}
                    className={`p-3 rounded-2xl ${currentTheme.bg} border border-border/50`}
                >
                    <Icon className={color === "text-primary" ? "text-primary" : color} size={24} />
                </motion.div>

                {/* Custom Sparkline */}
                <div className="h-[30px] w-[80px]">
                    <svg width="80" height="30" viewBox="0 0 80 30" className="overflow-visible">
                        <defs>
                            <linearGradient id={`gradient-${title.replace(/\s+/g, '')}`} x1="0" y1="0" x2="0" y2="1">
                                <stop offset="0%" stopColor={currentTheme.hex} stopOpacity="1" />
                                <stop offset="100%" stopColor={currentTheme.hex} stopOpacity="0.3" />
                            </linearGradient>
                        </defs>
                        <motion.path
                            initial={{ pathLength: 0, opacity: 0 }}
                            animate={{ pathLength: 1, opacity: 1 }}
                            transition={{ duration: 1.5, ease: "easeInOut" }}
                            d={generateSparklinePath(trendData)}
                            fill="none"
                            stroke={`url(#gradient-${title.replace(/\s+/g, '')})`}
                            strokeWidth="2"
                            strokeLinecap="round"
                            strokeLinejoin="round"
                        />
                        {/* Dot indicator on last point */}
                        {trendData.length > 0 && (
                            <motion.circle
                                initial={{ scale: 0 }}
                                animate={{ scale: 1 }}
                                transition={{ delay: 1.5 }}
                                cx="80"
                                cy={30 - ((trendData[trendData.length - 1] - Math.min(...trendData)) / (Math.max(...trendData) - Math.min(...trendData) || 1)) * 26 - 2}
                                r="3"
                                fill={currentTheme.hex}
                                className="pulse-glow"
                            />
                        )}
                    </svg>
                </div>
            </div>

            <div>
                <p className="text-[#1B263B] text-xs font-heading font-black uppercase tracking-widest">{title}</p>
                <div className="flex items-center justify-between mt-1">
                    <div className="flex items-baseline gap-1">
                        <motion.h3
                            initial={{ scale: 0.8, opacity: 0 }}
                            animate={{ scale: 1, opacity: 1 }}
                            className="text-3xl font-mono font-black text-[#1B263B] tracking-tighter"
                        >
                            {value}
                        </motion.h3>
                        {secondaryValue && (
                            <>
                                <span className="text-muted-foreground text-xl font-mono">/</span>
                                <span className="text-xl font-mono font-bold text-primary tracking-tight">{secondaryValue}</span>
                            </>
                        )}
                    </div>
                    <motion.div
                        initial={{ x: 20, opacity: 0 }}
                        animate={{ x: 0, opacity: 1 }}
                        className={`flex items-center gap-1 px-2.5 py-1 rounded-full text-[10px] font-black ${isPositive ? 'bg-emerald-500/10 text-emerald-600' : 'bg-red-500/10 text-red-600'}`}
                    >
                        {isPositive ? <TrendingUp size={12} /> : <TrendingDown size={12} />}
                        {trend}
                    </motion.div>
                </div>
            </div>

            <AnimatePresence>
                {isExpanded && (
                    <motion.div
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: "auto", opacity: 1 }}
                        exit={{ height: 0, opacity: 0 }}
                        transition={{ duration: 0.3, ease: "circOut" }}
                        className="overflow-hidden pt-4 border-t border-slate-100 space-y-3"
                    >
                        <div className="flex flex-col gap-1">
                            <span className="text-[10px] text-slate-400 font-bold uppercase tracking-tighter">Instant Insight</span>
                            <p className="text-xs text-[#1B263B] font-semibold">{insight}</p>
                        </div>
                        <div className="flex items-center justify-between p-3 rounded-2xl bg-[#F0F4F8] border border-slate-200/50">
                            <div className="flex flex-col">
                                <span className="text-[9px] text-muted-foreground font-bold uppercase">Benchmark</span>
                                <span className="text-[10px] text-primary font-bold">{benchmark}</span>
                            </div>
                            <div className="flex items-center gap-1 text-[9px] text-muted-foreground">
                                <span>details</span>
                                <TrendingUp size={10} />
                            </div>
                        </div>
                    </motion.div>
                )}
            </AnimatePresence>

            <div className="flex justify-center">
                <div className={`mt-2 text-gray-600 group-hover:text-gray-400 transition-colors`}>
                    {isExpanded ? <ChevronUp size={14} /> : <ChevronDown size={14} />}
                </div>
            </div>
        </motion.div>
    );
};

export default KPICard;
</file>

<file path="src/components/author/question/ExplanationEditor.jsx">
"use client";

import React, { useRef } from "react";
import { countWords, imageSizeClass, useAutoResizeTextarea } from "@/hooks/author/useQuestionEditor";

export default function ExplanationEditor({ editor }) {
  const {
    explanationCorrect, setExplanationCorrect, explanationCorrectImage, setExplanationCorrectImage,
    explanationWrong, setExplanationWrong, explanationWrongImage, setExplanationWrongImage,
    summary, setSummary, summaryImage, setSummaryImage,
    handleTextareaChange, handleKeyDownSuggested, handleImageChange
  } = editor;

  const expCorrectTextareaRef = useRef(null);
  const expWrongTextareaRef = useRef(null);
  const summaryTextareaRef = useRef(null);

  const expCorrectRef = useAutoResizeTextarea(explanationCorrect);
  const expWrongRef = useAutoResizeTextarea(explanationWrong);
  const summaryRef = useAutoResizeTextarea(summary);

  return (
    <section className="bg-card p-4 rounded-xl border border-border shadow-sm space-y-4">
      <span className="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground font-mono block ml-1">Rationale & Analysis</span>

      {/* Correct Rationale */}
      <div className="space-y-4">
        <label className="text-[10px] font-black uppercase tracking-[0.2em] text-emerald-600 font-mono block ml-1">Correct Rationale</label>
        <textarea
          ref={(el) => {
            expCorrectRef.current = el;
            expCorrectTextareaRef.current = el;
          }}
          value={explanationCorrect}
          onChange={handleTextareaChange(setExplanationCorrect, "correct")}
          onKeyDown={(e) => handleKeyDownSuggested(e, setExplanationCorrect, expCorrectTextareaRef)}
          placeholder="Explain why the correct answer is right..."
          className="bg-background text-foreground border border-border p-5 rounded-2xl w-full resize-none min-h-[160px] focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium focus:border-primary/20"
        />
        <div className="flex justify-between items-center px-1">
          <p className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
            {explanationCorrect.length} Characters ‚Ä¢ {countWords(explanationCorrect)} Words
          </p>
        </div>
        <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 mt-4">
          <div className="flex items-center gap-3">
            <label className="cursor-pointer bg-[#0066CC] hover:bg-[#0055AA] text-white border-2 border-[#0066CC] px-5 py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-md shadow-[#0066CC]/25 hover:shadow-lg hover:shadow-[#0066CC]/35">
              Choose Image
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleImageChange(setExplanationCorrectImage, explanationCorrectImage)}
              />
            </label>
            {explanationCorrectImage.fileName && (
              <span className="text-[10px] font-mono text-primary truncate max-w-[200px] uppercase">
                {explanationCorrectImage.fileName}
              </span>
            )}
          </div>
          <select
            value={explanationCorrectImage.size}
            onChange={(e) => setExplanationCorrectImage({ ...explanationCorrectImage, size: e.target.value })}
            className="bg-background text-foreground border border-border p-2 rounded-xl focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-sm"
          >
            <option value="default">Default</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
        {explanationCorrectImage.data && (
          <div className="relative inline-block mt-4 p-2 bg-background rounded-2xl border border-border shadow-2xl">
            <img src={explanationCorrectImage.data} alt="exp-correct" className={`${imageSizeClass(explanationCorrectImage.size)} rounded-xl`} />
            <button
              type="button"
              onClick={() => setExplanationCorrectImage({ data: "", size: "default", fileName: "" })}
              className="absolute -top-3 -right-3 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-xl shadow-lg hover:bg-red-600 transition-all font-bold border-2 border-card"
            >
              √ó
            </button>
          </div>
        )}
      </div>

      {/* Distractor Analysis */}
      <div className="space-y-3">
        <label className="text-[10px] font-black uppercase tracking-[0.2em] text-amber-600 font-mono block ml-1">Distractor Analysis</label>
        <textarea
          ref={(el) => {
            expWrongRef.current = el;
            expWrongTextareaRef.current = el;
          }}
          value={explanationWrong}
          onChange={handleTextareaChange(setExplanationWrong, "wrong")}
          onKeyDown={(e) => handleKeyDownSuggested(e, setExplanationWrong, expWrongTextareaRef)}
          placeholder="Explain why other choices are incorrect..."
          className="bg-background text-foreground border border-border p-4 rounded-xl w-full resize-none min-h-[80px] focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium focus:border-primary/20 text-sm"
        />
        <div className="flex justify-between items-center px-1">
          <p className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
            {explanationWrong.length} Characters ‚Ä¢ {countWords(explanationWrong)} Words
          </p>
        </div>
      </div>

      {/* Summary */}
      <div className="space-y-3">
        <label className="text-[10px] font-black uppercase tracking-[0.2em] text-[#0066CC] font-mono block ml-1">Key Summary</label>
        <textarea
          ref={(el) => {
            summaryRef.current = el;
            summaryTextareaRef.current = el;
          }}
          value={summary}
          onChange={handleTextareaChange(setSummary, "summary")}
          onKeyDown={(e) => handleKeyDownSuggested(e, setSummary, summaryTextareaRef)}
          placeholder="Brief educational objective..."
          className="bg-background text-foreground border border-border p-4 rounded-xl w-full resize-none min-h-[60px] focus:ring-4 focus:ring-primary/10 outline-none transition-all font-medium focus:border-primary/20 text-sm italic"
        />
        <div className="flex justify-between items-center px-1">
          <p className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
            {summary.length} Characters ‚Ä¢ {countWords(summary)} Words
          </p>
        </div>
      </div>
    </section>
  );
}
</file>

<file path="src/components/author/question/GovernanceTimeline.jsx">
"use client";

import { useState, useEffect } from "react";
import { getGovernanceHistory } from "@/services/question.service";
import { CheckCircle2, Circle, Clock, AlertTriangle, Archive, FileEdit, User } from "lucide-react";

export default function GovernanceTimeline({ versionId, conceptId }) {
    const [history, setHistory] = useState([]);
    const [loading, setLoading] = useState(true);

    useEffect(() => {
        const fetchHistory = async () => {
            setLoading(true);
            try {
                const data = await getGovernanceHistory(versionId, conceptId);
                setHistory(data);
            } catch (err) {
                console.error("Failed to load history:", err);
            } finally {
                setLoading(false);
            }
        };
        fetchHistory();
    }, [versionId, conceptId]);

    const getIcon = (state) => {
        switch (state) {
            case 'draft': return <FileEdit size={14} className="text-amber-500" />;
            case 'review': return <Clock size={14} className="text-blue-500" />;
            case 'approved': return <CheckCircle2 size={14} className="text-indigo-500" />;
            case 'published': return <CheckCircle2 size={14} className="text-emerald-500" />;
            case 'deprecated': return <AlertTriangle size={14} className="text-red-500" />;
            case 'archived': return <Archive size={14} className="text-slate-500" />;
            default: return <Circle size={14} className="text-slate-300" />;
        }
    };

    if (loading) return <div className="p-4 text-center text-xs text-slate-400">Loading history...</div>;
    if (history.length === 0) return <div className="p-4 text-center text-xs text-slate-400">No history events recorded</div>;

    return (
        <div className="space-y-4 p-2">
            <h4 className="text-[10px] font-black uppercase tracking-widest text-slate-400 mb-4 px-2">Governance Audit Trail</h4>
            <div className="relative border-l-2 border-slate-100 ml-4 pl-6 space-y-6">
                {history.map((event, i) => (
                    <div key={event.id || i} className="relative">
                        <div className="absolute -left-[31px] top-0 p-1 bg-white border border-slate-100 rounded-full shadow-sm">
                            {getIcon(event.toState)}
                        </div>
                        <div className="flex flex-col">
                            <div className="flex items-center gap-2">
                                <span className="text-[11px] font-black text-slate-700 uppercase">
                                    {event.fromState ? `${event.fromState} ‚Üí ` : ''}{event.toState}
                                </span>
                                <span className="text-[10px] text-slate-400">
                                    {new Date(event.performedAt).toLocaleString()}
                                </span>
                            </div>
                            <div className="flex items-center gap-1.5 mt-1">
                                <User size={10} className="text-slate-300" />
                                <span className="text-[10px] font-medium text-slate-500">{event.performedBy}</span>
                            </div>
                            {event.notes && (
                                <p className="mt-2 text-[11px] text-slate-600 bg-slate-50 p-2 rounded-lg border border-slate-100 italic">
                                    &quot;{event.notes}&quot;
                                </p>
                            )}
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
}
</file>

<file path="src/components/author/question/MetadataPanel.jsx">
"use client";

import React from "react";

export default function MetadataPanel({ editor }) {
  const {
    isEditing, lastSaved, questionId, setQuestionId, errors, generateAutoId,
    system, setSystem, availableSystems, subject, setSubject, availableSubjects,
    topic, setTopic, correctIndex, setCorrectIndex, tags, setTags,
    references, setReferences, stemImageMode, setStemImageMode,
    explanationImageMode, setExplanationImageMode, saveQuestion, resetForm,
    status, version
  } = editor;

  return (
    <div className="bg-[#FDFDFD] text-[#1B263B] p-3 rounded-xl border border-slate-200 shadow-[0_8px_30px_rgba(0,0,0,0.03)] space-y-3 h-fit sticky top-20">
      <div>
        <h2 className="text-xl font-heading font-black text-[#1B263B] uppercase tracking-tight flex items-center gap-2">
          <span className="w-1.5 h-6 bg-[#0066CC] rounded-full" />
        </h2>
        <div className="flex items-center gap-2 mt-2">
          <span className={`px-2 py-0.5 rounded-full text-[10px] font-black uppercase tracking-widest ${
            status === 'published' ? 'bg-emerald-100 text-emerald-700' : 
            status === 'draft' ? 'bg-amber-100 text-amber-700' : 
            status === 'review' ? 'bg-blue-100 text-blue-700' :
            status === 'approved' ? 'bg-indigo-100 text-indigo-700' :
            status === 'deprecated' ? 'bg-red-100 text-red-700' :
            'bg-slate-100 text-slate-600'
          }`}>
            {status || 'Draft'} v{version || 1}
          </span>
          {lastSaved && (
            <p className="text-[10px] font-black text-muted-foreground uppercase tracking-tight">
              Saved: {new Date(lastSaved).toLocaleTimeString()}
            </p>
          )}
        </div>
      </div>

      <div className="flex items-center gap-2">
        <div className="flex-1">
          <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest block mb-1.5 ml-1">Question ID</label>
          <input
            value={questionId}
            onChange={(e) => setQuestionId(e.target.value.toUpperCase())}
            placeholder="e.g. CV-HTN-001"
            className={`bg-white border border-slate-200 px-4 py-3 rounded-2xl w-full text-[#1B263B] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all shadow-sm ${errors.questionId ? "border-red-500" : ""}`}
            disabled={isEditing}
          />
          {errors.questionId && <p className="text-red-600 text-[10px] font-bold mt-1.5 ml-1">{errors.questionId}</p>}
        </div>
        {!isEditing && (
          <button
            type="button"
            onClick={generateAutoId}
            className="mt-6 px-4 py-3 bg-primary text-white rounded-2xl hover:opacity-90 text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-primary/20"
          >
            Auto
          </button>
        )}
      </div>

      <div className="space-y-2">
        <div>
          <label className="text-[10px] font-bold text-slate-500 uppercase block mb-0.5 ml-1">System</label>
          <select 
            disabled={status !== 'draft'}
            value={system} 
            onChange={(e) => setSystem(e.target.value)} 
            className={`bg-background text-foreground border border-border p-1.5 w-full rounded-lg focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-xs ${errors.system ? "border-red-500" : ""}`}
          >
            <option value="">Select System</option>
            {availableSystems.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
          {errors.system && <p className="text-red-600 text-[10px] mt-0.5">{errors.system}</p>}
        </div>

        <div>
          <label className="text-[10px] font-bold text-slate-500 uppercase block mb-0.5 ml-1">Subject</label>
          <select 
            disabled={status !== 'draft'}
            value={subject} 
            onChange={(e) => setSubject(e.target.value)} 
            className={`bg-background text-foreground border border-border p-1.5 w-full rounded-lg focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-xs ${errors.subject ? "border-red-500" : ""}`}
          >
            <option value="">Select Subject</option>
            {availableSubjects.map(s => <option key={s} value={s}>{s}</option>)}
          </select>
          {errors.subject && <p className="text-red-600 text-[10px] mt-0.5">{errors.subject}</p>}
        </div>

        <div>
          <label className="text-[10px] font-bold text-slate-500 uppercase block mb-0.5 ml-1">Topic</label>
          <input 
            disabled={status !== 'draft'}
            value={topic} 
            onChange={(e) => setTopic(e.target.value)} 
            placeholder="Topic" 
            className="bg-background text-foreground border border-border p-1.5 rounded-lg w-full focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-xs" 
          />
        </div>

        <div>
          <label className="text-[10px] font-bold text-slate-500 uppercase block mb-0.5 ml-1">Correct Answer</label>
          <select 
            disabled={status !== 'draft'}
            value={correctIndex} 
            onChange={(e) => setCorrectIndex(parseInt(e.target.value))} 
            className="bg-background text-foreground border border-border p-1.5 rounded-lg w-full focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-xs text-center font-bold"
          >
            <option value="0">A</option>
            <option value="1">B</option>
            <option value="2">C</option>
            <option value="3">D</option>
            <option value="4">E</option>
          </select>
        </div>
      </div>

      <div className="mt-2">
        <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-0.5 ml-1">Tags</label>
        <input value={tags} onChange={(e) => setTags(e.target.value)} placeholder="heart, surgery, pediatric" className="bg-background border border-border p-1.5 rounded-lg w-full focus:ring-2 focus:ring-primary/20 outline-none transition-all text-xs" />
      </div>

      <div className="mt-2">
        <label className="text-[10px] font-bold text-slate-500 uppercase tracking-widest block mb-0.5 ml-1">References</label>
        <textarea value={references} onChange={(e) => setReferences(e.target.value)} placeholder="Guidelines, Citations..." className="bg-background border border-border p-1.5 rounded-lg w-full h-14 resize-none focus:ring-2 focus:ring-primary/20 outline-none transition-all text-[10px]" />
      </div>

      <div className="mt-3 pt-2 border-t border-border/50">
        <label className="text-[10px] font-black text-gray-400 uppercase tracking-widest mb-1 block">Display Settings</label>
        <div className="space-y-2">
          <div>
            <label className="text-[9px] font-bold text-gray-400 uppercase block">Stem Image</label>
            <select value={stemImageMode} onChange={(e) => setStemImageMode(e.target.value)} className="bg-background text-foreground border border-border p-1.5 rounded-lg w-full focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-[10px]">
              <option value="auto">Show automatically</option>
              <option value="click">Click word to reveal</option>
            </select>
          </div>

          <div>
            <label className="text-[9px] font-bold text-gray-400 uppercase block">Explanations</label>
            <select value={explanationImageMode} onChange={(e) => setExplanationImageMode(e.target.value)} className="bg-background text-foreground border border-border p-1.5 rounded-lg w-full focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-[10px]">
              <option value="auto">Show automatically</option>
              <option value="click">Click word to reveal</option>
            </select>
          </div>
        </div>
      </div>

      <div className="flex flex-col gap-2 mt-4">
                <button 
          type="button"
          onClick={() => saveQuestion(true)}
          className="w-full bg-[#0066CC] text-white p-3 rounded-xl text-[10px] font-black uppercase tracking-widest shadow-lg shadow-[#0066CC]/20 hover:bg-[#0055AA] transition-all active:scale-95 flex items-center justify-center gap-2"
                >
          <div className="w-1.5 h-1.5 rounded-full bg-white animate-pulse" />
          {status === 'published' ? 'Update Published' : 'Publish Live'}
                </button>
                
                <button 
          type="button"
          onClick={() => saveQuestion(false)}
          className="w-full bg-white text-[#1B263B] p-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest border border-[#1B263B]/10 hover:border-[#1B263B]/30 hover:bg-slate-50 transition-all active:scale-95 shadow-sm"
                >
          Save Draft
        </button>

        <button
          type="button"
          onClick={() => {
            if (confirm("Clear entire form? This cannot be undone.")) {
              resetForm();
            }
          }}
          className="w-full mt-2 text-red-500 hover:bg-red-50 p-2 rounded-xl text-[9px] font-black uppercase tracking-widest transition-all"
        >
          Reset Workboard
        </button>
      </div>
    </div>
  );
}
</file>

<file path="src/components/author/question/OptionEditor.jsx">
"use client";

import React from "react";
import { imageSizeClass } from "@/hooks/author/useQuestionEditor";

export default function OptionEditor({ editor }) {
  const {
    choices, setChoices, errors, handleImageChange
  } = editor;

  return (
    <section className="bg-card p-4 rounded-xl border border-border shadow-sm space-y-3">
      <span className="text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground font-mono block ml-1">Distractors & Options</span>
      <div className="space-y-2">
        {choices.map((c, i) => (
          <div key={i} className="border border-border rounded-lg p-2 bg-panel/20 transition-all hover:bg-panel/30 group">
            <div className="flex items-start gap-2">
              <div className="w-7 h-7 flex-shrink-0 flex items-center justify-center bg-primary text-white font-black rounded shadow-md text-sm font-mono">
                {String.fromCharCode(65 + i)}
              </div>
              <div className="flex-1 space-y-1">
                <input
                  value={c.text}
                  onChange={(e) => {
                    const newChoices = [...choices];
                    newChoices[i].text = e.target.value;
                    setChoices(newChoices);
                  }}
                  placeholder={`Option ${String.fromCharCode(65 + i)}`}
                  className={`bg-background text-foreground border border-border px-3 py-1.5 rounded-lg w-full focus:ring-4 focus:ring-primary/10 outline-none transition-all text-sm font-medium ${errors[`choice${i}`] ? "border-red-500" : "focus:border-primary/20"}`}
                />
                {errors[`choice${i}`] && <p className="text-red-600 text-[9px] font-bold uppercase ml-1">{errors[`choice${i}`]}</p>}

                <div className="flex items-center gap-2 mt-1">
                  <label className="cursor-pointer bg-[#0066CC] hover:bg-[#0055AA] text-white px-3 py-1.5 rounded-lg text-[9px] font-black uppercase tracking-widest transition-all">
                    Add Asset
                    <input
                      type="file"
                      accept="image/*"
                      className="hidden"
                      onChange={handleImageChange((val) => {
                        const newChoices = [...choices];
                        newChoices[i].image = { ...newChoices[i].image, ...val };
                        setChoices(newChoices);
                      }, c.image)}
                    />
                  </label>
                  <select
                    value={c.image.size}
                    onChange={(e) => {
                      const newChoices = [...choices];
                      newChoices[i].image.size = e.target.value;
                      setChoices(newChoices);
                    }}
                    className="bg-background text-foreground border border-border px-2 py-1 rounded-lg focus:ring-2 focus:ring-primary/20 outline-none transition-all text-[10px]"
                  >
                    <option value="default">Size</option>
                    <option value="small">S</option>
                    <option value="medium">M</option>
                    <option value="large">L</option>
                  </select>
                  {c.image.fileName && (
                    <span className="text-[9px] font-bold text-primary truncate max-w-[120px] uppercase">
                      {c.image.fileName}
                    </span>
                  )}
                </div>

                {c.image.data && (
                  <div className="relative inline-block mt-4 p-2 bg-background rounded-2xl border border-border shadow-2xl">
                    <img src={c.image.data} alt={`choice-${i}`} className={`${imageSizeClass(c.image.size)} rounded-xl`} />
                    <button
                      type="button"
                      onClick={() => {
                        const newChoices = [...choices];
                        newChoices[i].image = { data: "", size: "default", fileName: "" };
                        setChoices(newChoices);
                      }}
                      className="absolute -top-3 -right-3 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-xl shadow-lg hover:bg-red-600 transition-all font-bold border-2 border-card"
                    >
                      √ó
                    </button>
                  </div>
                )}
              </div>
            </div>
          </div>
        ))}
      </div>
    </section>
  );
}
</file>

<file path="src/components/author/question/StemEditor.jsx">
"use client";

import React, { useRef } from "react";
import { countWords, imageSizeClass, useAutoResizeTextarea } from "@/hooks/author/useQuestionEditor";

export default function StemEditor({ editor }) {
  const {
    stem, setStem, errors, handleTextareaChange,
    handleKeyDownSuggested, stemImage, setStemImage, handleImageChange
  } = editor;

  const stemTextareaRef = useRef(null);
  const stemRef = useAutoResizeTextarea(stem);

  return (
    <section className="bg-white p-4 rounded-xl border border-slate-200 shadow-[0_15px_40px_rgba(0,0,94,0.04)] space-y-2">
      <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#0066CC] font-mono block ml-1">Question Content</span>
      <textarea
        ref={(el) => {
          stemRef.current = el;
          stemTextareaRef.current = el;
        }}
        value={stem}
        onChange={handleTextareaChange(setStem, "stem")}
        onKeyDown={(e) => handleKeyDownSuggested(e, setStem, stemTextareaRef)}
        placeholder="Type question stem here... Use [ to trigger auto-suggest"
        className={`bg-[#FDFDFD] text-[#1B263B] border border-slate-200 p-3 rounded-lg w-full resize-none min-h-[100px] text-sm font-medium focus:ring-8 focus:ring-[#0066CC]/5 focus:border-[#0066CC] outline-none transition-all ${errors.stem ? "border-red-500" : ""}`}
      />
      <div className="flex justify-between items-center px-1">
        <p className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
          {stem.length} Characters ‚Ä¢ {countWords(stem)} Words
        </p>
        {errors.stem && <p className="text-red-600 text-[10px] font-bold uppercase">{errors.stem}</p>}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest block mb-1 ml-1">Stem Image</label>
          <div className="flex items-center gap-4">
            <label className="cursor-pointer bg-[#0066CC] hover:bg-[#0055AA] text-white border-2 border-[#0066CC] px-6 py-3 rounded-xl text-[10px] font-black uppercase tracking-widest transition-all shadow-lg shadow-[#0066CC]/30 hover:shadow-xl hover:shadow-[#0066CC]/40">
              Select Asset
              <input
                type="file"
                accept="image/*"
                className="hidden"
                onChange={handleImageChange(setStemImage, stemImage)}
              />
            </label>
            {stemImage.fileName && (
              <span className="text-[10px] font-black text-primary truncate max-w-[200px] uppercase tracking-widest">
                {stemImage.fileName}
              </span>
            )}
          </div>
        </div>
        <div>
          <label className="text-sm font-medium block mb-1">Image size</label>
          <select value={stemImage.size} onChange={(e) => setStemImage({ ...stemImage, size: e.target.value })} className="bg-background text-foreground border border-border p-2 rounded-xl w-full mt-1 focus:ring-2 focus:ring-primary/20 outline-none transition-all hover:bg-panel/30 text-sm">
            <option value="default">Default</option>
            <option value="small">Small</option>
            <option value="medium">Medium</option>
            <option value="large">Large</option>
          </select>
        </div>
      </div>

      {stemImage.data && (
        <div className="relative inline-block mt-4 p-2 bg-background rounded-2xl border border-border shadow-2xl">
          <img src={stemImage.data} alt="stem" className={`${imageSizeClass(stemImage.size)} rounded-xl`} />
          <button
            type="button"
            onClick={() => setStemImage({ data: "", size: "default", fileName: "" })}
            className="absolute -top-3 -right-3 w-8 h-8 flex items-center justify-center bg-red-500 text-white rounded-xl shadow-lg hover:bg-red-600 transition-all font-bold border-2 border-card"
          >
            √ó
          </button>
        </div>
      )}
    </section>
  );
}
</file>

<file path="src/components/author/QuestionForm.jsx">
"use client";

import { useState } from "react";
import { addQuestion } from "@/services/question.service";
import Question from "@/models/question.model";

// UUID generator
function generateUUID() {
  return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, function(c) {
    const r = (Math.random() * 16) | 0;
    const v = c === "x" ? r : (r & 0x3) | 0x8;
    return v.toString(16);
  });
}

export default function QuestionForm() {
  const [stem, setStem] = useState("");
  const [choices, setChoices] = useState({ A: "", B: "", C: "", D: "", E: "" });
  const [correct, setCorrect] = useState("A");
  const [correctExplanation, setCorrectExplanation] = useState("");
  const [wrongExplanation, setWrongExplanation] = useState("");
  const [summary, setSummary] = useState("");
  const [subject, setSubject] = useState("");
  const [system, setSystem] = useState("");
  const [topic, setTopic] = useState("");

  async function handleSubmit() {
    if (!stem || Object.values(choices).some(c => !c) || !correct) {
      alert("Please fill all required fields");
      return;
    }

    const question = new Question({
      id: generateUUID(),
      stem,
      choices: Object.entries(choices).map(([k, v]) => ({ id: k, text: v })),
      correct,
      correctExplanation,
      wrongExplanation,
      summary,
      subject,
      system,
      topic,
      createdAt: Date.now()
    });

    await addQuestion(question);
    alert("Question added!");
    setStem(""); setChoices({ A: "", B: "", C: "", D: "", E: "" }); setCorrect("A");
    setCorrectExplanation(""); setWrongExplanation(""); setSummary("");
    setSubject(""); setSystem(""); setTopic("");
  }

  return (
    <div className="max-w-xl mx-auto p-4 bg-white border rounded">
      <h2 className="text-xl font-bold mb-4">Create Question</h2>

      <textarea placeholder="Question stem" className="w-full border p-2 mb-2" value={stem} onChange={e => setStem(e.target.value)} />

      {["A","B","C","D","E"].map(letter => (
        <input
          key={letter}
          placeholder={`Choice ${letter}`}
          className="w-full border p-2 mb-2"
          value={choices[letter]}
          onChange={e=>setChoices({...choices,[letter]:e.target.value})}
        />
      ))}

      <select className="w-full border p-2 mb-2" value={correct} onChange={e=>setCorrect(e.target.value)}>
        {["A","B","C","D","E"].map(c=><option key={c}>{c}</option>)}
      </select>

      <textarea placeholder="Why this answer is correct" className="w-full border p-2 mb-2" value={correctExplanation} onChange={e=>setCorrectExplanation(e.target.value)} />
      <textarea placeholder="Why other answers are wrong" className="w-full border p-2 mb-2" value={wrongExplanation} onChange={e=>setWrongExplanation(e.target.value)} />
      <textarea placeholder="Summary / Key points" className="w-full border p-2 mb-2" value={summary} onChange={e=>setSummary(e.target.value)} />

      <input placeholder="Subject" className="w-full border p-2 mb-2" value={subject} onChange={e=>setSubject(e.target.value)} />
      <input placeholder="System" className="w-full border p-2 mb-2" value={system} onChange={e=>setSystem(e.target.value)} />
      <input placeholder="Topic" className="w-full border p-2 mb-2" value={topic} onChange={e=>setTopic(e.target.value)} />

      <button className="w-full bg-black text-white py-2 rounded" onClick={handleSubmit}>Add Question</button>
    </div>
  );
}
</file>

<file path="src/components/author/QuestionList.jsx">
"use client";

import { useEffect, useState } from "react";
import { getAllQuestions } from "@/services/question.service";

export default function QuestionList() {
  const [questions, setQuestions] = useState([]);

  useEffect(() => {
    async function fetchQuestions() {
      try {
        const all = await getAllQuestions();
        setQuestions(Array.isArray(all) ? all : []);
      } catch (err) {
        console.error("Failed to fetch questions:", err);
        setQuestions([]);
      }
    }
    fetchQuestions();
  }, []);

  return (
    <div>
      <h2 className="text-xl font-bold mb-4">All Questions</h2>
      <table className="w-full border">
        <thead>
          <tr className="bg-gray-100">
            <th className="border p-2">ID</th>
            <th className="border p-2">Stem</th>
            <th className="border p-2">Subject</th>
            <th className="border p-2">System</th>
            <th className="border p-2">Topic</th>
          </tr>
        </thead>
        <tbody>
          {questions.map(q => (
            <tr key={q.id}>
              <td className="border p-2 text-xs">{q.id.slice(0, 8)}...</td>
              <td className="border p-2 text-sm">{q.stem.slice(0, 50)}...</td>
              <td className="border p-2">{q.subject}</td>
              <td className="border p-2">{q.system}</td>
              <td className="border p-2">{q.topic}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
}
</file>

<file path="src/components/author/QuickInsights.jsx">
"use client";
import React from 'react';
import { Clock, Smartphone, AlertTriangle } from 'lucide-react';

const QuickInsights = ({ insights = [] }) => {
    if (insights.length === 0) return null;

    return (
        <div className="flex flex-wrap gap-4 items-center">
            {insights.map((insight, idx) => (
                <div
                    key={idx}
                    className={`flex items-center gap-3 px-4 py-2 rounded-full ${insight.bg} border border-${insight.color.replace('text-', '')}/20 transition-all hover:scale-105 cursor-pointer`}
                >
                    <insight.icon className={insight.color} size={16} />
                    <span className={`text-xs font-medium ${insight.color}`}>{insight.label}</span>
                </div>
            ))}
        </div>
    );
};

export default QuickInsights;
</file>

<file path="src/components/student/exam/AnswerOptions.jsx">
"use client";

import React from "react";
import { Check, X } from "lucide-react";
import { useExam } from "@/context/ExamContext";

export default function AnswerOptions() {
  const { 
    currentQuestion: q, selectedAnswer, handleSelectAnswer, 
    strikeouts, toggleStrikeout, isReviewMode, mode, isSubmitted, lockedAnswers 
  } = useExam();

  if (!q) return null;

  return (
    <div className="space-y-4">
      {q.choices.map((choice, i) => {
        const letter = String.fromCharCode(65 + i);
        const isSelected = selectedAnswer === letter;
        const isCorrect = q.correct === letter;
        const isStruck = strikeouts[q.id]?.has(letter);
        const isLocked = !!lockedAnswers[q.id];
        const showFeedback = isReviewMode || (mode === "tutor" && isSubmitted);

        let choiceStyle = "border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/50";
        let radioStyle = "border-zinc-400 dark:border-zinc-600 border-[3px]";

        if (isLocked) choiceStyle = "opacity-80 border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/20 cursor-not-allowed";
        if (isSelected) radioStyle = "border-[#0072bc] bg-[#0072bc]";

        if (showFeedback) {
          choiceStyle = "border-transparent bg-transparent pointer-events-none";
          if (isSelected) radioStyle = "border-[#0072bc] bg-[#0072bc]";
          else if (isCorrect) radioStyle = "border-zinc-300 border-[3px]";
          else radioStyle = "border-zinc-200 border-[2px] opacity-40";
        }

        const dist = q.choiceDistribution || {};
        const totalPicks = Object.values(dist).reduce((a, b) => a + b, 0);
        const pickCount = dist[letter] || 0;
        const percentage = totalPicks > 0 ? Math.round((pickCount / totalPicks) * 100) : 0;

        return (
          <div 
            key={i}
            className={`flex items-start gap-2 rounded-md transition-all border ${choiceStyle} relative group overflow-hidden`}
          >
            {/* Visual Strike overlay */}
            {isStruck && (
              <div className="absolute inset-0 pointer-events-none z-10">
                <div className="absolute w-[120%] h-[1.5px] bg-zinc-300 dark:bg-zinc-700 top-1/2 left-0 -translate-y-1/2 rotate-[2deg] opacity-60" />
              </div>
            )}

            {showFeedback && (
              <div className="w-6 shrink-0 flex items-center justify-center mt-1.5">
                {isCorrect && <Check size={20} className="text-green-500 stroke-[4px]" />}
                {isSelected && !isCorrect && <X size={20} className="text-red-500 stroke-[4px]" />}
              </div>
            )}

            <div className={`flex flex-1 items-start gap-4 p-4 py-2.5 ${isStruck ? 'opacity-40 grayscale-[0.5]' : ''}`}>
              <div
                onClick={(e) => {
                  e.stopPropagation();
                  handleSelectAnswer(q.id, letter);
                }}
                className={`w-5 h-5 rounded-full flex items-center justify-center shrink-0 mt-0.5 cursor-pointer transition-all ${radioStyle}`}
              >
                {isSelected && <div className="w-2 h-2 rounded-full bg-white shadow-sm" />}
              </div>
              <div
                className="flex-1 flex flex-col gap-2 cursor-pointer relative"
                onClick={() => toggleStrikeout(q.id, letter)}
              >
                <span className={`text-[15px] select-none ${isStruck ? 'text-zinc-400 dark:text-zinc-600' : isSelected ? "font-bold text-zinc-900 dark:text-[#f8fafc]" : "font-medium text-zinc-700 dark:text-zinc-300"}`}>
                  {letter}. {choice.text}
                  {showFeedback && (
                    <span className="ml-2 text-zinc-400 dark:text-zinc-500 font-normal text-[14px]">
                      ({percentage}%)
                    </span>
                  )}
                </span>
                {choice.image?.data && (
                  <img src={choice.image.data} alt={`choice-${letter}`} className="max-w-xs rounded border mt-2" />
                )}
              </div>
            </div>
          </div>
        );
      })}
    </div>
  );
}
</file>

<file path="src/components/student/exam/ExamFooter.jsx">
"use client";

import React from "react";
import { Power, Pause, MessageSquare, ChevronLeft, ChevronRight } from "lucide-react";
import { useExam } from "@/context/ExamContext";

export default function ExamFooter() {
  const { 
    isReviewMode, handleEndBlock, handleSuspend, handlePrevious, 
    handleNext, currentIndex, totalQuestions, mode, isSubmitted 
  } = useExam();

  return (
    <footer className="bg-[#002b5c] text-white h-[45px] flex items-center px-0 shrink-0 shadow-[0_-10px_30px_rgba(0,0,0,0.15)] z-50 border-t border-white/10">
      <div className="flex items-center h-full">
        <button
          onClick={() => handleEndBlock()}
          className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group"
        >
          <Power size={18} className="text-white/70 group-hover:text-white" />
          <span className="text-[13px] font-medium leading-none">{isReviewMode ? "Exit" : "End"}</span>
        </button>

        <div className="w-px h-6 bg-white/20" />

        <button
          onClick={() => handleSuspend()}
          className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group"
        >
          <Pause size={18} className="text-white/70 group-hover:text-white" />
          <span className="text-[13px] font-medium leading-none">Suspend</span>
        </button>
      </div>

      <div className="flex-1 flex justify-center h-full">
        <button className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group">
          <MessageSquare size={16} className="text-white/70 group-hover:text-white" />
          <span className="text-[13px] font-medium leading-none">Feedback</span>
        </button>
      </div>

      <div className="flex items-center h-full">
        <button 
          onClick={handlePrevious}
          disabled={currentIndex === 0}
          className="flex items-center gap-2 px-6 h-full hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors group border-l border-white/10"
        >
          <ChevronLeft size={20} />
          <span className="text-[13px] font-medium leading-none">Previous</span>
        </button>
        <button
          onClick={handleNext}
          disabled={currentIndex === totalQuestions - 1 && (mode === "tutor" || isReviewMode)}
          className="flex items-center gap-2 px-6 h-full hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors group border-l border-white/10"
        >
          <span className="text-[13px] font-medium leading-none">Next</span>
          <ChevronRight size={20} />
        </button>
      </div>
    </footer>
  );
}
</file>

<file path="src/components/student/exam/ExamHeader.jsx">
"use client";

import React from "react";
import { 
  Menu, Flag, Maximize2, HelpCircle, ZoomIn, Settings, BarChart2 
} from "lucide-react";
import { useExam } from "@/context/ExamContext";
import { useTimer } from "@/hooks/exam/useTimer";

export default function ExamHeader() {
  const { 
    currentIndex, totalQuestions, currentQuestion, markedQuestions, 
    toggleMark, setShowQuestionList, showQuestionList, mode, elapsedTime,
    isReviewMode, isSubmitted, questions, setElapsedTime, setQuestionDurations,
    modal, isEnding, handleEndBlock
  } = useExam();

  const { formatTime } = useTimer({
    isReviewMode, mode, isSubmitted, questions, currentIndex, totalQuestions,
    setElapsedTime, setQuestionDurations, modalShow: modal.show, isEnding,
    handleAutoEnd: handleEndBlock
  });

  const focusedProduct = typeof window !== 'undefined' ? JSON.parse(localStorage.getItem("medbank_focused_product") || '"default"') : null;

  return (
    <header className="bg-[#002b5c] text-white h-[45px] flex items-center px-4 shrink-0 shadow-lg z-50 font-medium relative border-b border-white/10">
      <div className="flex items-center gap-5">
        <div className="flex gap-4">
          <Menu 
            size={18} 
            className="cursor-pointer hover:text-blue-300 transition-colors opacity-70" 
            onClick={() => setShowQuestionList(!showQuestionList)}
          />
          <div className="flex items-center gap-3 ml-2 border-l border-white/10 pl-4">
            <span className="text-[10px] font-black text-white/40 uppercase tracking-[0.2em]">Item ID:</span>
            <span className="text-[14px] font-bold text-white tracking-tight leading-none">{currentQuestion?.id}</span>
          </div>
        </div>
        <div 
          onClick={toggleMark}
          className="flex items-center gap-1.5 cursor-pointer group ml-2 hover:text-orange-400 transition-colors"
        >
          <Flag size={14} className={markedQuestions.has(currentQuestion?.id) ? "fill-orange-500 text-orange-500" : "text-white/50 group-hover:text-white"} />
          <span className={`text-[11px] font-bold uppercase tracking-wider ${markedQuestions.has(currentQuestion?.id) ? "text-orange-500" : "text-white/80"}`}>Mark</span>
        </div>
      </div>

      <div className="flex-1 flex justify-center items-center gap-4">
        <div className="hidden lg:flex items-center gap-2 px-3 py-1 bg-white/10 rounded-full border border-white/5">
           <div className="w-1.5 h-1.5 rounded-full bg-blue-400 animate-pulse" />
           <span className="text-[9px] font-black uppercase tracking-widest text-blue-300">
             {focusedProduct?.name || 'Standard QBank'}
           </span>
        </div>
        <span className="text-[13px] font-bold">
          {currentIndex + 1}/{totalQuestions}
        </span>
      </div>

      <div className="flex items-center gap-5">
        <div className="flex items-center gap-4 mr-4">
          {[
            { Icon: ZoomIn, label: 'Zoom' },
            { Icon: Settings, label: 'Settings' },
            { Icon: HelpCircle, label: 'Help' },
            { Icon: Maximize2, label: 'Full' }
          ].map((tool, i) => (
            <tool.Icon key={i} size={18} className="cursor-pointer hover:text-blue-300 transition-colors opacity-70" />
          ))}
        </div>

        <div className="flex items-center gap-2 font-mono text-[16px] font-bold tracking-tight bg-black/20 px-3 py-1 rounded border border-white/5">
          {mode === "timed"
            ? formatTime(Math.max(0, (totalQuestions * 90) - elapsedTime))
            : formatTime(elapsedTime)
          }
        </div>
      </div>
    </header>
  );
}
</file>

<file path="src/components/student/exam/ExamModal.jsx">
"use client";

import React from "react";
import { AlertTriangle, Check, LogOut } from "lucide-react";
import { useExam } from "@/context/ExamContext";

export default function ExamModal() {
  const { modal, setModal } = useExam();

  if (!modal.show) return null;

  return (
    <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
      <div 
        className="absolute inset-0 bg-[#001b3d]/60 backdrop-blur-[2px] animate-in fade-in duration-300" 
        onClick={() => setModal({ ...modal, show: false })} 
      />
      <div className="bg-white dark:bg-[#16161a] rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.4)] relative max-w-[400px] w-full overflow-hidden animate-in zoom-in-95 fade-in duration-300 border-none">
        {/* Header section based on type */}
        {modal.type === 'danger' && (
          <div className="bg-[#fffbeb] p-8 flex flex-col items-center border-b border-amber-100">
            <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(217,119,6,0.15)]">
              <AlertTriangle size={32} className="text-amber-500" strokeWidth={2.5} />
            </div>
            <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-[#92400e] text-center">
              {modal.title}
            </h3>
          </div>
        )}
        {modal.type === 'confirm' && (
          <div className="bg-emerald-50 p-8 flex flex-col items-center border-b border-emerald-100">
            <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(16,185,129,0.15)]">
              <Check size={32} className="text-emerald-500" strokeWidth={2.5} />
            </div>
            <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-emerald-800 text-center">
              {modal.title}
            </h3>
          </div>
        )}
        {modal.type === 'info' && (
          <div className="bg-blue-50 p-8 flex flex-col items-center border-b border-blue-100">
            <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(59,130,246,0.15)]">
              <LogOut size={32} className="text-blue-500" strokeWidth={2.5} />
            </div>
            <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-blue-800 text-center">
              {modal.title}
            </h3>
          </div>
        )}

        <div className="p-10 pt-8 bg-[#1e1e24] dark:bg-[#16161a]">
          <p className="text-[15px] font-medium leading-relaxed text-zinc-400 text-center mb-10">
            {modal.message}
          </p>

          <div className="flex flex-col gap-4">
            <button
              onClick={() => {
                modal.onConfirm();
                setModal({ ...modal, show: false });
              }}
              className={`w-full py-4 rounded-xl text-[12px] font-black uppercase tracking-[0.2em] transition-all active:scale-95 shadow-xl ${modal.type === 'danger'
                ? 'bg-red-600 text-white hover:bg-red-700 shadow-red-500/30'
                : modal.type === 'confirm'
                ? 'bg-emerald-600 text-white hover:bg-emerald-700 shadow-emerald-500/30'
                : 'bg-[#1d46af] text-white hover:bg-[#16368a] shadow-blue-500/30'
                }`}
            >
              {modal.confirmText || 'Confirm & Continue'}
            </button>
            <button
              onClick={() => setModal({ ...modal, show: false })}
              className="w-full py-3 text-[11px] font-black uppercase tracking-[0.2em] text-zinc-500 hover:text-zinc-200 transition-colors"
            >
              Go Back
            </button>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/student/exam/QuestionNavigator.jsx">
"use client";

import React from "react";
import { Flag } from "lucide-react";
import { useExam } from "@/context/ExamContext";

export default function QuestionNavigator() {
  const { 
    questions, currentIndex, setCurrentIndex, answers, markedQuestions, 
    showQuestionList, isReviewMode, mode, setSelectedAnswer, setIsSubmitted,
    tutorReveals
  } = useExam();

  return (
    <aside
      className={`bg-[#002b5c] border-r border-[#16368a] transition-all duration-300 overflow-y-auto no-scrollbar flex flex-col ${showQuestionList ? 'w-[64px]' : 'w-0'}`}
    >
      {questions.map((_, idx) => {
        const isCurrent = idx === currentIndex;
        const qItem = questions[idx];
        if (!qItem) return null;
        const qId = qItem.id;
        const userAnswer = answers[qId];
        const hasAnswer = !!userAnswer;
        const isMarked = markedQuestions.has(qId);

        const showResult = isReviewMode || (mode === "tutor" && hasAnswer);
        const isCorrect = showResult && hasAnswer && userAnswer === qItem.correct;

        return (
          <button
            key={idx}
            onClick={() => {
              setCurrentIndex(idx);
              const previousAnswer = answers[questions[idx]?.id] || null;
              setSelectedAnswer(previousAnswer);
              setIsSubmitted(isReviewMode || (mode === "tutor" && !!previousAnswer) || tutorReveals.has(questions[idx]?.id));
            }}
            className={`w-full py-4 flex flex-col items-center justify-center transition-all border-l-4 relative ${isCurrent
              ? 'bg-blue-400/10 border-amber-400'
              : 'border-transparent hover:bg-white/5 hover:text-white'
              }`}
          >
            <div className="flex flex-col items-center gap-0.5">
              <span className={`text-[15px] font-black tracking-tighter ${isCurrent ? 'text-amber-400' : 'text-white/40'}`}>
                {idx + 1}
              </span>
              <div className="flex gap-1 items-center h-1.5">
                {showResult ? (
                  hasAnswer && (
                    <div className={`w-1.5 h-1.5 rounded-full ${isCorrect ? 'bg-emerald-400' : 'bg-red-500'}`} title={isCorrect ? "Correct" : "Incorrect"} />
                  )
                ) : (
                  hasAnswer && (
                    <div className="w-1.5 h-1.5 rounded-full bg-blue-400" title="Answered" />
                  )
                )}
                {isMarked && <Flag size={9} className="text-orange-500 fill-orange-500" title="Marked" />}
              </div>
            </div>
          </button>
        );
      })}
    </aside>
  );
}
</file>

<file path="src/components/student/exam/RationalesPanel.jsx">
"use client";

import React from "react";
import { BarChart2, Clock } from "lucide-react";
import { useExam } from "@/context/ExamContext";

export default function RationalesPanel() {
  const { 
    currentQuestion: q, isReviewMode, mode, isSubmitted, 
    selectedAnswer, questionDurations, answerHistory
  } = useExam();

  if (!(isReviewMode || (mode === "tutor" && isSubmitted)) || !q) return null;

  const dist = q.choiceDistribution || {};
  const totalPicks = Object.values(dist).reduce((a, b) => a + b, 0);
  const correctPicks = dist[q.correct] || 0;
  const percentageCorrect = totalPicks > 0 ? Math.round((correctPicks / totalPicks) * 100) : 0;

  return (
    <div className="p-8 lg:p-10 bg-white dark:bg-zinc-900/50 rounded-2xl border-2 border-zinc-100 dark:border-zinc-800 shadow-sm transition-colors duration-300">
      <div className="space-y-8">
        <div className="max-w-none">
          <div className={`flex flex-wrap items-center gap-6 p-6 rounded-lg mb-8 bg-[#1e1e24] dark:bg-zinc-800/50 border-l-[6px] transition-all ${selectedAnswer === q.correct ? 'border-green-500' : 'border-red-500'}`}>
            <div className="flex flex-col min-w-[100px]">
              <span className={`text-[20px] font-bold ${selectedAnswer === q.correct ? 'text-green-500' : 'text-red-500'}`}>
                {!selectedAnswer ? 'Omitted' : (selectedAnswer === q.correct ? 'Correct' : 'Incorrect')}
              </span>
            </div>
            
            <div className="flex items-center gap-3 border-l border-zinc-700/50 pl-6 h-10">
              <BarChart2 size={24} className="text-zinc-400 opacity-60" strokeWidth={1.5} />
              <div className="flex flex-col">
                <span className="text-zinc-100 dark:text-zinc-200 font-bold leading-none text-lg">
                  {percentageCorrect}%
                </span>
                <span className="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mt-1">Peer Average</span>
              </div>
            </div>

            <div className="flex items-center gap-3 border-l border-zinc-700/50 pl-6 h-10">
              <Clock size={24} className="text-zinc-400 opacity-60" strokeWidth={1.5} />
              <div className="flex flex-col">
                <span className="text-zinc-100 dark:text-zinc-200 font-bold leading-none text-lg">
                  {questionDurations?.[q.id] || 0}s
                </span>
                <span className="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mt-1">Your Time</span>
              </div>
            </div>

            {/* FORENSIC: Volatility & Second-Guessing */}
            {answerHistory?.[q.id]?.length > 1 && (
              <div className="flex items-center gap-3 border-l border-zinc-700/50 pl-6 h-10">
                <div className="flex flex-col">
                  <span className="text-amber-400 font-bold leading-none text-lg">
                    {answerHistory[q.id].length} changes
                  </span>
                  <span className="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mt-1">Volatility</span>
                </div>
              </div>
            )}

            {(() => {
              const history = answerHistory?.[q.id] || [];
              if (history.length < 2) return null;
              const firstChoice = history[0].choice;
              const lastChoice = history[history.length - 1].choice;
              
              if (firstChoice === q.correct && lastChoice !== q.correct) {
                return (
                  <div className="flex items-center gap-3 border-l border-red-500/30 pl-6 h-10">
                    <span className="text-red-400 font-bold text-[12px] uppercase tracking-tighter leading-tight">
                      Second-Guessing:<br/>Right ‚Üí Wrong
                    </span>
                  </div>
                );
              }
              if (firstChoice !== q.correct && lastChoice === q.correct) {
                return (
                  <div className="flex items-center gap-3 border-l border-green-500/30 pl-6 h-10">
                    <span className="text-green-400 font-bold text-[12px] uppercase tracking-tighter leading-tight">
                      Good Recovery:<br/>Wrong ‚Üí Right
                    </span>
                  </div>
                );
              }
              return null;
            })()}
          </div>
          
          <div className="text-[17px] leading-relaxed text-zinc-800 dark:text-zinc-200 space-y-4">
            {q.explanationCorrect?.split('\n').map((para, i) => <p key={i}>{para}</p>)}
          </div>
        </div>

        {q.explanationWrong && (
          <div className="pt-8 border-t border-zinc-100">
            <h4 className="text-[11px] font-black uppercase tracking-widest text-zinc-400 dark:text-zinc-600 mb-4">Incorrect Explanations</h4>
            <div className="text-[15px] leading-relaxed text-zinc-500 dark:text-zinc-400 italic space-y-3">
              {q.explanationWrong.split('\n').map((para, i) => <p key={i}>{para}</p>)}
            </div>
          </div>
        )}

        {q.summary && (
          <div className="mt-8 p-6 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl border border-zinc-100 dark:border-zinc-800">
            <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#002b5c]/50 dark:text-blue-400/30 block mb-3">Key Summary</span>
            <p className="font-bold text-[16px] text-zinc-900 dark:text-zinc-200 italic">&quot;{q.summary}&quot;</p>
          </div>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/student/layout/AccountDropdown.jsx">
"use client";

import React, { useState, useEffect, useContext } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { User, Mail, Calendar, Clock, Settings, Key, ShieldCheck, X, LogOut, CreditCard } from "lucide-react";
import { getUserById, updateUser, getUserSubscriptions } from "@/services/user.service";
import { changeUserPassword } from "@/auth/auth.logic";
import LogoutModal from "@/components/ui/LogoutModal";
import { AppContext } from "@/context/AppContext";

export default function AccountDropdown() {
  const { selectedStudentProduct } = useContext(AppContext);
  const [isOpen, setIsOpen] = useState(false);
  const [showLogoutConfirm, setShowLogoutConfirm] = useState(false);
  const [user, setUser] = useState(null);
  const [activeSubscription, setActiveSubscription] = useState(null);
  const [showPasswordChange, setShowPasswordChange] = useState(false);
  const [passwords, setPasswords] = useState({ current: "", new: "", confirm: "" });
  const [isChanging, setIsChanging] = useState(false);
  const [error, setError] = useState("");

  useEffect(() => {
    const userId = localStorage.getItem("medbank_user");
    if (userId) {
      loadUser(userId);
    }
  }, []);

  useEffect(() => {
    async function fetchSub() {
      const userId = localStorage.getItem("medbank_user");
      const pId = selectedStudentProduct?.id;
      if (userId && pId) {
        try {
          console.log(`[AccountDropdown] Fetching sub for product: ${pId}`);
          const subs = await getUserSubscriptions(userId);
          const currentSub = subs.find(s => 
            String(s.packageId) === String(pId) && 
            s.status === 'active'
          );
          setActiveSubscription(currentSub);
        } catch (e) {
          console.error("Failed to fetch product sub:", e);
        }
      }
    }
    fetchSub();
  }, [selectedStudentProduct]);

  const loadUser = async (id) => {
    if (!id) return setUser(null);
    const data = await getUserById(id);
    setUser(data);
  };



  if (!user) return null;

  const joinDate = new Date(user.createdAt || Date.now());
  
  // Scoped Data: Prefer activeSubscription for the selected product
  const targetSub = activeSubscription || user;
  const isPremium = activeSubscription?.status === 'active' || user.subscriptionStatus === 'active' || user.purchased;

  // Calculate Expiration & Remaining Days
  const trialDuration = user.subscriptionDuration || 3;
  const trialExpirationDate = new Date(joinDate.getTime() + trialDuration * 24 * 60 * 60 * 1000);
  
  const expiresAt = activeSubscription?.expiresAt || user.expiresAt;
  const displayExpiration = expiresAt ? new Date(expiresAt).toLocaleDateString() : trialExpirationDate.toLocaleDateString();
  
  const daysRemaining = expiresAt 
    ? Math.ceil((new Date(expiresAt) - new Date()) / (1000 * 60 * 60 * 24))
    : Math.ceil((trialExpirationDate - new Date()) / (1000 * 60 * 60 * 24));
  
  const totalDuration = activeSubscription?.durationDays || user.subscriptionDuration || 3;

  return (
    <div className="relative">
      {/* Clickable Avatar */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="w-10 h-10 rounded-full bg-[#004e92] text-white flex items-center justify-center font-bold text-sm shadow-md hover:bg-[#003366] transition-all border-2 border-white"
      >
        {user.name?.charAt(0) || "U"}
      </button>

      <AnimatePresence>
        {isOpen && (
          <>
            {/* Backdrop */}
            <div 
              className="fixed inset-0 z-40" 
              onClick={() => setIsOpen(false)}
            />
            
            {/* Dropdown Card */}
            <motion.div
              initial={{ opacity: 0, y: 10, scale: 0.95 }}
              animate={{ opacity: 1, y: 0, scale: 1 }}
              exit={{ opacity: 0, y: 10, scale: 0.95 }}
              className="absolute right-0 mt-4 w-[350px] bg-white dark:bg-[#121214] rounded-3xl shadow-2xl border border-border overflow-hidden z-50 p-6 transition-colors duration-300"
            >
              <div className="flex items-start justify-between mb-6">
                <div className="flex items-center gap-4">
                  <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-[#004e92] to-[#00bbd4] flex items-center justify-center text-white text-xl font-bold shadow-lg">
                    {user.name?.charAt(0) || "U"}
                  </div>
                  <div>
                    <h3 className="font-bold text-zinc-900 dark:text-white">{user.name || "Student"}</h3>
                  </div>
                </div>
                <button onClick={() => setIsOpen(false)} className="text-zinc-300 hover:text-zinc-500">
                  <X size={20} />
                </button>
              </div>

              <div className="space-y-4">
                {/* Details Section */}
                <div className="bg-background rounded-2xl p-4 space-y-4">
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-zinc-600 dark:text-zinc-300 font-bold uppercase tracking-wider flex items-center gap-2">
                      <Mail size={14} /> Email
                    </span>
                    <span className="text-zinc-900 dark:text-zinc-100 font-medium truncate max-w-[150px]">{user.email}</span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-zinc-600 dark:text-zinc-300 font-bold uppercase tracking-wider flex items-center gap-2">
                       <Calendar size={14} /> Joined
                    </span>
                    <span className="text-zinc-900 dark:text-zinc-100 font-medium">{joinDate.toLocaleDateString()}</span>
                  </div>
                   <div className="flex items-center justify-between text-xs">
                    <span className="text-zinc-600 dark:text-zinc-300 font-bold uppercase tracking-wider flex items-center gap-2">
                       <Clock size={14} /> Expires
                    </span>
                    <span className="text-zinc-900 dark:text-zinc-100 font-medium">
                      {displayExpiration} <span className="text-zinc-400 dark:text-zinc-500">({daysRemaining} days remaining)</span>
                    </span>
                  </div>
                  <div className="flex items-center justify-between text-xs">
                    <span className="text-zinc-600 dark:text-zinc-300 font-bold uppercase tracking-wider flex items-center gap-2">
                       <ShieldCheck size={14} /> Status
                    </span>
                    <span className={`font-black uppercase tracking-tighter ${isPremium ? 'text-emerald-500' : 'text-[#004e92]'}`}>
                      {selectedStudentProduct?.name || activeSubscription?.productName || user.productName || (isPremium ? 'Active' : 'Free Trial')}
                    </span>
                  </div>
                </div>

                {/* Account Settings Menu */}
                {/* Account Settings Menu */}
                <div className="grid grid-cols-1 gap-2">
                  <button 
                    onClick={() => window.location.href = '/student/portal'}
                    className="flex items-center justify-between w-full p-3 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-xl transition-all text-sm font-semibold text-zinc-900 dark:text-zinc-100 group"
                  >
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-lg bg-blue-100 text-[#004e92] flex items-center justify-center group-hover:scale-110 transition-transform">
                          <Settings size={16} />
                        </div>
                        Manage Account
                    </div>
                  </button>

                  <button 
                    onClick={() => setShowPasswordChange(!showPasswordChange)}
                    className="flex items-center justify-between w-full p-3 hover:bg-zinc-50 dark:hover:bg-zinc-800 rounded-xl transition-all text-sm font-semibold text-zinc-900 dark:text-zinc-100 group"
                  >
                    <div className="flex items-center gap-3">
                        <div className="w-8 h-8 rounded-lg bg-orange-100 text-orange-600 flex items-center justify-center group-hover:scale-110 transition-transform">
                        <Key size={16} />
                        </div>
                        Change Password
                    </div>
                  </button>
                  
                  {showPasswordChange && (
                    <motion.div
                        initial={{ height: 0, opacity: 0 }}
                        animate={{ height: "auto", opacity: 1 }}
                        className="space-y-3 pt-2 pb-2 px-1"
                    >
                        <div className="space-y-1">
                        <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider ml-1">Current Password</label>
                            <input 
                                type="password"
                                placeholder="Enter current password"
                                value={passwords.current}
                                onChange={(e) => setPasswords({...passwords, current: e.target.value})}
                          className="w-full px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 rounded-lg text-xs text-zinc-900 dark:text-white placeholder:text-zinc-500 focus:outline-none focus:border-[#004e92] dark:focus:border-blue-500 transition-colors"
                            />
                        </div>
                        <div className="space-y-1">
                        <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider ml-1">New Password</label>
                            <input 
                                type="password"
                                placeholder="Enter new password"
                                value={passwords.new}
                                onChange={(e) => setPasswords({...passwords, new: e.target.value})}
                          className="w-full px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 rounded-lg text-xs text-zinc-900 dark:text-white placeholder:text-zinc-500 focus:outline-none focus:border-[#004e92] dark:focus:border-blue-500 transition-colors"
                            />
                        </div>
                        <div className="space-y-1">
                        <label className="text-[10px] font-bold text-muted-foreground uppercase tracking-wider ml-1">Confirm Password</label>
                            <input 
                                type="password"
                                placeholder="Re-enter new password"
                                value={passwords.confirm}
                                onChange={(e) => setPasswords({...passwords, confirm: e.target.value})}
                          className="w-full px-3 py-2 bg-white dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 rounded-lg text-xs text-zinc-900 dark:text-white placeholder:text-zinc-500 focus:outline-none focus:border-[#004e92] dark:focus:border-blue-500 transition-colors"
                            />
                        </div>
                        {error && (
                            <div className="p-2 bg-red-50 text-red-600 rounded text-[10px] font-bold border border-red-100">
                                {error}
                            </div>
                        )}
                        <button 
                            disabled={isChanging}
                            onClick={async () => {
                                setError("");
                                if (!passwords.current || !passwords.new || !passwords.confirm) {
                                    return setError("All fields are required");
                                }
                                if (passwords.new !== passwords.confirm) {
                                    return setError("Passwords do not match");
                                }
                                if (passwords.new.length < 6) {
                                    return setError("Password must be at least 6 characters");
                                }

                                setIsChanging(true);
                                try {
                                    await changeUserPassword(user.id, passwords.current, passwords.new);
                                    alert("Password updated successfully!");
                                    setShowPasswordChange(false);
                                    setPasswords({ current: "", new: "", confirm: "" });
                                } catch (err) {
                                    setError(err?.message || err || "Failed to update password");
                                } finally {
                                    setIsChanging(false);
                                }
                            }}
                            className="w-full bg-[#004e92] text-white py-2 rounded-lg text-xs font-bold disabled:opacity-50"
                        >
                            {isChanging ? "Updating..." : "Update Password"}
                        </button>
                    </motion.div>
                  )}
                </div>
              </div>

              <div className="mt-8 pt-6 border-t border-border">
                 <button 
                   onClick={() => setShowLogoutConfirm(true)}
                  className="flex items-center justify-center gap-2 w-full p-3 text-red-500 hover:bg-red-50 dark:hover:bg-red-900/10 rounded-xl transition-all text-sm font-bold uppercase tracking-[0.2em]"
                 >
                   <LogOut size={16} />
                   Log Out
                 </button>
              </div>
            </motion.div>
          </>
        )}
      </AnimatePresence>

      <LogoutModal 
        isOpen={showLogoutConfirm} 
        onClose={() => setShowLogoutConfirm(false)}
        onConfirm={async () => {
          const { logout } = await import("@/auth/auth.logic");
          logout();
          window.location.href = "/";
        }}
      />
    </div>
  );
}
</file>

<file path="src/components/student/layout/CartDropdown.jsx">
"use client";

import React, { useContext } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { ShoppingCart, X, Trash2, ArrowRight, Activity } from "lucide-react";
import { useRouter } from "next/navigation";
import { AppContext } from "@/context/AppContext";

export default function CartDropdown() {
  const { cart, isCartOpen, setIsCartOpen, removeFromCart } = useContext(AppContext);
  const router = useRouter();

  if (!isCartOpen) return null;

  return (
    <div className="relative">
      <AnimatePresence>
        {isCartOpen && (
          <>
            {/* Backdrop */}
            <div 
              className="fixed inset-0 z-40" 
              onClick={() => setIsCartOpen(false)}
            />
            
            {/* Dropdown Card */}
            <motion.div
              initial={{ opacity: 0, y: 10, scale: 0.95 }}
              animate={{ opacity: 1, y: 0, scale: 1 }}
              exit={{ opacity: 0, y: 10, scale: 0.95 }}
              onClick={(e) => e.stopPropagation()}
              className="absolute right-0 mt-4 w-[380px] bg-white rounded-[2.5rem] shadow-2xl border-2 border-[#1d46af]/20 overflow-hidden z-50 p-8"
            >
              <div className="flex items-center justify-between mb-8 border-b-2 border-slate-100 pb-4">
                <div className="flex items-center gap-3">
                  <div className="w-10 h-10 rounded-xl bg-blue-50 flex items-center justify-center text-[#1d46af]">
                    <ShoppingCart size={20} />
                  </div>
                  <h3 className="font-black text-slate-900 tracking-tight">Your Cart</h3>
                  <span className="bg-slate-100 text-slate-500 text-[10px] font-black px-2 py-0.5 rounded-full uppercase tracking-widest">
                    {cart.reduce((total, item) => total + (item.quantity || 1), 0)} Items
                  </span>
                </div>
                <button 
                  onClick={() => setIsCartOpen(false)} 
                  className="w-8 h-8 rounded-full bg-slate-50 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center border border-slate-200 hover:border-red-200"
                >
                  <X size={18} />
                </button>
              </div>

              {cart.length === 0 ? (
                <div className="py-12 text-center">
                  <div className="w-16 h-16 rounded-full bg-slate-50 flex items-center justify-center mx-auto mb-4 text-slate-200">
                    <ShoppingCart size={32} />
                  </div>
                  <p className="text-slate-400 font-bold text-sm tracking-tight">Your cart is empty</p>
                  <button 
                    onClick={() => {
                        setIsCartOpen(false);
                        router.push('/products');
                    }}
                    className="mt-4 text-[#1d46af] text-xs font-black uppercase tracking-widest hover:underline"
                  >
                    Browse Products
                  </button>
                </div>
              ) : (
                <>
                  <div className="space-y-6 max-h-[300px] overflow-y-auto pr-2 scroll-smooth">
                    {cart.map((item) => (
                      <div key={item.id} className="flex items-center gap-4 group relative p-3 rounded-2xl hover:bg-slate-50 transition-all">
                        <div className="w-16 h-16 rounded-2xl bg-rose-50 flex items-center justify-center text-rose-500 shrink-0 border border-rose-100/50 relative">
                          <Activity size={24} />
                          {(item.quantity || 1) > 1 && (
                            <div className="absolute -top-2 -right-2 w-5 h-5 bg-[#1d46af] text-white text-[10px] font-black rounded-full flex items-center justify-center border-2 border-white">
                                {item.quantity}
                            </div>
                          )}
                        </div>
                        <div className="flex-1 min-w-0">
                          <h4 className="font-black text-slate-800 text-sm truncate">{item.title}</h4>
                          <p className="text-[11px] font-bold text-slate-400 uppercase tracking-tighter mt-0.5">
                            {item.duration || 90}-Day Access {(item.quantity || 1) > 1 && `(x${item.quantity})`}
                          </p>
                          <div className="mt-1">
                            <span className="text-[#1d46af] font-black text-sm">${(item.price * (item.quantity || 1)).toFixed(2)}</span>
                            {(item.quantity || 1) > 1 && <span className="text-slate-400 text-[10px] font-medium ml-2">${item.price}/each</span>}
                          </div>
                        </div>
                        <button 
                          onClick={() => removeFromCart(item.id)}
                          className="w-7 h-7 rounded-full bg-slate-100 hover:bg-red-50 text-slate-400 hover:text-red-500 transition-all flex items-center justify-center border border-slate-200 hover:border-red-200 shrink-0"
                          title="Remove from cart"
                        >
                          <X size={14} />
                        </button>
                      </div>
                    ))}
                  </div>

                  <div className="mt-10 pt-8 border-t border-slate-50">
                    <div className="flex justify-between items-center mb-6">
                      <span className="text-sm font-bold text-slate-400 uppercase tracking-widest">Subtotal</span>
                      <span className="text-2xl font-black text-slate-900 leading-none">
                        ${cart.reduce((total, item) => total + (item.price * (item.quantity || 1)), 0).toFixed(2)}
                      </span>
                    </div>
                    <button 
                      onClick={() => {
                        setIsCartOpen(false);
                        router.push('/checkout');
                      }}
                      className="w-full py-4 bg-blue-50 text-[#1d46af] border-2 border-[#1d46af]/30 text-sm font-black rounded-2xl hover:bg-blue-100 transition-all active:scale-95 flex items-center justify-center gap-3 shadow-xl shadow-blue-500/5"
                    >
                      PROCEED TO CHECKOUT
                      <ArrowRight size={18} />
                    </button>
                    <button 
                      onClick={() => {
                        setIsCartOpen(false);
                        router.push('/products');
                      }}
                      className="w-full mt-3 py-2 text-slate-400 text-xs font-black uppercase tracking-widest hover:text-[#1d46af] transition-colors"
                    >
                      Continue Shopping
                    </button>
                  </div>
                </>
              )}
            </motion.div>
          </>
        )}
      </AnimatePresence>
    </div>
  );
}
</file>

<file path="src/components/student/layout/ProductStreamHeader.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";

export default function ProductStreamHeader() {
  const router = useRouter();
  const [productName, setProductName] = useState("Loading Stream...");

  useEffect(() => {
    const updateProduct = () => {
      const stored = localStorage.getItem("medbank_focused_product");
      if (stored === 'default' || !stored) {
        setProductName("Standard QBank");
      } else {
        try {
          const p = JSON.parse(stored);
          setProductName(p.name || "Premium Stream");
        } catch (e) {
          setProductName("Standard QBank");
        }
      }
    };

    updateProduct();
    
    // Listen for both native storage events (other tabs) and custom events (current tab)
    window.addEventListener("storage", updateProduct);
    window.addEventListener("medbank_product_change", updateProduct);
    
    return () => {
      window.removeEventListener("storage", updateProduct);
      window.removeEventListener("medbank_product_change", updateProduct);
    };
  }, []);

  return (
    <div className="mb-10 flex flex-col gap-1 select-none">
      <div className="flex items-center gap-2 text-[11px] font-[1000] text-[#3b82f6] uppercase tracking-[0.4em] mb-1">
        <div className="w-2 h-2 rounded-full bg-[#3b82f6] shadow-[0_0_8px_#3b82f6] animate-pulse" />
        Stream_Active
      </div>
      <h1 className="text-5xl font-[1000] text-slate-900 dark:text-white italic uppercase tracking-tighter leading-none drop-shadow-sm">
        {productName}
      </h1>
    </div>
  );
}
</file>

<file path="src/components/student/layout/Sidebar.jsx">
"use client";

import { useState, useEffect } from "react";
import Link from "next/link";
import { usePathname } from "next/navigation";
import {
  LayoutDashboard,
  Calendar,
  History,
  BarChart3,
  User,
  LogOut,
  BookOpen,
  PlusSquare,
  Play,
  CheckSquare,
  ChevronRight
} from "lucide-react";
import { logout } from "@/auth/auth.logic";
import LogoutModal from "@/components/ui/LogoutModal";

import { AppContext } from "@/context/AppContext";
import { useContext } from "react";

export default function Sidebar({ isOpen, onClose }) {
  const pathname = usePathname();
  const { selectedStudentProduct } = useContext(AppContext);
  const [qbankOpen, setQbankOpen] = useState(pathname.startsWith("/student/qbank") || pathname.startsWith("/student/tests"));

  const isActive = (path) => pathname.startsWith(path);

  return (
    <>
      {/* Mobile Overlay */}
      {isOpen && (
        <div 
          className="fixed inset-0 bg-black/50 z-40 lg:hidden"
          onClick={onClose}
        />
      )}

      <aside className={`
        fixed lg:static inset-y-0 left-0 z-50 w-64 flex-col bg-[#1d46af] dark:bg-[#08080a] text-white h-screen border-r border-[#16368a] dark:border-zinc-800 transition-all duration-300
        ${isOpen ? "translate-x-0" : "-translate-x-full lg:translate-x-0"}
      `}>
        {/* Brand */}
        <div className="p-6 border-b border-white/10 flex justify-between items-center bg-white/5">
          <div className="flex items-center gap-3">
            <div className="relative w-10 h-10 flex items-center justify-center">
              <div className="absolute inset-0 rounded-full border-[2.5px] border-white"></div>
              <div className="absolute inset-[3px] rounded-full border border-amber-400 opacity-80"></div>
              <div className="absolute top-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
              <div className="absolute bottom-[3px] left-1/2 -translate-x-1/2 w-1.5 h-1.5 rounded-full bg-amber-400"></div>
              <span className="text-white font-black text-[12px] tracking-tighter">MD</span>
            </div>
            <div>
              <h1 className="text-xl font-black tracking-wider uppercase">ISKY<span className="text-amber-400">MD</span></h1>
              <p className="text-[10px] font-bold uppercase tracking-[0.2em] text-white/50 underline decoration-amber-400/30 underline-offset-4">Education Suite</p>
            </div>
          </div>
        </div>

        {/* Navigation */}
        <nav className="flex-1 py-4 space-y-0.5 overflow-y-auto custom-scrollbar">
          <div className="px-6 py-3">
            <p className="text-[10px] font-bold uppercase tracking-widest text-white/40">Navigation</p>
          </div>
          
          <NavItem
            href="/student/dashboard"
            icon={<LayoutDashboard size={18} />}
            label="Dashboard"
            active={isActive("/student/dashboard")}
          />
          
          {selectedStudentProduct && (
            <>
              {/* Expandable QBank */}
              <div>
                <button
                  onClick={() => setQbankOpen(!qbankOpen)}
                  className={`w-full group flex items-center gap-3 px-6 py-3.5 transition-all relative ${isActive("/student/qbank") || isActive("/student/tests")
                    ? "bg-[#16368a] text-white border-l-4 border-amber-400"
                    : "text-white/70 hover:text-white hover:bg-white/5 border-l-4 border-transparent"
                  }`}
                >
                  <span className={`${isActive("/student/qbank") || isActive("/student/tests") ? "text-amber-400" : "text-white/40 group-hover:text-white/70"}`}>
                    <BookOpen size={18} />
                  </span>
                  <span className="text-[13px] font-medium tracking-wide">Question Bank</span>
                  <div className={`ml-auto transition-transform ${qbankOpen ? "rotate-90" : ""}`}>
                    <ChevronRight size={14} className="text-white/30" />
                  </div>
                </button>
                
                {qbankOpen && (
                  <div className="bg-black/20 dark:bg-white/5 py-1 animate-in slide-in-from-top-2 duration-200 transition-colors">
                    <SubNavItem
                      href="/student/qbank/create-test"
                      label="Create Test"
                      active={isActive("/student/qbank/create-test")}
                    />
                    <SubNavItem
                      href="/student/tests"
                      label="Previous Tests"
                      active={isActive("/student/tests")}
                    />
                  </div>
                )}
              </div>

              <NavItem
                href="/student/performance"
                icon={<BarChart3 size={18} />}
                label="Performance"
                active={isActive("/student/performance")}
              />
            </>
          )}
          <NavItem
            href="/student/planner"
            icon={<Calendar size={18} />}
            label="Study Planner"
            active={isActive("/student/planner")}
          />


        </nav>

        <div className="p-6 border-t border-white/5 mt-auto bg-black/10 pt-8">
            <CompactProfileFooter />
        </div>
      </aside>
    </>
  );
}

function NavItem({ href, icon, label, active }) {
  return (
    <Link
      href={href}
      className={`group flex items-center gap-3 px-6 py-3.5 transition-all relative ${active
          ? "bg-[#1d46af]/20 text-white border-l-4 border-amber-400"
          : "text-white/70 hover:text-white hover:bg-white/5 border-l-4 border-transparent"
        }`}
    >
      <span className={`${active ? "text-amber-400" : "text-white/40 group-hover:text-white/70"}`}>
        {icon}
      </span>
      <span className="text-[13px] font-medium tracking-wide">{label}</span>
      {active && (
        <div className="ml-auto">
          <ChevronRight size={14} className="text-white/30" />
        </div>
      )}
    </Link>
  );
}

function SubNavItem({ href, label, active }) {
  const handleClick = () => {
    localStorage.setItem("medbank_last_qbank_view", href);
  };

  return (
    <Link
      href={href}
      onClick={handleClick}
      className={`flex items-center gap-3 pl-14 py-2.5 transition-all ${active
          ? "text-white font-bold"
          : "text-white/50 hover:text-white hover:bg-white/5"
        }`}
    >
      <div className={`w-1 h-1 rounded-full ${active ? "bg-amber-400 scale-125" : "bg-white/20"}`} />
      <span className="text-[12px] tracking-wide">{label}</span>
      {active && <div className="ml-auto pr-6"><ChevronRight size={12} className="text-white/20" /></div>}
    </Link>
  );
}

function CompactProfileFooter() {
  const [user, setUser] = useState(null);

  const loadUser = async (id) => {
    if (!id) {
      setUser(null);
      return;
    }
    const { getUserById } = await import("@/services/user.service");
    const data = await getUserById(id);
    setUser(data);
  };

  useEffect(() => {
    const userId = localStorage.getItem("medbank_user");
    if (userId) {
      loadUser(userId);
    }

    const handleStorageChange = (e) => {
      if (e.key === "medbank_user") {
        if (e.newValue) {
          loadUser(e.newValue);
        } else {
          setUser(null);
        }
      }
    };

    window.addEventListener("storage", handleStorageChange);
    return () => window.removeEventListener("storage", handleStorageChange);
  }, []);

  if (!user) return null;

  const joinDate = new Date(user.createdAt || Date.now());
  const trialExpiration = new Date(joinDate.getTime() + 3 * 24 * 60 * 60 * 1000); // 3 days
  const expirationDate = user.expiresAt ? new Date(user.expiresAt) : trialExpiration;

  return (
    <div className="flex items-center gap-3">
      <div className="w-8 h-8 rounded-md bg-white/10 flex items-center justify-center text-white font-bold text-xs border border-white/5 flex-shrink-0">
        {user.name?.charAt(0) || "U"}
      </div>
      <div className="flex flex-col min-w-0">
        <p className="text-[8px] font-black uppercase tracking-[0.2em] text-white/30">Subscription Expires</p>
        <p className="text-[11px] font-bold text-amber-400 tracking-wide truncate">
          {expirationDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
        </p>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ThemeWrapper.jsx">
"use client";

import { useContext, useEffect } from "react";
import { AppContext } from "@/context/AppContext";

export default function ThemeWrapper({ children }) {
  const { theme } = useContext(AppContext);

  useEffect(() => {
    // Apply theme to html element directly for global scope
    const root = window.document.documentElement;
    root.classList.remove("light", "dark");
    root.classList.add(theme);
    
    // Also set color-scheme for native elements
    root.style.colorScheme = theme;
  }, [theme]);

  return <>{children}</>;
}
</file>

<file path="src/components/ui/ConfirmModal.jsx">
"use client";
import React from "react";
import { motion, AnimatePresence } from "framer-motion";
import { AlertTriangle, X } from "lucide-react";

export default function ConfirmModal({ isOpen, onClose, onConfirm, title, message, confirmText = "Confirm", isDangerous = false }) {
  return (
    <AnimatePresence>
      {isOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="absolute inset-0 bg-[#0f172a]/60 backdrop-blur-sm"
          />
          <motion.div
            initial={{ scale: 0.95, opacity: 0, y: 10 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            exit={{ scale: 0.95, opacity: 0, y: 10 }}
            className="relative w-full max-w-sm bg-white rounded-3xl shadow-2xl p-8 overflow-hidden border border-white/20"
          >
             {/* Decorative background */}
             <div className={`absolute top-0 left-0 w-full h-32 bg-gradient-to-b ${isDangerous ? 'from-red-50/50' : 'from-blue-50/50'} to-transparent pointer-events-none`} />

             <button 
                onClick={onClose}
                className="absolute top-4 right-4 p-2 text-slate-400 hover:text-slate-600 rounded-full hover:bg-slate-100 transition-colors z-20"
             >
                <X size={18} />
             </button>

             <div className="flex flex-col items-center text-center gap-6 relative z-10 pt-2">
               <div className={`w-20 h-20 rounded-full bg-white shadow-xl flex items-center justify-center mb-2 border-4 ${isDangerous ? 'border-red-50' : 'border-blue-50'}`}>
                 <div className={`w-16 h-16 rounded-full flex items-center justify-center text-white shadow-inner ${isDangerous ? 'bg-red-500' : 'bg-blue-500'}`}>
                    <AlertTriangle size={32} strokeWidth={2.5} />
                 </div>
               </div>
               
               <div className="space-y-2">
                  <h3 className="text-2xl font-black text-slate-800 tracking-tight">{title}</h3>
                  <p className="text-slate-500 text-sm font-medium leading-relaxed px-4">
                    {message}
                  </p>
               </div>

               <div className="grid grid-cols-2 gap-3 w-full mt-2">
                 <button
                   onClick={onClose}
                   className="py-3.5 px-4 rounded-2xl bg-slate-100 text-slate-600 font-bold text-xs uppercase tracking-widest hover:bg-slate-200 transition-colors"
                 >
                   Cancel
                 </button>
                 <button
                   onClick={onConfirm}
                   className={`py-3.5 px-4 rounded-2xl font-bold text-xs uppercase tracking-widest text-white shadow-lg transition-all active:scale-95 ${isDangerous ? 'bg-red-500 hover:bg-red-600 shadow-red-500/30' : 'bg-blue-600 hover:bg-blue-700 shadow-blue-500/30'}`}
                 >
                   {confirmText}
                 </button>
               </div>
             </div>
          </motion.div>
        </div>
      )}
    </AnimatePresence>
  );
}
</file>

<file path="src/context/ExamContext.js">
"use client";

import React, { createContext, useContext } from 'react';

const ExamContext = createContext(null);

export function ExamProvider({ children, value }) {
  return (
    <ExamContext.Provider value={value}>
      {children}
    </ExamContext.Provider>
  );
}

export function useExam() {
  const context = useContext(ExamContext);
  if (!context) {
    throw new Error('useExam must be used within an ExamProvider');
  }
  return context;
}
</file>

<file path="src/docs/DELETE_FUNCTIONALITY.md">
# Delete Functionality Documentation

## Overview

This document explains the comprehensive delete functionality implemented for products, questions, and users in the MedBank application. The system provides unified delete handlers with proper API integration, UI state management, and error handling.

## Architecture

### Core Components

1. **`/src/utils/deleteUtils.js`** - Core utility functions for delete operations
2. **`/src/hooks/useDeleteItem.js`** - React hook for managing delete state
3. **Updated Components** - Products, Questions, and Users management pages

### Features

- ‚úÖ Unified delete API for all item types
- ‚úÖ Confirmation dialogs with customizable messages
- ‚úÖ Automatic UI state updates after successful deletion
- ‚úÖ Bulk delete operations with progress tracking
- ‚úÖ Error handling with user-friendly messages
- ‚úÖ Loading states during delete operations
- ‚úÖ Selection management (clear selections after deletion)
- ‚úÖ TypeScript-friendly with proper error types

## Usage

### 1. Basic Delete Operation

```javascript
import { handleDeleteItem } from '@/utils/deleteUtils';

// Delete a single item
const success = await handleDeleteItem('product', productId, {
  onSuccess: (id) => {
    console.log(`Product ${id} deleted successfully`);
    // UI is automatically updated
  },
  onError: (error) => {
    console.error('Delete failed:', error);
  }
});
```

### 2. Using the React Hook (Recommended)

```javascript
import { useDeleteItem } from '@/hooks/useDeleteItem';

function MyComponent() {
  const [items, setItems] = useState([]);
  const [selectedIds, setSelectedIds] = useState(new Set());
  
  const { handleDelete, handleBulkDelete, isDeleting, error } = useDeleteItem(
    'product',
    setItems,
    setSelectedIds
  );

  // Single delete
  const deleteItem = async (id) => {
    await handleDelete(id, {
      onSuccess: () => {
        // Additional custom logic
        console.log('Item deleted');
      }
    });
  };

  // Bulk delete
  const deleteSelected = async () => {
    const ids = Array.from(selectedIds);
    await handleBulkDelete(ids);
  };
}
```

### 3. Bulk Delete Operations

```javascript
import { handleBulkDelete } from '@/utils/deleteUtils';

const result = await handleBulkDelete('question', questionIds, {
  confirmMessage: `Delete ${questionIds.length} questions?`,
  onSuccess: ({ success, failed }) => {
    console.log(`Successfully deleted: ${success}`);
    console.log(`Failed to delete: ${failed}`);
  }
});
```

## API Endpoints

The delete utility automatically calls the appropriate API endpoints:

- **Products**: `DELETE /api/products/:id`
- **Questions**: `DELETE /api/questions/:id`
- **Users**: `DELETE /api/users/:id`

## UI State Management

### Automatic Updates

The delete utilities automatically handle:

1. **Removing items from arrays** - Uses `removeItemsFromArray()` helper
2. **Clearing selections** - Removes deleted items from `selectedIds`
3. **Loading states** - Shows loading indicators during operations
4. **Error states** - Displays error messages when operations fail

### Manual State Updates

If you need custom state management:

```javascript
const { handleDelete } = useDeleteItem('product', setItems);

await handleDelete(id, {
  onSuccess: (deletedId) => {
    // Custom logic beyond automatic updates
    if (editingId === deletedId) {
      setEditingId(null);
    }
  }
});
```

## Error Handling

### Built-in Error Messages

The system provides default error messages for each item type:

- Products: "Failed to delete product"
- Questions: "Failed to delete question"
- Users: "Failed to delete user"

### Custom Error Handling

```javascript
await handleDeleteItem('product', id, {
  onError: (error) => {
    // Custom error handling
    showNotification(error.message, 'error');
    logErrorToService(error);
  }
});
```

## Confirmation Messages

### Default Messages

Each item type has appropriate default confirmation messages:

- **Products**: Warns about active subscriptions
- **Questions**: Permanent deletion warning
- **Users**: Critical data purge warning

### Custom Messages

```javascript
await handleDeleteItem('user', userId, {
  confirmMessage: "Are you sure you want to delete this user? This cannot be undone."
});
```

## Bulk Operations

### Progress Tracking

Bulk delete operations provide detailed feedback:

```javascript
const result = await handleBulkDelete('question', ids);
// result = { success: 5, failed: 1 }
```

### Error Accumulation

Failed bulk operations collect all errors:

```
Delete operation completed.
Success: 8
Failed: 2

Errors:
question 123: Network error
question 456: Permission denied
```

## Implementation Examples

### Products Page

```javascript
// In manage-products/page.jsx
const { handleDelete: deleteProduct } = useDeleteItem(
  'product', 
  setProducts, 
  setSelectedIds
);

const handleDelete = async (id) => {
  await deleteProduct(id, {
    onSuccess: () => {
      // Clear editing state if needed
      if (editingId === id) {
        setEditingId(null);
        setShowCreateForm(false);
      }
    }
  });
};
```

### Questions Page

```javascript
// In manage-questions/page.jsx
const { 
  handleDelete: deleteQuestion, 
  handleBulkDelete: bulkDeleteQuestions 
} = useDeleteItem('question', setQuestions, setSelectedIds);

// Single delete
const handleDelete = async (id) => {
  await deleteQuestion(id);
};

// Bulk delete
const bulkDelete = async () => {
  const ids = Array.from(selectedIds);
  await bulkDeleteQuestions(ids);
};
```

### Users Page

```javascript
// In users/page.jsx
const { handleBulkDelete: bulkDeleteUsers } = useDeleteItem(
  'user',
  setUsers,
  setSelectedIds
);

const handleBulkDelete = async () => {
  const ids = Array.from(selectedIds);
  await bulkDeleteUsers(ids, {
    confirmMessage: `CRITICAL: Delete ${ids.length} accounts?`,
    successMessage: `Purge Complete: ${ids.length} identities erased.`
  });
};
```

## Best Practices

1. **Use the React Hook** - Provides automatic state management
2. **Handle Loading States** - Show loading indicators during operations
3. **Clear Selections** - Automatically handled by the hook
4. **Custom Confirmations** - Use context-appropriate messages
5. **Error Boundaries** - Wrap delete operations in try-catch when needed
6. **Permission Checks** - Ensure users have delete permissions

## Migration Guide

### From Old Implementation

```javascript
// OLD
const handleDelete = async (id) => {
  if (!confirm("Delete this item?")) return;
  try {
    await deleteProduct(id);
    setProducts(prev => prev.filter(p => p.id !== id));
  } catch (err) {
    alert("Failed to delete");
  }
};

// NEW
const { handleDelete } = useDeleteItem('product', setProducts, setSelectedIds);
const handleDelete = async (id) => {
  await handleDelete(id);
};
```

## Testing

### Test Files

- `/src/utils/deleteUtils.test.js` - Example usage and test cases

### Manual Testing Checklist

- [ ] Single item deletion works
- [ ] Confirmation dialogs appear
- [ ] Items are removed from UI after deletion
- [ ] Selections are cleared after deletion
- [ ] Bulk delete operations work
- [ ] Error messages display correctly
- [ ] Loading states show during operations
- [ ] Network errors are handled gracefully

## Future Enhancements

1. **Undo Functionality** - Add temporary restore capability
2. **Soft Delete** - Implement trash/recycle bin
3. **Audit Logging** - Track all delete operations
4. **Batch Progress** - Show progress for large bulk operations
5. **Permission Integration** - Role-based delete permissions
</file>

<file path="src/hooks/author/useQuestionEditor.js">
"use client";

import { useState, useEffect, useCallback, useRef, useContext } from "react";
import { useRouter, useSearchParams } from "next/navigation";
import { addQuestion, getQuestionById, updateQuestion } from "@/services/question.service";
import Question from "@/models/question.model";
import { AppContext } from "@/context/AppContext";

/* ---------- Helpers ---------- */
export function imageSizeClass(size) {
  if (size === "small") return "max-w-240 mx-auto rounded border mt-3 block";
  if (size === "medium") return "max-w-480 mx-auto rounded border mt-3 block";
  if (size === "large") return "max-w-720 mx-auto rounded border mt-3 block";
  return "max-w-full mx-auto rounded border mt-3 block";
}

export function fileToBase64(file, callback) {
  if (!file) return;
  const reader = new FileReader();
  reader.onloadend = () => callback(reader.result);
  reader.readAsDataURL(file);
}

export function countWords(text) {
  return text.trim().split(/\s+/).filter(Boolean).length;
}

export function useAutoResizeTextarea(value) {
  const ref = useRef(null);
  useEffect(() => {
    if (ref.current) {
      ref.current.style.height = "auto";
      ref.current.style.height = ref.current.scrollHeight + "px";
    }
  }, [value]);
  return ref;
}

export function useQuestionEditor() {
  const router = useRouter();
  const searchParams = useSearchParams();
  const { selectedAuthorProduct } = useContext(AppContext);

  const [isAuthorized, setIsAuthorized] = useState(false);
  const [isEditing, setIsEditing] = useState(false);
  const [loading, setLoading] = useState(false);
  const [loadError, setLoadError] = useState(null);
  const [errors, setErrors] = useState({});

  const [questionId, setQuestionId] = useState("");
  const [conceptId, setConceptId] = useState("");
  const [status, setStatus] = useState("draft");
  const [originalCreatedAt, setOriginalCreatedAt] = useState(Date.now());
  const [version, setVersion] = useState(1);
  const [lastSaved, setLastSaved] = useState(null);

  // Meta
  const [system, setSystem] = useState("");
  const [subject, setSubject] = useState("");
  const [topic, setTopic] = useState("");
  const [packageId, setPackageId] = useState("");

  // Content
  const [stem, setStem] = useState("");
  const [stemImage, setStemImage] = useState({ data: "", size: "default", fileName: "" });
  const [choices, setChoices] = useState(
    Array(5).fill().map(() => ({ text: "", image: { data: "", size: "default", fileName: "" } }))
  );
  const [correctIndex, setCorrectIndex] = useState(0);

  // Explanations
  const [explanationCorrect, setExplanationCorrect] = useState("");
  const [explanationCorrectImage, setExplanationCorrectImage] = useState({ data: "", size: "default", fileName: "" });
  const [explanationWrong, setExplanationWrong] = useState("");
  const [explanationWrongImage, setExplanationWrongImage] = useState({ data: "", size: "default", fileName: "" });
  const [summary, setSummary] = useState("");
  const [summaryImage, setSummaryImage] = useState({ data: "", size: "default", fileName: "" });

  const [stemImageMode, setStemImageMode] = useState("auto");
  const [explanationImageMode, setExplanationImageMode] = useState("auto");
  const [references, setReferences] = useState("");
  const [tags, setTags] = useState("");

  // Auto-suggest
  const [suggestion, setSuggestion] = useState(null);
  const [activeField, setActiveField] = useState(null);

  // Taxonomy
  const STANDARD_SYSTEMS = [
    "Cardiovascular", "Respiratory", "Renal", "Gastrointestinal", "Neurology",
    "Musculoskeletal", "Endocrine", "Reproductive", "Hematology", "Dermatology", "Psychiatry", "Multisystem"
  ];
  const STANDARD_SUBJECTS = [
    "Anatomy", "Physiology", "Biochemistry", "Pharmacology", "Pathology",
    "Microbiology", "Immunology", "Behavioral Science", "Genetics", "Biostatistics", "Epidemiology"
  ];
  const [availableSystems, setAvailableSystems] = useState(STANDARD_SYSTEMS);
  const [availableSubjects, setAvailableSubjects] = useState(STANDARD_SUBJECTS);

  useEffect(() => {
    if (selectedAuthorProduct) {
      setAvailableSystems(selectedAuthorProduct.systems?.length > 0 ? selectedAuthorProduct.systems : STANDARD_SYSTEMS);
      setAvailableSubjects(selectedAuthorProduct.subjects?.length > 0 ? selectedAuthorProduct.subjects : STANDARD_SUBJECTS);
      setPackageId(selectedAuthorProduct.id.toString());
    }
  }, [selectedAuthorProduct]);

  useEffect(() => {
    // Legacy Password Check Removed: Authorization now handled by AuthorLayout
    setIsAuthorized(true);
    setSystem(localStorage.getItem("author-system") || "");
    setSubject(localStorage.getItem("author-subject") || "");
  }, [router]);

  useEffect(() => {
    const id = searchParams.get("id");
    if (!id) return;
    setLoading(true);
    (async () => {
      try {
        const q = await getQuestionById(id);
        if (!q) {
          router.push("/author/manage-questions");
          return;
        }
        setIsEditing(true);
        setQuestionId(q.id);
        setConceptId(q.conceptId || "");
        setStatus(q.status || "draft");
        setOriginalCreatedAt(q.createdAt || Date.now());
        setTopic(q.topic || "");
        setStem(q.stem || "");
        setStemImage(q.stemImage || { data: "", size: "default", fileName: "" });
        setSystem(q.system || "");
        setSubject(q.subject || "");
        setStemImageMode(q.stemImageMode || "auto");
        setExplanationImageMode(q.explanationImageMode || "auto");
        const loadedChoices = (q.choices || []).map(ch => ({
          text: ch.text || "",
          image: ch.image || { data: "", size: "default", fileName: "" }
        }));
        while (loadedChoices.length < 5) loadedChoices.push({ text: "", image: { data: "", size: "default", fileName: "" } });
        setChoices(loadedChoices.slice(0, 5));
        setCorrectIndex(q.correct ? q.correct.charCodeAt(0) - 65 : 0);
        setExplanationCorrect(q.explanationCorrect || "");
        setExplanationCorrectImage(q.explanationCorrectImage || { data: "", size: "default", fileName: "" });
        setExplanationWrong(q.explanationWrong || "");
        setExplanationWrongImage(q.explanationWrongImage || { data: "", size: "default", fileName: "" });
        setSummary(q.summary || "");
        setSummaryImage(q.summaryImage || { data: "", size: "default", fileName: "" });
        setReferences(q.references || "");
        setTags(Array.isArray(q.tags) ? q.tags.join(", ") : "");
        setPackageId(q.packageId || "");
        setVersion(q.versionNumber || 1);
      } catch (err) {
        setLoadError("Failed to load question");
      } finally {
        setLoading(false);
      }
    })();
  }, [searchParams, router]);

  useEffect(() => { localStorage.setItem("author-system", system); }, [system]);
  useEffect(() => { localStorage.setItem("author-subject", subject); }, [subject]);

  const validate = useCallback(() => {
    const newErrors = {};
    if (!questionId.trim()) newErrors.questionId = "Question ID required";
    if (!stem.trim()) newErrors.stem = "Question stem required";
    if (!system.trim()) newErrors.system = "System required";
    if (!subject.trim()) newErrors.subject = "Subject required";
    if (!selectedAuthorProduct) newErrors.product = "Product must be selected";
    choices.forEach((c, i) => {
      if (!c.text.trim()) newErrors[`choice${i}`] = `Choice ${String.fromCharCode(65 + i)} required`;
    });
    setErrors(newErrors);
    return Object.keys(newErrors).length === 0;
  }, [questionId, stem, system, subject, choices, selectedAuthorProduct]);

  const saveQuestion = useCallback(async (shouldPublish = false) => {
    const isValid = validate();
    if (!isValid) {
      console.log("Validation errors:", errors);
      alert("Please fix the highlighted errors first.");
      return;
    }



    const action = shouldPublish ? "publish" : "save draft";
    if (!confirm(`Are you sure you want to ${action}?`)) return;

    console.log("Saving question with data:", {
      questionId,
      system,
      subject,
      topic,
      selectedAuthorProduct,
      packageId: selectedAuthorProduct ? selectedAuthorProduct.id : packageId
    });

    const q = {
      id: questionId,
      conceptId: conceptId || null,
      stem,
      stemImage,
      choices: choices.map((c, i) => ({
        id: String.fromCharCode(65 + i),
        text: c.text,
        image: c.image
      })),
      correct: String.fromCharCode(65 + correctIndex),
      explanationCorrect,
      explanationCorrectImage,
      explanationWrong,
      explanationWrongImage,
      summary,
      summaryImage,
      system,
      subject,
      topic: topic.trim() || "Mixed",
      status: shouldPublish ? 'published' : 'draft',
      published: shouldPublish ? 1 : 0,
      stemImageMode,
      explanationImageMode,
      createdAt: originalCreatedAt,
      updatedAt: new Date().toISOString(),
      type: "multiple-choice",
      references,
      tags: tags.split(",").map(t => t.trim()).filter(Boolean),
      versionNumber: version,
      packageId: selectedAuthorProduct ? parseInt(selectedAuthorProduct.id) : (packageId ? parseInt(packageId) : null),
      productId: selectedAuthorProduct ? parseInt(selectedAuthorProduct.id) : (packageId ? parseInt(packageId) : null)
    };

    try {
      setLoading(true);
      let resultId = questionId;
      if (isEditing) {
        await updateQuestion(q);
      } else {
        const created = await addQuestion(q);
        resultId = created.id;
      }

      if (shouldPublish) {
        alert("Published successfully!");
        router.push("/author/manage-questions");
      } else {
        setLastSaved(Date.now());
        alert("Draft saved!");
        if (!isEditing) router.push(`/author/create-question?id=${resultId}`);
      }
    } catch (err) {
      console.error("Save error details:", err);
      alert("Save failed: " + err.message);
    } finally {
      setLoading(false);
    }
  }, [validate, errors, isEditing, status, version, questionId, conceptId, stem, stemImage, choices, correctIndex, explanationCorrect, explanationCorrectImage, explanationWrong, explanationWrongImage, summary, summaryImage, system, subject, topic, stemImageMode, explanationImageMode, originalCreatedAt, references, tags, selectedAuthorProduct, packageId, router]);

  const resetForm = useCallback(() => {
    setQuestionId("");
    setConceptId("");
    setStatus("draft");
    setTopic("");
    setStem("");
    setStemImage({ data: "", size: "default", fileName: "" });
    setChoices(Array(5).fill().map(() => ({ text: "", image: { data: "", size: "default", fileName: "" } })));
    setCorrectIndex(0);
    setExplanationCorrect("");
    setExplanationCorrectImage({ data: "", size: "default", fileName: "" });
    setExplanationWrong("");
    setExplanationWrongImage({ data: "", size: "default", fileName: "" });
    setSummary("");
    setSummaryImage({ data: "", size: "default", fileName: "" });
    setReferences("");
    setTags("");
    setVersion(1);
    setLastSaved(null);
  }, []);

  const generateAutoId = useCallback(() => {
    const random = Math.floor(1000 + Math.random() * 9000).toString();
    setQuestionId(random);
  }, []);

  const handleImageChange = useCallback((setter, current) => (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    fileToBase64(file, (img) => setter({ ...current, data: img, fileName: file.name }));
  }, []);

  const handleTextareaChange = useCallback((setter, fieldName) => (e) => {
    const value = e.target.value;
    setter(value);
    const pos = e.target.selectionStart;
    const textBefore = value.slice(0, pos);
    const openBracket = textBefore.lastIndexOf('[');
    const closeBracket = textBefore.lastIndexOf(']');
    if (openBracket > closeBracket && pos - openBracket < 40) {
      let suggestedKey = "";
      if (fieldName === "stem") suggestedKey = "stem-image";
      else if (fieldName === "correct") suggestedKey = "correct-image";
      else if (fieldName === "wrong") suggestedKey = "wrong-image";
      else if (fieldName === "summary") suggestedKey = "summary-image";
      const inside = textBefore.slice(openBracket + 1);
      setSuggestion(`[${inside}|${suggestedKey}]`);
      setActiveField(fieldName);
    } else {
      setSuggestion(null);
      setActiveField(null);
    }
  }, []);

  const handleKeyDownSuggested = useCallback((e, setter, textareaRef) => {
    if ((e.key === "Tab" || e.key === "Enter") && suggestion && activeField) {
      e.preventDefault();
      const textarea = textareaRef.current;
      if (!textarea) return;
      const pos = textarea.selectionStart;
      const textBefore = textarea.value.slice(0, pos);
      const openIndex = textBefore.lastIndexOf('[');
      if (openIndex !== -1) {
        const newValue = textarea.value.slice(0, openIndex) + suggestion + textarea.value.slice(pos);
        setter(newValue);
        setTimeout(() => {
          textarea.focus();
          const newPos = openIndex + suggestion.length;
          textarea.setSelectionRange(newPos, newPos);
        }, 0);
      }
      setSuggestion(null);
      setActiveField(null);
    }
  }, [suggestion, activeField]);

  return {
    isAuthorized, isEditing, loading, loadError, errors,
    questionId, setQuestionId, originalCreatedAt, version, lastSaved,
    status, conceptId,
    system, setSystem, subject, setSubject, topic, setTopic, packageId,
    stem, setStem, stemImage, setStemImage,
    choices, setChoices, correctIndex, setCorrectIndex,
    explanationCorrect, setExplanationCorrect, explanationCorrectImage, setExplanationCorrectImage,
    explanationWrong, setExplanationWrong, explanationWrongImage, setExplanationWrongImage,
    summary, setSummary, summaryImage, setSummaryImage,
    stemImageMode, setStemImageMode, explanationImageMode, setExplanationImageMode,
    references, setReferences, tags, setTags,
    suggestion, activeField, availableSystems, availableSubjects,
    saveQuestion, resetForm, generateAutoId, handleImageChange, handleTextareaChange, handleKeyDownSuggested
  };
}
</file>

<file path="src/hooks/exam/useTimer.js">
"use client";

import { useEffect, useCallback } from "react";

export function useTimer({
  isReviewMode,
  mode,
  isSubmitted,
  questions,
  currentIndex,
  totalQuestions,
  elapsedTime,
  setElapsedTime,
  setQuestionDurations,
  modalShow,
  isEnding,
  handleAutoEnd
}) {
  
  // Timer interval
  useEffect(() => {
    if (isReviewMode || isEnding) return;
    if (mode === "tutor" && isSubmitted) return;

    const timer = setInterval(() => {
      setElapsedTime(prev => prev + 1);

      const currentQId = questions[currentIndex]?.id;
      if (currentQId) {
        setQuestionDurations(prev => ({
          ...prev,
          [currentQId]: (prev[currentQId] || 0) + 1
        }));
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [isReviewMode, mode, isSubmitted, questions, currentIndex, setElapsedTime, setQuestionDurations, isEnding]);

  // Auto-end for Timed Mode
  useEffect(() => {
    if (mode === "timed" && !isReviewMode && totalQuestions > 0 && !modalShow && !isEnding) {
      const timeLimit = totalQuestions * 90;
      if (elapsedTime >= timeLimit) {
        handleAutoEnd(true);
      }
    }
  }, [elapsedTime, mode, isReviewMode, totalQuestions, modalShow, isEnding, handleAutoEnd]);

  const formatTime = useCallback((seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  }, []);

  return { formatTime };
}
</file>

<file path="src/lib/cognition-engine.js">
/**
 * cognition-engine.js
 * 
 * Core intelligence layer for inferring behavioral traits and readiness 
 * from immutable forensic logs.
 */

/**
 * Analyze a single exam session for behavioral signals.
 * @param {Object} test - The full test object with sessionState.logs
 */
export function analyzeSessionBehavior(test) {
    const logs = test.sessionState?.logs || [];
    if (logs.length === 0) return null;

    let secondGuesses = 0; // Right -> Wrong
    let recoveries = 0;    // Wrong -> Right
    let impulsivityCount = 0; // Wrong under 10s
    let totalQuestions = test.questions.length;
    
    const questionEvents = {}; // Map of qId -> list of selection logs

    logs.forEach(log => {
        if (log.action === 'select_answer') {
            if (!questionEvents[log.questionId]) questionEvents[log.questionId] = [];
            questionEvents[log.questionId].push(log);
        }
    });

    Object.entries(questionEvents).forEach(([qId, events]) => {
        if (events.length < 2) return;

        const q = test.questions.find(item => item.id === qId);
        if (!q) return;

        const firstChoice = events[0].choice;
        const lastChoice = events[events.length - 1].choice;

        if (firstChoice === q.correct && lastChoice !== q.correct) {
            secondGuesses++;
        } else if (firstChoice !== q.correct && lastChoice === q.correct) {
            recoveries++;
        }

        // Impulsivity: Incorrect choice made very quickly (under 10s of cumulative time for that Q)
        // Note: For truly deep impulsivity we'd need per-log cumulative timers, 
        // but here we'll use a heuristic based on the first event's offset if available.
        if (events[0].offset < 10000 && firstChoice !== q.correct && events.length === 1) {
            impulsivityCount++;
        }
    });

    // Fatigue Detection: Compare accuracy in first half vs second half
    const halfIndex = Math.floor(test.questions.length / 2);
    const firstHalf = test.questions.slice(0, halfIndex);
    const secondHalf = test.questions.slice(halfIndex);

    const firstHalfCorrect = firstHalf.filter(q => q.userAnswer === q.correct).length;
    const secondHalfCorrect = secondHalf.filter(q => q.userAnswer === q.correct).length;

    const firstHalfAccuracy = firstHalf.length > 0 ? firstHalfCorrect / firstHalf.length : 0;
    const secondHalfAccuracy = secondHalf.length > 0 ? secondHalfCorrect / secondHalf.length : 0;
    const fatigueFactor = firstHalfAccuracy > 0 ? Math.max(0, (firstHalfAccuracy - secondHalfAccuracy) / firstHalfAccuracy) : 0;

    return {
        overthinkingScore: secondGuesses / (totalQuestions || 1),
        recoveryScore: recoveries / (totalQuestions || 1),
        impulsivityScore: impulsivityCount / (totalQuestions || 1),
        fatigueFactor: fatigueFactor
    };
}

/**
 * Calculate pass probability based on accuracy, unique exposure, and stability.
 */
export function calculateReadiness(stats) {
    const { 
        accuracy, // 0 to 1
        uniqueExposure, // % of unique questions used (0 to 1)
        performanceStability // inverse of variance (0 to 1) 
    } = stats;

    // Weighting: Accuracy (60%), Stability (20%), Exposure (20%)
    // High exposure with low accuracy = "memorized pool" penalty
    const exposureWeight = uniqueExposure < 0.3 ? 0.5 : 1.0; 
    const baseScore = (accuracy * 0.6) + (performanceStability * 0.2) + (uniqueExposure * 0.2);
    
    return Math.round(baseScore * exposureWeight * 100);
}
</file>

<file path="src/models/planner.model.js">
// Planner/Study Plan model schema
export class StudyPlan {
  constructor(id, userId, goals = [], schedule = {}) {
    this.id = id;
    this.userId = userId;
    this.goals = goals;
    this.schedule = schedule;
    this.createdAt = new Date();
    this.updatedAt = new Date();
  }
}
</file>

<file path="src/models/test.model.js">
// Test model schema
export class Test {
  constructor(id, title, questions = [], duration, createdBy) {
    this.id = id;
    this.title = title;
    this.questions = questions;
    this.duration = duration;
    this.createdBy = createdBy;
    this.createdAt = new Date();
    this.updatedAt = new Date();
  }
}
</file>

<file path="src/services/communications.service.js">
// communications.service.js

const mockQA = [
    { id: 'QA-101', student: 'Sarah J.', topic: 'Pharmacology - HTN', message: 'Why is lisinopril preferred over ARBs in this specific case?', status: 'urgent', date: new Date().toISOString() },
    { id: 'QA-102', student: 'Michael R.', topic: 'Anatomy - Neuro', message: 'The crossing of fibers in the medulla is confusing in diagram 4.2.', status: 'new', date: new Date().toISOString() },
    { id: 'QA-103', student: 'Elena T.', topic: 'Biochem - TCA', message: 'Is there a pneumonic for the rate-limiting enzymes?', status: 'answered', date: new Date().toISOString() }
];

export async function getQAItems() {
    return new Promise(resolve => setTimeout(() => resolve(mockQA), 500));
}

export async function sendAnnouncement(title, body, target = 'all') {
    console.log(`[Announcement] ${title}: ${body} (Target: ${target})`);
    return new Promise(resolve => setTimeout(() => resolve({ success: true }), 500));
}
</file>

<file path="src/services/performance.service.js">
// performance.service.js - Real product-scoped analytics

/**
 * Fetch product-scoped performance statistics.
 * @param {string} packageId - Required product ID
 * @returns {Promise<Object>} Performance stats for the specified product
 */
export async function getPerformanceStats(packageId) {
  if (!packageId) {
    console.warn('getPerformanceStats called without packageId');
    return { 
      error: 'No product selected',
      revenue: { total: 0, thisMonth: 0, trend: '0%' },
      students: { total: 0, active: 0, growth: '0%' },
      charts: { revenueHistory: [], enrollments: [] }
    };
  }

  try {
    const res = await fetch(`/api/analytics?type=dashboard&packageId=${packageId}`);
    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData.error || 'Failed to fetch analytics');
    }
    return await res.json();
  } catch (error) {
    console.error('getPerformanceStats error:', error);
    return { 
      revenue: { total: 0, thisMonth: 0, trend: '0%' },
      students: { total: 0, active: 0, growth: '0%' },
      charts: { revenueHistory: [], enrollments: [] }
    };
  }
}

/**
 * Fetch product-scoped engagement data.
 * @param {string} packageId - Required product ID
 */
export async function getEngagementStats(packageId) {
  if (!packageId) {
    return { error: 'No product selected', data: [] };
  }

  try {
    const res = await fetch(`/api/analytics?type=engagement&packageId=${packageId}`);
    if (!res.ok) throw new Error('Failed to fetch engagement data');
    return await res.json();
  } catch (error) {
    console.error('getEngagementStats error:', error);
    return { data: [] };
  }
}

/**
 * Fetch student cognition profile for a specific product.
 * @param {string} userId - User ID
 * @param {string} packageId - Required product ID
 */
export async function getCognitionProfile(userId, packageId) {
  if (!userId || !packageId) {
    return { readinessScore: 0, overthinkingIndex: 0, impulsivityIndex: 0, fatigueFactor: 0 };
  }

  try {
    const res = await fetch(`/api/analytics?type=cognition&userId=${userId}&packageId=${packageId}`);
    if (!res.ok) throw new Error('Failed to fetch cognition profile');
    return await res.json();
  } catch (error) {
    console.error('getCognitionProfile error:', error);
    return { readinessScore: 0, overthinkingIndex: 0, impulsivityIndex: 0, fatigueFactor: 0 };
  }
}
</file>

<file path="src/services/product.service.js">
// product.service.js - API client service
const API_BASE = '/api/products';

export async function getAllProducts() {
  try {
    const res = await fetch(API_BASE);
    if (!res.ok) throw new Error('Failed to fetch products');
    return await res.json();
  } catch (error) {
    console.error('getAllProducts error:', error);
    return [];
  }
}

export async function getPublishedProducts() {
  try {
    const res = await fetch(`${API_BASE}?type=published`);
    if (!res.ok) throw new Error('Failed to fetch published products');
    const data = await res.json();
    console.log('[ProductService] getPublishedProducts result:', data);
    return data;
  } catch (error) {
    console.error('getPublishedProducts error:', error);
    return [];
  }
}

export async function getProductById(id) {
  try {
    const res = await fetch(`${API_BASE}?id=${id}`);
    if (!res.ok) throw new Error('Failed to fetch product');
    return await res.json();
  } catch (error) {
    console.error('getProductById error:', error);
    return null;
  }
}

// New function to get product including deleted ones (for existing user access)
export async function getProductByIdIncludeDeleted(id) {
  try {
    const res = await fetch(`${API_BASE}?id=${id}&includeDeleted=true`);
    if (!res.ok) throw new Error('Failed to fetch product');
    return await res.json();
  } catch (error) {
    console.error('getProductByIdIncludeDeleted error:', error);
    return null;
  }
}


export async function addProduct(product) {
  try {
    // Force is_published to 1 (true)
    const productData = { ...product, is_published: 1 };
    
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(productData)
    });
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Failed to add product');
    }
    return await res.json();
  } catch (error) {
    console.error('addProduct error:', error);
    throw error;
  }
}

export async function updateProduct(product) {
  try {
    const res = await fetch(API_BASE, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(product)
    });
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Failed to update product');
    }
    return await res.json();
  } catch (error) {
    console.error('updateProduct error:', error);
    throw error;
  }
}

export async function deleteProduct(id) {
  try {
    const res = await fetch(API_BASE, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Failed to delete product');
    }
    return true;
  } catch (error) {
    console.error('deleteProduct error:', error);
    throw error;
  }
}
</file>

<file path="src/utils/createTestHelpers.js">
/**
 * Shared constants and utility functions for Create Test functionality
 */

export const SUBJECTS = ["Anatomy", "Physiology", "Biochemistry", "Pathology", "Microbiology", "Pharmacology", "Public Health", "Behavioral Science"];

export const SYSTEMS = ["Cardiovascular", "Respiratory", "Gastrointestinal", "Renal", "Neurology", "Endocrine", "Hematology & Oncology", "Musculoskeletal & Integumentary", "Reproductive", "Multi-system"];

export const STATUS_FILTERS = ["Unused", "Incorrect", "Marked", "Omitted", "Correct"];

/**
 * Shuffles questions and returns a set of IDs
 * @param {Array} pool - The pool of questions to select from
 * @param {number} count - Number of questions to select
 * @returns {Array} - Array of question IDs
 */
export const selectRandomQuestions = (pool, count) => {
  const shuffled = [...pool].sort(() => 0.5 - Math.random());
  return shuffled.slice(0, count).map(q => q.id);
};

/**
 * Generates a unique test ID scoped by user ID
 * @param {string} userId - Current user ID
 * @returns {string} - Unique test ID
 */
export const generateTestId = (userId) => {
  return `${userId}_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
};

/**
 * Validates and retrieves the persistent test ID for the session
 * @param {string} userId - Current user ID
 * @returns {string} - Persistent or new test ID
 */
export const getPersistentTestId = (userId) => {
  if (typeof window === 'undefined') return '';
  
  let testId = sessionStorage.getItem('current_test_id');
  if (!testId || !testId.startsWith(userId + '_')) {
    testId = generateTestId(userId);
    sessionStorage.setItem('current_test_id', testId);
  }
  return testId;
};
</file>

<file path="src/utils/crypto.js">
export async function hashPassword(password) {
  const enc = new TextEncoder().encode(password);
  const buffer = await crypto.subtle.digest("SHA-256", enc);
  return Array.from(new Uint8Array(buffer))
    .map(b => b.toString(16).padStart(2, "0"))
    .join("");
}
</file>

<file path="src/utils/helpers.js">
// Helper utilities
export function formatDate(date) {
  return new Date(date).toLocaleDateString();
}

export function formatTime(seconds) {
  const hours = Math.floor(seconds / 3600);
  const minutes = Math.floor((seconds % 3600) / 60);
  const secs = seconds % 60;
  return `${hours}h ${minutes}m ${secs}s`;
}

export function capitalizeString(str) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

export function truncateString(str, length) {
  return str.length > length ? str.substring(0, length) + '...' : str;
}

export function isEmpty(obj) {
  return Object.keys(obj).length === 0;
}
</file>

<file path="package.json">
{
  "name": "medbank",
  "version": "1.0.0",
  "private": true,
  "description": "Medical question bank and study platform",
  "scripts": {
    "dev": "next dev --webpack",
    "build": "next build",
    "start": "next start",
    "lint": "eslint ."
  },
  "dependencies": {
    "better-sqlite3": "^12.6.2",
    "framer-motion": "^12.26.2",
    "lucide-react": "^0.562.0",
    "next": "16.1.1",
    "react": "19.2.3",
    "react-dom": "19.2.3",
    "recharts": "^3.6.0",
    "uuid": "^13.0.0"
  },
  "devDependencies": {
    "@tailwindcss/postcss": "^4",
    "eslint": "^9",
    "eslint-config-next": "16.1.1",
    "tailwindcss": "^4"
  }
}
</file>

<file path="src/app/api/tests/[id]/route.js">
import { NextResponse } from 'next/server';
import { getTestById } from '@/lib/server-db';

export async function GET(request, { params }) {
  try {
    const { id } = await params;
    const { searchParams } = new URL(request.url);
    const packageId = searchParams.get('packageId');

    // 1. Try to fetch as a Test Attempt first (New behavior)
    const { getTestAttempt } = await import('@/lib/server-db');
    const attempt = getTestAttempt(id);
    if (attempt) {
      console.log(`[API] Returning test attempt ${id}`);
      return NextResponse.json(attempt);
    }

    // 2. Fallback to standard test lookup
    const test = getTestById(id, packageId || 'all');
    
    if (!test) {
      return NextResponse.json({ error: 'Test or Attempt not found' }, { status: 404 });
    }
    
    return NextResponse.json(test);
  } catch (error) {
    console.error('Get test error:', error);
    return NextResponse.json({ error: 'Failed to get test' }, { status: 500 });
  }
}
</file>

<file path="src/app/api/users/route.js">
import { NextResponse } from 'next/server';
import { getAllUsers, getUserById, updateUser, deleteUser, createNotification } from '@/lib/server-db';

// GET /api/users - Get all users or single user by id
export async function GET(request) {
  try {
    const { searchParams } = new URL(request.url);
    const id = searchParams.get('id');
    
    if (id) {
      const user = getUserById(id);
      if (!user) {
        return NextResponse.json({ error: 'User not found' }, { status: 404 });
      }
      const { passwordHash: _, ...safeUser } = user;
      return NextResponse.json(safeUser);
    }
    
    const users = getAllUsers().map(({ passwordHash: _, ...user }) => user);
    return NextResponse.json(users);
  } catch (error) {
    console.error('Get users error:', error);
    return NextResponse.json({ error: 'Failed to get users' }, { status: 500 });
  }
}

// PUT /api/users - Update a user
export async function PUT(request) {
  try {
    const updates = await request.json();
    console.log('API: Processing user update for ID:', updates.id);
    
    if (!updates.id) {
      console.error('API: Update failed - missing user ID');
      return NextResponse.json({ error: 'User id required' }, { status: 400 });
    }
    
    // Fetch existing user to preserve fields not sent by client (like passwordHash)
    const existingUser = getUserById(updates.id);
    if (!existingUser) {
      console.error('API: Update failed - user not found in DB:', updates.id);
      return NextResponse.json({ error: 'User not found' }, { status: 404 });
    }

    // Merge updates into existing user
    const updatedUser = {
      ...existingUser,
      ...updates,
      // Ensure we don't accidentally unset stats if not provided
      stats: updates.stats || existingUser.stats
    };

    // Detect purchase activation
    if (updates.activatedByPurchase && !existingUser.activatedByPurchase) {
        createNotification(
            'purchase',
            `Subscription activated: ${existingUser.name} (${existingUser.email})`,
            existingUser.id,
            { email: existingUser.email, name: existingUser.name, type: 'paid' }
        );
    }
    
    try {
      const saved = updateUser(updatedUser);
      console.log('API: User updated successfully in DB');
      const { passwordHash: _, ...safeUser } = saved;
      return NextResponse.json(safeUser);
    } catch (dbError) {
      console.error('API: Database update error:', dbError);
      return NextResponse.json({ error: 'Database update failed', details: dbError.message }, { status: 500 });
    }
  } catch (error) {
    console.error('API: Unexpected update error:', error);
    return NextResponse.json({ error: 'Failed to update user' }, { status: 500 });
  }
}

// DELETE /api/users - Delete a user
export async function DELETE(request) {
  try {
    const { id } = await request.json();
    
    if (!id) {
      return NextResponse.json({ error: 'User id required' }, { status: 400 });
    }
    
    try {
      const result = deleteUser(id);
      return NextResponse.json({ success: true, message: 'User permanently deleted' });
    } catch (dbError) {
      console.error('Delete user DB error:', dbError);
      return NextResponse.json({ error: dbError.message || 'Failed to delete user from database' }, { status: 500 });
    }
  } catch (error) {
    console.error('Delete user error:', error);
    return NextResponse.json({ error: 'Failed to delete user' }, { status: 500 });
  }
}
</file>

<file path="src/app/author/layout.jsx">
"use client";

import Link from "next/link";
import { usePathname, useRouter } from "next/navigation";
import { useEffect, useState, useContext } from "react";
import { motion, AnimatePresence } from "framer-motion";
import { AppContext } from "@/context/AppContext";
import {
  BarChart3,
  Users,
  TrendingUp,
  Filter,
  Database,
  LayoutDashboard,
  LogOut,
  Shield,
  ChevronDown,
  MessageSquare,
  DollarSign,
  Settings,
  Target,
  PieChart,
  Megaphone,
  LifeBuoy,
  Wrench,
  Package
} from "lucide-react";
import AuthorHeader from "@/components/author/AuthorHeader";

export default function AuthorLayout({ children }) {
  const pathname = usePathname();
  const router = useRouter();
  const [loading, setLoading] = useState(true);
  const [openDropdown, setOpenDropdown] = useState(null);
  const { sidebarCollapsed, setSidebarCollapsed } = useContext(AppContext);

  useEffect(() => {
    // Responsive collapse
    const handleResize = () => {
      if (window.innerWidth < 1200) {
        setSidebarCollapsed(true);
      }
    };

    window.addEventListener("resize", handleResize);
    if (window.innerWidth < 1200) setSidebarCollapsed(true); // Initial check

    return () => window.removeEventListener("resize", handleResize);
  }, []);

  const navItems = [
    { label: 'Overview', icon: LayoutDashboard, href: '/author' },
    {
      label: 'Question Bank',
      icon: Database,
      href: '/author/manage-questions',
      children: [
        { label: 'Management', href: '/author/manage-questions' },
        { label: 'Create Question', href: '/author/create-question' },
      ]
    },
    { label: 'Users', icon: Users, href: '/author/users' },
    { label: 'Activity', icon: TrendingUp, href: '/author/activity' },
    { label: 'Products', icon: Package, href: '/author/manage-products' },
    { label: 'Tools', icon: Wrench, href: '/author/tools' },
    { label: 'Settings', icon: Settings, href: '/author/settings' },
  ];

  useEffect(() => {
    // Role-based security check for Author Portal
    const checkAuth = async () => {
      if (typeof window === "undefined") return;

      const userId = localStorage.getItem("medbank_user");
      
      if (!userId) {
        console.warn("[Author Security] No user session found, redirecting to login");
        router.push("/author/login");
        return;
      }

      try {
        const { getUserById } = await import("@/services/user.service");
        const user = await getUserById(userId);
        
        // Pass if we are on the login page or the user has author/admin privileges
        if (pathname === "/author/login") {
            setLoading(false);
            return;
        }

        if (!user) {
          console.warn("[Author Security] Session invalid - user record not found.");
          localStorage.removeItem("medbank_user");
          router.push("/author/login");
          return;
        }

        const effectiveRole = String(user?.role || '').toLowerCase().trim();
        const userEmail = user?.email || "No Email";

        if (effectiveRole !== 'admin' && effectiveRole !== 'author' && user.email !== 'norbekoviskandar@gmail.com') {
          console.warn(`[Author Security] ACCESS DENIED for ${userEmail} (Role: ${effectiveRole}). Redirecting to student portal.`);
          router.push("/student/portal");
          return;
        }

        console.log(`[Author Security] ACCESS GRANTED for ${userEmail} (Role: ${effectiveRole})`);

        // Verified admin
        setLoading(false);
      } catch (err) {
        console.error("[Author Security] Verification failed:", err);
        router.push("/auth");
      }
    };

    checkAuth();
  }, [pathname, router]);

  useEffect(() => {
    // Auto-open dropdown if child is active
    navItems.forEach(item => {
      if (item.children && item.children.some(child => pathname === child.href)) {
        setOpenDropdown(item.label);
      }
    });
  }, [pathname]);

  // Loading only on first entry to the author portal to prevent flickering during internal navigation
  if (loading && pathname === "/author") {
    return (
      <div className="min-h-screen cyber-theme flex items-center justify-center p-6 cyber-mesh">
        <div className="text-[#8B5CF6] font-mono text-xl animate-pulse tracking-[0.5em] font-bold">
          SECURITY_CHECK...
        </div>
      </div>
    );
  }

  return (
    <div className="flex min-h-screen cyber-theme cyber-mesh transition-all duration-500 overflow-hidden">
      {/* Mobile Overlay */}
      <div 
        onClick={() => setSidebarCollapsed(true)}
        className={`fixed inset-0 bg-black/80 backdrop-blur-sm z-40 lg:hidden transition-opacity duration-300 ${!sidebarCollapsed ? 'opacity-100 pointer-events-auto' : 'opacity-0 pointer-events-none'}`}
      />

      {/* Sidebar */}
      <aside
        className={`fixed lg:sticky top-0 h-screen flex flex-col gap-10 bg-[#1B263B] border-r border-[#2D3A54] p-6 transition-all duration-700 ease-in-out z-50 
          ${sidebarCollapsed 
            ? '-translate-x-full lg:translate-x-0 lg:w-24 px-4' 
          : 'translate-x-0 w-72 p-8 shadow-[10px_0_40px_rgba(0,0,0,0.15)]'
          }`}
      >
        <div className={`flex items-center gap-4 group cursor-pointer ${sidebarCollapsed ? 'justify-center' : ''}`}>
          <div className="w-12 h-12 flex-shrink-0 rounded-2xl bg-gradient-to-tr from-[#005EB8] to-[#0D9488] p-[1.5px] shadow-[0_4px_20px_rgba(0,94,184,0.3)] group-hover:shadow-[0_4px_30px_rgba(0,94,184,0.5)] transition-all">
            <div className="w-full h-full rounded-2xl bg-[#1B263B] flex items-center justify-center">
              <Shield className="text-white w-6 h-6" />
            </div>
          </div>
          <AnimatePresence>
            {!sidebarCollapsed && (
              <motion.div
                initial={{ opacity: 0, x: -10 }}
                animate={{ opacity: 1, x: 0 }}
                exit={{ opacity: 0, x: -10 }}
                className="overflow-hidden whitespace-nowrap"
              >
                <h2 className="font-heading font-black text-xl text-white tracking-widest uppercase italic">Author<span className="text-[#00CCFF]">Portal</span></h2>
                <div className="flex items-center gap-2">
                  <div className="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                  <span className="text-[10px] font-mono text-gray-500 uppercase tracking-tighter">System_Secure</span>
                </div>
              </motion.div>
            )}
          </AnimatePresence>
        </div>

        <nav className="flex flex-col gap-2 mt-4 flex-1 overflow-y-auto custom-scrollbar">
          <AnimatePresence>
            {!sidebarCollapsed && (
                <motion.div
                  initial={{ opacity: 0 }}
                  animate={{ opacity: 1 }}
                  exit={{ opacity: 0 }}
                  className="text-[10px] font-bold text-[#00CCFF] uppercase tracking-[0.2em] mb-4 ml-4 whitespace-nowrap opacity-80"
                >
                  Dashboard Stream
                </motion.div>
            )}
          </AnimatePresence>

          {navItems.map((item, idx) => {
            const hasChildren = item.children && item.children.length > 0;
            const isChildActive = hasChildren && item.children.some(child => pathname === child.href);
            const isActive = pathname === item.href || isChildActive;
            const isOpen = openDropdown === item.label && !sidebarCollapsed;

            const NavContent = (
              <>
                <item.icon size={20} className={isActive ? "text-white" : "group-hover:text-[#00CCFF] transition-colors flex-shrink-0"} />
                <AnimatePresence>
                  {!sidebarCollapsed && (
                    <motion.span
                      initial={{ opacity: 0, x: -10 }}
                      animate={{ opacity: 1, x: 0 }}
                      exit={{ opacity: 0, x: -10 }}
                      className="text-[11px] font-black uppercase tracking-[0.2em] whitespace-nowrap"
                    >
                      {item.label}
                    </motion.span>
                  )}
                </AnimatePresence>
                {!sidebarCollapsed && hasChildren && (
                  <div className={`ml-auto transition-transform duration-300 ${isOpen ? 'rotate-180' : ''}`}>
                    <ChevronDown size={16} />
                  </div>
                )}
                {!sidebarCollapsed && !hasChildren && isActive && (
                  <div className="ml-auto w-1.5 h-1.5 rounded-full bg-white shadow-[0_0_8px_#ffffff]" />
                )}
                {sidebarCollapsed && isActive && (
                  <div className="absolute right-0 top-1/2 -translate-y-1/2 w-1 h-6 bg-[#005EB8] rounded-l-full shadow-[0_0_15px_#005EB8]" />
                )}
              </>
            );

            const commonClasses = `flex items-center gap-4 px-5 py-4 rounded-2xl transition-all duration-300 relative group overflow-hidden cursor-pointer ${sidebarCollapsed ? 'justify-center px-0 w-full' : ''} ${isActive ? "bg-gradient-to-r from-[#0066CC] to-[#004C99] text-white shadow-[0_4px_15px_rgba(0,102,204,0.3)]" : "text-slate-400 hover:text-white hover:bg-white/5"}`;

            return (
              <div key={idx} className="flex flex-col gap-1">
                {hasChildren ? (
                  <div
                    onClick={() => {
                      setOpenDropdown(isOpen ? null : item.label);
                      if (pathname !== item.href) router.push(item.href);
                    }}
                    className={commonClasses}
                  >
                    {NavContent}
                  </div>
                ) : (
                  <Link href={item.href} className={commonClasses}>
                    {NavContent}
                  </Link>
                )}

                <AnimatePresence>
                  {hasChildren && isOpen && !sidebarCollapsed && (
                    <motion.div
                      initial={{ height: 0, opacity: 0 }}
                      animate={{ height: "auto", opacity: 1 }}
                      exit={{ height: 0, opacity: 0 }}
                      className="overflow-hidden flex flex-col gap-1 ml-9"
                    >
                      {item.children.map((child, cIdx) => {
                        const isChildActive = pathname === child.href;
                        return (
                          <Link
                            key={cIdx}
                            href={child.href}
                            className={`flex items-center gap-3 px-4 py-3 rounded-xl transition-all ${isChildActive
                              ? "text-white font-bold bg-white/10"
                              : "text-slate-400 hover:text-white hover:bg-white/5"
                              }`}
                          >
                            <div className={`w-1.5 h-1.5 rounded-full ${isChildActive ? 'bg-[#0D9488] shadow-[0_0_10px_#0D9488]' : 'bg-slate-600'}`} />
                            <span className="text-xs">{child.label}</span>
                          </Link>
                        );
                      })}
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            );
          })}
        </nav>

        <div className="mt-auto space-y-4">

          <button
            onClick={() => {
              router.push("/student/portal");
            }}
            className={`flex items-center gap-4 px-5 py-4 w-full rounded-2xl text-red-500/60 hover:text-red-500 hover:bg-red-500/5 transition-all text-sm font-semibold ${sidebarCollapsed ? 'justify-center px-0' : ''
              }`}
          >
            <LogOut size={20} className="flex-shrink-0" />
            {!sidebarCollapsed && <span>Exit Portal</span>}
          </button>
        </div>
      </aside>

      {/* Main Content */}
      <main className="flex-1 overflow-auto relative">
        <AuthorHeader />
        <div className="relative">
          {children}
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/app/author/manage-products/page.jsx">
"use client";

import { useEffect, useState, useContext } from "react";
import { useRouter } from "next/navigation";
import { getAllProducts, addProduct, updateProduct } from "@/services/product.service";
import { useDeleteItem } from "@/hooks/useDeleteItem";
import { Package, Plus, Trash2, ShieldCheck, ShieldAlert, Edit2, Check, X, Tag, Clock, DollarSign, Database } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import { AppContext } from "@/context/AppContext";

export default function ManageProductsPage() {
  const router = useRouter();
  const { setGlobalAuthorProduct } = useContext(AppContext);
  const [ok, setOk] = useState(false);
  const [products, setProducts] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // Selection state
  const [selectedIds, setSelectedIds] = useState(new Set());

  // Delete hook
  const { handleDelete: deleteProduct, isDeleting, error: deleteError, clearError } = useDeleteItem(
    'product', 
    setProducts, 
    setSelectedIds
  );

  const ECG_SYSTEMS = ["Cardiology ‚Äì ECG"];
  const ECG_SUBJECTS = [
    "Fundamentals & Chamber Enlargement",
    "Intraventricular Conduction Disturbances",
    "Myocardial Ischaemia & Stress Testing",
    "Supraventricular Arrhythmias",
    "Ventricular Arrhythmias & Tachycardias",
    "AV Blocks & Preexcitation",
    "Systemic, Drug, & Electrolyte Effects",
    "Technical Methods & Pacemakers",
    "Paediatric & Congenital ECG"
  ];

  // Form state
  const [showCreateForm, setShowCreateForm] = useState(false);
  const [editingId, setEditingId] = useState(null);
  const [formData, setFormData] = useState({
    name: "",
    duration_days: "",
    price: "",
    description: "",
    templateType: "DEFAULT",
    systems: [],
    subjects: [],
    is_published: true,
    plans: [], // Array of {days, price}
    defaultCreateTestConfig: {
      columns: ["system", "difficulty"],
      modes: ["timed", "tutor"],
      blockSize: 40,
      negativeMarking: false
    }
  });

  // Auth check
  useEffect(() => {
    // Legacy Password Check Removed: Authorization now handled by AuthorLayout
    setOk(true);
  }, [router]);

  useEffect(() => {
    if (ok) loadProducts();
  }, [ok]);

  const addPlanTier = () => {
    setFormData(prev => ({
        ...prev,
        plans: [...prev.plans, { days: "", price: "" }]
    }));
  };

  const removePlanTier = (index) => {
    setFormData(prev => {
        const nextPlans = [...prev.plans];
        nextPlans.splice(index, 1);
        return { ...prev, plans: nextPlans };
    });
  };

  const updatePlanTier = (index, field, value) => {
    setFormData(prev => {
        const nextPlans = [...prev.plans];
        nextPlans[index] = { ...nextPlans[index], [field]: value };
        return { ...prev, plans: nextPlans };
    });
  };

  const loadProducts = async () => {
    setIsLoading(true);
    setError(null);
    try {
      const all = await getAllProducts();
      setProducts(all || []);
    } catch (err) {
      console.error(err);
      setError("Failed to load products");
    } finally {
      setIsLoading(false);
    }
  };

  const resetForm = () => {
    setFormData({
      name: "",
      duration_days: "",
      price: "",
      description: "",
      templateType: "DEFAULT",
      systems: [],
      subjects: [],
      is_published: true,
      plans: [],
      defaultCreateTestConfig: {
        columns: ["system", "difficulty"],
        modes: ["timed", "tutor"],
        blockSize: 40,
        negativeMarking: false
      }
    });
    setEditingId(null);
    setShowCreateForm(false);
  };

  const handleCreate = async (e) => {
    e.preventDefault();
    try {
      // Create cleaned plans array
      const cleanedPlans = formData.plans
        .map(p => ({ days: parseInt(p.days), price: parseFloat(p.price) }))
        .filter(p => !isNaN(p.days) && !isNaN(p.price));

      const effectiveTemplateType = formData.templateType || 'DEFAULT';
      const effectiveSystems = effectiveTemplateType === 'ECG' ? ECG_SYSTEMS : (formData.systems || []);
      const effectiveSubjects = effectiveTemplateType === 'ECG' ? ECG_SUBJECTS : (formData.subjects || []);

      const newProduct = await addProduct({
        ...formData,
        templateType: effectiveTemplateType,
        systems: effectiveSystems,
        subjects: effectiveSubjects,
        duration_days: parseInt(formData.duration_days) || 0,
        price: parseFloat(formData.price) || 0,
        plans: cleanedPlans
      });
      
      // AUTO-FOCUS ON NEW PRODUCT
      if (newProduct && setGlobalAuthorProduct) {
        setGlobalAuthorProduct(newProduct);
      }
      
      resetForm();
      loadProducts();
      alert("Product launched successfully! Context locked to new stream.");
    } catch (err) {
      alert(err.message);
    }
  };

  const handleUpdate = async (e) => {
    e.preventDefault();
    try {
      const cleanedPlans = formData.plans
        .map(p => ({ days: parseInt(p.days), price: parseFloat(p.price) }))
        .filter(p => !isNaN(p.days) && !isNaN(p.price));

      const effectiveTemplateType = formData.templateType || 'DEFAULT';
      const effectiveSystems = effectiveTemplateType === 'ECG' ? ECG_SYSTEMS : (formData.systems || []);
      const effectiveSubjects = effectiveTemplateType === 'ECG' ? ECG_SUBJECTS : (formData.subjects || []);

      await updateProduct({
        ...formData,
        id: editingId,
        templateType: effectiveTemplateType,
        systems: effectiveSystems,
        subjects: effectiveSubjects,
        duration_days: parseInt(formData.duration_days) || 0,
        price: parseFloat(formData.price) || 0,
        plans: cleanedPlans
      });
      resetForm();
      loadProducts();
    } catch (err) {
      alert(err.message);
    }
  };

  const handleEdit = (product) => {
    setFormData({
      name: product.name,
      duration_days: product.duration_days?.toString() || "",
      price: product.price?.toString() || "",
      description: product.description || "",
      templateType: product.templateType || 'DEFAULT',
      systems: Array.isArray(product.systems) ? product.systems : [],
      subjects: Array.isArray(product.subjects) ? product.subjects : [],
      is_published: product.is_published,
      plans: product.plans || [],
      defaultCreateTestConfig: product.defaultCreateTestConfig || {
        columns: ["system", "difficulty"],
        modes: ["timed", "tutor"],
        blockSize: 40,
        negativeMarking: false
      }
    });
    setEditingId(product.id);
    setShowCreateForm(true);
  };

  const handleDelete = async (id) => {
    await deleteProduct(id, {
      onSuccess: () => {
        // Clear editing if deleted item was being edited
        if (editingId === id) {
          setEditingId(null);
          setShowCreateForm(false);
        }
      }
    });
  };

  const toggleSelect = (id) => {
    const next = new Set(selectedIds);
    if (next.has(id)) next.delete(id);
    else next.add(id);
    setSelectedIds(next);
  };

  const toggleSelectAll = () => {
    if (selectedIds.size === products.length) {
      setSelectedIds(new Set());
    } else {
      setSelectedIds(new Set(products.map(p => p.id)));
    }
  };

  const handleBulkToggleVisibility = async (published) => {
    const ids = Array.from(selectedIds);
    if (!ids.length) return;
    setIsLoading(true);
    try {
      await Promise.all(ids.map(id => {
        const p = products.find(prod => prod.id === id);
        return updateProduct({ ...p, is_published: published });
      }));
      setSelectedIds(new Set());
      loadProducts();
    } catch (err) {
      alert("Bulk operation failed");
    } finally {
      setIsLoading(false);
    }
  };

  if (!ok) return null;

    return (
        <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#0891B2]/5 pointer-events-none" />
            <main className="max-w-[1400px] mx-auto px-6 py-8 relative z-10">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-heading font-black tracking-tight text-[#1B263B] uppercase italic">Product <span className="text-[#005EB8]">Vault</span></h1>
            <p className="text-slate-500 mt-2 text-sm font-medium">Control subscription packages, pricing, and availability</p>
          </div>
          <button 
            onClick={() => {
              if (showCreateForm) resetForm();
              else setShowCreateForm(true);
            }} 
            className="px-6 py-3 bg-[#005EB8] text-white rounded-2xl hover:bg-[#004e9a] text-xs font-black uppercase tracking-widest transition-all shadow-lg shadow-[#005EB8]/20 flex items-center gap-2 active:scale-95"
          >
            {showCreateForm ? <X size={16} /> : <Plus size={16} />}
            {showCreateForm ? "Cancel" : "Create Product"}
          </button>
        </div>

        <AnimatePresence>
          {showCreateForm && (
            <motion.div
              initial={{ opacity: 0, y: -20 }}
              animate={{ opacity: 1, y: 0 }}
              exit={{ opacity: 0, y: -20 }}
              className="bg-white border border-slate-200 p-8 rounded-[40px] shadow-[0_20px_50px_rgba(0,94,184,0.06)] mb-8 relative overflow-hidden"
            >
              <div className="absolute top-0 left-0 w-1.5 h-full bg-[#005EB8]" />
              <h2 className="text-xl font-heading font-black text-[#1B263B] mb-6 uppercase flex items-center gap-2">
                {editingId ? "Modify" : "Deploy"} <span className="text-[#005EB8]">Package</span>
              </h2>
              <form onSubmit={editingId ? handleUpdate : handleCreate} className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Product Name</label>
                  <input
                    required
                    value={formData.name}
                    onChange={e => setFormData({ ...formData, name: e.target.value })}
                    placeholder="e.g. 90-Day VIP Access"
                    className="bg-[#FDFDFD] border border-slate-200 px-4 py-3 rounded-2xl w-full text-[#1B263B] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all font-medium shadow-sm"
                  />
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Duration (Days)</label>
                  <div className="relative">
                    <Clock className="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground" size={16} />
                    <input
                      required
                      type="number"
                      value={formData.duration_days}
                      onChange={e => setFormData({ ...formData, duration_days: e.target.value })}
                      placeholder="90"
                      className="bg-background border border-border pl-12 pr-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium"
                    />
                  </div>
                </div>
                <div className="space-y-2">
                  <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Price (USD)</label>
                  <div className="relative">
                    <DollarSign className="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground" size={16} />
                    <input
                      required
                      type="number"
                      step="0.01"
                      value={formData.price}
                      onChange={e => setFormData({ ...formData, price: e.target.value })}
                      placeholder="49.99"
                      className="bg-background border border-border pl-12 pr-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium"
                    />
                  </div>
                </div>
                <div className="md:col-span-2 lg:col-span-2 space-y-2">
                  <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Description</label>
                  <input
                    value={formData.description}
                    onChange={e => setFormData({ ...formData, description: e.target.value })}
                    placeholder="Brief highlight of features..."
                    className="bg-background border border-border px-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium"
                  />
                </div>

                <div className="space-y-2">
                  <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Template Type</label>
                  <select
                    value={formData.templateType || 'DEFAULT'}
                    onChange={e => {
                      const nextType = e.target.value;
                      if (nextType === 'ECG') {
                        setFormData({ ...formData, templateType: nextType, systems: ECG_SYSTEMS, subjects: ECG_SUBJECTS });
                      } else {
                        setFormData({ ...formData, templateType: nextType });
                      }
                    }}
                    className="bg-background border border-border px-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium"
                  >
                    <option value="DEFAULT">DEFAULT</option>
                    <option value="ECG">ECG</option>
                  </select>
                </div>

                <div className="lg:col-span-3 grid grid-cols-1 md:grid-cols-2 gap-6">
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Systems</label>
                    <textarea
                      value={(formData.templateType === 'ECG' ? ECG_SYSTEMS : (formData.systems || [])).join('\n')}
                      readOnly={formData.templateType === 'ECG'}
                      onChange={e => {
                        if (formData.templateType === 'ECG') return;
                        const next = e.target.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        setFormData({ ...formData, systems: next });
                      }}
                      className="bg-background border border-border px-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium h-28"
                    />
                  </div>
                  <div className="space-y-2">
                    <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest ml-1">Subjects</label>
                    <textarea
                      value={(formData.templateType === 'ECG' ? ECG_SUBJECTS : (formData.subjects || [])).join('\n')}
                      readOnly={formData.templateType === 'ECG'}
                      onChange={e => {
                        if (formData.templateType === 'ECG') return;
                        const next = e.target.value.split(/\r?\n/).map(s => s.trim()).filter(Boolean);
                        setFormData({ ...formData, subjects: next });
                      }}
                      className="bg-background border border-border px-4 py-3 rounded-2xl w-full text-foreground focus:ring-2 focus:ring-primary/20 outline-none transition-all font-medium h-28"
                    />
                  </div>
                </div>
                <div className="lg:col-span-3 h-[1px] bg-slate-100 my-2" />

                <div className="lg:col-span-3 space-y-4">
                  <div className="flex items-center justify-between">
                    <label className="text-[10px] font-black text-[#0066CC] uppercase tracking-[0.2em] ml-1">Additional Pricing Tiers</label>
                    <button 
                      type="button" 
                      onClick={addPlanTier}
                      className="px-4 py-1.5 bg-slate-50 border border-slate-200 rounded-lg text-[9px] font-black uppercase tracking-widest text-[#1B263B] hover:bg-[#0066CC] hover:text-white transition-all shadow-sm"
                    >
                      + Add Tier
                    </button>
                  </div>
                  
                  {formData.plans.length === 0 ? (
                    <div className="bg-slate-50 border-2 border-dashed border-slate-200 rounded-3xl p-6 text-center">
                       <p className="text-[10px] font-black text-slate-300 uppercase tracking-widest">No extra tiers defined for this stream</p>
                    </div>
                  ) : (
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      {formData.plans.map((plan, idx) => (
                        <div key={idx} className="flex items-center gap-3 bg-slate-50 border border-slate-200 p-4 rounded-[24px] shadow-sm animate-in fade-in slide-in-from-top-2 duration-300">
                          <div className="flex-1 space-y-2">
                             <div className="relative">
                               <Clock className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                               <input 
                                 type="number" 
                                 placeholder="Days"
                                 value={plan.days}
                                 onChange={e => updatePlanTier(idx, 'days', e.target.value)}
                                 className="w-full bg-white border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs font-bold focus:ring-4 focus:ring-[#0066CC]/5 outline-none"
                               />
                             </div>
                          </div>
                          <div className="flex-1 space-y-2">
                             <div className="relative">
                               <DollarSign className="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400" size={14} />
                               <input 
                                 type="number" 
                                 placeholder="Price"
                                 value={plan.price}
                                 onChange={e => updatePlanTier(idx, 'price', e.target.value)}
                                 className="w-full bg-white border border-slate-200 pl-10 pr-4 py-2 rounded-xl text-xs font-bold focus:ring-4 focus:ring-[#0066CC]/5 outline-none"
                               />
                             </div>
                          </div>
                          <button 
                            type="button" 
                            onClick={() => removePlanTier(idx)}
                            className="p-3 bg-white border border-slate-200 text-red-500 rounded-xl hover:bg-red-500 hover:text-white transition-all shadow-sm"
                          >
                            <Trash2 size={14} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>

                <div className="lg:col-span-3 h-[1px] bg-slate-100 my-4" />

                <div className="lg:col-span-3 space-y-4">
                  <label className="text-[10px] font-black text-[#0066CC] uppercase tracking-[0.2em] ml-1">Testing Configuration</label>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 bg-slate-50/30 p-6 rounded-[32px] border border-slate-100/50">
                    <div className="space-y-2">
                      <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Default Block Size</label>
                      <input 
                        type="number"
                        value={formData.defaultCreateTestConfig.blockSize}
                        onChange={e => setFormData({
                          ...formData,
                          defaultCreateTestConfig: { ...formData.defaultCreateTestConfig, blockSize: parseInt(e.target.value) || 0 }
                        })}
                        className="w-full bg-white border border-slate-200 px-4 py-2.5 rounded-xl text-xs font-bold focus:ring-4 focus:ring-[#0066CC]/5 outline-none"
                      />
                    </div>
                    <div className="space-y-2">
                       <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Negative Marking</label>
                       <div className="flex items-center gap-3 h-[42px] px-3 bg-white rounded-xl border border-slate-200">
                          <input 
                            type="checkbox"
                            checked={formData.defaultCreateTestConfig.negativeMarking}
                            onChange={e => setFormData({
                              ...formData,
                              defaultCreateTestConfig: { ...formData.defaultCreateTestConfig, negativeMarking: e.target.checked }
                            })}
                            className="w-4 h-4 rounded text-[#0066CC] focus:ring-[#0066CC]/20"
                          />
                          <span className="text-[10px] font-bold text-slate-600 uppercase tracking-wider">Enabled</span>
                       </div>
                    </div>
                    <div className="md:col-span-2 space-y-2">
                      <label className="text-[9px] font-black text-slate-400 uppercase tracking-widest ml-1">Display Columns</label>
                      <input 
                        type="text"
                        placeholder="system, difficulty, tags"
                        value={formData.defaultCreateTestConfig.columns.join(', ')}
                        onChange={e => setFormData({
                          ...formData,
                          defaultCreateTestConfig: { ...formData.defaultCreateTestConfig, columns: e.target.value.split(',').map(s => s.trim()).filter(Boolean) }
                        })}
                        className="w-full bg-white border border-slate-200 px-4 py-2.5 rounded-xl text-xs font-bold focus:ring-4 focus:ring-[#0066CC]/5 outline-none"
                      />
                      <p className="text-[8px] text-slate-400 font-bold uppercase tracking-widest ml-1">Comma-separated: system, difficulty, tags, etc.</p>
                    </div>
                  </div>
                </div>

                <div className="lg:col-span-3 flex flex-col justify-end mt-4">
                  <div className="flex items-center gap-6 h-[60px]">
                    <label className="flex items-center gap-4 cursor-pointer group shrink-0">
                      <div className={`w-14 h-8 rounded-full p-1.5 transition-all duration-500 shadow-inner ${formData.is_published ? 'bg-emerald-500 shadow-[0_0_20px_rgba(16,185,129,0.4)]' : 'bg-slate-200'}`}>
                        <div className={`w-5 h-5 bg-white rounded-full transition-all duration-500 shadow-md ${formData.is_published ? 'translate-x-6' : 'translate-x-0'}`} />
                      </div>
                      <span className={`text-[12px] font-black uppercase tracking-[0.2em] transition-all duration-500 ${formData.is_published ? 'text-emerald-600 scale-105' : 'text-slate-400'}`}>
                        {formData.is_published ? 'PUBLISHED' : 'DRAFT'}
                      </span>
                      <input type="checkbox" className="hidden" checked={formData.is_published} onChange={e => setFormData({ ...formData, is_published: e.target.checked })} />
                    </label>
                    <button type="submit" className={`flex-1 rounded-[24px] text-[11px] font-black uppercase tracking-[0.3em] transition-all duration-500 shadow-2xl h-full active:scale-95 group relative overflow-hidden ${
                      formData.is_published 
                        ? 'bg-emerald-600 hover:bg-emerald-700 text-white shadow-emerald-600/20' 
                        : 'bg-[#0066CC] hover:bg-[#0052A3] text-white shadow-[#0066CC]/20'
                    }`}>
                       <span className="relative z-10">{editingId ? "Update Product" : (formData.is_published ? "Launch Live" : "Sync Archive")}</span>
                       <div className="absolute inset-0 bg-white/10 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-1000 skew-x-12" />
                    </button>
                  </div>
                </div>
              </form>
            </motion.div>
          )}
        </AnimatePresence>

        {/* List UI */}
        <div className="space-y-4">
          <div className="flex flex-wrap gap-2 items-center mb-4">
             <button
              onClick={() => handleBulkToggleVisibility(true)}
              disabled={selectedIds.size === 0}
              className="px-4 py-2 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-emerald-100 transition-all disabled:opacity-30 flex items-center gap-2"
            >
              <ShieldCheck size={14} /> Bulk Publish
            </button>
            <button
               onClick={() => handleBulkToggleVisibility(false)}
              disabled={selectedIds.size === 0}
              className="px-4 py-2 bg-amber-50 text-amber-600 border border-amber-100 rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-100 transition-all disabled:opacity-30 flex items-center gap-2"
            >
              <ShieldAlert size={14} /> Bulk Draft
            </button>
            {selectedIds.size > 0 && (
              <span className="ml-2 text-[10px] font-black text-muted-foreground uppercase tracking-[0.2em] animate-pulse">
                {selectedIds.size} STREAMS CAPTURED
              </span>
            )}
          </div>

          {/* Standard QBank Management Card */}
          <div className="bg-white border border-slate-200 p-6 rounded-[32px] mb-8 flex flex-col md:flex-row items-center justify-between shadow-sm relative overflow-hidden group">
             <div className="absolute top-0 right-0 w-32 h-32 bg-slate-50 rounded-full translate-x-10 translate-y-[-10px] opacity-50 group-hover:scale-110 transition-transform" />
             
             <div className="flex items-center gap-5 relative z-10">
                <div className="w-14 h-14 rounded-2xl bg-gradient-to-br from-slate-100 to-slate-50 border border-slate-200 flex items-center justify-center text-slate-400">
                   <Database size={24} />
                </div>
                <div>
                   <h3 className="text-xl font-heading font-black text-slate-800">Standard QBank</h3>
                   <p className="text-xs font-bold text-slate-400 uppercase tracking-wider">Universal Question Repository (Legacy)</p>
                </div>
             </div>

             <div className="flex items-center gap-3 mt-4 md:mt-0 relative z-10">
                <button 
                  onClick={() => router.push('/author/manage-questions')}
                  className="px-5 py-3 rounded-xl bg-white border border-slate-200 text-slate-600 hover:text-[#005EB8] hover:border-[#005EB8]/30 font-bold text-[11px] uppercase tracking-widest shadow-sm hover:shadow-md transition-all flex items-center gap-2"
                >
                   <Database size={16} /> Manage Pool
                </button>
                <button 
                  onClick={() => router.push('/author/create-question')}
                  className="px-5 py-3 rounded-xl bg-[#005EB8] text-white font-bold text-[11px] uppercase tracking-widest shadow-lg shadow-[#005EB8]/20 hover:bg-[#004E9A] transition-all flex items-center gap-2"
                >
                   <Plus size={16} /> Add Item
                </button>
             </div>
          </div>

          <div className="overflow-hidden bg-card rounded-[32px] border border-border shadow-2xl shadow-primary/5">
            <table className="w-full text-left border-collapse">
              <thead>
                <tr className="border-b border-border bg-panel/30">
                  <th className="px-8 py-5 w-16">
                    <input 
                      type="checkbox" 
                      className="w-4 h-4 rounded border-border accent-primary cursor-pointer"
                      checked={products.length > 0 && selectedIds.size === products.length}
                      onChange={toggleSelectAll}
                    />
                  </th>
                  <th className="px-8 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground">Product Detail</th>
                  <th className="px-8 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground">Terms</th>
                  <th className="px-8 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground">Pricing</th>
                  <th className="px-8 py-5 text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground">Status</th>
                  <th className="px-8 py-5 text-right text-[10px] font-black uppercase tracking-[0.2em] text-muted-foreground">Edit</th>
                </tr>
              </thead>
              <tbody className="divide-y divide-border/50">
                {isLoading ? (
                  <tr>
                    <td colSpan="6" className="py-20 text-center">
                      <div className="w-10 h-10 border-4 border-primary/20 border-t-primary rounded-full animate-spin mx-auto mb-4"></div>
                      <p className="text-muted-foreground font-mono text-[10px] uppercase tracking-widest">Uplinking_To_Catalog...</p>
                    </td>
                  </tr>
                ) : products.length === 0 ? (
                   <tr>
                    <td colSpan="6" className="py-20 text-center text-muted-foreground opacity-50 uppercase tracking-[0.3em] font-mono text-xs">
                      No Products Found in Database
                    </td>
                  </tr>
                ) : products.map((product) => {
                  // Ensure plans is an array for mapping (defense-in-depth)
                  const plans = Array.isArray(product.plans) 
                    ? product.plans 
                    : (typeof product.plans === 'string' ? JSON.parse(product.plans || '[]') : []);
                  
                  return (
                    <tr key={product.id} className="hover:bg-panel/20 transition-all group">
                    <td className="px-8 py-6">
                      <input 
                        type="checkbox" 
                        className="w-4 h-4 rounded border-border accent-primary cursor-pointer"
                        checked={selectedIds.has(product.id)}
                        onChange={() => toggleSelect(product.id)}
                      />
                    </td>
                    <td className="px-8 py-6">
                      <div className="flex items-center gap-4 group cursor-pointer" onClick={() => router.push(`/author/manage-products/${product.id}`)}>
                        <div className="w-10 h-10 rounded-xl bg-gradient-to-tr from-primary/20 to-primary/5 border border-primary/10 flex items-center justify-center text-primary group-hover:bg-primary group-hover:text-white transition-all">
                          <Package size={18} />
                        </div>
                        <div>
                          <div className="font-bold text-foreground text-sm group-hover:text-primary transition-colors underline decoration-transparent group-hover:decoration-primary/30 underline-offset-4">{product.name}</div>
                          <div className="text-[10px] font-mono text-muted-foreground uppercase truncate max-w-[200px]">{product.description || 'Secure Educational Stream'}</div>
                        </div>
                      </div>
                    </td>
                    <td className="px-8 py-6">
                       <div className="flex flex-col gap-1.5">
                          <span className="bg-panel px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest border border-border w-fit">
                            {product.duration_days} DAYS
                          </span>
                          {plans.map((p, i) => (
                            <span key={i} className="bg-[#0066CC]/5 px-3 py-1 rounded-full text-[9px] font-bold uppercase tracking-tight border border-[#0066CC]/10 text-[#0066CC] w-fit">
                              {p.days} DAYS
                            </span>
                          ))}
                       </div>
                    </td>
                    <td className="px-8 py-6">
                       <div className="flex flex-col gap-1.5">
                          <div className="text-sm font-black text-[#1B263B]">${(Number(product.price) || 0).toFixed(2)}</div>
                          {plans.map((p, i) => (
                            <div key={i} className="text-[10px] font-bold text-slate-400">${parseFloat(p.price || 0).toFixed(2)}</div>
                          ))}
                       </div>
                    </td>
                    <td className="px-8 py-6">
                      <span className={`inline-flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-black uppercase tracking-widest ${product.is_published ? 'bg-emerald-500/10 text-emerald-600' : 'bg-amber-500/10 text-amber-600'}`}>
                        <div className={`w-1.5 h-1.5 rounded-full ${product.is_published ? 'bg-emerald-500 animate-pulse' : 'bg-amber-500'}`} />
                        {product.is_published ? 'LIVE' : 'DRAFT'}
                      </span>
                    </td>
                    <td className="px-8 py-6 text-right">
                       <div className="flex justify-end gap-2">
                        <button 
                          onClick={() => router.push(`/author/manage-questions?packageId=${product.id}`)}
                          className="p-2.5 rounded-xl bg-[#005EB8]/10 text-[#005EB8] hover:bg-[#005EB8] hover:text-white transition-all border border-[#005EB8]/20 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest px-4"
                          title="Manage Questions for this Package"
                        >
                          <Database size={14} /> Questions
                        </button>
                        <button 
                          onClick={() => router.push(`/author/create-question?packageId=${product.id}`)}
                          className="p-2.5 rounded-xl bg-emerald-50 text-emerald-600 hover:bg-emerald-600 hover:text-white transition-all border border-emerald-100 flex items-center gap-2 text-[10px] font-black uppercase tracking-widest px-4"
                          title="Create Question for this Package"
                        >
                          <Plus size={14} /> Create
                        </button>
                        <button 
                          onClick={() => handleEdit(product)}
                          className="p-2.5 rounded-xl bg-panel hover:bg-primary hover:text-white transition-all border border-border"
                          title="Edit Product"
                        >
                          <Edit2 size={16} />
                        </button>
                        <button 
                          onClick={() => handleDelete(product.id)}
                          className="p-2.5 rounded-xl bg-panel hover:bg-red-500 hover:text-white transition-all border border-border"
                          title="Delete Product"
                        >
                          <Trash2 size={16} />
                        </button>
                       </div>
                    </td>
                  </tr>
                );
              })}
            </tbody>
            </table>
          </div>
        </div>
      </main>
    </div>
  );
}
</file>

<file path="src/app/author/manage-questions/page.jsx">
"use client";

import { useEffect, useState, useRef, useContext } from "react";
import { useRouter } from "next/navigation";
import { getAllQuestions, updateQuestion, addQuestion, getQuestionById, submitForReview, approveQuestion, publishQuestion, deprecateQuestion, reviseQuestion } from "@/services/question.service";
import { getAllProducts, getProductById } from "@/services/product.service";
import { useDeleteItem } from "@/hooks/useDeleteItem";
import { ChevronDown, Search, Filter, Database, ArrowUpDown, LayoutGrid, CheckCircle2, Clock, AlertTriangle, Archive, FileEdit, History } from "lucide-react";
import GovernanceTimeline from "@/components/author/question/GovernanceTimeline";
import { AppContext } from "@/context/AppContext";

function imageSizeClass(size) {
  if (size === "small") return "max-w-240 mx-auto rounded border mt-3 block";
  if (size === "medium") return "max-w-480 mx-auto rounded border mt-3 block";
  if (size === "large") return "max-w-720 mx-auto rounded border mt-3 block";
  return "max-w-full mx-auto rounded border mt-3 block";
}

export default function ManageQuestionsPage() {
  const router = useRouter();
  const { selectedAuthorProduct } = useContext(AppContext);
  const [ok, setOk] = useState(false);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  const [questions, setQuestions] = useState([]);
  const [filterSystem, setFilterSystem] = useState("");
  const [filterSubject, setFilterSubject] = useState("");
  const [filterTopic, setFilterTopic] = useState("");
  const [filterStem, setFilterStem] = useState("");
  const [sortBy, setSortBy] = useState("newest");
  const [selectedIds, setSelectedIds] = useState(new Set());

  // Delete hook
  const { handleDelete: deleteQuestion, handleBulkDelete: bulkDeleteQuestions, isDeleting } = useDeleteItem(
    'question',
    setQuestions,
    setSelectedIds
  );

  const [packageFilter, setPackageFilter] = useState("");
  const [packageName, setPackageName] = useState("");

  const [currentPage, setCurrentPage] = useState(1);
  const questionsPerPage = 20;

  // Preview modal
  const [previewQuestion, setPreviewQuestion] = useState(null);
  const [previewTab, setPreviewTab] = useState('preview'); // 'preview' or 'history'
  const [revealedImages, setRevealedImages] = useState(new Set());

  // Reset revealed images whenever a new preview is opened
  useEffect(() => {
    setRevealedImages(new Set());
    setPreviewTab('preview');
  }, [previewQuestion]);

  const fileInputRef = useRef(null);

  // Universal Taxonomy Defaults
  const DEFAULT_SYSTEMS = [
    "Cardiovascular", "Respiratory", "Renal", "Gastrointestinal", "Neurology",
    "Musculoskeletal", "Endocrine", "Reproductive", "Hematology", "Dermatology", "Psychiatry", "Multisystem"
  ];
  const DEFAULT_SUBJECTS = [
    "Anatomy", "Physiology", "Biochemistry", "Pharmacology", "Pathology",
    "Microbiology", "Immunology", "Behavioral Science", "Genetics", "Biostatistics", "Epidemiology"
  ];

  const [availableSystems, setAvailableSystems] = useState(DEFAULT_SYSTEMS);
  const [availableSubjects, setAvailableSubjects] = useState(DEFAULT_SUBJECTS);

  // Auth check
  useEffect(() => {
    // Legacy Password Check Removed: Authorization now handled by AuthorLayout
    setOk(true);
  }, [router]);

  // Load questions
  const loadQuestions = async () => {
    if (!selectedAuthorProduct) return;
    setIsLoading(true);
    setError(null);
    try {
      const all = await getAllQuestions(selectedAuthorProduct.id);
      setQuestions(all || []);
    } catch (err) {
      console.error("Load error:", err);
      setError("Failed to load questions");
    } finally {
      setIsLoading(false);
    }
  };

  const loadPackageDetails = async (id) => {
    try {
      const p = await getProductById(id);
      if (p) {
        setPackageName(p.name);
        setAvailableSystems(p.systems?.length > 0 ? p.systems : DEFAULT_SYSTEMS);
        setAvailableSubjects(p.subjects?.length > 0 ? p.subjects : DEFAULT_SUBJECTS);
      }
    } catch (err) {
      console.error(err);
    }
  };

  useEffect(() => {
    // Priority: Global Context
    if (selectedAuthorProduct) {
      setPackageFilter(selectedAuthorProduct.id.toString());
      setPackageName(selectedAuthorProduct.name);
      setAvailableSystems(selectedAuthorProduct.systems?.length > 0 ? selectedAuthorProduct.systems : DEFAULT_SYSTEMS);
      setAvailableSubjects(selectedAuthorProduct.subjects?.length > 0 ? selectedAuthorProduct.subjects : DEFAULT_SUBJECTS);
      loadQuestions();
    } else {
      // Fallback for direct URL access if global context isn't ready
      const pId = new URLSearchParams(window.location.search).get("packageId");
      if (pId) {
        setPackageFilter(pId);
        loadPackageDetails(pId);
        (async () => {
          setIsLoading(true);
          try {
            const all = await getAllQuestions(pId);
            setQuestions(all || []);
          } catch (e) { }
          setIsLoading(false);
        })();
      } else {
        setPackageFilter("");
        setPackageName("");
        setAvailableSystems(DEFAULT_SYSTEMS);
        setAvailableSubjects(DEFAULT_SUBJECTS);
        setQuestions([]);
      }
    }
  }, [selectedAuthorProduct]);

  // Governance Actions
  const handleSubmit = async (id) => {
    const notes = prompt("Add submission notes (optional):");
    if (notes === null) return;
    try {
      await submitForReview(id, notes);
      await loadQuestions();
    } catch (err) {
      alert("Submission failed: " + err.message);
    }
  };

  const handleApprove = async (id) => {
    const notes = prompt("Add approval notes (optional):");
    if (notes === null) return;
    try {
      await approveQuestion(id, notes);
      await loadQuestions();
    } catch (err) {
      alert("Approval failed: " + err.message);
    }
  };

  // Publish a draft/approved version
  const handlePublish = async (id) => {
    if (!confirm("Publish this question? It will become live for students.")) return;
    try {
      await publishQuestion(id, "Manually published from dashboard");
      await loadQuestions();
    } catch (err) {
      console.error(err);
      alert("Failed to publish: " + err.message);
    }
  };

  const handleDeprecate = async (id) => {
    const reason = prompt("Why are you deprecating this question?");
    if (!reason) return;
    try {
      await deprecateQuestion(id, reason);
      await loadQuestions();
    } catch (err) {
      alert("Deprecation failed: " + err.message);
    }
  };

  // Revise a published question
  const handleRevise = async (id) => {
    const notes = prompt("Why are you revising this? (optional):");
    if (notes === null) return;
    try {
      const newDraft = await reviseQuestion(id, notes);
      router.push(`/author/create-question?id=${newDraft.id}`);
    } catch (err) {
      console.error(err);
      alert("Failed to create revision: " + err.message);
    }
  };

  // Delete with confirmation
  const handleDelete = async (id) => {
    await deleteQuestion(id);
  };

  // Selection logic
  const toggleSelect = (id) => {
    setSelectedIds(prev => {
      const next = new Set(prev);
      if (next.has(id)) next.delete(id);
      else next.add(id);
      return next;
    });
  };

  const toggleSelectAll = () => {
    const allOnPage = paginated.map(q => q.id);
    const someUnselected = allOnPage.some(id => !selectedIds.has(id));

    setSelectedIds(prev => {
      const next = new Set(prev);
      if (someUnselected) {
        allOnPage.forEach(id => next.add(id));
      } else {
        allOnPage.forEach(id => next.delete(id));
      }
      return next;
    });
  };

  // Bulk actions updated for lifecycle
  const bulkPublish = async () => {
    const ids = Array.from(selectedIds);
    if (!ids.length) return alert("Please select questions first");
    const drafts = ids.filter(id => questions.find(q => q.id === id)?.status === 'draft');
    if (drafts.length === 0) return alert("No drafts selected to publish");
    
    if (!confirm(`Publish ${drafts.length} selected draft(s)?`)) return;

    try {
      setIsLoading(true);
      const { publishQuestion } = await import("@/services/question.service");
      await Promise.all(drafts.map(id => publishQuestion(id)));
      setSelectedIds(new Set());
      await loadQuestions();
      alert(`Published ${drafts.length} questions`);
    } catch (err) {
      alert("Bulk publish failed");
      console.error(err);
    } finally {
      setIsLoading(false);
    }
  };

  const bulkDelete = async () => {
    const ids = Array.from(selectedIds);
    
    try {
      setIsLoading(true);
      await bulkDeleteQuestions(ids);
    } finally {
      setIsLoading(false);
    }
  };

  // Export to JSON
  const handleExport = () => {
    const dataToExport = filteredQuestions.length > 0 ? filteredQuestions : questions;
    if (dataToExport.length === 0) return alert("No data available to export");

    const dataStr = JSON.stringify(dataToExport, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `medbank-export-${new Date().toISOString().slice(0, 10)}.json`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  const handleExportCSV = () => {
    const dataToExport = filteredQuestions.length > 0 ? filteredQuestions : questions;
    if (dataToExport.length === 0) return alert("No data available to export");

    const headers = [
      "id", "system", "subject", "topic", "stem", "correct",
      "explanationCorrect", "explanationWrong", "summary",
      "published", "choices"
    ];

    const rows = dataToExport.map(q => headers.map(h => {
      let val = q[h];

      // Special handling for objects/arrays
      if (h === 'choices' || typeof val === 'object') {
        val = JSON.stringify(val || []);
      }

      let str = String(val ?? "");
      // Escape quotes for CSV
      return `"${str.replace(/"/g, '""')}"`;
    }).join(","));

    const csvContent = [headers.join(","), ...rows].join("\n");
    const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = `medbank-export-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  };

  // Import from JSON or CSV
  const handleImport = (e) => {
    const file = e.target.files?.[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = async (event) => {
      try {
        let imported = [];
        const content = event.target.result;

        if (file.name.endsWith('.json')) {
          imported = JSON.parse(content);
        } else if (file.name.endsWith('.csv')) {
          const lines = content.split('\n').filter(l => l.trim());
          const headers = lines[0].split(',').map(h => h.trim().replace(/"/g, ''));

          imported = lines.slice(1).map(line => {
            // Basic CSV split, handles quotes
            const values = line.match(/(".*?"|[^",\s]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((h, i) => {
              let val = values[i]?.trim().replace(/^"|"$/g, '') || "";
              if (h === 'published') val = val.toLowerCase() === 'true' || val === '1';
              if (h === 'choices') {
                try { val = JSON.parse(val.replace(/""/g, '"')); } catch (e) { val = []; }
              }
              obj[h] = val;
            });
            return obj;
          });
        }

        if (!Array.isArray(imported)) throw new Error("Invalid format: Expected an array");

        let added = 0;
        let updated = 0;
        setIsLoading(true);

        for (const q of imported) {
          // STRICT MODE: If a global product is selected, enforce it!
          if (selectedAuthorProduct) {
            q.packageId = selectedAuthorProduct.id;
          }

          if (!q.id) continue;
          try {
            const exists = questions.find(existing => existing.id === q.id);
            if (exists) {
              await updateQuestion(q);
              updated++;
            } else {
              await addQuestion(q);
              added++;
            }
          } catch (err) {
            console.error(`Error processing question ${q.id}:`, err);
          }
        }

        alert(`Bulk Import Complete!\n‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nNew Records: ${added}\nUpdated: ${updated}`);
        loadQuestions();
      } catch (err) {
        console.error(err);
        alert("Import failed: " + err.message);
      } finally {
        setIsLoading(false);
      }
    };
    reader.readAsText(file);
    e.target.value = ''; // Reset input
  };

  // Sorting & Filtering
  const sortedQuestions = [...questions].sort((a, b) => {
    const dateA = new Date(a.createdAt || 0);
    const dateB = new Date(b.createdAt || 0);
    return sortBy === "newest" ? dateB - dateA : dateA - dateB;
  });

  const filteredQuestions = sortedQuestions.filter(q => {
    return (
      (!filterSystem || q.system === filterSystem) &&
      (!filterSubject || q.subject === filterSubject) &&
      (!filterTopic || q.topic?.toLowerCase().includes(filterTopic.toLowerCase())) &&
      (!filterStem || q.stem?.toLowerCase().includes(filterStem.toLowerCase())) &&
      (!packageFilter || (q.packageId && q.packageId.toString() === packageFilter.toString()))
    );
  });

  const totalPages = Math.ceil(filteredQuestions.length / questionsPerPage);
  const paginated = filteredQuestions.slice(
    (currentPage - 1) * questionsPerPage,
    currentPage * questionsPerPage
  );

  if (!ok) return null;

  return (
    <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#005EB8]/5 pointer-events-none" />
      <main className="max-w-[1400px] mx-auto px-6 py-8 relative z-10">
        <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
          <div>
            <h1 className="text-3xl font-heading font-black tracking-tight text-[#1B263B]">Question <span className="text-[#005EB8]">Bank</span></h1>
            <p className="text-slate-500 mt-2 text-sm font-medium">Manage your educational content, import/export data, and monitor question status</p>
          </div>
          <div className="flex flex-wrap gap-3">
            <button onClick={handleExport} className="px-6 py-2.5 bg-background border border-border text-foreground rounded-2xl hover:bg-panel text-xs font-bold transition-all shadow-sm">
              Export JSON
            </button>
            <button onClick={handleExportCSV} className="px-6 py-2.5 bg-background border border-border text-foreground rounded-2xl hover:bg-panel text-xs font-bold transition-all shadow-sm">
              Export CSV
            </button>
            <label className="px-6 py-2.5 bg-white border-2 border-primary/20 text-primary rounded-2xl hover:bg-primary hover:text-white text-[11px] font-black uppercase tracking-widest cursor-pointer transition-all shadow-md group border-dashed hover:border-solid">
              <span className="flex items-center gap-2">
                <LayoutGrid size={14} className="group-hover:rotate-90 transition-transform duration-500" />
                Import Questions
              </span>
              <input
                type="file"
                accept=".json,.csv"
                className="hidden"
                onChange={handleImport}
                ref={fileInputRef}
              />
            </label>
          </div>
        </div>

        <div className="flex flex-wrap items-center gap-4 mb-6 mt-4 p-4 bg-white/50 border border-slate-200 rounded-[24px] backdrop-blur-sm shadow-sm">
          <div className="flex items-center gap-2">
            <div className="flex items-center gap-3 px-4 py-2 bg-white border border-[#E2E8F0] rounded-xl shadow-sm">
              <div className="w-1.5 h-6 bg-[#0066CC] rounded-full" />
              <span className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Master Pool:</span>
              <span className="text-sm font-black text-[#1B263B]">{questions.length}</span>
            </div>
            <div className="flex items-center gap-3 px-4 py-2 bg-[#0066CC]/5 border border-[#0066CC]/10 rounded-xl shadow-sm">
              <div className="w-1.5 h-6 bg-[#0066CC] rounded-full animate-pulse" />
              <span className="text-[10px] font-black text-[#0066CC] uppercase tracking-widest">Active Stream:</span>
              <span className="text-sm font-black text-[#0066CC]">{filteredQuestions.length}</span>
            </div>
          </div>
          {packageName && (
            <div className="flex items-center gap-2 bg-[#005EB8]/10 text-[#005EB8] px-4 py-1.5 rounded-full border border-[#005EB8]/20 animate-in fade-in slide-in-from-left-4 duration-500">
              <Database size={14} />
              <span className="text-[10px] font-black uppercase tracking-widest">
                {selectedAuthorProduct ? 'LOCKED CONTEXT:' : 'Package:'} {packageName}
              </span>
              {!selectedAuthorProduct && (
                <button onClick={() => { setPackageFilter(""); setPackageName(""); }} className="ml-1 hover:text-red-500 opacity-70">√ó</button>
              )}
            </div>
          )}
        </div>

        {/* Filters */}
        <div className="flex flex-wrap gap-3 mb-6">
          <select value={filterSystem} onChange={e => { setFilterSystem(e.target.value); setCurrentPage(1); }} className="bg-white text-[#1B263B] border border-slate-200 p-2.5 rounded-xl min-w-[160px] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all hover:bg-slate-50 shadow-sm">
            <option value="">All Systems</option>
            {availableSystems.map(s => <option key={s} value={s}>{s}</option>)}
          </select>

          <select value={filterSubject} onChange={e => { setFilterSubject(e.target.value); setCurrentPage(1); }} className="bg-white text-[#1B263B] border border-slate-200 p-2.5 rounded-xl min-w-[160px] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all hover:bg-slate-50 shadow-sm">
            <option value="">All Subjects</option>
            {availableSubjects.map(s => <option key={s} value={s}>{s}</option>)}
          </select>

          <input placeholder="Filter Topic" value={filterTopic} onChange={e => { setFilterTopic(e.target.value); setCurrentPage(1); }} className="bg-white text-[#1B263B] border border-slate-200 p-2.5 rounded-xl min-w-[160px] focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all hover:bg-slate-50 shadow-sm" />

          <input placeholder="Filter Stem" value={filterStem} onChange={e => { setFilterStem(e.target.value); setCurrentPage(1); }} className="bg-white text-[#1B263B] border border-slate-200 p-2.5 rounded-xl min-w-[200px] flex-1 focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all shadow-sm" />

          <div className="relative group">
            <select value={sortBy} onChange={e => { setSortBy(e.target.value); setCurrentPage(1); }} className="bg-card text-foreground border border-border p-2 rounded-xl min-w-[140px] focus:ring-2 focus:ring-primary/20 outline-none transition-all appearance-none pr-8">
              <option value="newest">Newest first</option>
              <option value="oldest">Oldest first</option>
            </select>
            <div className="absolute right-3 top-1/2 -translate-y-1/2 pointer-events-none text-muted-foreground">
              <ChevronDown size={14} />
            </div>
          </div>



          <button onClick={() => {
            setFilterSystem("");
            setFilterSubject("");
            setFilterTopic("");
            setFilterStem("");
            setPackageFilter("");
            setPackageName("");

            // Remove packageId from URL without full reload
            const url = new URL(window.location);
            url.searchParams.delete('packageId');
            window.history.pushState({}, '', url);

            setCurrentPage(1);
          }} className="px-6 py-2.5 bg-panel hover:bg-border/50 text-foreground rounded-2xl text-xs font-bold transition-all border border-border">
            Clear Filters
          </button>

          <div className="flex flex-wrap gap-2 mt-4 w-full">
            <button
              onClick={bulkPublish}
              className="px-4 py-2 bg-emerald-50 text-emerald-600 border border-emerald-100 rounded-xl text-xs font-bold hover:bg-emerald-100 transition-all disabled:opacity-30"
              disabled={selectedIds.size === 0}
            >
              Bulk Publish Drafts
            </button>
            <button
              onClick={bulkDelete}
              className="px-4 py-2 bg-red-50 text-red-600 border border-red-100 rounded-xl text-xs font-bold hover:bg-red-100 transition-all disabled:opacity-30"
              disabled={selectedIds.size === 0}
            >
              Bulk Delete
            </button>
            {selectedIds.size > 0 && (
              <span className="ml-2 text-xs font-bold text-muted-foreground flex items-center">
                {selectedIds.size} Selected
              </span>
            )}
          </div>
        </div>

        {isLoading ? (
          <div className="text-center py-12 text-gray-500">Loading...</div>
        ) : error ? (
          <div className="text-center py-12 text-red-600">{error}</div>
        ) : filteredQuestions.length === 0 ? (
          <div className="text-center py-12 opacity-50 bg-card rounded-2xl border border-border">No questions found</div>
        ) : (
          <>
                  <div className="overflow-x-auto bg-white rounded-2xl border border-slate-200 shadow-[0_15px_40px_rgba(0,0,94,0.04)] mb-6">
              <table className="min-w-full divide-y divide-border">
                      <thead className="bg-panel font-bold text-[10px] uppercase tracking-widest text-muted-foreground border-b border-border">
                  <tr>
                          <th className="px-6 py-4 text-left">
                            <input
                              type="checkbox"
                              className="w-4 h-4 rounded border-border accent-primary cursor-pointer"
                              checked={paginated.length > 0 && paginated.every(q => selectedIds.has(q.id))}
                              onChange={toggleSelectAll}
                            />
                          </th>
                          <th className="px-6 py-4 text-left">ID</th>
                          <th className="px-6 py-4">System</th>
                          <th className="px-6 py-4">Category</th>
                          <th className="px-6 py-4">Stem</th>
                          <th className="px-6 py-4">Created</th>
                          <th className="px-6 py-4">Status</th>
                          <th className="px-6 py-4 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-border">
                  {paginated.map(q => (
                    <tr key={q.id} className={`hover:bg-[#EAF1F7]/50 transition-all border-b border-slate-100 last:border-0 group cursor-default ${selectedIds.has(q.id) ? 'bg-[#0066CC]/5' : ''}`}>
                      <td className="px-6 py-5 whitespace-nowrap">
                        <input
                          type="checkbox"
                          className="w-4 h-4 rounded border-border accent-primary cursor-pointer"
                          checked={selectedIds.has(q.id)}
                          onChange={() => toggleSelect(q.id)}
                        />
                      </td>
                      <td className="px-6 py-5 whitespace-nowrap text-xs font-mono text-muted-foreground">{q.id.substring(0, 8)}</td>
                      <td className="px-6 py-5 whitespace-nowrap text-xs font-bold text-foreground opacity-80">{q.system || '-'}</td>
                      <td className="px-6 py-5 whitespace-nowrap">
                        <div className="text-xs font-bold text-foreground">{q.subject}</div>
                        <div className="text-[10px] text-muted-foreground uppercase font-medium">{q.topic || '-'}</div>
                      </td>
                      <td className="px-6 py-5 max-w-xs">
                        <div className="line-clamp-1 text-sm text-foreground/80 group-hover:text-primary transition-colors" title={q.stem}>
                          {q.stem?.substring(0, 60) || "No stem"}{q.stem?.length > 60 ? '...' : ''}
                        </div>
                      </td>
                      <td className="px-6 py-5 whitespace-nowrap text-xs text-muted-foreground">
                        {q.createdAt ? new Date(q.createdAt).toLocaleDateString() : '-'}
                      </td>
                      <td className="px-6 py-5 whitespace-nowrap">
                        <span className={`px-2 py-0.5 rounded-full text-[10px] font-bold uppercase tracking-wider flex items-center gap-1.5 w-fit ${
                          q.status === 'published' ? 'bg-emerald-100 text-emerald-700' : 
                          q.status === 'draft' ? 'bg-amber-100 text-amber-700' : 
                          q.status === 'review' ? 'bg-blue-100 text-blue-700' :
                          q.status === 'approved' ? 'bg-indigo-100 text-indigo-700' :
                          q.status === 'deprecated' ? 'bg-red-100 text-red-700' :
                          'bg-slate-100 text-slate-600'
                        }`}>
                          {q.status === 'published' && <CheckCircle2 size={10} />}
                          {q.status === 'review' && <Clock size={10} />}
                          {q.status === 'draft' && <FileEdit size={10} />}
                          {q.status === 'approved' && <CheckCircle2 size={10} />}
                          {q.status === 'deprecated' && <AlertTriangle size={10} />}
                          {q.status || 'Draft'} {q.versionNumber ? `v${q.versionNumber}` : ''}
                        </span>
                      </td>
                      <td className="px-6 py-5 whitespace-nowrap text-right">
                        <div className="flex items-center justify-end gap-2">
                          <button
                            onClick={() => router.push(`/author/create-question?id=${q.id}`)}
                            className="p-1 px-3 bg-blue-100 text-blue-600 rounded text-[10px] font-bold hover:bg-blue-200 transition-colors uppercase"
                          >
                            Edit
                          </button>
                          <button
                            onClick={() => setPreviewQuestion(q)}
                            className="p-1 px-3 bg-slate-100 text-slate-600 rounded text-[10px] font-bold hover:bg-slate-200 transition-colors uppercase"
                          >
                            View
                          </button>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            {/* Pagination */}
            {totalPages > 1 && (
              <div className="flex justify-center items-center gap-6 mt-8 font-mono text-sm">
                <button disabled={currentPage === 1} onClick={() => setCurrentPage(p => p - 1)} className="px-6 py-2 border border-border bg-card hover:bg-accent transition-all rounded-xl disabled:opacity-30">
                  PREV
                </button>
                <span className="opacity-60">PAGE {currentPage} / {totalPages}</span>
                <button disabled={currentPage === totalPages} onClick={() => setCurrentPage(p => p + 1)} className="px-6 py-2 border border-border bg-card hover:bg-accent transition-all rounded-xl disabled:opacity-30">
                  NEXT
                </button>
              </div>
            )}
          </>
        )
        }

        {/* Preview Modal */}
        {previewQuestion && (
          <div className="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 p-4" onClick={() => setPreviewQuestion(null)}>
            <div className="bg-card text-card-foreground rounded-3xl max-w-4xl w-full max-h-[90vh] overflow-y-auto p-8 shadow-2xl border border-border relative" onClick={e => e.stopPropagation()}>
              <h2 className="text-2xl font-heading font-black text-foreground mb-6 uppercase tracking-tight flex items-center justify-between gap-3">
                <div className="flex items-center gap-3">
                  <span className="w-2 h-8 bg-primary rounded-full" />
                  Previewing <span className="text-primary">Question</span>
                </div>
                <div className="flex gap-3">
                  <button onClick={() => setPreviewTab('preview')} className={`text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl transition-all ${previewTab === 'preview' ? 'bg-primary text-white shadow-lg shadow-primary/30' : 'bg-panel text-slate-400 hover:bg-border/20'}`}>Content</button>
                  <button onClick={() => setPreviewTab('history')} className={`text-[10px] font-black uppercase tracking-widest px-4 py-2 rounded-xl transition-all ${previewTab === 'history' ? 'bg-primary text-white shadow-lg shadow-primary/30' : 'bg-panel text-slate-400 hover:bg-border/20'}`}>Audit Trail</button>
                </div>
              </h2>

              <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-sm">
                <div><strong>System:</strong> {previewQuestion.system || '-'}</div>
                <div><strong>Subject:</strong> {previewQuestion.subject || '-'}</div>
                <div><strong>Topic:</strong> {previewQuestion.topic || '-'}</div>
                <div>
                  <strong>Status:</strong> 
                  <span className="ml-2 font-black uppercase text-[10px] text-primary">{previewQuestion.status || 'Draft'}</span>
                </div>
              </div>

              {previewTab === 'history' ? (
                <div className="bg-panel/50 rounded-2xl p-6 border border-border">
                  <GovernanceTimeline versionId={previewQuestion.id} conceptId={previewQuestion.conceptId} />
                </div>
              ) : (
                <>
                {/* Content... existing content moved here */}

              {/* Stem */}
              <div className="mb-8">
                <h3 className="font-semibold text-lg mb-2 text-foreground">Stem</h3>
                <p className="mb-4 whitespace-pre-wrap text-muted-foreground">{previewQuestion.stem || "No stem"}</p>
                {previewQuestion.stemImage?.data && (
                  revealedImages.has('stem') ? (
                    <img src={previewQuestion.stemImage.data} alt="Stem" className={`rounded-xl shadow-lg border border-border ${imageSizeClass(previewQuestion.stemImage.size || "default")}`} />
                  ) : (
                    <div
                      role="button"
                      tabIndex={0}
                      onClick={() => setRevealedImages(prev => { const s = new Set(prev); s.add('stem'); return s; })}
                        className="relative group rounded-xl border border-border bg-panel cursor-pointer overflow-hidden"
                        style={{ backgroundImage: `url(${previewQuestion.stemImage.data})`, minHeight: 200, backgroundSize: 'cover', backgroundPosition: 'center' }}
                    >
                        <div className="absolute inset-0 flex items-center justify-center bg-background/60 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                          <span className="bg-primary text-white px-5 py-2.5 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-primary/30">Click to Reveal Image</span>
                        </div>
                    </div>
                  )
                )}
              </div>

              {/* Choices */}
              <div className="mb-8">
                <h3 className="font-semibold text-lg mb-3">Choices</h3>
                <div className="space-y-4">
                  {previewQuestion.choices?.map((c, i) => (
                    <div key={i} className="flex gap-4">
                      <span className="font-bold w-8">{String.fromCharCode(65 + i)}.</span>
                      <div>
                        <p className="mb-2">{c.text || "No text"}</p>
                        {c.image?.data && (
                          revealedImages.has(`choice-${i}`) ? (
                            <img src={c.image.data} alt={`Choice ${String.fromCharCode(65 + i)}`} className={`rounded-xl shadow-md border border-border ${imageSizeClass(c.image.size || "default")}`} />
                          ) : (
                            <div
                              role="button"
                              tabIndex={0}
                              onClick={() => setRevealedImages(prev => { const s = new Set(prev); s.add(`choice-${i}`); return s; })}
                                className="relative group rounded-xl border border-border bg-panel cursor-pointer overflow-hidden"
                                style={{ backgroundImage: `url(${c.image.data})`, minHeight: 120, backgroundSize: 'cover', backgroundPosition: 'center' }}
                            >
                                <div className="absolute inset-0 flex items-center justify-center bg-background/60 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                                  <span className="bg-primary text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg shadow-primary/20">Reveal Image</span>
                                </div>
                            </div>
                          )
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* Explanations */}
              <div>
                <h3 className="font-semibold text-lg mb-3">Explanations</h3>
                {previewQuestion.explanationCorrect && (
                  <div className="mb-6">
                    <p className="font-medium mb-2">Correct:</p>
                    <p className="whitespace-pre-wrap">{previewQuestion.explanationCorrect}</p>
                    {previewQuestion.explanationCorrectImage?.data && (
                      revealedImages.has('explanation-correct') ? (
                        <img src={previewQuestion.explanationCorrectImage.data} alt="Correct" className={`mt-3 rounded-xl shadow-md border border-border ${imageSizeClass(previewQuestion.explanationCorrectImage.size || "default")}`} />
                      ) : (
                        <div
                          role="button"
                          tabIndex={0}
                          onClick={() => setRevealedImages(prev => { const s = new Set(prev); s.add('explanation-correct'); return s; })}
                            className="relative group mt-3 rounded-xl border border-border bg-panel cursor-pointer overflow-hidden"
                            style={{ backgroundImage: `url(${previewQuestion.explanationCorrectImage.data})`, minHeight: 120, backgroundSize: 'cover', backgroundPosition: 'center' }}
                        >
                            <div className="absolute inset-0 flex items-center justify-center bg-background/60 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                              <span className="bg-primary text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg shadow-primary/20">Reveal Image</span>
                            </div>
                        </div>
                      )
                    )}
                  </div>
                )}
                {previewQuestion.explanationWrong && (
                  <div className="mb-6">
                    <p className="font-medium mb-2">Wrong:</p>
                    <p className="whitespace-pre-wrap">{previewQuestion.explanationWrong}</p>
                    {previewQuestion.explanationWrongImage?.data && (
                      revealedImages.has('explanation-wrong') ? (
                        <img src={previewQuestion.explanationWrongImage.data} alt="Wrong" className={`mt-3 rounded-xl shadow-md border border-border ${imageSizeClass(previewQuestion.explanationWrongImage.size || "default")}`} />
                      ) : (
                        <div
                          role="button"
                          tabIndex={0}
                          onClick={() => setRevealedImages(prev => { const s = new Set(prev); s.add('explanation-wrong'); return s; })}
                            className="relative group mt-3 rounded-xl border border-border bg-panel cursor-pointer overflow-hidden"
                            style={{ backgroundImage: `url(${previewQuestion.explanationWrongImage.data})`, minHeight: 120, backgroundSize: 'cover', backgroundPosition: 'center' }}
                        >
                            <div className="absolute inset-0 flex items-center justify-center bg-background/60 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                              <span className="bg-primary text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg shadow-primary/20">Reveal Image</span>
                            </div>
                        </div>
                      )
                    )}
                  </div>
                )}
                {previewQuestion.summary && (
                  <div>
                    <p className="font-medium mb-2">Summary:</p>
                    <p className="whitespace-pre-wrap">{previewQuestion.summary}</p>
                    {previewQuestion.summaryImage?.data && (
                      revealedImages.has('summary') ? (
                        <img src={previewQuestion.summaryImage.data} alt="Summary" className={`mt-3 rounded-xl shadow-md border border-border ${imageSizeClass(previewQuestion.summaryImage.size || "default")}`} />
                      ) : (
                        <div
                          role="button"
                          tabIndex={0}
                          onClick={() => setRevealedImages(prev => { const s = new Set(prev); s.add('summary'); return s; })}
                            className="relative group mt-3 rounded-xl border border-border bg-panel cursor-pointer overflow-hidden"
                            style={{ backgroundImage: `url(${previewQuestion.summaryImage.data})`, minHeight: 120, backgroundSize: 'cover', backgroundPosition: 'center' }}
                        >
                            <div className="absolute inset-0 flex items-center justify-center bg-background/60 backdrop-blur-sm opacity-0 group-hover:opacity-100 transition-opacity">
                              <span className="bg-primary text-white px-4 py-2 rounded-xl text-[9px] font-black uppercase tracking-widest shadow-lg shadow-primary/20">Reveal Image</span>
                            </div>
                        </div>
                      )
                    )}
                  </div>
                )}
              </div>
              </>
              )}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
</file>

<file path="src/app/author/page.jsx">
"use client";
import React, { useState, useEffect, useContext } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Users, Clock, TrendingUp, Target, Shield, Eye, EyeOff, Database } from 'lucide-react';

// Import components
import KPICard from '@/components/author/KPICard';
import QuickInsights from '@/components/author/QuickInsights';
import DashboardCharts from '@/components/author/DashboardCharts';
import BottomStats from '@/components/author/BottomStats';

// Import analytics
import { getDashboardStats, getEngagementChartData, getEngagementStats } from '@/services/analytics.service';
import { getAllUsers } from '@/services/user.service';
import { getAllQuestions } from '@/services/question.service';
import { AppContext } from '@/context/AppContext';


const dummyChartData = [
  { name: '1', val: 400 },
  { name: '2', val: 300 },
  { name: '3', val: 500 },
  { name: '4', val: 450 },
  { name: '5', val: 600 },
  { name: '6', val: 700 },
  { name: '7', val: 850 },
];

const decliningData = [
  { name: '1', val: 850 },
  { name: '2', val: 700 },
  { name: '3', val: 750 },
  { name: '4', val: 600 },
  { name: '5', val: 500 },
  { name: '6', val: 450 },
  { name: '7', val: 400 },
];

export default function Dashboard() {
  const { selectedAuthorProduct } = useContext(AppContext);
  const [stats, setStats] = useState({
    totalQuestions: 0,
    publishedCount: 0,
    draftCount: 0,
    totalUsers: 0,
    paidUsers: 0,
    dau: 0,
    totalTests: 0,
    avgSession: "0m 0s",
    systemBreakdown: {},
    qbankActivity: [],
    systemData: [],
    recentQuestions: [],
    lastUpdated: new Date()
  });

  const [isLoading, setIsLoading] = useState(true);

  // Load real data
  const loadRealData = async () => {
    setIsLoading(true);
    try {
      const pId = selectedAuthorProduct?.id;
      const [allQs, globalStats, engagementData] = await Promise.all([
        getAllQuestions(pId, true).catch(e => { console.error(e); return []; }),
        getDashboardStats(pId).catch(e => { console.error(e); return {}; }),
        getEngagementChartData(pId).catch(e => { console.error(e); return []; })
      ]);

      const published = allQs.filter(q => q.published).length;
      const drafts = allQs.length - published;

      const systemMap = {};
      allQs.forEach(q => {
        if (q.system) systemMap[q.system] = (systemMap[q.system] || 0) + 1;
      });

      const sortedSystems = Object.entries(systemMap)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([name, val]) => ({ name, val }));

      setStats({
        totalQuestions: allQs.length,
        publishedCount: published,
        draftCount: drafts,
        totalUsers: globalStats.totalUsers || 0,
        paidUsers: globalStats.paidUsers || 0,
        dau: globalStats.dau || 0,
        totalTests: globalStats.totalTests || 0,
        avgSession: globalStats.avgSession || "0m 0s",
        avgVolatility: globalStats.behavioral?.avgVolatility?.toFixed(2) || "0.00",
        avgDifficulty: globalStats.behavioral?.avgDifficulty?.toFixed(1) || "0",
        qbankActivity: (engagementData && engagementData.length > 0) ? engagementData : dummyChartData,
        systemData: sortedSystems.length > 0 ? sortedSystems : [{ name: "ECG", val: allQs.length }],
        recentQuestions: allQs.slice(-5).reverse(),
        lastUpdated: new Date()
      });
    } catch (err) {
      console.error("Critical error in Dashboard load:", err);
      // Fallback
      setStats(prev => ({
        ...prev,
        qbankActivity: dummyChartData,
        lastUpdated: new Date()
      }));
    } finally {
      setIsLoading(false);
    }
  };

  // Visibility & Focus handling
  useEffect(() => {
    const handleVisibility = () => {
      if (document.visibilityState === 'visible') {
        loadRealData();
      }
    };
    window.addEventListener("visibilitychange", handleVisibility);
    return () => window.removeEventListener("visibilitychange", handleVisibility);
  }, []);

  // Auto-refresh logic (5 mins)
  useEffect(() => {
    const interval = setInterval(() => {
      loadRealData();
    }, 300000);
    return () => clearInterval(interval);
  }, []);

  useEffect(() => {
    loadRealData();
  }, [selectedAuthorProduct]);

  const formatRelativeTime = (date) => {
    if (!date) return "N/A";
    const now = new Date();
    const then = new Date(date);
    const diff = Math.floor((now - then) / 1000);

    if (diff < 60) return `${diff}s ago`;
    if (diff < 3600) return `${Math.floor(diff / 60)}m ago`;
    if (diff < 86400) return `${Math.floor(diff / 3600)}h ago`;
    return then.toLocaleDateString();
  };

  if (isLoading) {
    return (
      <div className="flex min-h-screen items-center justify-center bg-background">
        <div className="flex flex-col items-center gap-4">
          <div className="w-12 h-12 border-4 border-[#8B5CF6]/20 border-t-[#8B5CF6] rounded-full animate-spin"></div>
          <p className="text-gray-500 font-mono text-xs uppercase tracking-[0.3em] animate-pulse">Syncing_Realtime_Data...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
      <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#8B5CF6]/5 pointer-events-none" />
      <main className="max-w-[1400px] mx-auto px-6 py-8 relative z-10">
        <motion.div
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          transition={{ duration: 0.5 }}
          className="flex flex-col gap-8"
        >
          {/* KPI Section */}
          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6">
            <KPICard
              title="Total Users"
              value={stats.totalUsers}
              trend="+100%"
              icon={Users}
              color="text-[#8B5CF6]"
              trendData={[100, 200, 300, 400, 500, 600, 700]}
              insight="Students on platform"
              benchmark={`${stats.paidUsers} Paid subs`}
            />
            <KPICard
              title="Total Questions"
              value={stats.totalQuestions}
              trend="+5%"
              icon={Database}
              color="text-[#06B6D4]"
              trendData={[400, 420, 450, 480, 500, 520, stats.totalQuestions]}
              insight="Total items in QBank"
              benchmark="Sync: Realtime"
            />
            <KPICard
              title="Live Items"
              value={stats.publishedCount}
              trend="ACTIVE"
              icon={Shield}
              color="text-[#10B981]"
              trendData={[300, 310, 320, 330, 340, 350, stats.publishedCount]}
              insight="Questions live for students"
              benchmark="Live content"
            />
            <KPICard
              title="Global Volatility"
              value={stats.avgVolatility}
              trend="FORENSIC"
              icon={TrendingUp}
              color="text-amber-500"
              trendData={[1.1, 1.2, 1.15, 1.3, 1.25, 1.4, parseFloat(stats.avgVolatility)]}
              insight="Avg changes per item"
              benchmark="Overthinking index"
            />
            <KPICard
              title="Avg Difficulty"
              value={`${stats.avgDifficulty}%`}
              trend="CALIBRATED"
              icon={Target}
              color="text-blue-500"
              trendData={[65, 68, 70, 67, 69, 72, parseFloat(stats.avgDifficulty)]}
              insight="Overall correct rate"
              benchmark="Difficulty index"
            />
          </div>

          {/* Insights Bar */}
          <QuickInsights insights={[
            { icon: Users, label: `${stats.dau} Students active today`, bg: "bg-emerald-50", color: "text-emerald-600" },
            { icon: Database, label: `${stats.draftCount} Drafts awaiting review`, bg: "bg-amber-50", color: "text-amber-600" },
            { icon: Clock, label: "Peak Time: 18:00 - 21:00", bg: "bg-blue-50", color: "text-blue-600" },
            { icon: Shield, label: "System Secure: MB-2026-v2", bg: "bg-purple-50", color: "text-purple-600" }
          ]} />

          {/* Main Charts */}
          <DashboardCharts engagementData={stats.qbankActivity} sessionData={stats.systemData} />

        {/* Bottom Stats */}
          <BottomStats
            topEvents={[
              { name: "Active Students", count: stats.dau, trend: "up", change: "Daily" },
              { name: "Live Content", count: stats.publishedCount, trend: "up", change: "Sync" },
              { name: "Tests Taken", count: stats.totalTests, trend: "up", change: "Total" }
            ]}
            recentActivities={stats.recentQuestions.map(q => ({
              action: q.published ? "Published Content" : "Saved Draft",
              user: q.id.substring(0, 8),
              time: formatRelativeTime(q.updatedAt),
              status: q.published ? "success" : "info"
            }))}
          />
        </motion.div>
      </main>
    </div >
  );
}
</file>

<file path="src/app/author/users/page.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { getAllUsers, updateUserSubscription, getStudentProgress, banUser } from "@/services/user.service";
import { useDeleteItem } from "@/hooks/useDeleteItem";
import UserProfileModal from "@/components/author/UserProfileModal";
import { Search, Filter, MessageSquare, Shield, Clock, BookOpen, ChevronRight, User } from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";

export default function ManageUsersPage() {
    const router = useRouter();
    const [ok, setOk] = useState(false);
    const [users, setUsers] = useState([]);
    const [isLoading, setIsLoading] = useState(true);
    const [error, setError] = useState(null);

    // Filters
    const [searchQuery, setSearchQuery] = useState("");
    const [filterStatus, setFilterStatus] = useState("");
    const [sortBy, setSortBy] = useState("newest");

    const [selectedUser, setSelectedUser] = useState(null);
    const [selectedIds, setSelectedIds] = useState(new Set());
    const [isBulkLoading, setIsBulkLoading] = useState(false);

    // Delete hook
    const { handleBulkDelete: bulkDeleteUsers, isDeleting } = useDeleteItem(
        'user',
        setUsers,
        setSelectedIds
    );

    // Auth check
    useEffect(() => {
        // Legacy Password Check Removed: Authorization now handled by AuthorLayout
        setOk(true);
    }, [router]);

    useEffect(() => {
        if (ok) loadUsers();
    }, [ok]);

    const loadUsers = async () => {
        setIsLoading(true);
        setError(null);
        try {
            const all = await getAllUsers();
            // Enrich users with progress data
            const enriched = await Promise.all(all.map(async (u) => {
                const progress = await getStudentProgress(u.id);
                return { ...u, progress };
            }));
            setUsers(enriched);
        } catch (err) {
            console.error(err);
            setError("Failed to load user data");
        } finally {
            setIsLoading(false);
        }
    };

    const filteredUsers = users.filter(u => {
        const matchesSearch = u.name?.toLowerCase().includes(searchQuery.toLowerCase()) ||
            u.email?.toLowerCase().includes(searchQuery.toLowerCase());
        const matchesStatus = !filterStatus || 
            (filterStatus === 'paid' ? (u.subscriptionStatus === 'active' && (u.activatedByPurchase || u.purchased)) :
             filterStatus === 'trial' ? (u.subscriptionStatus === 'active' && !(u.activatedByPurchase || u.purchased)) :
             u.subscriptionStatus === filterStatus);
        return matchesSearch && matchesStatus;
    }).sort((a, b) => {
        const dateA = new Date(a.createdAt || 0);
        const dateB = new Date(b.createdAt || 0);
        return sortBy === "newest" ? dateB - dateA : dateA - dateB;
    });

    const toggleSelectAll = () => {
        if (selectedIds.size === filteredUsers.length && filteredUsers.length > 0) {
            setSelectedIds(new Set());
        } else {
            setSelectedIds(new Set(filteredUsers.map(u => u.id)));
        }
    };

    const toggleSelectOne = (id) => {
        const next = new Set(selectedIds);
        if (next.has(id)) next.delete(id);
        else next.add(id);
        setSelectedIds(next);
    };

    const handleBulkBan = async () => {
        if (!confirm(`Are you sure you want to REVOKE ACCESS for ${selectedIds.size} users?`)) return;
        setIsBulkLoading(true);
        try {
            for (const id of Array.from(selectedIds)) {
                await banUser(id);
            }
            alert(`Uplink Severed: ${selectedIds.size} personnel records suspended and login access revoked.`);
            setSelectedIds(new Set());
            loadUsers();
        } catch (err) {
            console.error(err);
            alert("Security Protocol Error: Failed to sever user uplinks.");
        } finally {
            setIsBulkLoading(false);
        }
    };

    const handleBulkDelete = async () => {
        const ids = Array.from(selectedIds);
        setIsBulkLoading(true);
        
        try {
            await bulkDeleteUsers(ids, {
                confirmMessage: `CRITICAL: Are you sure you want to PERMANENTLY DELETE ${ids.length} accounts? This action will PURGE ALL DATA and cannot be undone.`,
                successMessage: `Purge Complete: ${ids.length} identities erased from master registry.`
            });
        } finally {
            setIsBulkLoading(false);
        }
    };

    if (!ok) return null;

    return (
        <div className="font-body min-h-screen bg-[#F1F4F7] relative overflow-hidden">
            {/* Background Blend Accent */}
            <div className="absolute inset-0 bg-gradient-to-br from-white/20 via-transparent to-[#0066CC]/5 pointer-events-none" />
            
            <main className="max-w-[1400px] mx-auto px-6 py-8 relative z-10">
                <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-6">
                    <div>
                        <h1 className="text-4xl font-heading font-black tracking-tighter text-[#1B263B] uppercase italic">Personnel <span className="text-[#0066CC]">Registry</span></h1>
                        <p className="text-slate-500 mt-2 text-sm font-semibold tracking-tight">System-wide monitoring of student access, credentials, and progress metrics</p>
                    </div>

                    <div className="flex items-center gap-4">
                        {selectedIds.size > 0 && (
                            <motion.div 
                                initial={{ opacity: 0, x: 20 }}
                                animate={{ opacity: 1, x: 0 }}
                                className="flex items-center gap-3 bg-white p-2 pl-4 rounded-2xl border border-[#0066CC]/20 shadow-lg"
                            >
                                <span className="text-[10px] font-black text-[#0066CC] uppercase tracking-widest mr-2">{selectedIds.size} Selected</span>
                                <button 
                                    onClick={handleBulkBan}
                                    className="px-4 py-2 bg-amber-500 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-amber-600 transition-all shadow-md active:scale-95"
                                >
                                    Ban Access
                                </button>
                                <button 
                                    onClick={handleBulkDelete}
                                    className="px-4 py-2 bg-red-600 text-white rounded-xl text-[10px] font-black uppercase tracking-widest hover:bg-red-700 transition-all shadow-md active:scale-95"
                                >
                                    Terminate Account
                                </button>
                            </motion.div>
                        )}
                    </div>
                </div>

                {/* Filters */}
                <div className="flex flex-wrap gap-4 mb-8">
                    <div className="flex-1 min-w-[300px] relative">
                        <Search className="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground" size={18} />
                        <input
                            placeholder="Search by name or email..."
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="w-full bg-white border border-slate-200 pl-12 pr-4 py-3 rounded-2xl focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all font-black shadow-sm text-[#1B263B] uppercase tracking-tight"
                        />
                    </div>

                    <select
                        value={filterStatus}
                        onChange={(e) => setFilterStatus(e.target.value)}
                        className="bg-white text-[#1B263B] border border-slate-200 px-6 py-3 rounded-2xl text-sm font-black uppercase tracking-widest focus:ring-4 focus:ring-[#0066CC]/10 focus:border-[#0066CC] outline-none transition-all cursor-pointer hover:bg-slate-50 shadow-sm"
                    >
                        <option value="">All Statuses</option>
                        <option value="active">Active (All)</option>
                        <option value="paid">Paid Access</option>
                        <option value="trial">Free Trial</option>
                        <option value="expired">Expired</option>
                        <option value="canceled">Canceled</option>
                    </select>

                    <button
                        onClick={loadUsers}
                        className="p-3 bg-white border border-slate-200 text-[#1B263B] hover:bg-slate-50 rounded-2xl transition-all shadow-sm"
                        title="Refresh List"
                    >
                        <Clock size={20} />
                    </button>
                </div>

                {isLoading ? (
                    <div className="flex flex-col items-center justify-center py-20 gap-4">
                        <div className="w-10 h-10 border-4 border-[#0066CC]/20 border-t-[#0066CC] rounded-full animate-spin"></div>
                        <p className="text-slate-400 font-mono text-[10px] font-black uppercase tracking-[0.3em]">Hydrating_User_Registry...</p>
                    </div>
                ) : error ? (
                    <div className="p-10 bg-red-50 text-red-600 rounded-3xl border border-red-100 text-center font-black uppercase text-xs tracking-widest">
                        {error}
                    </div>
                ) : filteredUsers.length === 0 ? (
                    <div className="p-20 bg-white rounded-[40px] border border-slate-200 text-center shadow-sm">
                        <div className="w-20 h-20 bg-slate-50 rounded-3xl flex items-center justify-center mx-auto mb-6">
                            <User size={40} className="text-[#0066CC]" />
                        </div>
                        <h3 className="font-heading font-black text-2xl mb-2 text-[#1B263B] uppercase italic">Empty Registry</h3>
                        <p className="text-slate-500 text-sm font-semibold max-w-xs mx-auto">No student identities detected matching the current search parameters.</p>
                    </div>
                ) : (
                    <div className="overflow-hidden bg-white rounded-[40px] border border-slate-200 shadow-[0_15px_40px_rgba(0,0,94,0.04)]">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="border-b border-slate-100 bg-slate-50/50">
                                    <th className="px-8 py-6 w-16">
                                        <input 
                                            type="checkbox" 
                                            className="w-5 h-5 rounded-md border-slate-300 text-[#0066CC] focus:ring-[#0066CC] cursor-pointer shadow-sm"
                                            checked={selectedIds.size === filteredUsers.length && filteredUsers.length > 0}
                                            onChange={toggleSelectAll}
                                        />
                                    </th>
                                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B]">Student Identity</th>
                                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B]">Subscription</th>
                                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B]">Enrolled</th>
                                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B]">Registry Progress</th>
                                    <th className="px-8 py-6 text-[11px] font-black uppercase tracking-[0.2em] text-[#1B263B] text-right">Actions</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {filteredUsers.map((user) => (
                                    <tr key={user.id} className={`hover:bg-[#EAF1F7]/40 transition-all group ${selectedIds.has(user.id) ? 'bg-[#0066CC]/5' : ''}`}>
                                        <td className="px-8 py-6">
                                            <input 
                                                type="checkbox" 
                                                className="w-5 h-5 rounded border-slate-300 text-[#0066CC] focus:ring-[#0066CC] cursor-pointer shadow-sm"
                                                checked={selectedIds.has(user.id)}
                                                onChange={() => toggleSelectOne(user.id)}
                                            />
                                        </td>
                                        <td className="px-8 py-6">
                                            <div className="flex items-center gap-4">
                                                <div className="w-12 h-12 rounded-2xl bg-gradient-to-tr from-[#0066CC]/10 to-[#00CCFF]/10 border border-[#0066CC]/20 flex items-center justify-center text-[#0066CC] font-black shadow-sm text-lg">
                                                    {user.name?.charAt(0) || 'U'}
                                                </div>
                                                <div>
                                                    <div className="font-black text-[#1B263B] text-[15px] group-hover:text-[#0066CC] transition-colors uppercase tracking-tight">{user.name || 'Anonymous Student'}</div>
                                                    <div className="text-[10px] font-black font-mono text-slate-400 uppercase tracking-widest">{user.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-8 py-6">
                                            <div className="flex flex-col gap-1">
                                                <span className={`inline-flex items-center gap-2 px-3 py-1.5 rounded-full text-[10px] font-black uppercase tracking-widest w-fit shadow-sm border ${
                                                    user.subscriptionStatus === 'active' ? 'bg-[#0D9488]/10 text-[#0D9488] border-[#0D9488]/20' :
                                                    user.subscriptionStatus === 'expired' ? 'bg-amber-100 text-amber-700 border-amber-200' :
                                                    'bg-red-100 text-red-700 border-red-200'
                                                }`}>
                                                    <div className={`w-1.5 h-1.5 rounded-full ${user.subscriptionStatus === 'active' ? 'bg-[#0D9488] animate-pulse' :
                                                            user.subscriptionStatus === 'expired' ? 'bg-amber-500' :
                                                                'bg-red-500'
                                                        }`} />
                                                    {user.subscriptionStatus === 'active'
                                                        ? (user.activatedByPurchase || user.purchased ? 'PAID_ACCESS' : 'TRIAL_UPLINK')
                                                        : user.subscriptionStatus?.toUpperCase() || 'OFFLINE'
                                                    }
                                                </span>
                                                {(user.activatedByPurchase || user.purchased) && user.expiresAt && (
                                                    <div className="text-[10px] font-black font-mono text-slate-400 uppercase tracking-widest mt-1 ml-1 opacity-70">
                                                        EXP: {new Date(user.expiresAt).toLocaleDateString()}
                                                    </div>
                                                )}
                                            </div>
                                        </td>
                                        <td className="px-8 py-6">
                                            <div className="text-xs font-black text-[#1B263B] uppercase tracking-widest opacity-80 font-mono">
                                                {new Date(user.createdAt || Date.now()).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                            </div>
                                        </td>
                                        <td className="px-8 py-6">
                                            <div className="flex flex-col gap-2 w-48">
                                                <div className="flex items-center justify-between">
                                                    <span className="text-[10px] font-black text-[#0066CC] uppercase tracking-widest">{user.progress?.percentage}% Mastery</span>
                                                    <span className="text-[10px] font-black font-mono text-slate-400">{user.progress?.completed}/{user.progress?.total}</span>
                                                </div>
                                                <div className="h-2 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                                                    <div
                                                        className="h-full bg-[#0066CC] transition-all duration-1000 shadow-[0_0_12px_rgba(0,102,204,0.4)]"
                                                        style={{ width: `${user.progress?.percentage}%` }}
                                                    />
                                                </div>
                                            </div>
                                        </td>
                                        <td className="px-8 py-6 text-right">
                                            <button 
                                                onClick={() => setSelectedUser(user)}
                                                className="p-3 rounded-2xl bg-white hover:bg-[#0066CC] hover:text-white transition-all border border-slate-200 shadow-sm group/btn"
                                            >
                                                <ChevronRight size={18} className="group-hover/btn:translate-x-0.5 transition-transform" />
                                            </button>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                )}
            </main>

            {selectedUser && (
                <UserProfileModal
                    user={selectedUser}
                    onClose={() => setSelectedUser(null)}
                    onUpdate={loadUsers}
                />
            )}
        </div>
    );
}
</file>

<file path="src/app/globals.css">
@import "tailwindcss";

:root {
  /* Common Tokens */
  --primary: #007BFF;
  --primary-foreground: #ffffff;
  --radius: 1rem;
    /* Theme Colors (Default Light) */
    --background: #F8F9FA;
    --foreground: #212529;
    --card: #FFFFFF;
    --card-foreground: #212529;
    --panel: #E9ECEF;
    --border: #DEE2E6;
    --muted-foreground: #6C757D;
    --accent: #E7F1FF;
    /* Sidebar Specific (Light) */
    --sidebar-bg: #FFFFFF;
    --sidebar-text: #495057;
    --sidebar-hover: #F1F3F5;
    --sidebar-active: #E7F1FF;
    --sidebar-active-text: #007BFF;

  /* Professional Medical Palette (UWorld/High-End Inspired) */
    --cyber-bg: #F1F4F7;
    /* Ultra light clinical grey-blue base */
    --cyber-navy: #151B28;
    --cyber-purple: #4F46E5;
    --cyber-blue: #0066CC;
    /* Rich Medical Blue */
    --cyber-teal: #0891B2;
    --cyber-green: #10B981;
    --cyber-amber: #F59E0B;
    --cyber-red: #EF4444;
    --cyber-gray: #475569;
      --cyber-card: #FDFDFD;
      /* Very subtle off-white clinical tint */
      --cyber-border: #CBD5E1;
      --cyber-glow: 0 4px 15px rgba(0, 102, 204, 0.08);
      --cyber-glow-elevated: 0 10px 30px rgba(0, 102, 204, 0.12);
}

.dark {
  --background: #121212;
    --foreground: #E9ECEF;
    --card: #1E1E1E;
    --card-foreground: #F8F9FA;
    --panel: #2D2D2D;
    --border: #404040;
    --muted-foreground: #ADB5BD;
    --accent: #0056B3;
  
    /* Sidebar Specific (Dark) */
    --sidebar-bg: #1A1A1A;
    --sidebar-text: #CED4DA;
    --sidebar-hover: #2D2D2D;
    --sidebar-active: #007BFF;
    --sidebar-active-text: #FFFFFF;
}



.cyber-theme {
    --background: var(--cyber-bg);
      --foreground: #0F172A;
      --card: var(--cyber-card);
      --border: var(--cyber-border);
    background-color: var(--cyber-bg);
    color: var(--foreground);
      min-height: 100vh;
    font-weight: 500;
      /* Cleaner and more visible default weight */
}

body {
  background: var(--background);
  color: var(--foreground);
  font-family: var(--font-sans), system-ui, sans-serif;
  overflow-x: hidden;
}

.glass {
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.dark .glass {
  background: rgba(15, 23, 42, 0.7);
  border: 1px solid rgba(255, 255, 255, 0.1);
}

.cyber-card {
  background: #FFFFFF;
  backdrop-filter: blur(24px);
  -webkit-backdrop-filter: blur(24px);
  border: 1px solid #E2E8F0;
  border-radius: 24px;
  box-shadow: 0 4px 20px rgba(0, 70, 150, 0.04);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.cyber-card:hover {
  transform: translateY(-6px) scale(1.005);
    box-shadow: 0 15px 40px rgba(0, 70, 150, 0.08);
}

.cyber-gradient-text {
  background: linear-gradient(135deg, var(--cyber-purple), var(--cyber-blue));
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

.no-scrollbar::-webkit-scrollbar {
  display: none;
}

.no-scrollbar {
  -ms-overflow-style: none;
  scrollbar-width: none;
}

.font-heading {
  font-family: var(--font-heading);
  font-weight: 800;
    /* More prominent headings */
    letter-spacing: -0.02em;
}

.font-body {
  font-family: var(--font-body);
  font-weight: 500;
    /* More visible body text */
}

.font-mono {
  font-family: var(--font-mono);
}

.cyber-mesh {
  background-color: #E2E8F0;
  background-image:
    radial-gradient(at 0% 0%, rgba(250, 252, 255, 0.8) 0px, transparent 100%),
      radial-gradient(at 100% 0%, rgba(0, 102, 204, 0.1) 0px, transparent 100%),
      radial-gradient(at 50% 50%, rgba(241, 244, 247, 0.5) 0px, transparent 100%),
      radial-gradient(at 100% 100%, rgba(124, 58, 237, 0.1) 0px, transparent 100%),
      radial-gradient(at 0% 100%, rgba(16, 185, 129, 0.1) 0px, transparent 100%);
      background-attachment: fixed;
}

.pulse-glow {
  animation: pulse-glow 2s infinite;
}

@keyframes pulse-glow {
  0% {
    box-shadow: 0 0 5px rgba(139, 92, 246, 0.2);
  }

  50% {
    box-shadow: 0 0 20px rgba(139, 92, 246, 0.5);
  }

  100% {
    box-shadow: 0 0 5px rgba(139, 92, 246, 0.2);
  }
}

.shimmer {
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
  background-size: 200% 100%;
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% {
    background-position: -200% 0;
  }

  100% {
    background-position: 200% 0;
  }
}

.gradient-text {
  background: linear-gradient(135deg, #2563eb, #7c3aed);
  -webkit-background-clip: text;
  background-clip: text;
  -webkit-text-fill-color: transparent;
}

/* MedBank Specific Classes */
.medbank-sidebar {
  background-color: var(--medbank-navy);
  color: white;
}

.medbank-active {
  background-color: rgba(255, 255, 255, 0.1);
  border-left: 4px solid var(--medbank-accent);
}

.medbank-card {
  background: white;
  border: 1px solid var(--medbank-border);
  border-radius: 4px;
}

.medbank-header {
  background: white;
  border-bottom: 2px solid var(--medbank-navy);
  }
  
  /* Global Select Option Fixes */
  select option {
    background-color: var(--card);
    color: var(--foreground);
  }
  
  .dark select option {
    background-color: #1e1e1e;
    color: #f8f9fa;
  }
  
  .cyber-theme select option {
    background-color: #ffffff;
    color: #0f172a;
  }
  
  /* Custom Scrollbar for nicer looks in terminal */
  .custom-scrollbar::-webkit-scrollbar {
    width: 6px;
    height: 6px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-track {
    background: transparent;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb {
    background: var(--border);
    border-radius: 10px;
  }
  
  .custom-scrollbar::-webkit-scrollbar-thumb:hover {
    background: var(--muted-foreground);
}
</file>

<file path="src/app/student/(dashboard)/layout.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter, usePathname } from "next/navigation";
import { requireAuth } from "@/auth/auth.guard";
import Sidebar from "@/components/student/layout/Sidebar";
import AccountDropdown from "@/components/student/layout/AccountDropdown";
import { LogOut, User, Menu, ShoppingCart, Sun, Moon } from "lucide-react";
import { logout } from "@/auth/auth.logic";
import { AppContext } from "@/context/AppContext";
import { useContext } from "react";
import { getPublishedProducts } from "@/services/product.service";
import { ChevronDown, Package } from "lucide-react";
import { AnimatePresence, motion } from "framer-motion";
export default function AppLayout({ children }) {
  const router = useRouter();
  const pathname = usePathname();
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
  const [user, setUser] = useState(null);
  const [timeRemaining, setTimeRemaining] = useState({ days: 0, hours: 0, minutes: 0, seconds: 0 });
  const { theme, toggleTheme, selectedStudentProduct, setGlobalStudentProduct, setAvailableStudentProducts, availableStudentProducts } = useContext(AppContext);
  const [showVaultSwitcher, setShowVaultSwitcher] = useState(false);

  const handleLogout = () => {
    logout();
    router.push("/");
  };

  useEffect(() => {
    requireAuth(router);
    
    // Safety check for banned status and expiration
    const userId = localStorage.getItem("medbank_user");
    if (userId) {
      import("@/services/user.service").then(async ({ getUserById }) => {
        const userData = await getUserById(userId);
        setUser(userData);
        if (!userData) {
          console.warn("[Student Security] Session invalid - user record not found. Clearing credentials.");
          handleLogout();
          return;
        }

        if (userData?.isBanned) {
          alert("Your account has been suspended. Please contact support.");
          handleLogout();
          return;
        }

        // Role-based isolation
        const effectiveRole = String(userData?.role || '').toLowerCase().trim();
        if (effectiveRole === 'author') {
           console.log(`[Student Portal] Role: ${effectiveRole} detected. Authors are restricted to the author portal. Redirecting...`);
           router.push("/author");
           return;
        }
        
        console.log(`[Student Portal] Role: ${effectiveRole} access permitted.`);

        // Expiration check
        if (userData?.expiresAt) {
          const now = new Date();
          const expiry = new Date(userData.expiresAt);
          if (expiry <= now) {
            router.push("/student/portal");
            return;
          }
        }
      });
    }
  }, [router, pathname]);

  // Load authorized subcriptions (vaults) for the student
  useEffect(() => {
    if (!user) return;
    
    import("@/services/user.service").then(m => {
      m.getUserSubscriptions(user.id).then(subs => {
        // Map active subscriptions to product-like objects for the UI
        const activeSubs = subs.filter(s => s.status === 'active').map(s => ({
          subscriptionId: s.id,
          id: s.packageId, // used for API scoping
          name: s.productName || 'Medical QBank',
          expiresAt: s.expiresAt,
          durationDays: s.durationDays
        }));

        setAvailableStudentProducts(activeSubs);
        
        // Enforce selection
        if (!selectedStudentProduct && activeSubs.length > 0) {
          setGlobalStudentProduct(activeSubs[0]);
        }
      });
    });
  }, [user]);

  // Close dropdown on click outside
  useEffect(() => {
    const handle = () => setShowVaultSwitcher(false);
    if (showVaultSwitcher) window.addEventListener('click', handle);
    return () => window.removeEventListener('click', handle);
  }, [showVaultSwitcher]);

  // Close mobile menu on route change
  useEffect(() => {
    setMobileMenuOpen(false);
  }, [pathname]);

  const isRenewalTime = () => {
    if (user?.hasPendingPurchase || (user?.purchased && !user?.activatedByPurchase)) return false;
    if (!user?.activatedAt || !user?.expiresAt || user.subscriptionStatus !== 'active') return false;
    
    const expiry = new Date(user.expiresAt).getTime();
    const now = new Date().getTime();
    const remaining = expiry - now;
    
    if (remaining <= 0) return false;

    // Show when 5 days or less remain (5 * 24 * 60 * 60 * 1000)
    const fiveDaysMs = 5 * 24 * 60 * 60 * 1000;
    
    return remaining <= fiveDaysMs;
  };

  const showRenew = isRenewalTime();
  const getDaysLeft = () => {
    if (!user?.expiresAt) return 0;
    const diff = new Date(user.expiresAt).getTime() - new Date().getTime();
    return Math.max(0, Math.ceil(diff / (1000 * 60 * 60 * 24)));
  };
  const daysLeft = getDaysLeft();

  useEffect(() => {
    if (user?.subscriptionStatus !== 'active' || !user?.expiresAt) return;
    const update = () => {
      const diff = new Date(user.expiresAt) - new Date();
      if (diff <= 0) setTimeRemaining({ days: 0, hours: 0, minutes: 0, seconds: 0 });
      else setTimeRemaining({
        days: Math.floor(diff / (1000 * 60 * 60 * 24)),
        hours: Math.floor((diff / (1000 * 60 * 60)) % 24),
        minutes: Math.floor((diff / 1000 / 60) % 60),
        seconds: Math.floor((diff / 1000) % 60)
      });
    };
    update();
    const interval = setInterval(update, 1000);
    return () => clearInterval(interval);
  }, [user?.expiresAt, user?.subscriptionStatus, user?.activatedAt]);

  return (
    <div className={`flex h-screen overflow-hidden bg-[#f1f5f9] dark:bg-[#0F0F12] transition-colors duration-300 ${theme === 'dark' ? 'dark' : ''}`}>
      {/* Sidebar */}
      <Sidebar isOpen={mobileMenuOpen} onClose={() => setMobileMenuOpen(false)} />

      {/* Main content */}
      <div className="flex-1 flex flex-col overflow-hidden w-full">
        {/* Header - Modular & Clean */}
        <header className="bg-white dark:bg-[#16161a] border-b-2 border-[#1d46af] dark:border-blue-500/30 h-16 flex justify-between items-center px-4 lg:px-8 flex-shrink-0 z-20 transition-colors duration-300">
          <div className="flex items-center gap-4">
            <button 
              onClick={() => setMobileMenuOpen(true)}
              className="lg:hidden p-2 hover:bg-zinc-100 rounded transition-colors font-bold text-[#1d46af]"
            >
              <Menu size={24} />
            </button>
            <div className="flex flex-col">
              <p className="text-[10px] font-bold text-[#64748b] dark:text-[#94a3b8] uppercase tracking-widest leading-none mb-1">Active Session / {pathname?.split('/').pop() || 'Module'}</p>
              
              <div className="relative" onClick={(e) => e.stopPropagation()}>
                <button 
                  onClick={() => setShowVaultSwitcher(!showVaultSwitcher)}
                  className="flex items-center gap-2 text-[#1B263B] dark:text-zinc-200 font-bold text-xs hover:text-[#1d46af] dark:hover:text-blue-400 transition-colors"
                >
                  <Package size={14} className="text-[#1d46af] dark:text-blue-500" />
                  {selectedStudentProduct ? selectedStudentProduct.name : 'Select Vault'}
                  <ChevronDown size={12} className={`text-zinc-400 transition-transform duration-300 ${showVaultSwitcher ? 'rotate-180' : ''}`} />
                </button>

                <AnimatePresence>
                  {showVaultSwitcher && (
                    <motion.div 
                      initial={{ opacity: 0, y: 10 }}
                      animate={{ opacity: 1, y: 0 }}
                      exit={{ opacity: 0, y: 10 }}
                      className="absolute top-full left-0 mt-2 w-64 bg-white dark:bg-[#1C1C21] border border-zinc-200 dark:border-zinc-800 rounded-2xl shadow-2xl overflow-hidden z-50 p-2"
                    >
                      <div className="max-h-[200px] overflow-y-auto custom-scrollbar space-y-1">
                        {availableStudentProducts.length === 0 ? (
                          <div className="p-4 text-center text-[10px] text-zinc-500 font-bold uppercase tracking-widest">No Authorized Vaults</div>
                        ) : (
                          availableStudentProducts.map(p => (
                            <button
                              key={p.id}
                              onClick={() => {
                                setGlobalStudentProduct(p);
                                setShowVaultSwitcher(false);
                              }}
                              className={`w-full text-left px-4 py-3 rounded-xl text-xs font-bold transition-all flex items-center gap-3 ${selectedStudentProduct?.id === p.id ? 'bg-blue-500/10 text-blue-500' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-600 dark:text-zinc-400'}`}
                            >
                              <div className={`w-1.5 h-1.5 rounded-full ${selectedStudentProduct?.id === p.id ? 'bg-blue-500' : 'bg-zinc-300 dark:bg-zinc-700'}`} />
                              {p.name}
                            </button>
                          ))
                        )}
                      </div>
                    </motion.div>
                  )}
                </AnimatePresence>
              </div>
            </div>
          </div>
          
          <div className="flex items-center gap-6">
            {/* Theme Toggle */}
            <button
              onClick={toggleTheme}
              className="p-2 hover:bg-zinc-100 dark:hover:bg-zinc-800 rounded-full transition-all text-[#64748b] dark:text-[#94a3b8]"
              title={theme === 'dark' ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
            >
              {theme === 'dark' ? <Sun size={20} /> : <Moon size={20} />}
            </button>

            <AccountDropdown />
          </div>
        </header>

        {user?.subscriptionStatus === 'active' && user?.expiresAt && showRenew && (
           <div className="w-full bg-[#2196f3] py-4 px-6 flex items-center justify-center animate-in slide-in-from-top-4 duration-500 shadow-lg z-10 border-b border-white/10">
             <div className="flex items-center gap-3 text-white font-extrabold text-[13px] md:text-sm tracking-tight text-center">
               <span>You have</span>
               <div className="flex items-center justify-center w-7 h-7 bg-zinc-900 rounded-full text-[12px] text-white shrink-0 shadow-lg">
                 {daysLeft}
               </div>
               {user?.activatedByPurchase || user?.purchased || user?.hasPendingPurchase ? (
                 <span>days left on your subscription. Renew today to keep your access.</span>
               ) : (
                 <span>days left on your free trial. Upgrade today to unlock the full QBank.</span>
               )}
             </div>
           </div>
        )}

        {/* Page content */}
        <main className="flex-1 overflow-y-auto bg-[#f1f5f9] dark:bg-[#0F0F12] transition-colors duration-300">
          <div className="p-4 md:p-8 lg:p-12 max-w-[1600px] mx-auto">
            {children}
          </div>
        </main>

        {/* Footer */}
        <footer className="bg-white dark:bg-[#16161a] border-t border-zinc-200 dark:border-zinc-800 py-3 px-8 hidden md:flex justify-between items-center text-[10px] font-bold text-[#94a3b8] dark:text-[#64748b] uppercase tracking-widest transition-colors duration-300">
          <div>¬© 2026 IskyMD Universal Systems</div>
          <div className="flex gap-6">
            <a href="#" className="hover:text-[#1d46af]">Privacy Policy</a>
            <a href="#" className="hover:text-[#1d46af]">Terms of End User License</a>
          </div>
        </footer>
      </div>
    </div>
  );
}
</file>

<file path="src/auth/auth.guard.js">
export function getCurrentUserId() {
  return localStorage.getItem("medbank_user");
}

export function requireAuth(router) {
  const userId = getCurrentUserId();
  if (!userId) {
    router.push("/auth");
  }
}
</file>

<file path="src/auth/auth.logic.js">
// auth.logic.js - Now uses API instead of IndexedDB

export async function registerUser(name, email, password, role = "student") {
  try {
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email, password, role })
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Registration failed');
    }

    return await res.json();
  } catch (error) {
    console.error('registerUser error:', error);
    throw error.message || error;
  }
}

export async function loginUser(email, password) {
  try {
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });

    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Login failed');
    }

    const user = await res.json();

    // Clear any existing test data from previous users
    localStorage.removeItem("medbank_current_test");
    localStorage.removeItem("medbank_last_test_id");

    localStorage.setItem("medbank_user", user.id);
    return user;
  } catch (error) {
    console.error('loginUser error:', error);
    throw error.message || error;
  }
}

export async function changeUserPassword(userId, oldPassword, newPassword) {
  try {
  // First verify old password by trying to get user and check
    const { getUserById, updateUser } = await import("@/services/user.service");
    const user = await getUserById(userId);
    if (!user) throw new Error("User not found");

    // Hash passwords for comparison (done server-side ideally)
    const crypto = await import('crypto');
    const hashPassword = (pwd) => crypto.createHash('sha256').update(pwd).digest('hex');

    // We need a server endpoint for this - for now, use a workaround
    // This should be a proper API endpoint in production
    const res = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email: user.email, password: oldPassword })
    });

    if (!res.ok) {
      throw new Error("Current password incorrect");
    }

    // Update password via user update
    const newHash = hashPassword(newPassword);
    await updateUser({ ...user, passwordHash: newHash });
    return true;
  } catch (error) {
    console.error('changeUserPassword error:', error);
    throw error.message || error;
  }
}

export function logout() {
  localStorage.removeItem("medbank_user");
  localStorage.removeItem("medbank_current_test");
  localStorage.removeItem("medbank_last_test_id");
}
</file>

<file path="src/components/author/UserProfileModal.jsx">
"use client";

import React, { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { X, Shield, Clock, BookOpen, Mail, User, ShieldCheck, AlertCircle, Save } from 'lucide-react';
import { updateUserSubscription, getArchiveMetadata } from '@/services/user.service';

export default function UserProfileModal({ user, onClose, onUpdate }) {
  const [isSaving, setIsSaving] = useState(false);
  const [status, setStatus] = useState(user.subscriptionStatus || 'expired');

  const handleUpdateSubscription = async () => {
    setIsSaving(true);
    try {
      const isPaid = status === 'active-paid';
      const actualStatus = status.startsWith('active') ? 'active' : status;
      const days = status === 'active-trial' ? 3 : 90;
      
      await updateUserSubscription(user.id, actualStatus, days, isPaid);
      onUpdate();
      onClose();
    } catch (err) {
      console.error(err);
      alert("Failed to update subscription");
    } finally {
      setIsSaving(false);
    }
  };

  return (
    <div className="fixed inset-0 z-[100] flex items-center justify-center p-4">
      <motion.div 
        initial={{ opacity: 0 }}
        animate={{ opacity: 1 }}
        exit={{ opacity: 0 }}
        onClick={onClose}
        className="absolute inset-0 bg-[#0F172A]/60 backdrop-blur-md"
      />
      
      <motion.div 
        initial={{ opacity: 0, scale: 0.95, y: 20 }}
        animate={{ opacity: 1, scale: 1, y: 0 }}
        exit={{ opacity: 0, scale: 0.95, y: 20 }}
        className="relative w-full max-w-2xl bg-white border border-slate-200 rounded-[32px] shadow-2xl overflow-hidden"
      >
        {/* Header */}
        <div className="p-8 border-b border-slate-100 bg-[#F8FAFC] flex items-center justify-between">
          <div className="flex items-center gap-5">
            <div className="w-16 h-16 rounded-2xl bg-gradient-to-tr from-primary to-primary/40 p-[1px] shadow-lg shadow-primary/20">
              <div className="w-full h-full rounded-2xl bg-card flex items-center justify-center text-primary text-2xl font-black">
                {user.name?.charAt(0) || 'U'}
              </div>
            </div>
            <div>
              <h2 className="text-2xl font-heading font-black text-foreground tracking-tight">{user.name || 'Anonymous Student'}</h2>
              <div className="flex items-center gap-3 mt-1">
                <span className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">{user.email}</span>
                <span className="w-1 h-1 rounded-full bg-border" />
                <span className="text-[10px] font-black text-primary uppercase tracking-widest">
                  {user.subscriptionStatus === 'active' 
                    ? (user.activatedByPurchase || user.purchased ? 'Paid Access' : 'Free Trial')
                    : 'No Active Access'}
                </span>
                {user.expiresAt && (
                  <>
                    <span className="w-1 h-1 rounded-full bg-border" />
                    <span className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
                      Expires: {new Date(user.expiresAt).toLocaleDateString()}
                    </span>
                  </>
                )}
              </div>
            </div>
          </div>
          <button 
            onClick={onClose}
            className="p-2 rounded-xl bg-panel hover:bg-border transition-all text-muted-foreground hover:text-foreground"
          >
            <X size={24} />
          </button>
        </div>

        {/* Content */}
        <div className="p-8 grid grid-cols-1 md:grid-cols-2 gap-8">
          <div className="space-y-6">
            <div>
              <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest block mb-1.5 ml-1">Subscription Control</label>
              <div className="space-y-3">
                <button 
                  onClick={() => setStatus('active-paid')}
                  className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all ${
                    status === 'active-paid' 
                    ? 'bg-emerald-500/10 border-emerald-500/30 text-emerald-600' 
                    : 'bg-panel border-border text-muted-foreground hover:border-border/80'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <ShieldCheck size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Grant Paid Access</span>
                  </div>
                  {status === 'active-paid' && <div className="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_10px_#10b981]" />}
                </button>

                <button 
                  onClick={() => setStatus('active-trial')}
                  className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all ${
                    status === 'active-trial' 
                    ? 'bg-blue-500/10 border-blue-500/30 text-blue-600' 
                    : 'bg-panel border-border text-muted-foreground hover:border-border/80'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <ShieldCheck size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Grant Free Trial</span>
                  </div>
                  {status === 'active-trial' && <div className="w-2 h-2 rounded-full bg-blue-500 shadow-[0_0_10px_#3b82f6]" />}
                </button>

                <button 
                  onClick={() => setStatus('expired')}
                  className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all ${
                    status === 'expired' 
                    ? 'bg-amber-500/10 border-amber-500/30 text-amber-600' 
                    : 'bg-panel border-border text-muted-foreground hover:border-border/80'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <Clock size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Expired Session</span>
                  </div>
                  {status === 'expired' && <div className="w-2 h-2 rounded-full bg-amber-500 shadow-[0_0_10px_#f59e0b]" />}
                </button>

                <button 
                  onClick={() => setStatus('canceled')}
                  className={`w-full flex items-center justify-between p-4 rounded-2xl border transition-all ${
                    status === 'canceled' 
                    ? 'bg-red-500/10 border-red-500/30 text-red-600' 
                    : 'bg-panel border-border text-muted-foreground hover:border-border/80'
                  }`}
                >
                  <div className="flex items-center gap-3">
                    <AlertCircle size={18} />
                    <span className="text-xs font-bold uppercase tracking-wider">Canceled Access</span>
                  </div>
                  {status === 'canceled' && <div className="w-2 h-2 rounded-full bg-red-500 shadow-[0_0_10px_#ef4444]" />}
                </button>
              </div>
            </div>

            <div className="pt-4">
              <button 
                onClick={handleUpdateSubscription}
                disabled={isSaving || status === user.subscriptionStatus}
                className="w-full bg-primary text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl shadow-primary/20 hover:opacity-95 transition-all disabled:opacity-30 disabled:shadow-none flex items-center justify-center gap-3"
              >
                {isSaving ? (
                  <div className="w-4 h-4 border-2 border-white/20 border-t-white rounded-full animate-spin" />
                ) : (
                  <Save size={16} />
                )}
                Save Access Changes
              </button>
            </div>
          </div>

          <div className="space-y-6">
            <div className="bg-[#F8FAFC] border border-slate-100 rounded-3xl p-6">
              <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest block mb-4">Mastery Statistics</label>
              <div className="space-y-4">
                <div className="flex items-center justify-between">
                  <span className="text-xs font-bold text-muted-foreground">Overall Progress</span>
                  <span className="text-sm font-black text-foreground">{user.progress?.percentage || 0}%</span>
                </div>
                <div className="h-2 w-full bg-panel border border-border/10 rounded-full overflow-hidden">
                  <div className="h-full bg-primary shadow-[0_0_10px_rgba(139,92,246,0.3)] transition-all duration-1000" style={{ width: `${user.progress?.percentage || 0}%` }} />
                </div>
                <div className="grid grid-cols-2 gap-4 mt-2">
                  <div className="bg-card border border-border/50 rounded-2xl p-4">
                    <div className="text-[10px] font-black text-muted-foreground uppercase tracking-widest mb-1">Completed</div>
                    <div className="text-xl font-black text-foreground">{user.progress?.completed || 0}</div>
                  </div>
                  <div className="bg-card border border-border/50 rounded-2xl p-4">
                    <div className="text-[10px] font-black text-muted-foreground uppercase tracking-widest mb-1">Accuracy</div>
                    <div className={`text-xl font-black ${user.progress?.accuracy >= 70 ? 'text-emerald-500' : 'text-amber-500'}`}>
                      {user.progress?.accuracy || 0}%
                    </div>
                  </div>
                </div>
              </div>
            </div>

            {/* Performance Breakdown */}
            <div className="bg-[#F8FAFC] border border-slate-100 rounded-3xl p-6 flex-1 overflow-hidden flex flex-col">
              <label className="text-[10px] font-black text-muted-foreground uppercase tracking-widest block mb-4">Performance Analysis</label>
              <div className="space-y-4 overflow-y-auto max-h-[250px] pr-2 custom-scrollbar">
                {user.progress?.systems && Object.entries(user.progress.systems).map(([name, data]) => {
                  const pct = data.total > 0 ? Math.round((data.correct / data.total) * 100) : 0;
                  return (
                    <div key={name} className="space-y-1.5">
                      <div className="flex items-center justify-between text-[10px]">
                        <span className="font-bold text-foreground/80 uppercase tracking-tight">{name}</span>
                        <span className="font-mono text-muted-foreground">{pct}% ({data.correct}/{data.total})</span>
                      </div>
                      <div className="h-1 w-full bg-panel rounded-full overflow-hidden">
                        <div 
                          className={`h-full transition-all duration-1000 ${pct >= 70 ? 'bg-emerald-500' : pct >= 40 ? 'bg-amber-500' : 'bg-red-500'}`}
                          style={{ width: `${pct}%` }} 
                        />
                      </div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="flex flex-col gap-3">
              {/* Archived Data Insights */}
              {(() => {
                const archive = getArchiveMetadata(user);
                if (!archive) return null;
                return (
                  <div className="bg-amber-500/5 border border-amber-500/10 rounded-2xl p-5 mb-3">
                    <div className="flex items-center gap-3 mb-2">
                      <AlertCircle size={16} className="text-amber-600" />
                      <span className="text-[10px] font-black text-amber-600 uppercase tracking-widest">Archived Data Pool</span>
                    </div>
                    <p className="text-[11px] text-amber-700/70 font-medium mb-3">
                      This student&apos;s paid access ended. Tests, notes, and flashcards are safely archived for 30 days.
                    </p>
                    <div className="flex items-center justify-between">
                      <div className="text-[10px] font-black text-amber-700 uppercase">
                        {archive.daysRemaining} Days Until Wiped
                      </div>
                    </div>
                  </div>
                );
              })()}

              <button className="w-full bg-panel border border-border text-foreground hover:text-primary hover:border-primary/30 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all flex items-center justify-center gap-3">
                <Mail size={16} />
                Send Manual Alert
              </button>

              <div className="h-[1px] bg-slate-100 my-2" />

              <button
                onClick={async () => {
                  if (confirm("CRITICAL: Are you sure you want to PERMANENTLY TERMINATE this account? All tests, progress, and data will be IRREVERSIBLY PURGED.")) {
                    try {
                      setIsSaving(true);
                      const { deleteUser } = await import("@/services/user.service");
                      await deleteUser(user.id);
                      alert("Identity Purged: Account and all associated data have been erased from the master registry.");
                      onUpdate();
                      onClose();
                    } catch (err) {
                      alert("Purge Failed: " + err.message);
                    } finally {
                      setIsSaving(false);
                    }
                  }
                }}
                disabled={isSaving}
                className="w-full bg-red-50 text-red-600 border border-red-100 hover:bg-red-600 hover:text-white py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest transition-all shadow-sm flex items-center justify-center gap-3"
              >
                <AlertCircle size={16} />
                Terminate Account permanently
              </button>

              <p className="text-[10px] text-muted-foreground text-center italic mt-2 uppercase tracking-tight font-mono opacity-50">Authorized as verified administrator</p>
            </div>
          </div>
        </div>
      </motion.div>
    </div>
  );
}
</file>

<file path="src/components/student/exam/QuestionViewer.jsx">
"use client";

import React, { memo } from "react";
import Image from "next/image";
import { useExam } from "@/context/ExamContext";

function QuestionViewer() {
  const { currentQuestion: q } = useExam();

  if (!q) return null;

  return (
    <div className="w-full space-y-6">
      <div className="text-[18px] leading-relaxed text-zinc-800 dark:text-zinc-200 font-medium whitespace-pre-wrap">
        {q.stem}
        {q.stemImage?.data && (
          <div className="mt-8 flex justify-center">
            <Image 
              src={q.stemImage.data} 
              alt="stem" 
              width={400} height={300}
              loading="lazy"
              className="max-w-full rounded border-2 border-zinc-100 shadow-sm" 
            />
          </div>
        )}
      </div>
    </div>
  );
}

export default memo(QuestionViewer);
</file>

<file path="src/components/ui/LogoutModal.jsx">
"use client";
import React from "react";
import { motion, AnimatePresence } from "framer-motion";
import { LogOut, AlertCircle } from "lucide-react";

export default function LogoutModal({ isOpen, onClose, onConfirm }) {
  return (
    <AnimatePresence>
      {isOpen && (
        <div className="fixed inset-0 z-[100] flex items-center justify-center px-4">
          <motion.div
            initial={{ opacity: 0 }}
            animate={{ opacity: 1 }}
            exit={{ opacity: 0 }}
            onClick={onClose}
            className="absolute inset-0 bg-[#0f172a]/60 backdrop-blur-sm"
          />
          <motion.div
            initial={{ scale: 0.95, opacity: 0, y: 10 }}
            animate={{ scale: 1, opacity: 1, y: 0 }}
            exit={{ scale: 0.95, opacity: 0, y: 10 }}
            className="relative w-full max-w-sm bg-card rounded-3xl shadow-2xl p-8 overflow-hidden border border-border"
          >
             {/* Decorative background blur */}
             <div className="absolute top-0 left-0 w-full h-32 bg-gradient-to-b from-red-50/50 to-transparent pointer-events-none" />

             <div className="flex flex-col items-center text-center gap-6 relative z-10">
               <div className="w-20 h-20 rounded-full bg-white shadow-xl flex items-center justify-center mb-2 border-4 border-red-50">
                 <div className="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center text-white shadow-inner">
                    <LogOut size={32} strokeWidth={2.5} className="ml-1" />
                 </div>
               </div>
               
               <div className="space-y-2">
                  <h3 className="text-2xl font-black text-slate-800 tracking-tight">Signing Out?</h3>
                  <p className="text-slate-500 text-sm font-medium leading-relaxed px-4">
                    You are about to end your secure session. Please confirm to proceed.
                  </p>
               </div>

               <div className="grid grid-cols-2 gap-3 w-full mt-2">
                 <button
                   onClick={onClose}
                   className="py-3.5 px-4 rounded-2xl bg-slate-100 text-slate-600 font-bold text-xs uppercase tracking-widest hover:bg-slate-200 transition-colors"
                 >
                   Cancel
                 </button>
                 <button
                   onClick={onConfirm}
                   className="py-3.5 px-4 rounded-2xl bg-red-500 text-white font-bold text-xs uppercase tracking-widest hover:bg-red-600 shadow-[0_10px_20px_-10px_rgba(239,68,68,0.5)] transition-all active:scale-95"
                 >
                   Confirm
                 </button>
               </div>
             </div>
          </motion.div>
        </div>
      )}
    </AnimatePresence>
  );
}
</file>

<file path="src/hooks/useDeleteItem.js">
import { useState, useCallback } from 'react';
import { handleDeleteItem, handleBulkDelete as bulkDeleteItems, removeItemsFromArray } from '@/utils/deleteUtils';

/**
 * React hook for handling delete operations with loading states
 * @param {string} type - The type of item ('product', 'question', 'user')
 * @param {Function} setItems - Function to update the items array in state
 * @param {Function} setSelectedIds - Function to update selected IDs (optional)
 * @returns {Object} - Delete handlers and loading state
 */
export function useDeleteItem(type, setItems, setSelectedIds) {
  const [isDeleting, setIsDeleting] = useState(false);
  const [error, setError] = useState(null);

  const handleDelete = useCallback(async (id, options = {}) => {
    setIsDeleting(true);
    setError(null);
    
    try {
      const success = await handleDeleteItem(type, id, {
        ...options,
        onSuccess: (deletedId) => {
          // Update UI state
          setItems(prev => removeItemsFromArray(prev, deletedId));
          
          // Clear selection if needed
          if (setSelectedIds) {
            setSelectedIds(prev => {
              const next = new Set(prev);
              next.delete(deletedId);
              return next;
            });
          }
          
          // Call custom success callback
          if (options.onSuccess) {
            options.onSuccess(deletedId);
          }
        },
        onError: (err) => {
          setError(err.message);
          if (options.onError) {
            options.onError(err);
          }
        }
      });
      
      return success;
    } finally {
      setIsDeleting(false);
    }
  }, [type, setItems, setSelectedIds]);

  const handleBulkDelete = useCallback(async (ids, options = {}) => {
    setIsDeleting(true);
    setError(null);
    
    try {
      const result = await bulkDeleteItems(type, ids, {
        ...options,
        onSuccess: ({ success, failed }) => {
          // Update UI state
          if (success > 0) {
            setItems(prev => removeItemsFromArray(prev, ids));
            
            // Clear selections
            if (setSelectedIds) {
              setSelectedIds(new Set());
            }
          }
          
          // Call custom success callback
          if (options.onSuccess) {
            options.onSuccess({ success, failed });
          }
        },
        onError: (err) => {
          setError(err.message);
          if (options.onError) {
            options.onError(err);
          }
        }
      });
      
      return result;
    } finally {
      setIsDeleting(false);
    }
  }, [type, setItems, setSelectedIds]);

  const clearError = useCallback(() => {
    setError(null);
  }, []);

  return {
    handleDelete,
    handleBulkDelete,
    isDeleting,
    error,
    clearError
  };
}

/**
 * Simplified hook for single delete operations
 * @param {string} type - The type of item ('product', 'question', 'user')
 * @param {Function} setItems - Function to update the items array in state
 * @returns {Object} - Delete handler and loading state
 */
export function useSimpleDelete(type, setItems) {
  const { handleDelete, isDeleting, error, clearError } = useDeleteItem(type, setItems);
  
  return {
    deleteItem: handleDelete,
    isDeleting,
    error,
    clearError
  };
}
</file>

<file path="src/lib/db.js">
let dbs = {};

export function openDB(name = "global") {
  // Use "medbank" as the platform database for backward compatibility with existing data
  const dbName = name === "global" ? "medbank" : `medbank_user_${name}`;

  return new Promise((resolve, reject) => {
    if (dbs[dbName]) return resolve(dbs[dbName]);

    const request = indexedDB.open(dbName, 2);

    request.onerror = () => reject(`Failed to open DB: ${dbName}`);

    request.onsuccess = () => {
      dbs[dbName] = request.result;
      resolve(dbName === "medbank" ? resolvePlatformSchema(dbs[dbName]) : resolveUserSchema(dbs[dbName]));
    };

    request.onupgradeneeded = (e) => {
      const db = e.target.result;
      const transaction = e.target.transaction;

      // Users store
      if (!db.objectStoreNames.contains("users")) {
        db.createObjectStore("users", { keyPath: "id" });
      }

      // Questions store
      if (!db.objectStoreNames.contains("questions")) {
        db.createObjectStore("questions", { keyPath: "id" });
      }

      // Tests store - Migration: change keyPath from "id" to "testId"
      if (db.objectStoreNames.contains("tests")) {
        const testStore = transaction.objectStore("tests");
        if (testStore.keyPath !== "testId") {
          db.deleteObjectStore("tests");
          db.createObjectStore("tests", { keyPath: "testId" });
        }
      } else {
        db.createObjectStore("tests", { keyPath: "testId" });
      }

      // Planner store
      if (!db.objectStoreNames.contains("planner")) {
        db.createObjectStore("planner", { keyPath: "id" });
      }
    };
  });
}

function resolvePlatformSchema(db) {
  return db;
}
function resolveUserSchema(db) {
  return db;
}
</file>

<file path="src/models/question.model.js">
// question.model.js
export default class Question {
  constructor(data) {
    this.id = data.id;
    this.stem = data.stem;
    this.stemImage = data.stemImage || data.image || { data: "", size: "default", fileName: "" };
    this.choices = data.choices || [];
    this.correct = data.correct;
    this.subject = data.subject;
    this.system = data.system;
    this.topic = data.topic;
    this.createdAt = data.createdAt || Date.now();
    this.updatedAt = data.updatedAt || Date.now();
    
    this.explanationCorrect = data.explanationCorrect || data.correctExplanation || "";
    this.explanationCorrectImage = data.explanationCorrectImage || { data: "", size: "default", fileName: "" };
    
    this.explanationWrong = data.explanationWrong || data.wrongExplanation || "";
    this.explanationWrongImage = data.explanationWrongImage || { data: "", size: "default", fileName: "" };
    
    this.summary = data.summary || "";
    this.summaryImage = data.summaryImage || { data: "", size: "default", fileName: "" };
    
    this.published = data.published ?? false;
    this.stemImageMode = data.stemImageMode || "auto";
    this.explanationImageMode = data.explanationImageMode || "auto";

    this.references = data.references || ""; // scientific citations
    this.tags = data.tags || []; // array of strings

    // Governance Fields
    this.status = data.status || 'draft'; // draft, review, approved, published, archived, deprecated
    this.versionNumber = data.versionNumber || 1;
    this.isLatest = data.isLatest ?? 1;
    this.conceptId = data.conceptId || null;
    this.packageId = data.packageId || null;

    // Version is a legacy field, versionNumber is the new standard
    this.version = data.version || this.versionNumber;
  }
}
</file>

<file path="src/models/user.model.js">
export function createUser({ id, name, email, passwordHash, role }) {
  return {
    id,
    name,
    email,
    passwordHash,
    role, // "author" | "student"
    subscriptionStatus: "trial",
    purchased: false,
    createdAt: new Date().toISOString(),
    stats: {
      attempted: 0,
      correct: 0,
      tests: 0
    }
  };
}
</file>

<file path="src/services/analytics.service.js">
// analytics.service.js - Now uses API instead of IndexedDB

const API_BASE = '/api/analytics';

export async function getDashboardStats(packageId = null) {
    try {
        let url = API_BASE;
        if (packageId) url += `?packageId=${packageId}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch dashboard stats');
        return await res.json();
    } catch (error) {
        console.error('getDashboardStats error:', error);
    return {
        totalUsers: 0,
        paidUsers: 0,
        dau: 0,
        retention: "0%",
        conversion: "0%",
        avgSession: "0m 0s",
        totalQuestions: 0,
        totalTests: 0
    };
    }
}

export async function getEngagementChartData(packageId = null) {
    try {
        let url = `${API_BASE}?type=engagement`;
        if (packageId) url += `&packageId=${packageId}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error('Failed to fetch engagement data');
        return await res.json();
    } catch (error) {
        console.error('getEngagementChartData error:', error);
        return [];
    }
}

export async function getStudentCognition(packageId) {
    const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
    if (!userId || !packageId) return null;

    try {
        const res = await fetch(`${API_BASE}?type=cognition&userId=${userId}&packageId=${packageId}`);
        if (!res.ok) throw new Error('Failed to fetch cognition');
        return await res.json();
    } catch (error) {
        console.error('getStudentCognition error:', error);
        return null;
    }
}

export async function getUserProductStats(packageId) {
    const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
    if (!userId || !packageId) return { accuracy: 0, usage: 0, completedTests: 0 };

    try {
        const res = await fetch(`/api/student/stats?userId=${userId}&packageId=${packageId}`);
        if (!res.ok) throw new Error('Failed to fetch student stats');
        return await res.json();
    } catch (error) {
        console.error('getUserProductStats error:', error);
        return { accuracy: 0, usage: 0, completedTests: 0 };
    }
}

// These are still return mock/empty data for now as we transition
export async function getRetentionData() {
    return [];
}

export async function getEngagementStats() {
    return {
        distribution: [],
        topEvents: [],
        recentActivities: []
    };
}

export async function getFunnelMetrics() {
    return [];
}
</file>

<file path="src/services/question.service.js">
// question.service.js - Now uses API instead of IndexedDB

const API_BASE = '/api/questions';

// Optional productId parameter for product-specific question pools
export async function getAllQuestions(productId = null) {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  const isAuthor = typeof window !== 'undefined' && localStorage.getItem("medbank-author-unlocked") === "true";
  const isAuthorRoute = typeof window !== 'undefined' && window.location?.pathname?.startsWith('/author');

  try {
    if ((isAuthor && isAuthorRoute) || !userId) {
      // Authors get questions, potentially filtered by packageId
      let effectiveProductId = productId;
      if (effectiveProductId === null && typeof window !== 'undefined') {
        const storedContext = localStorage.getItem("medbank_author_product_context");
        if (storedContext) {
          try {
            const product = JSON.parse(storedContext);
            effectiveProductId = product?.id || null;
          } catch (e) {
            effectiveProductId = null;
          }
        }
      }

      let url = API_BASE;
      url += `?includeUnpublished=true`; // Authors always see everything
      if (effectiveProductId) {
        url += `&productId=${effectiveProductId}`;
      }

      const res = await fetch(url);
      if (!res.ok) throw new Error('Failed to fetch questions');
      return await res.json();
    }

    // Students get published questions with their progress, filtered by productId
    let effectiveProductId = productId;
    if (effectiveProductId === null && typeof window !== 'undefined') {
      const storedProduct = localStorage.getItem("medbank_focused_product");
      if (storedProduct) {
        try {
          const product = JSON.parse(storedProduct);
          effectiveProductId = product?.id || null;
        } catch (e) {
          effectiveProductId = null;
        }
      }
    }

    let url = `${API_BASE}/user?userId=${userId}&includeUnpublished=false`;
    if (effectiveProductId) {
      url += `&productId=${effectiveProductId}`;
    }

    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch questions');
    return await res.json();
  } catch (error) {
    console.error('getAllQuestions error:', error);
    return [];
  }
}

export async function getQuestionById(id) {
  try {
    const res = await fetch(`${API_BASE}/${id}`);
    if (!res.ok) {
      if (res.status === 404) return null;
      throw new Error('Failed to fetch question');
    }
    return await res.json();
  } catch (error) {
    console.error('getQuestionById error:', error);
    return null;
  }
}

export async function addQuestion(question) {
  try {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(question)
    });
    if (!res.ok) throw new Error('Failed to add question');
    return await res.json();
  } catch (error) {
    console.error('addQuestion error:', error);
    throw error;
  }
}

export async function updateQuestion(updatedQuestion) {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  const isAuthor = typeof window !== 'undefined' && localStorage.getItem("medbank-author-unlocked") === "true";
  const isAuthorRoute = typeof window !== 'undefined' && window.location?.pathname?.startsWith('/author');

  try {
    if (isAuthor && isAuthorRoute) {
      // Author updates the master question
      const res = await fetch(API_BASE, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(updatedQuestion)
      });
      if (!res.ok) throw new Error('Failed to update question');
      return await res.json();
    }

    // Student updates their progress only
    if (userId) {
      const payload = {
        userId,
        questionId: updatedQuestion.id,
        productId: updatedQuestion.productId || updatedQuestion.packageId,
        packageId: updatedQuestion.packageId || updatedQuestion.productId,
        status: updatedQuestion.status,
        isMarked: updatedQuestion.isMarked,
        userAnswer: updatedQuestion.userAnswer,
        userHistory: updatedQuestion.userHistory
      };
      console.log("Updating user question progress:", payload);
      const res = await fetch(`${API_BASE}/user`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      console.log("Update user question response:", res.status, res.statusText);
      if (!res.ok) {
        const errBody = await res.json().catch(() => ({}));
        console.error("Update user question failed:", errBody);
        throw new Error(errBody.error || 'Failed to update question progress');
      }
      return true;
    }
  } catch (error) {
    console.error('updateQuestion error:', error);
    throw error;
  }
}

export async function deleteQuestion(id) {
  try {
    const res = await fetch(API_BASE, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    if (!res.ok) throw new Error('Failed to delete question');
    return true;
  } catch (error) {
    console.error('deleteQuestion error:', error);
    throw error;
  }
}

// Reset all question progress for a user (used in fresh start)
export async function resetUserQuestionProgress(userId) {
  try {
    const res = await fetch(`${API_BASE}/user`, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId })
    });
    if (!res.ok) throw new Error('Failed to reset progress');
    return true;
  } catch (error) {
    console.error('resetUserQuestionProgress error:', error);
    throw error;
  }
}
// Governance Methods
export async function submitForReview(versionId, notes = "") {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  try {
    const res = await fetch(`${API_BASE}/governance`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'submit', versionId, userId, notes })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to submit for review');
    }
    return true;
  } catch (error) {
    console.error('submitForReview error:', error);
    throw error;
  }
}

export async function approveQuestion(versionId, notes = "") {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  try {
    const res = await fetch(`${API_BASE}/governance`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'approve', versionId, userId, notes })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to approve question');
    }
    return true;
  } catch (error) {
    console.error('approveQuestion error:', error);
    throw error;
  }
}

export async function deprecateQuestion(versionId, reason = "") {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  try {
    const res = await fetch(`${API_BASE}/governance`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'deprecate', versionId, userId, notes: reason })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to deprecate question');
    }
    return true;
  } catch (error) {
    console.error('deprecateQuestion error:', error);
    throw error;
  }
}

export async function getGovernanceHistory(versionId = null, conceptId = null) {
  try {
    let url = `${API_BASE}/governance/history`;
    if (versionId) url += `?versionId=${versionId}`;
    else if (conceptId) url += `?conceptId=${conceptId}`;

    const res = await fetch(url);
    if (!res.ok) throw new Error('Failed to fetch governance history');
    return await res.json();
  } catch (error) {
    console.error('getGovernanceHistory error:', error);
    return [];
  }
}

// Lifecycle Management (Updated)
export async function reviseQuestion(versionId, notes = "") {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  try {
    const res = await fetch(`${API_BASE}/revise`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ versionId, userId, notes })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to revise question');
    }
    return await res.json();
  } catch (error) {
    console.error('reviseQuestion error:', error);
    throw error;
  }
}

export async function publishQuestion(versionId, notes = "") {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  try {
    const res = await fetch(`${API_BASE}/governance`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: 'publish', versionId, userId, notes })
    });
    if (!res.ok) {
      const text = await res.text();
      let err;
      try {
        err = text ? JSON.parse(text) : { error: `Request failed with status ${res.status}` };
      } catch (e) {
        err = { error: text || res.statusText };
      }
      throw new Error(err.error || 'Failed to publish question');
    }
    return true;
  } catch (error) {
    console.error('publishQuestion error:', error);
    throw error;
  }
}

export async function updateQuestionStats(versionId, stats) {
  try {
    const res = await fetch(`${API_BASE}/stats`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ versionId, stats })
    });
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || 'Failed to update stats');
    }
    return true;
  } catch (error) {
    console.error('updateQuestionStats error:', error);
    throw error;
  }
}
</file>

<file path="src/services/test.service.js">
// test.service.js - Now uses API instead of IndexedDB

const API_BASE = '/api/tests';

export async function saveTest(test) {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  
  if (!test || !test.testId) {
    console.error("Attempted to save test without testId:", test);
    throw new Error("Cannot save test: missing testId");
  }
  
  if (!test.userId && userId) {
    test.userId = userId;
  }
  
  try {
    const res = await fetch(API_BASE, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(test)
    });
    if (!res.ok) {
      const errData = await res.json().catch(() => ({}));
      throw new Error(errData.error || 'Failed to save test');
    }
    return await res.json();
  } catch (error) {
    console.error('saveTest error:', error);
    throw error;
  }
}

/**
 * NEW: Calculate pool sizing before test creation
 */
export async function getPoolSizing(packageId, filters) {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  if (!userId) return { universeSize: 0, eligiblePoolSize: 0 };

  try {
    const res = await fetch('/api/tests/pool', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, packageId, filters })
    });
    if (!res.ok) throw new Error('Failed to calculate pool');
    return await res.json();
  } catch (err) {
    console.error('getPoolSizing error:', err);
    return { universeSize: 0, eligiblePoolSize: 0 };
  }
}

/**
 * NEW: Request an assembled test from the server logic
 */
export async function assembleTest(packageId, poolLogic, count, mode = 'tutor') {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  if (!userId) throw new Error("No user logged in");

  const testId = crypto.randomUUID();
  const testData = {
    testId,
    userId,
    packageId,
    poolLogic,
    count,
    mode,
    questions: null, // Instructs server to assemble
    date: new Date().toLocaleDateString(),
  };

  return await saveTest(testData);
}

export async function getAllTests(packageId = null) {
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;
  
  if (!userId) {
    console.warn('No user logged in, returning empty tests');
    return [];
  }

  let effectivePackageId = packageId;
  if (effectivePackageId === null && typeof window !== 'undefined') {
    const stored = localStorage.getItem("medbank_focused_product");
    if (stored) {
      try {
        const focused = JSON.parse(stored);
        effectivePackageId = focused?.id || null;
      } catch (e) {
        effectivePackageId = null;
      }
    }
  }
  
  try {
    let url = `${API_BASE}?userId=${userId}`;
    if (effectivePackageId) {
      url += `&packageId=${effectivePackageId}`;
    }
    const res = await fetch(url);
    if (!res.ok) {
        const errData = await res.json().catch(() => ({}));
        throw new Error(errData.error || 'Failed to fetch tests');
    }
    return await res.json();
  } catch (error) {
    console.error('getAllTests error:', error);
    return [];
  }
}

export async function getTestById(id, productId) {
  try {
    const query = productId ? `?packageId=${productId}` : '';
    const res = await fetch(`${API_BASE}/${id}${query}`);
    if (!res.ok) {
      if (res.status === 404) return null;
      throw new Error('Failed to fetch test');
    }
    return await res.json();
  } catch (error) {
    console.error('getTestById error:', error);
    return null;
  }
}

export async function deleteTest(id) {
  try {
    const res = await fetch(API_BASE, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ testId: id })
    });
    if (!res.ok) throw new Error('Failed to delete test');
    return true;
  } catch (error) {
    console.error('deleteTest error:', error);
    throw error;
  }
}

export async function clearAllUserTests(userId) {
  try {
    const res = await fetch(API_BASE, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ userId, clearAll: true })
    });
    if (!res.ok) throw new Error('Failed to clear tests');
    return true;
  } catch (error) {
    console.error('clearAllUserTests error:', error);
    throw error;
  }
}

/**
 * ATTEMPT SCOPED ATOMIC UPDATES
 */

export async function updateAttemptAnswer(attemptId, questionId, selectedOption) {
  try {
    const res = await fetch(`/api/tests/attempts/${attemptId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'answer',
        questionId,
        selectedOption
      })
    });
    return res.ok;
  } catch (err) {
    console.error('updateAttemptAnswer error:', err);
    return false;
  }
}

export async function updateAttemptFlag(attemptId, questionId, isFlagged) {
  try {
    const res = await fetch(`/api/tests/attempts/${attemptId}`, {
      method: 'PATCH',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'flag',
        questionId,
        isFlagged
      })
    });
    return res.ok;
  } catch (err) {
    console.error('updateAttemptFlag error:', err);
    return false;
  }
}

export async function snapshotAttempt(attemptId, snapshot) {
  try {
    const res = await fetch(`/api/tests/attempts/${attemptId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'snapshot',
        snapshot
      })
    });
    return res.ok;
  } catch (err) {
    console.error('snapshotAttempt error:', err);
    return false;
  }
}

export async function finishAttempt(attemptId, snapshot) {
  try {
    const res = await fetch(`/api/tests/attempts/${attemptId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        type: 'finish',
        snapshot
      })
    });
    return res.ok;
  } catch (err) {
    console.error('finishAttempt error:', err);
    return false;
  }
}
</file>

<file path="src/services/user.service.js">
// user.service.js - Now uses API instead of IndexedDB
import { resetUserQuestionProgress } from './question.service';
import { clearAllUserTests } from './test.service';

const API_BASE = '/api/users';

export async function addUser(user) {
  // Registration is handled by /api/auth/register
  try {
    const res = await fetch('/api/auth/register', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user)
    });
    if (!res.ok) {
      const error = await res.json();
      throw new Error(error.error || 'Registration failed');
    }
    return await res.json();
  } catch (error) {
    console.error('addUser error:', error);
    throw error;
  }
}

export async function getUserByEmail(email) {
  try {
    const users = await getAllUsers();
    return users.find(u => u.email === email);
  } catch (error) {
    console.error('getUserByEmail error:', error);
    return null;
  }
}

export async function getUserById(id) {
  try {
    const res = await fetch(`${API_BASE}?id=${id}`);
    if (!res.ok) return null;
    return await res.json();
  } catch (error) {
    console.error('getUserById error:', error);
    return null;
  }
}

export async function getAllUsers() {
  try {
    const res = await fetch(API_BASE);
    if (!res.ok) throw new Error('Failed to fetch users');
    return await res.json();
  } catch (error) {
    console.error('getAllUsers error:', error);
    return [];
  }
}

export async function updateUser(user) {
  try {
    const res = await fetch(API_BASE, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(user)
    });
    if (!res.ok) {
      const errorData = await res.json().catch(() => ({}));
      console.error('API Error details:', errorData);
      throw new Error(errorData.error || 'Failed to update user');
    }
    localStorage.setItem('medbank_users_updated', Date.now().toString());
    return await res.json();
  } catch (error) {
    console.error('updateUser error:', error);
    throw error;
  }
}

export async function deleteUser(id) {
  try {
    const res = await fetch(API_BASE, {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id })
    });
    if (!res.ok) throw new Error('Failed to delete user');
    return true;
  } catch (error) {
    console.error('deleteUser error:', error);
    throw error;
  }
}

export async function activateUserSubscription(id, requestedDays = 90) {
  const user = await getUserById(id);
  if (!user) throw new Error("User not found");
  
  const now = new Date();
  const isPaid = !!user.purchased || !!user.hasPendingPurchase;

  let days = requestedDays;
  if (!isPaid) {
    throw new Error("Subscription required. Please upgrade to access the QBank.");
  } else {
    // For paid users, always use the pendingDuration from the database record
    // This ensures we use the correct duration even if the client state is stale
    days = user.pendingDuration || requestedDays || 90;
  }

  // Fresh Start: Reset question progress and clear tests
  if (isPaid) {
    await resetUserQuestionProgress(id);
    await clearAllUserTests(id);
  }

  const durationMs = days * 24 * 60 * 60 * 1000;
  const expiry = new Date(now.getTime() + durationMs);

  const updatedUser = {
    ...user,
    subscriptionStatus: 'active',
    activatedAt: now.toISOString(),
    expiresAt: expiry.toISOString(),
    activatedByPurchase: isPaid,
    purchased: isPaid,
    hasPendingPurchase: false,
    pendingDuration: 0, // Clear pending duration after activation
    subscriptionDuration: days, // Store the duration
    productName: user.productName || (isPaid ? 'Medical QBank' : 'ECG QBank'), // Preserve or set default
    trialUsed: user.trialUsed || !isPaid,
    updatedAt: now.toISOString()
  };
  
  await updateUser(updatedUser);
  return updatedUser;
}

export async function renewUserSubscription(id, extraDays = 90) {
  const user = await getUserById(id);
  if (!user) throw new Error("User not found");
  
  const now = new Date();
  let baseDate = now;

  if (user.subscriptionStatus === 'active' && user.activatedByPurchase && user.expiresAt) {
    const currentExpiry = new Date(user.expiresAt);
    if (currentExpiry > now) {
      baseDate = currentExpiry;
    }
  }

  const durationMs = extraDays * 24 * 60 * 60 * 1000;
  const expiry = new Date(baseDate.getTime() + durationMs);

  const updatedUser = {
    ...user,
    subscriptionStatus: 'active',
    purchased: true,
    activatedByPurchase: true,
    hasPendingPurchase: false,
    subscriptionDuration: (user.subscriptionDuration || 0) + extraDays, // Accumulate duration
    expiresAt: expiry.toISOString(),
    lastRenewedAt: now.toISOString()
  };
  
  await updateUser(updatedUser);
  return updatedUser;
}

export async function getStudentProgress(userId, productId) {
  try {
    const effectiveProductId = productId;
    if (!effectiveProductId) return { percentage: 0, completed: 0, total: 0, systems: {}, subjects: {} };

    const res = await fetch(`/api/questions/user?userId=${userId}&productId=${effectiveProductId}`);
    if (!res.ok) return { percentage: 0, completed: 0, total: 0, systems: {}, subjects: {} };

    const questions = await res.json();
    const total = questions.length;
    const completed = questions.filter(q => q.status === 'correct' || q.status === 'incorrect').length;
    const correctCount = questions.filter(q => q.status === 'correct').length;
    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;
    const accuracy = completed > 0 ? Math.round((correctCount / completed) * 100) : 0;

    // Breakdown by system and subject
    const systems = {};
    const subjects = {};

    questions.forEach(q => {
      const sys = q.system || 'Other';
      const sub = q.subject || 'Other';

      if (!systems[sys]) systems[sys] = { total: 0, completed: 0, correct: 0 };
      if (!subjects[sub]) subjects[sub] = { total: 0, completed: 0, correct: 0 };

      systems[sys].total++;
      subjects[sub].total++;

      if (q.status === 'correct' || q.status === 'incorrect') {
        systems[sys].completed++;
        subjects[sub].completed++;
        if (q.status === 'correct') {
          systems[sys].correct++;
          subjects[sub].correct++;
        }
      }
    });

    return {
      percentage,
      completed,
      total,
      accuracy,
      correctCount,
      systems,
      subjects
    };
  } catch (error) {
    console.error('getStudentProgress error:', error);
    return { percentage: 0, completed: 0, total: 0, systems: {}, subjects: {} };
  }
}

export async function getUserSubscriptions(userId) {
  try {
    const res = await fetch(`/api/users/subscriptions?userId=${userId}`);
    if (!res.ok) throw new Error('Failed to fetch subscriptions');
    return await res.json();
  } catch (error) {
    console.error('getUserSubscriptions error:', error);
    return [];
  }
}

export async function updateUserSubscription(id, status, days = 90, isPaid = false) {
  const user = await getUserById(id);
  if (!user) throw new Error("User not found");

  const now = new Date();
  const expiry = new Date(now.getTime() + (days * 24 * 60 * 60 * 1000));

  const updatedUser = {
    ...user,
    subscriptionStatus: status,
    purchased: isPaid ? true : user.purchased,
    activatedByPurchase: isPaid ? true : user.activatedByPurchase,
    expiresAt: status === 'active' ? expiry.toISOString() : user.expiresAt,
    updatedAt: now.toISOString()
  };

  await updateUser(updatedUser);
  return updatedUser;
}

export async function banUser(id) {
  const user = await getUserById(id);
  if (!user) throw new Error("User not found");

  const updatedUser = {
    ...user,
    isBanned: true,
    subscriptionStatus: 'canceled',
    updatedAt: new Date().toISOString()
  };

  return await updateUser(updatedUser);
}

export async function updateUserQuestion(userId, questionId, productId, data) {
  try {
    const res = await fetch('/api/questions/user', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        userId,
        questionId,
        productId,
        packageId: productId, // Fallback for API
        userAnswer: data.userAnswer,
        status: data.status,
        isMarked: data.isMarked,
        timeSpent: data.timeSpent,
        testId: data.testId // NEW: Forward testId for answer logging
      })
    });
    if (!res.ok) throw new Error('Failed to update question progress');
    return await res.json();
  } catch (err) {
    console.error('Update user question error:', err);
    throw err;
  }
}

export function getArchiveMetadata(user) {
  if (!user) return null;

  const isExpired = user.subscriptionStatus === 'expired' ||
    (user.expiresAt && new Date(user.expiresAt) <= new Date());

  if (isExpired) {
    const expiry = new Date(user.expiresAt);
    const now = new Date();
    const gracePeriodDays = 30;
    const deletionDate = new Date(expiry.getTime() + (gracePeriodDays * 24 * 60 * 60 * 1000));
    const daysRemaining = Math.ceil((deletionDate.getTime() - now.getTime()) / (1000 * 60 * 60 * 24));

    return {
      type: 'expired',
      daysRemaining: Math.max(0, daysRemaining),
      deletionDate: deletionDate.toISOString(),
      isDeletable: daysRemaining <= 0
    };
  }

  return null;
}
</file>

<file path="src/utils/deleteUtils.js">
import { deleteProduct } from "@/services/product.service";
import { deleteQuestion } from "@/services/question.service";
import { deleteUser } from "@/services/user.service";

/**
 * Unified delete handler for products, questions, and users
 * @param {string} type - The type of item to delete ('product', 'question', 'user')
 * @param {string} id - The ID of the item to delete
 * @param {Object} options - Additional options
 * @param {Function} options.onSuccess - Callback after successful deletion
 * @param {Function} options.onError - Callback on error
 * @param {string} options.confirmMessage - Custom confirmation message
 * @param {boolean} options.showConfirmation - Whether to show confirmation dialog (default: true)
 * @returns {Promise<boolean>} - Returns true if deleted successfully
 */
export async function handleDeleteItem(type, id, options = {}) {
  const {
    onSuccess,
    onError,
    confirmMessage,
    showConfirmation = true,
    successMessage = `${type.charAt(0).toUpperCase() + type.slice(1)} deleted successfully`
  } = options;

  // Show confirmation dialog if required
  if (showConfirmation) {
    const message = confirmMessage || getDefaultConfirmMessage(type);
    if (!confirm(message)) {
      return false;
    }
  }

  try {
    // Call the appropriate delete service
    let result;
    switch (type) {
      case 'product':
        result = await deleteProduct(id);
        break;
      case 'question':
        result = await deleteQuestion(id);
        break;
      case 'user':
        result = await deleteUser(id);
        break;
      default:
        throw new Error(`Unknown delete type: ${type}`);
    }

    // Show success message
    if (successMessage) {
      alert(successMessage);
    }

    // Call success callback
    if (onSuccess) {
      onSuccess(id, type);
    }

    return true;
  } catch (error) {
    console.error(`Failed to delete ${type}:`, error);
    
    // Show error message
    const errorMessage = error.message || `Failed to delete ${type}`;
    alert(errorMessage);
    
    // Call error callback
    if (onError) {
      onError(error, type);
    }
    
    return false;
  }
}

/**
 * Bulk delete handler for multiple items
 * @param {string} type - The type of items to delete
 * @param {Array<string>} ids - Array of IDs to delete
 * @param {Object} options - Additional options
 * @returns {Promise<{success: number, failed: number}>}
 */
export async function handleBulkDelete(type, ids, options = {}) {
  const {
    onSuccess,
    onError,
    confirmMessage,
    showConfirmation = true,
    successMessage = `Deleted ${ids.length} ${type}(s) successfully`
  } = options;

  if (!ids.length) {
    alert(`No ${type}s selected for deletion`);
    return { success: 0, failed: 0 };
  }

  // Show confirmation dialog if required
  if (showConfirmation) {
    const message = confirmMessage || `Permanently delete ${ids.length} selected ${type}(s)? This cannot be undone.`;
    if (!confirm(message)) {
      return { success: 0, failed: 0 };
    }
  }

  let successCount = 0;
  let failedCount = 0;
  const errors = [];

  try {
    // Delete items one by one to handle individual failures
    for (const id of ids) {
      try {
        await handleDeleteItem(type, id, { 
          showConfirmation: false, 
          successMessage: null 
        });
        successCount++;
      } catch (error) {
        failedCount++;
        errors.push(`${type} ${id}: ${error.message}`);
      }
    }

    // Show final result message
    if (successCount > 0 && failedCount === 0) {
      if (successMessage) alert(successMessage);
    } else if (failedCount > 0) {
      const message = `Delete operation completed.\nSuccess: ${successCount}\nFailed: ${failedCount}\n\nErrors:\n${errors.join('\n')}`;
      alert(message);
    }

    // Call success callback
    if (onSuccess) {
      onSuccess({ success: successCount, failed: failedCount, ids });
    }

    return { success: successCount, failed: failedCount };
  } catch (error) {
    console.error(`Bulk delete failed for ${type}s:`, error);
    
    if (onError) {
      onError(error, type);
    }
    
    return { success: successCount, failed: failedCount + 1 };
  }
}

/**
 * Update UI state after deletion
 * @param {Array} items - Current items array
 * @param {string|Array} deletedIds - ID(s) of deleted items
 * @returns {Array} - Updated items array
 */
export function removeItemsFromArray(items, deletedIds) {
  const idsToDelete = Array.isArray(deletedIds) ? deletedIds : [deletedIds];
  return items.filter(item => !idsToDelete.includes(item.id));
}

/**
 * Get default confirmation message for item type
 * @param {string} type - Item type
 * @returns {string} - Default confirmation message
 */
function getDefaultConfirmMessage(type) {
  switch (type) {
    case 'product':
      return "Are you sure you want to PERMANENTLY delete this product? This action cannot be undone and will remove the record from the database completely.";
    case 'question':
      return "Delete this question permanently? This cannot be undone.";
    case 'user':
      return "Are you sure you want to PERMANENTLY delete this user account? This will PURGE ALL DATA (tests, stats, progress) and remove the record completely. This cannot be undone.";
    default:
      return `Are you sure you want to delete this ${type}?`;
  }
}
</file>

<file path="next.config.mjs">
export default {
  compress: true,
  productionBrowserSourceMaps: false
};
</file>

<file path="src/app/student/(dashboard)/qbank/test-summary/page.jsx">
"use client";

import { useEffect, useState, useMemo } from "react";
import { useRouter } from "next/navigation";
import { 
   Eye, CheckCircle2, XCircle,
   MinusCircle, GraduationCap, Clock, FileText, ChevronLeft, Info,
   Check, X, Minus, Plus, ChevronDown
} from "lucide-react";
import { getTestById, getAllTests } from "@/services/test.service";

function ScoreDonut({ stats }) {
   const [hovered, setHovered] = useState(null);
   const radius = 90;
   const circumference = 2 * Math.PI * radius;

   const cP = stats.correct / stats.total;
   const iP = stats.incorrect / stats.total;
   const oP = stats.omitted / stats.total;

   // Start from top (-90deg)
   const cO = 0;
   const iO = -(cP * circumference);
   const oO = -((cP + iP) * circumference);

   return (
      <div className="relative w-full h-full flex items-center justify-center">
         <svg className="w-full h-full transform -rotate-90 scale-100" viewBox="0 0 224 224">
            {/* Omitted */}
            <circle
               cx="112" cy="112" r={hovered === 'omitted' ? radius + 3 : radius}
               stroke={hovered === 'omitted' ? "#334155" : "#1e293b"}
               strokeWidth={hovered === 'omitted' ? "30" : "24"}
               fill="transparent"
               strokeDasharray={`${oP * circumference} ${circumference}`}
               strokeDashoffset={oO}
               className="transition-all duration-300 cursor-pointer"
               onMouseEnter={() => setHovered('omitted')}
               onMouseLeave={() => setHovered(null)}
            />
            {/* Incorrect */}
            <circle
               cx="112" cy="112" r={hovered === 'incorrect' ? radius + 3 : radius}
               stroke={hovered === 'incorrect' ? "#ef4444" : "#7f1d1d"}
               strokeWidth={hovered === 'incorrect' ? "30" : "24"}
               fill="transparent"
               strokeDasharray={`${iP * circumference} ${circumference}`}
               strokeDashoffset={iO}
               className="transition-all duration-300 cursor-pointer"
               onMouseEnter={() => setHovered('incorrect')}
               onMouseLeave={() => setHovered(null)}
            />
            {/* Correct */}
            <circle
               cx="112" cy="112" r={hovered === 'correct' ? radius + 3 : radius}
               stroke={hovered === 'correct' ? "#22c55e" : "#14532d"}
               strokeWidth={hovered === 'correct' ? "30" : "24"}
               fill="transparent"
               strokeDasharray={`${cP * circumference} ${circumference}`}
               strokeDashoffset={cO}
               className="transition-all duration-300 cursor-pointer"
               onMouseEnter={() => setHovered('correct')}
               onMouseLeave={() => setHovered(null)}
            />
         </svg>
         <div className="absolute flex flex-col items-center pointer-events-none">
            <span className={`text-4xl font-black transition-all duration-300 ${hovered === 'correct' ? 'text-green-500 scale-110' : hovered === 'incorrect' ? 'text-red-500 scale-110' : 'text-zinc-200'}`}>
               {stats.percentage}%
            </span>
            <span className="text-[12px] font-medium text-zinc-500 uppercase tracking-widest">Correct</span>
         </div>
      </div>
   );
}


export default function TestSummaryPage() {
   const [testResult, setTestResult] = useState(null);
   const [activeTab, setActiveTabState] = useState("results"); // results, analysis
   const [copySuccess, setCopySuccess] = useState(null);
   const [isTemplateB, setIsTemplateB] = useState(false);

   useEffect(() => {
      if (!testResult?.packageId) return;

      const pId = testResult.packageId;
     const val =
       typeof window !== "undefined"
           ? localStorage.getItem(`medbank_product_templateType_${pId}`)
         : null;

      if (val === "ECG") {
       setIsTemplateB(true);
     }
   }, [testResult?.packageId]);

   const setActiveTab = (tab) => {
      setActiveTabState(tab);
      localStorage.setItem("medbank_summary_tab", tab);
   };
   const [filter, setFilter] = useState("all");
  const router = useRouter();

   useEffect(() => {
      async function loadResult() {
         // 1. Get attemptId from payload and fallback to legacy key
         let attemptId = null;
         let pkgId = null;

         const lastTestInfoStr = localStorage.getItem("medbank_last_test_info");
         if (lastTestInfoStr) {
            try {
               const info = JSON.parse(lastTestInfoStr);
               attemptId = info.testId;
               pkgId = info.packageId;
            } catch (e) { }
         }

         if (!attemptId) attemptId = localStorage.getItem("medbank_last_attempt_id");

         if (!attemptId) {
            router.push("/student/qbank/create-test");
            return;
         }

         // 2. Fetch test. Note: we prioritize the test ID; it carries its own product link in DB
         // We pass null or the passed pkgId; the backend should handle it
         const result = await getTestById(attemptId, pkgId || 'all');
         if (!result) {
            router.push("/student/qbank/create-test");
            return;
         }

         // Apply chronological numbering matching history page
         if (!result.testNumber) {
            const history = await getAllTests(result.packageId);
            const sorted = history.sort((a, b) => new Date(a.date) - new Date(b.date));
            const idx = sorted.findIndex(t => String(t.testId) === String(result.testId));
            result.testNumber = idx !== -1 ? idx + 1 : history.length + 1;
         }

         setTestResult(result);
      }

      loadResult();

      const savedTab = localStorage.getItem("medbank_summary_tab");
      if (savedTab) {
         setActiveTab(savedTab);
      }
   }, [router]);

   const stats = useMemo(() => {
     if (!testResult) return null;

     const attemptAnswers = Array.isArray(testResult.attemptAnswers) ? testResult.attemptAnswers : [];

     const total = Number.isFinite(testResult.totalQuestions)
       ? testResult.totalQuestions
       : attemptAnswers.length;

     let correct = 0;
     let incorrect = 0;
     let omitted = 0;
     let flagged = 0;
     const finishedAt = testResult.finishedAt;

     attemptAnswers.forEach(a => {
       if (a.isFlagged) flagged++;

       const hasAnswer = a.selectedOption !== null && a.selectedOption !== undefined;
       if (hasAnswer) {
         if (a.isCorrect) correct++;
         else incorrect++;
       } else if (finishedAt) {
         omitted++;
       }
     });

     const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;

     // Enrich attemptAnswers with real question data (subject/system/topic) if available
     const enrichedAnswers = attemptAnswers.map(a => {
       const question = testResult.questions?.find(q => String(q.id) === String(a.questionId));
       if (question) {
         return {
           ...a,
           subject: question.subject || a.subject,
           system: question.system || a.system,
           topic: question.topic || a.topic
         };
       }
       return a;
     });

     // Summary is read-only; we do not compute subject stats without frozen question snapshots.
     return {
       total,
       correct,
       incorrect,
       omitted,
       flagged,
       percentage,
       attemptAnswers: enrichedAnswers
     };
   }, [testResult]);

   const handleCopyId = (id) => {
      navigator.clipboard.writeText(id).then(() => {
         setCopySuccess(id);
         setTimeout(() => setCopySuccess(null), 2000);
      });
   };

   const handleReview = () => {
    localStorage.setItem("medbank_current_test", JSON.stringify({
      ...testResult,
       questions: testResult.questions.map(q => typeof q === 'object' ? q.id : q),
       testAttemptId: testResult.testAttemptId || testResult.id || null,
       isReview: true
    }));
    router.push("/student/qbank/take-test");
  };

   if (!testResult || !stats) return null;

   return (
      <div className="min-h-screen bg-zinc-50 dark:bg-[#0F0F12] font-sans pb-20 select-none transition-colors duration-300">
         {/* HEADER */}
         <div className="bg-white dark:bg-[#16161a] border-b border-zinc-200 dark:border-zinc-800 transition-colors duration-300 shadow-sm">
            <div className="max-w-[1400px] mx-auto px-6 h-16 flex items-center justify-between">
               <div className="flex items-center gap-4">
                  <div className="w-10 h-10 bg-[#0072bc] rounded flex items-center justify-center text-white">
                     <FileText size={20} />
                  </div>
                  <div className="flex items-baseline gap-3">
                     <span className="text-[11px] font-black text-zinc-500 uppercase tracking-[0.2em]">Number</span>
                     <h1 className="text-2xl font-black text-[#3b82f6]">
                        {testResult.testNumber || 1}
                     </h1>
                  </div>
               </div>

            </div>
         </div>

         <div className="max-w-[1400px] mx-auto px-10 py-8">
            {/* ACTION BAR */}
            <div className="flex items-center justify-between mb-8">
               <button
                  onClick={() => router.push("/student/tests")}
                  className="flex items-center gap-2 text-[#0072bc] hover:text-[#005a96] transition-colors font-medium text-[14px]"
               >
                  <ChevronLeft size={18} />
                  Previous Tests
               </button>
               <div className="flex items-center gap-6">
                  <span className="flex items-center gap-2 text-zinc-500 text-[13px] hover:text-zinc-700 cursor-pointer">
                     <FileText size={16} /> Notes
                  </span>

                  <button
                     onClick={handleReview}
                     className="bg-[#3b82f6] hover:bg-[#2563eb] text-white px-6 py-2 rounded font-medium text-[13px] transition-all"
                  >
                     Review Test
                  </button>
               </div>
            </div>

            {/* TABS */}
            <div className="flex items-center justify-between border-b border-zinc-200 mb-8 relative">
               <div className="flex gap-12">
                  <button
                     onClick={() => setActiveTab("results")}
                     className={`pb-4 text-[15px] font-medium transition-all relative ${activeTab === 'results' ? 'text-zinc-800' : 'text-zinc-400 hover:text-zinc-600'}`}
                  >
                     Test Results
                     {activeTab === 'results' && <div className="absolute bottom-0 left-0 w-full h-1 bg-[#3b82f6]" />}
                  </button>
                  <button
                     onClick={() => setActiveTab("analysis")}
                     className={`pb-4 text-[15px] font-medium transition-all relative ${activeTab === 'analysis' ? 'text-zinc-800' : 'text-zinc-400 hover:text-zinc-600'}`}
                  >
                     Test Analysis
                     {activeTab === 'analysis' && <div className="absolute bottom-0 left-0 w-full h-1 bg-[#3b82f6]" />}
                  </button>
               </div>
               <div 
                  className="flex items-center gap-2 pb-4 text-[13px] text-zinc-500 cursor-copy select-none relative group"
                  onDoubleClick={() => handleCopyId(testResult.testId)}
                  title="Double-click to copy"
               >
                  Custom Test Id: <span className="text-zinc-800 dark:text-zinc-200 font-semibold">{testResult.testId}</span>
                  <Info size={14} className="text-zinc-300" />
                  {copySuccess === testResult.testId && (
                     <span className="absolute -top-1 left-1/2 -translate-x-1/2 bg-zinc-800 text-white text-[10px] px-2 py-1 rounded shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300 font-bold whitespace-nowrap z-50">
                        COPIED!
                     </span>
                  )}
               </div>
            </div>

            {activeTab === "results" ? (
               <div className="space-y-12 animate-in fade-in duration-500">
                  {/* SCORE BAR SECTION */}
                  <div className="grid grid-cols-2 gap-20 py-8">
                     <div className="flex flex-col items-center">
                        <h3 className="text-[13px] font-medium text-zinc-500 mb-6">Your Score</h3>
                        <div className="w-full relative px-2">
                           {/* Label Container */}
                           <div className="relative h-12 w-full mb-1">
                              {/* Your Score Label */}
                              <div
                                 className="absolute flex flex-col items-center transition-all duration-1000"
                                 style={{
                                    left: `${stats.percentage}%`,
                                    transform: 'translateX(-50%)',
                                    color: stats.percentage > 0 ? '#22c55e' : '#94a3b8'
                                 }}
                              >
                                 <span className="text-[12px] font-black whitespace-nowrap">
                                    {stats.percentage}%
                                 </span>
                                 <div className={`w-2 h-2 rotate-45 mt-1 ${stats.percentage > 0 ? 'bg-green-500' : 'bg-zinc-400'}`} />
                              </div>
                           </div>

                           {/* Bar Container with Outline */}
                           <div className="h-10 w-full bg-zinc-50 dark:bg-zinc-900 border-2 border-zinc-200 dark:border-zinc-800 rounded-lg overflow-hidden flex items-center relative shadow-sm">
                              {/* Filled Bar */}
                              <div
                                 className="h-full bg-[#22c55e] absolute left-0 top-0 transition-all duration-1000 shadow-[0_0_10px_rgba(34,197,94,0.3)]"
                                 style={{ width: `${stats.percentage}%` }}
                              />

                              {/* Scale Markings */}
                              <div className="absolute left-0 h-full w-[1px] bg-zinc-300 dark:bg-zinc-700 z-10" />
                              <div className="absolute right-0 h-full w-[1px] bg-zinc-300 dark:bg-zinc-700 z-10" />

                              {/* Average marker */}
                              <div className="absolute left-[47%] h-full w-0.5 bg-zinc-400/50 z-20">
                                 <div className="absolute -top-6 left-1/2 -translate-x-1/2 whitespace-nowrap text-[9px] text-zinc-400 font-bold uppercase tracking-widest">Avg: 47%</div>
                              </div>
                           </div>

                           {/* Bottom Markers */}
                           <div className="flex justify-between mt-2 px-0.5">
                              <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-tighter">0%</span>
                              <span className="text-[10px] font-bold text-zinc-400 uppercase tracking-tighter">100% Correct</span>
                           </div>
                        </div>
                     </div>

                     <div className="flex flex-col gap-6">
                        <h3 className="text-[13px] font-medium text-zinc-500">Test Settings</h3>
                        <div className="grid grid-cols-[120px_1fr] items-center gap-y-4 text-[13px]">
                           <span className="text-zinc-400 text-[11px] font-bold uppercase tracking-wider">Mode</span>
                           <div className="flex gap-2">
                              <span className="bg-zinc-100 dark:bg-zinc-800 px-3 py-1 rounded text-zinc-600 dark:text-zinc-300 uppercase text-[10px] font-bold border border-zinc-200 dark:border-zinc-700 transition-colors">
                                 {testResult.mode === 'tutor' ? 'Tutor' : 'Timed'}
                              </span>
                           </div>
                        </div>
                     </div>
                  </div>

                  {/* RESULTS TABLE */}
                  <div className="mt-12 bg-white dark:bg-[#16161a] rounded-xl border border-zinc-200 dark:border-zinc-800 overflow-hidden shadow-sm">
                     <table className="w-full text-left">
                        <thead>
                           <tr className="bg-white dark:bg-[#16161a] text-[11px] font-black uppercase tracking-[0.1em] text-zinc-400 border-b border-zinc-100 dark:border-zinc-800">
                              <th className="px-12 py-6"># ID</th>
                              <th className="px-12 py-6">Subjects</th>
                              <th className="px-12 py-6">Systems</th>
                              <th className="px-12 py-6">Topics</th>
                              <th className="px-12 py-6">% Correct Others</th>
                              <th className="px-12 py-6">Time Spent</th>
                           </tr>
                        </thead>
                        <tbody className="divide-y divide-zinc-50 dark:divide-zinc-800/50">
                           {stats.attemptAnswers.map((a, idx) => {
                              const isOmitted = a.selectedOption === null || a.selectedOption === undefined;
                              const isCorrect = !isOmitted && !!a.isCorrect;
                              const attemptKey = testResult.testAttemptId || testResult.testId || 'attempt';
                              
                              // Helper to format subject/system display
                              const formatDisplay = (value, type) => {
                                if (!value) return '--';
                                // If it's a string with commas, treat as multiple
                                const items = typeof value === 'string' ? value.split(',').map(s => s.trim()).filter(Boolean) : [value];
                                if (items.length === 0) return '--';
                                if (items.length > 1) return 'Multiple';
                                const single = items[0];
                                // For Template B (ECG) products, format system as "Cardiology-ECG" if it's Cardiology
                                if (type === 'system' && isTemplateB && single.toLowerCase() === 'cardiology') {
                                  return 'Cardiology-ECG';
                                }
                                // Truncate long strings
                                return single.length > 15 ? single.substring(0, 15) + '...' : single;
                              };
                              
                              const displaySubject = formatDisplay(a.subject, 'subject');
                              const displaySystem = formatDisplay(a.system, 'system');
                              const displayTopic = a.topic || 'Standard Item';
                              
                              return (
                                 <tr key={`${String(a.questionId)}-${attemptKey}`} className="hover:bg-zinc-50/50 dark:hover:bg-zinc-800/10 transition-colors group">
                                    <td className="px-12 py-7 flex items-center gap-6">
                                       <div className={`w-8 h-8 rounded-full flex items-center justify-center shrink-0 shadow-sm ${isOmitted ? 'bg-zinc-100 dark:bg-zinc-800 text-zinc-400' :
                                          isCorrect ? 'bg-green-100 dark:bg-green-900/20 text-green-600' : 'bg-red-100 dark:bg-red-900/20 text-red-600'
                                          }`}>
                                          {isOmitted ? <Minus size={14} className="stroke-[4]" /> :
                                             isCorrect ? <Check size={18} className="stroke-[4]" /> :
                                                <X size={18} className="stroke-[4]" />}
                                       </div>
                                       <div className="flex flex-col">
                                          <div className="flex items-center gap-2">
                                             <span className="text-[15px] font-bold text-zinc-400 tracking-tight">
                                                {idx + 1} - <span className="text-zinc-700 dark:text-zinc-300">{a.questionId}</span>
                                             </span>
                                             {a.isFlagged && (
                                                <div className="bg-amber-100 dark:bg-amber-900/30 text-amber-600 dark:text-amber-400 p-1 rounded">
                                                   <Eye size={12} className="fill-current" />
                                                </div>
                                             )}
                                          </div>
                                          {isOmitted && <span className="text-[10px] uppercase font-black text-zinc-400 tracking-widest mt-0.5">Omitted</span>}
                                       </div>
                                    </td>
                                    <td className="px-12 py-7">
                                       <span className="text-[15px] font-bold text-zinc-500 dark:text-zinc-400">{displaySubject}</span>
                                    </td>
                                    <td className="px-12 py-7">
                                       <span className="text-[15px] font-bold text-zinc-500 dark:text-zinc-400">{displaySystem}</span>
                                    </td>
                                    <td className="px-12 py-7">
                                       <span className="text-[15px] font-bold text-zinc-400 dark:text-zinc-600">{displayTopic}</span>
                                    </td>
                                    <td className="px-12 py-7">
                                       <span className="text-[15px] font-bold text-zinc-500 dark:text-zinc-400">{a.percentCorrectOthers || '--'}</span>
                                    </td>
                                    <td className="px-12 py-7 text-[15px] font-bold text-zinc-500 dark:text-zinc-400">{a.timeSpentSec || 0} sec</td>
                                 </tr>
                              );
                           })}
                        </tbody>
                     </table>
                  </div>
               </div>
            ) : (
               <div className="space-y-12 animate-in fade-in duration-500">
                  {/* ANALYSIS GRAPHS SECTION */}
                  <div className="grid grid-cols-12 gap-8 py-8 items-start">
                     <div className="col-span-4 flex flex-col items-center justify-center pt-8">
                        <div className="relative w-64 h-64 flex items-center justify-center">
                           <ScoreDonut stats={stats} />
                        </div>
                     </div>

                     <div className="col-span-4 flex flex-col border-r border-zinc-100 dark:border-zinc-800 pr-12">
                        <h3 className="text-[14px] font-medium text-zinc-700 dark:text-zinc-300 mb-6 font-medium">Your Score</h3>
                        <div className="space-y-4">
                           {[
                              { label: 'Total Correct', value: stats.correct },
                              { label: 'Total Incorrect', value: stats.incorrect },
                              { label: 'Total Omitted', value: stats.omitted },
                              { label: 'Total Flagged', value: stats.flagged }
                           ].map((item, i) => (
                              <div key={i} className="flex justify-between items-center py-3 border-b border-zinc-100 dark:border-zinc-800 last:border-0 transition-colors">
                                 <span className="text-[13px] text-zinc-500 dark:text-zinc-400">{item.label}</span>
                                 <span className={`bg-zinc-100 dark:bg-zinc-800 px-3 py-1 rounded text-[12px] font-black ${item.label.includes('Correct') ? 'text-green-600' : item.label.includes('Incorrect') ? 'text-red-600' : 'text-zinc-600 dark:text-zinc-300'}`}>{item.value}</span>
                              </div>
                           ))}
                        </div>
                     </div>

                     <div className="col-span-4 flex flex-col" />
                  </div>
               </div>
            )}

        </div>

         {/* FOOTER */}
         <footer className="fixed bottom-0 left-0 w-full bg-white dark:bg-[#16161a] border-t border-zinc-200 dark:border-zinc-800 py-3 text-center transition-colors">
            <span className="text-[11px] text-zinc-400 dark:text-zinc-500 font-medium">Copyright ¬© MedBank. All rights reserved.</span>
         </footer>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/tests/page.jsx">
"use client";

import { useEffect, useState } from "react";
import { useRouter } from "next/navigation";
import { getAllTests } from "@/services/test.service";
import { 
   Play, List, BarChart2, Search, Menu,
   CheckCircle2, GraduationCap, ChevronLeft, ChevronRight,
   X, MoreHorizontal, RefreshCw
} from "lucide-react";
import { useContext } from "react";
import { AppContext } from "@/context/AppContext";


export default function PreviousTestsPage() {
  const { selectedStudentProduct } = useContext(AppContext);
  const [tests, setTests] = useState([]);
   const [searchQuery, setSearchQuery] = useState("");
  const [currentPage, setCurrentPage] = useState(1);
   const [copySuccess, setCopySuccess] = useState(null);
  const itemsPerPage = 10;
  const router = useRouter();

  // Reactivity handled by context + useEffect[selectedStudentProduct]

  useEffect(() => {
     async function loadTests() {
        const pId = selectedStudentProduct?.id;
        const history = await getAllTests(pId);

        // Sort and assign test numbers if missing
        const sorted = history.sort((a, b) => new Date(a.date) - new Date(b.date));
        const normalized = sorted.map((test, index) => ({
           ...test,
           testNumber: test.testNumber || index + 1
        }));

        setTests(normalized.sort((a, b) => (b.testNumber || 0) - (a.testNumber || 0)));
     }
     loadTests();
  }, [selectedStudentProduct]);

   const handleResume = (test, isResumeOmitted = false) => {
      // Always use all questions from the original test session
      const questions = test.questions || [];
      const questionIds = questions.map(q => typeof q === 'string' ? q : q.id);

      if (questionIds.length === 0) return;

      // Store the original testId in sessionStorage for reuse
      sessionStorage.setItem('current_test_id', test.testId);

      localStorage.setItem("medbank_current_test", JSON.stringify({
         testId: test.testId, // Use the original testId
         testNumber: test.testNumber,
         date: test.date,
         packageId: test.packageId || test.productId || null,
         packageName: test.packageName || null,
         questions: questionIds,
         mode: test.mode,
         pool: test.pool,
         resumeData: {
            originalTestId: test.testId,
            answers: test.answers || {},
            currentIndex: test.currentIndex || 0,
            elapsedTime: test.elapsedTime || 0,
            markedIds: test.markedIds || [],
            isOmittedResume: isResumeOmitted,
            isSuspended: !!test.isSuspended
         }
      }));

      router.push("/student/qbank/take-test");
   };

   const handleViewSummary = (test, tab = "results") => {
      // Store full payload for summary page source-of-truth
      const payload = {
         testId: (test.latestAttemptId || test.testId).toString(),
         packageId: test.packageId || test.productId || null,
         packageName: test.packageName || null,
         mode: test.mode || 'tutor'
      };

      localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
      localStorage.setItem("medbank_last_test_id", payload.testId); // Keep for legacy
      localStorage.setItem("medbank_summary_tab", tab);
      router.push(`/student/qbank/test-summary?tab=${encodeURIComponent(tab)}`);
   };

   const handleCopyId = (id) => {
      navigator.clipboard.writeText(id).then(() => {
         setCopySuccess(id);
         setTimeout(() => setCopySuccess(null), 2000);
      });
   };

   const filteredTests = tests.filter(test => {
      const testNum = test.testNumber?.toString() || "";
      return testNum.includes(searchQuery);
   });

   const totalPages = Math.ceil(filteredTests.length / itemsPerPage);
   const paginatedTests = filteredTests.slice(
      (currentPage - 1) * itemsPerPage,
      currentPage * itemsPerPage
   );

  return (
     <div className="min-h-screen bg-background text-foreground font-sans pb-20 select-none transition-colors duration-300">
        {/* HEADER */}
        <div className="bg-card border-b border-border transition-colors duration-300">
           <div className="max-w-[1400px] mx-auto px-6 h-16 flex items-center justify-between">
              <div className="flex items-center gap-4">
                 <div className="w-10 h-10 bg-[#0072bc] dark:bg-blue-600 rounded flex items-center justify-center text-white">
                    <CheckCircle2 size={20} />
                 </div>
                 <h1 className="text-2xl font-light text-zinc-500 dark:text-zinc-400">Previous <span className="text-zinc-900 dark:text-zinc-100 font-normal">Tests</span></h1>
            </div>
              <div className="flex items-center gap-6">
                 <div className="w-8 h-8 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center text-zinc-400 border border-zinc-200 dark:border-zinc-700">
                    <GraduationCap size={18} />
                 </div>
              </div>
           </div>
        </div>

        <div className="max-w-[1400px] mx-auto p-10">


           {/* TOP CONTROL BAR */}
           <div className="flex items-center justify-between mb-8 py-2">
              <div className="flex items-center gap-3">
              </div>

              <div className="relative w-64 group">
                 <input
                    type="text"
                    placeholder="Search"
                    value={searchQuery}
                    onChange={(e) => setSearchQuery(e.target.value)}
                    className="w-full pl-2 pr-8 border-b border-border bg-transparent py-1 text-[14px] text-zinc-800 dark:text-zinc-100 font-medium focus:outline-none focus:border-primary transition-all placeholder:text-zinc-400"
                 />
                 <Search size={16} className="absolute right-0 top-1/2 -translate-y-1/2 text-zinc-400 group-focus-within:text-primary" />
              </div>
           </div>

           {/* MAIN TABLE */}
           <div className="bg-card rounded-lg border border-border shadow-sm overflow-hidden min-h-[400px] flex flex-col transition-colors duration-300">
              <div className="flex-1 overflow-x-auto">
                 <table className="w-full text-left">
                    <thead>
                       <tr className="text-[11px] font-bold uppercase tracking-wider text-zinc-500 dark:text-zinc-400">
                          <th className="px-6 py-6 font-normal">Score</th>
                          <th className="px-6 py-6 font-normal">Number</th>
                          <th className="px-6 py-6 font-normal">Date</th>
                          <th className="px-6 py-6 font-normal">Mode</th>
                          <th className="px-6 py-6 font-normal">Q.Pool</th>
                          <th className="px-6 py-6 font-normal">Subjects</th>
                          <th className="px-6 py-6 font-normal">Systems</th>
                          <th className="px-6 py-6 font-normal">Stream</th>
                          <th className="px-6 py-6 font-normal"># Q&apos;s</th>
                          <th className="px-6 py-6 text-right font-normal">Actions</th>
                       </tr>
                    </thead>
                    <tbody className="divide-y divide-zinc-50 dark:divide-zinc-800">
                       {paginatedTests.length === 0 ? (
                          <tr>
                             <td colSpan="9" className="px-6 py-20 text-center text-muted-foreground text-[14px]">
                                No tests found
                             </td>
                          </tr>
                       ) : (
                             paginatedTests.map((test) => {
                                const hasAttemptStats = !!test.attemptStats && typeof test.attemptStats === 'object';
                                const totalCount = hasAttemptStats ? Number(test.attemptStats.total || 0) : (test.questions || []).length;
                                const correctCount = hasAttemptStats ? Number(test.attemptStats.correct || 0) : (test.questions || []).filter(q => q.userAnswer === q.correct).length;
                                const percentage = totalCount > 0 ? Math.round((correctCount / totalCount) * 100) : 0;
                                const isSuspended = test.isSuspended === 1 || test.isSuspended === '1' || test.isSuspended === true;
                                const omittedCount = hasAttemptStats ? Number(test.attemptStats.omitted || 0) : (test.questions || []).filter(q => !q.userAnswer).length;
                                const allOmitted = totalCount > 0 && omittedCount === totalCount;

                                const uniqueSubjects = [...new Set((test.questions || []).map(q => q.subject))].filter(Boolean);
                                const uniqueSystems = [...new Set((test.questions || []).map(q => q.system))].filter(Boolean);

                                let displayPool = "MULTIPLE";
                                if (Array.isArray(test.pool)) {
                                   if (test.pool.length === 1) {
                                      displayPool = test.pool[0].toUpperCase();
                                   } else if (test.pool.length === 0) {
                                      displayPool = "NONE";
                                   }
                                } else if (typeof test.pool === 'string') {
                                   if (test.pool === 'All Questions') displayPool = "ALL";
                                   else displayPool = test.pool.toUpperCase();
                                }

                                const displaySubjects = uniqueSubjects.length > 1
                                   ? "MULTIPLE"
                                   : (uniqueSubjects[0]?.toUpperCase() || "--");

                                const displaySystems = uniqueSystems.length > 1
                                   ? "MULTIPLE"
                                   : (uniqueSystems[0]?.toUpperCase() || "--");

                                return (
                                   <tr key={test.testId} className="hover:bg-zinc-50 dark:hover:bg-zinc-800/50 transition-colors group">
                                      <td className="px-6 py-5">
                                         <div className="w-10 h-10 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center text-[10px] font-bold text-zinc-500 dark:text-zinc-200 relative border border-zinc-200 dark:border-zinc-700">
                                            {percentage}%
                                            <svg className="absolute inset-0 w-full h-full -rotate-90">
                                               <circle cx="20" cy="20" r="18" fill="transparent" stroke="currentColor" className="text-zinc-200 dark:text-zinc-700" strokeWidth="2" />
                                               <circle
                                                  cx="20" cy="20" r="18" fill="transparent" stroke={percentage >= 70 ? "#10b981" : "#3b82f6"}
                                                  strokeWidth="2" strokeDasharray={2 * Math.PI * 18}
                                                  strokeDashoffset={2 * Math.PI * 18 * (1 - percentage / 100)}
                                                  strokeLinecap="round"
                                               />
                                            </svg>
                                         </div>
                                      </td>
                                      <td
                                         className="px-6 py-5 text-[14px] font-black text-zinc-900 dark:text-blue-400 truncate max-w-[50px] cursor-copy select-none relative group"
                                         onDoubleClick={() => handleCopyId(test.testNumber)}
                                         title="Double-click to copy"
                                      >
                                         {test.testNumber}
                                         {copySuccess === test.testNumber && (
                                            <span className="absolute -top-1 left-1/2 -translate-x-1/2 bg-zinc-800 text-white text-[10px] px-2 py-1 rounded shadow-lg animate-in fade-in slide-in-from-bottom-2 duration-300 font-bold whitespace-nowrap z-50">
                                               COPIED!
                                            </span>
                                         )}
                                      </td>
                                      <td className="px-6 py-5 text-[14px] text-zinc-900 dark:text-zinc-100 font-bold whitespace-nowrap">
                                         {new Date(test.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}
                                      </td>
                                      <td className="px-6 py-5 text-[14px] text-zinc-900 dark:text-zinc-100 font-bold lowercase">
                                         {test.mode === 'tutor' ? 'tutor' : 'timed'}
                                      </td>
                                      <td className="px-6 py-5 text-[11px] text-[#0072bc] dark:text-white font-black uppercase tracking-widest" title={Array.isArray(test.pool) ? test.pool.join(', ') : test.pool}>
                                         {displayPool}
                                      </td>
                                      <td className="px-6 py-5 text-[13px] text-zinc-900 dark:text-zinc-100 font-black" title={uniqueSubjects.join(', ')}>
                                         {displaySubjects}
                                      </td>
                                      <td className="px-6 py-5 text-[13px] text-zinc-900 dark:text-zinc-100 font-black" title={uniqueSystems.join(', ')}>
                                         {displaySystems}
                                      </td>

                                       <td className="px-6 py-5 whitespace-nowrap">
                                          <span className={`px-2 py-1 rounded-md text-[9px] font-black uppercase tracking-wider ${test.packageId && test.packageId !== 'default' ? 'bg-[#3b82f6]/10 text-[#3b82f6] border border-[#3b82f6]/20' : 'bg-zinc-100 dark:bg-zinc-800 text-zinc-500 dark:text-zinc-400 border border-zinc-200 dark:border-zinc-700'}`}>
                                             {test.packageId && test.packageId !== 'default' ? (test.packageName || 'PREMIUM') : 'STANDARD'}
                                          </span>
                                       </td>
                                       <td className="px-6 py-5 text-[14px] text-zinc-900 dark:text-zinc-100 font-black font-mono">{totalCount}</td>
                                      <td className="px-6 py-5 text-right">
                                         <div className="flex items-center justify-end gap-3 text-[#3b82f6] dark:text-blue-400">
                                            {isSuspended ? (
                                               <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleResume(test); }} className="hover:scale-110 transition-all p-1.5" title="Resume Progress">
                                                  <Play size={18} />
                                               </button>
                                            ) : (
                                                  omittedCount > 0 && (
                                                     <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleResume(test, true); }} className="hover:scale-110 transition-all p-1.5" title="Resume Omitted">
                                                        <Play size={18} className="fill-blue-500/20" />
                                                     </button>
                                                  )
                                            )}
                                            <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleViewSummary(test, "results"); }} className="hover:scale-110 transition-all p-1.5" title="View Results">
                                               <List size={18} />
                                            </button>
                                            <button type="button" onClick={(e) => { e.preventDefault(); e.stopPropagation(); handleViewSummary(test, "analysis"); }} className="hover:scale-110 transition-all p-1.5" title="View Analysis">
                                               <BarChart2 size={18} />
                                            </button>
                                         </div>
                                      </td>
                                   </tr>
                                );
                             })
                       )}
                    </tbody>
                 </table>
              </div>

              {/* PAGINATION FOOTER */}
              <div className="border-t border-zinc-100 dark:border-zinc-800 px-6 py-4 flex items-center justify-between bg-zinc-50/30 dark:bg-zinc-900/30">
                 <div className="text-[13px] text-zinc-500 dark:text-zinc-400 font-medium">
                    Showing <span className="text-zinc-900 dark:text-zinc-100 font-bold">{paginatedTests.length > 0 ? ((currentPage - 1) * itemsPerPage) + 1 : 0}</span> to <span className="text-zinc-900 dark:text-zinc-100 font-bold">{Math.min(currentPage * itemsPerPage, filteredTests.length)}</span> of <span className="text-zinc-900 dark:text-zinc-100 font-bold">{filteredTests.length}</span> tests
                 </div>
                 <div className="flex items-center gap-2">
                    <button
                       onClick={() => setCurrentPage(p => Math.max(1, p - 1))}
                       disabled={currentPage === 1}
                       className="p-1.5 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
                    >
                       <ChevronLeft size={18} className="text-zinc-500 dark:text-zinc-400" />
                    </button>
                    {Array.from({ length: totalPages }, (_, i) => i + 1).map(page => (
                       <button
                          key={page}
                          onClick={() => setCurrentPage(page)}
                          className={`px-3 py-1.5 rounded text-[13px] font-medium transition-all ${currentPage === page ? 'bg-[#3b82f6] text-white' : 'hover:bg-zinc-100 dark:hover:bg-zinc-800 text-zinc-500 dark:text-zinc-400'}`}
                       >
                          {page}
                       </button>
                    ))}
                    <button
                       onClick={() => setCurrentPage(p => Math.min(totalPages, p + 1))}
                       disabled={currentPage === totalPages || totalPages === 0}
                       className="p-1.5 rounded hover:bg-zinc-100 dark:hover:bg-zinc-800 disabled:opacity-30 disabled:cursor-not-allowed transition-all"
                    >
                       <ChevronRight size={18} className="text-zinc-500 dark:text-zinc-400" />
                    </button>
                 </div>
              </div>
           </div>
        </div>

        {/* FOOTER */}
        <footer className="fixed bottom-0 left-0 w-full bg-card border-t border-border py-3 text-center transition-colors duration-300">
           <span className="text-[11px] text-zinc-500 dark:text-zinc-400 font-medium">Copyright ¬© MedBank. All rights reserved.</span>
        </footer>
    </div>
  );
}
</file>

<file path="src/context/AppContext.js">
"use client";

import { createContext, useEffect, useState, useMemo } from "react";

export const AppContext = createContext();

export default function AppProvider({ children }) {
  const [theme, setTheme] = useState("light"); // Default to light

  useEffect(() => {
    // Initial theme setup
    const savedTheme = localStorage.getItem("medbank-theme");
    if (savedTheme) {
      queueMicrotask(() => setTheme(savedTheme));
    }
  }, []);

  const [sidebarCollapsed, setSidebarCollapsed] = useState(false);
  const [cart, setCart] = useState([]);
  const [isCartOpen, setIsCartOpen] = useState(false);

  useEffect(() => {
    const savedCart = localStorage.getItem("medbank_cart");
    if (savedCart) {
      try {
        const parsed = JSON.parse(savedCart);
        queueMicrotask(() => setCart(parsed));
      } catch (e) {
        console.error("Failed to parse cart JSON", e);
      }
    }
  }, []);

  const addToCart = (product) => {
    console.log('[Cart] Adding product to cart:', product);
    setCart(prev => {
      // Check if product already exists
      const existingItemIndex = prev.findIndex(item => item.id === product.id);
      
      let newCart;
      if (existingItemIndex >= 0) {
        // Increment quantity
        console.log('[Cart] Product exists, incrementing quantity');
        newCart = [...prev];
        newCart[existingItemIndex] = {
          ...newCart[existingItemIndex],
          quantity: (newCart[existingItemIndex].quantity || 1) + 1
        };
      } else {
        // Add new item with quantity 1
        // Store only serializable data
        const serializableProduct = {
          id: product.id,
          title: product.title,
          subtitle: product.subtitle,
          description: product.description,
          color: product.color,
          price: product.price,
          duration: product.duration,
          features: product.features,
          quantity: 1
        };
        console.log('[Cart] Adding new item:', serializableProduct);
        newCart = [...prev, serializableProduct];
      }
      
      console.log('[Cart] New cart state:', newCart);
      localStorage.setItem("medbank_cart", JSON.stringify(newCart));
      return newCart;
    });
  };

  const removeFromCart = (productId) => {
    setCart(prev => {
      const newCart = prev.filter(item => item.id !== productId);
      localStorage.setItem("medbank_cart", JSON.stringify(newCart));
      return newCart;
    });
  };

  const clearCart = () => {
    setCart([]);
    localStorage.removeItem("medbank_cart");
    console.log('[Cart] Cart cleared');
  };

  const toggleTheme = () => {
    const newTheme = theme === "dark" ? "light" : "dark";
    setTheme(newTheme);
    localStorage.setItem("medbank-theme", newTheme);
  };

  const toggleSidebar = () => setSidebarCollapsed(prev => !prev);

  const [selectedAuthorProduct, setSelectedAuthorProduct] = useState(null);

  useEffect(() => {
    // Persist selected author product
    const saved = localStorage.getItem("medbank_author_product_context");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        queueMicrotask(() => setSelectedAuthorProduct(parsed));
      } catch (e) {
        console.error("Failed to parse saved product context");
      }
    }
  }, []);

  const setGlobalAuthorProduct = (product) => {
    setSelectedAuthorProduct(product);
    if (product) {
      localStorage.setItem("medbank_author_product_context", JSON.stringify(product));
    } else {
      localStorage.removeItem("medbank_author_product_context");
    }
  };

  // --- Student Product Context ---
  const [selectedStudentProduct, setSelectedStudentProduct] = useState(null);
  const [availableStudentProducts, setAvailableStudentProducts] = useState([]);

  useEffect(() => {
    const saved = localStorage.getItem("medbank_focused_product");
    if (saved) {
      try {
        const parsed = JSON.parse(saved);
        if (parsed !== 'default') queueMicrotask(() => setSelectedStudentProduct(parsed));
      } catch (e) {
        console.error("Failed to parse student product context");
      }
    }
  }, []);

  const setGlobalStudentProduct = (product) => {
    setSelectedStudentProduct(product);
    if (product) {
      localStorage.setItem("medbank_focused_product", JSON.stringify(product));
      // Trigger a custom event for legacy components still using listeners
      window.dispatchEvent(new Event("medbank_product_change"));
    } else {
      localStorage.removeItem("medbank_focused_product");
      window.dispatchEvent(new Event("medbank_product_change"));
    }
  };

  const value = useMemo(() => ({ 
    theme, toggleTheme, 
    sidebarCollapsed, setSidebarCollapsed, toggleSidebar,
    cart, setCart, isCartOpen, setIsCartOpen, addToCart, removeFromCart, clearCart,
    selectedAuthorProduct, setGlobalAuthorProduct,
    selectedStudentProduct, setSelectedStudentProduct, setGlobalStudentProduct,
    availableStudentProducts, setAvailableStudentProducts
  }), [
    theme, toggleTheme,
    sidebarCollapsed, setSidebarCollapsed, toggleSidebar,
    cart, setCart, isCartOpen, setIsCartOpen, addToCart, removeFromCart, clearCart,
    selectedAuthorProduct, setGlobalAuthorProduct,
    selectedStudentProduct, setSelectedStudentProduct, setGlobalStudentProduct,
    availableStudentProducts, setAvailableStudentProducts
  ]);

  return (
    <AppContext.Provider value={value}>
      {children}
    </AppContext.Provider>
  );
}
</file>

<file path="src/hooks/exam/useExamEngine.js">
"use client";

import { useState, useEffect, useCallback, useRef } from "react";
import { useRouter } from "next/navigation";
import { getAllQuestions, getQuestionById, updateQuestionStats } from "@/services/question.service";
import { updateUserQuestion } from "@/services/user.service";
import { saveTest, getTestById } from "@/services/test.service";

export function useExamEngine() {
  const router = useRouter();
  
  // --- STATE ---
  const [questions, setQuestions] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [answers, setAnswers] = useState({});
  const [isSubmitted, setIsSubmitted] = useState(false);
  const [mode, setMode] = useState("tutor");
  const [isReviewMode, setIsReviewMode] = useState(false);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [markedQuestions, setMarkedQuestions] = useState(new Set());
  const [lockedAnswers, setLockedAnswers] = useState({});
  const [firstAnswers, setFirstAnswers] = useState({});
  const [sessionTestId, setSessionTestId] = useState(null);
  const [questionDurations, setQuestionDurations] = useState({});
  const [showQuestionList, setShowQuestionList] = useState(false);
  const [strikeouts, setStrikeouts] = useState({});
  const [modal, setModal] = useState({ show: false, title: "", message: "", onConfirm: null });
  const [isEnding, setIsEnding] = useState(false);
  const [isLoading, setIsLoading] = useState(true);

  // --- ENGINE EXTENSIONS (Audit & State) ---
  const [sessionLogs, setSessionLogs] = useState([]);
  const [answerHistory, setAnswerHistory] = useState({});
  const [tutorReveals, setTutorReveals] = useState(new Set());
  const [lastSyncHash, setLastSyncHash] = useState("");
  const syncTimerRef = useRef(null);

  // --- DERIVED ---
  const currentQuestion = questions[currentIndex] || null;
  const totalQuestions = questions.length;

  // --- INITIAL LOAD ---
  useEffect(() => {
    const testData = JSON.parse(localStorage.getItem("medbank_current_test"));
    if (!testData || !testData.questions) {
      router.push("/student/qbank/create-test");
      return;
    }

    const testMode = testData.mode || "tutor";
    setMode(testMode);
    setIsReviewMode(!!testData.isReview);
    
    async function fetchQuestions() {
      setIsLoading(true);
      try {
        // NEW: Assembly Snapshot Engine
        // Try to use the snapshotted 'questions' list first (guarantees immutability)
        let ordered = [];
        if (typeof testData.questions === 'string') {
          try {
            const parsed = JSON.parse(testData.questions);
            if (Array.isArray(parsed) && parsed.length > 0 && typeof parsed[0] === 'object') {
              ordered = parsed;
            }
          } catch(e) {}
        }
        
        // Fallback to ID-based loading if snapshot is missing or stale
        if (ordered.length === 0) {
          const all = await getAllQuestions();
          const rawIds = testData.questions || [];
          const selectedIds = rawIds.map(id => (typeof id === 'object' && id !== null) ? String(id.id) : String(id));
          const selected = all.filter(q => selectedIds.includes(String(q.id)));
          ordered = selectedIds.map(id => selected.find(q => String(q.id) === id)).filter(Boolean);
        }
        
        if (testData.sessionState) {
          try {
            const ss = typeof testData.sessionState === 'string' ? JSON.parse(testData.sessionState) : testData.sessionState;
            setAnswerHistory(ss.answerHistory || {});
            setSessionLogs(ss.logs || []);
            setTutorReveals(new Set(ss.tutorReveals || []));
            if (ss.strikeouts) {
                const restoredStrikes = {};
                Object.entries(ss.strikeouts).forEach(([qid, letters]) => {
                    restoredStrikes[qid] = new Set(letters);
                });
                setStrikeouts(restoredStrikes);
            }
          } catch(e) { console.warn("Failed to restore sessionState", e); }
        }

        setQuestions(ordered);

        const sourceAnswers = testData.answers || testData.resumeData?.answers || {};
        const savedFirstAnswers = testData.firstAnswers || testData.resumeData?.firstAnswers || {};
        setFirstAnswers(savedFirstAnswers);
        
        const savedIndex = testData.currentIndex ?? testData.resumeData?.currentIndex ?? 0;
        let savedTime = testData.elapsedTime ?? testData.resumeData?.elapsedTime ?? 0;
        const savedDurations = testData.questionDurations || testData.resumeData?.questionDurations || {};
        setQuestionDurations(savedDurations);

        if (testMode === "timed" && testData.resumeData?.isOmittedResume) {
          const timeLimit = selectedIds.length * 90;
          if (savedTime >= timeLimit) {
            const omittedCount = selectedIds.filter(id => !sourceAnswers[id]).length;
            savedTime = Math.max(0, timeLimit - (omittedCount * 60));
          }
        }

        const savedMarked = testData.markedIds ?? testData.resumeData?.markedIds ?? [];
        setAnswers(sourceAnswers);

        // Lock logic
        if (testData.isReview) {
          setLockedAnswers(sourceAnswers);
        } else if (testMode.toLowerCase() === 'tutor') {
          setLockedAnswers(sourceAnswers);
        } else if (testData.resumeData?.isOmittedResume && !testData.resumeData?.isSuspended) {
          setLockedAnswers(sourceAnswers);
        } else {
          setLockedAnswers({});
        }

        let targetIndex = savedIndex;
        if (testData.resumeData?.isOmittedResume) {
          const firstOmittedIdx = ordered.findIndex(qObj => !sourceAnswers[qObj.id]);
          if (firstOmittedIdx !== -1) targetIndex = firstOmittedIdx;
        }

        setCurrentIndex(targetIndex);
        setElapsedTime(savedTime);
        setMarkedQuestions(new Set(savedMarked));

        const currentUser = localStorage.getItem("medbank_user");
        const persistentId = String(testData.testId || testData.resumeData?.originalTestId || Date.now());
        setSessionTestId(persistentId);

        const activeQuestion = ordered[targetIndex];
        if (activeQuestion) {
          const currentAnswer = sourceAnswers[activeQuestion.id];
          if (testData.isReview || (testMode.toLowerCase() === 'tutor' && currentAnswer)) {
            setSelectedAnswer(currentAnswer);
            setIsSubmitted(true);
          } else if (currentAnswer) {
            setSelectedAnswer(currentAnswer);
            setIsSubmitted(false);
          }
        }
      } catch (err) {
        console.error("Exam load error:", err);
      } finally {
        setIsLoading(false);
      }
    }
    fetchQuestions();
  }, [router]);

  // --- AUDIT LOG HELPER ---
  const logAction = useCallback((action, metadata = {}) => {
    const entry = {
        timestamp: new Date().toISOString(),
        offset: elapsedTime,
        questionId: currentQuestion?.id,
        index: currentIndex,
        action,
        ...metadata
    };
    setSessionLogs(prev => [...prev, entry]);
  }, [elapsedTime, currentQuestion?.id, currentIndex]);

  // --- PERSISTENCE & SYNC ---
  useEffect(() => {
    if (questions.length === 0 || isReviewMode || isEnding) return;
    const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
    const activeTestId = sessionTestId || String(currentTestData.testId || "");
    if (!activeTestId) return;

    // Convert Sets to Arrays for JSON serialization
    const serializableStrikes = {};
    Object.entries(strikeouts).forEach(([qid, set]) => {
        serializableStrikes[qid] = Array.from(set);
    });

    const sessionState = {
        answerHistory,
        strikeouts: serializableStrikes,
        tutorReveals: Array.from(tutorReveals),
        logs: sessionLogs
    };

    const updatedTestData = {
      ...currentTestData,
      testId: activeTestId,
      answers,
      currentIndex,
      elapsedTime,
      markedIds: Array.from(markedQuestions),
      firstAnswers,
      questionDurations,
      sessionState
    };
    
    const stateString = JSON.stringify(updatedTestData);
    localStorage.setItem("medbank_current_test", stateString);

    // Silent Sync Logic (Authoritative)
    if (!syncTimerRef.current) {
        syncTimerRef.current = setInterval(async () => {
            const currentHash = localStorage.getItem("medbank_current_test");
            if (currentHash !== lastSyncHash) {
                try {
                    const data = JSON.parse(currentHash);
                    await saveTest(data);
                    setLastSyncHash(currentHash);
                    console.log("Exam Engine: Silent sync complete.");
                } catch(e) { console.error("Silent sync failed", e); }
            }
        }, 10000);
    }

    return () => {
        if (syncTimerRef.current) {
            clearInterval(syncTimerRef.current);
            syncTimerRef.current = null;
        }
    };
  }, [answers, currentIndex, elapsedTime, markedQuestions, questions.length, isReviewMode, questionDurations, sessionTestId, firstAnswers, isEnding, answerHistory, strikeouts, tutorReveals, sessionLogs, lastSyncHash]);

  // --- ACTIONS ---
  const handleEndBlock = useCallback((isAuto = false) => {
    const processSubmission = async () => {
      setIsEnding(true);
      if (isReviewMode) {
        const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
        const payload = {
          testId: sessionTestId || String(currentTestData.testId || ""),
          packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package"),
          packageName: currentTestData.packageName || null,
          mode: currentTestData.mode || 'tutor'
        };
        localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
        router.push("/student/qbank/test-summary");
        return;
      }

      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const activeTestId = sessionTestId || String(currentTestData.testId || "");
      
      const results = {
        testId: String(activeTestId || Date.now()),
        testNumber: currentTestData.testNumber,
        date: currentTestData.date || new Date().toISOString(),
        mode,
        pool: currentTestData.pool || "All Questions",
        packageId: currentTestData.packageId || null,
        questions: questions.map(quest => ({
          id: quest?.id,
          correct: quest?.correct,
          userAnswer: answers[quest?.id] || null,
          subject: quest?.subject,
          system: quest?.system,
          timeSpent: questionDurations[quest?.id] || 0
        })),
        answers,
        firstAnswers,
        elapsedTime,
        markedIds: Array.from(markedQuestions),
        isSuspended: false
      };

      const currentUser = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;

      await Promise.all(results.questions.map(async (item) => {
        try {
          const isCorrect = item.userAnswer === item.correct;
          const choiceDistUpdate = {};
          if (item.userAnswer) choiceDistUpdate[item.userAnswer] = 1;

          const qHistory = answerHistory[item.id] || [];
          const volatility = qHistory.length; 
          const strikeCount = (strikeouts[item.id]?.size) || 0;
          const isMarked = markedQuestions.has(item.id) ? 1 : 0;

          await updateQuestionStats(item.id, {
            globalAttempts: 1,
            globalCorrect: isCorrect ? 1 : 0,
            choiceDistribution: choiceDistUpdate,
            timeSpent: item.timeSpent || 0,
            volatility,
            strikes: strikeCount,
            marks: isMarked
          });

          const isNowCorrect = item.userAnswer === item.correct;
          const status = !item.userAnswer ? 'omitted' : (isNowCorrect ? 'correct' : 'incorrect');

          if (currentUser) {
            await updateUserQuestion(currentUser, item.id, results.packageId, {
              userAnswer: item.userAnswer,
              status,
              isMarked,
              timeSpent: item.timeSpent || 0,
              testId: results.testId // NEW: Pass testId for granular logging
            });
          }
        } catch (err) { console.error("Stat update error:", item.id, err); }
      }));

      await saveTest(results);

      const payload = {
        testId: results.testId,
        packageId: results.packageId || localStorage.getItem("medbank_selected_package"),
        packageName: currentTestData.packageName || localStorage.getItem("medbank_selected_package_name"),
        mode: results.mode
      };
      localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
      localStorage.setItem("medbank_last_test_id", results.testId);
      localStorage.setItem("medbank_current_test", JSON.stringify({ ...results, isReview: false }));
      router.push("/student/qbank/test-summary");
    };

    if (isAuto) {
      processSubmission();
    } else {
      let msg, title, type;
      if (isReviewMode) {
        title = "End Review Session";
        msg = "Are you sure you want to exit this review session?";
        type = "info";
      } else {
        const unansweredCount = questions.length - Object.keys(answers).length;
        if (unansweredCount > 0) {
          title = "End Test Block Permanently";
          msg = `Warning: You still have ${unansweredCount} unanswered questions. If you end this block now, it will be marked as finished. You can resume the omitted questions later from your history, but your current answers will be saved permanently and cannot be changed.`;
          type = "danger";
        } else {
          title = "End Test Session";
          msg = "Great job finishing all questions! Are you sure you want to end this block? This will calculate your final score and record the results permanently.";
          type = "confirm";
        }
      }

      setModal({
        show: true,
        title: title,
        message: msg,
        type: type,
        confirmText: isReviewMode ? "End Review" : "End Block Permanently",
        onConfirm: processSubmission,
      });
    }
  }, [sessionTestId, questions, answers, mode, elapsedTime, markedQuestions, isReviewMode, firstAnswers, questionDurations, router, logAction, strikeouts, answerHistory]);

  const handleNext = useCallback(() => {
    if (currentIndex < totalQuestions - 1) {
      const nextIdx = currentIndex + 1;
      logAction("navigate_next", { from: currentIndex, to: nextIdx });
      setCurrentIndex(nextIdx);
      const nextAnswer = answers[questions[nextIdx]?.id] || null;
      setSelectedAnswer(nextAnswer);
      setIsSubmitted(isReviewMode || (mode === "tutor" && !!nextAnswer) || tutorReveals.has(questions[nextIdx]?.id));
    } else if (!isReviewMode) {
      handleEndBlock();
    }
  }, [currentIndex, totalQuestions, questions, answers, isReviewMode, mode, logAction, tutorReveals, handleEndBlock]);

  const handlePrevious = useCallback(() => {
    if (currentIndex > 0) {
      const prevIdx = currentIndex - 1;
      logAction("navigate_previous", { from: currentIndex, to: prevIdx });
      setCurrentIndex(prevIdx);
      const prevAnswer = answers[questions[prevIdx]?.id] || null;
      setSelectedAnswer(prevAnswer);
      setIsSubmitted(isReviewMode || (mode === "tutor" && !!prevAnswer) || tutorReveals.has(questions[prevIdx]?.id));
    }
  }, [currentIndex, questions, answers, isReviewMode, mode, logAction, tutorReveals]);

  const handleSubmit = useCallback(() => {
    if (isReviewMode || !selectedAnswer || !currentQuestion) return;
    if (mode === "tutor") {
      setIsSubmitted(true);
      setTutorReveals(prev => new Set([...prev, currentQuestion.id]));
      logAction("tutor_reveal", { choice: selectedAnswer });
      setAnswers(prev => ({ ...prev, [currentQuestion.id]: selectedAnswer }));
    } else {
      handleNext();
    }
  }, [currentQuestion, isReviewMode, mode, selectedAnswer, logAction, handleNext]);

  const toggleStrikeout = useCallback((qId, letter) => {
    if (isReviewMode || isSubmitted || !qId) return;
    setStrikeouts(prev => {
      const qStrikeouts = new Set(prev[qId] || []);
      if (qStrikeouts.has(letter)) {
        qStrikeouts.delete(letter);
        logAction("unstrike_option", { questionId: qId, choice: letter });
      } else {
        qStrikeouts.add(letter);
        logAction("strike_option", { questionId: qId, choice: letter });
        if (answers[qId] === letter) {
          setAnswers(prevAns => {
            const next = { ...prevAns };
            delete next[qId];
            return next;
          });
          if (qId === currentQuestion?.id) setSelectedAnswer(null);
        }
      }
      return { ...prev, [qId]: qStrikeouts };
    });
  }, [isReviewMode, isSubmitted, answers, currentQuestion?.id, logAction]);

  const handleSelectAnswer = useCallback((qId, letter) => {
    if (isReviewMode || isSubmitted || !qId || lockedAnswers[qId]) return;

    if (!firstAnswers[qId]) {
      setFirstAnswers(prev => ({ ...prev, [qId]: letter }));
    }

    const currentLetter = answers[qId];

    if (currentLetter === letter) {
      // Deselect
      setAnswers(prev => {
        const newState = { ...prev };
        delete newState[qId];
        return newState;
      });
      logAction("deselect_answer", { questionId: qId, choice: letter });
      if (qId === currentQuestion?.id) setSelectedAnswer(null);
    } else {
      // Select
      setAnswers(prev => ({ ...prev, [qId]: letter }));
      logAction("select_answer", { questionId: qId, choice: letter });
      
      if (qId === currentQuestion?.id) setSelectedAnswer(letter);

      // Track Answer History
      setAnswerHistory(prev => {
        const qHistory = prev[qId] || [];
        return {
            ...prev,
            [qId]: [...qHistory, { choice: letter, timestamp: new Date().toISOString(), offset: elapsedTime }]
        };
      });

      if (strikeouts[qId]?.has(letter)) {
        toggleStrikeout(qId, letter);
      }
    }
  }, [answers, firstAnswers, isReviewMode, isSubmitted, lockedAnswers, logAction, currentQuestion?.id, elapsedTime, strikeouts, toggleStrikeout]);

  const toggleMark = useCallback(async () => {
    if (!currentQuestion) return;
    const newMarked = new Set(markedQuestions);
    const isNowMarked = !newMarked.has(currentQuestion.id);

    if (newMarked.has(currentQuestion.id)) newMarked.delete(currentQuestion.id);
    else newMarked.add(currentQuestion.id);
    setMarkedQuestions(newMarked);

    try {
      const currentUser = localStorage.getItem("medbank_user");
      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const packageId = currentTestData.packageId;

      if (currentUser && packageId) {
        await updateUserQuestion(currentUser, currentQuestion.id, packageId, {
          isMarked: isNowMarked,
          testId: sessionTestId || String(currentTestData.testId || "")
        });
      }
    } catch (err) {
      console.error("Flag persist error:", err);
    }
  }, [currentQuestion, markedQuestions]);

  const handleSuspend = useCallback((showConfirm = true) => {
    if (isReviewMode) {
      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const payload = {
        testId: sessionTestId || String(currentTestData.testId || ""),
        packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package"),
        packageName: currentTestData.packageName || null,
        mode: currentTestData.mode || 'tutor'
      };
      localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
      router.push("/student/qbank/test-summary");
      return;
    }

    const executeSuspend = async () => {
      setIsEnding(true);
      logAction("suspend_session");
      const testData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      await saveTest(testData); 
      localStorage.removeItem("medbank_current_test");
      router.push("/student/qbank");
    };

    if (showConfirm) {
      setModal({
        show: true,
        title: "Suspend Test session",
        message: "Are you sure you want to suspend this test? You will be able to resume this session exactly where you left off from your Previous Tests history.",
        onConfirm: executeSuspend
      });
    } else {
      executeSuspend();
    }
  }, [isReviewMode, router, logAction]);

  // --- KEYBOARD SHORTCUTS ---
  useEffect(() => {
    if (isReviewMode || isEnding || isLoading || !currentQuestion) return;

    const handleKeyDown = (e) => {
        if (document.activeElement.tagName === 'INPUT' || document.activeElement.tagName === 'TEXTAREA' || modal.show) return;

        const key = e.key.toUpperCase();
        
        if (['A', 'B', 'C', 'D', 'E'].includes(key)) {
            handleSelectAnswer(currentQuestion.id, key);
        }
        else if (key === 'M') {
            toggleMark();
        }
        else if (e.key === 'ArrowRight') {
            handleNext();
        }
        else if (e.key === 'ArrowLeft') {
            handlePrevious();
        }
        else if (e.key === 'Enter' && selectedAnswer && !isSubmitted) {
            handleSubmit();
        }
    };

    window.addEventListener('keydown', handleKeyDown);
    return () => window.removeEventListener('keydown', handleKeyDown);
  }, [isReviewMode, isEnding, isLoading, currentQuestion, handleSelectAnswer, toggleMark, handleNext, handlePrevious, handleSubmit, selectedAnswer, isSubmitted, modal.show]);

  return {
    // State
    questions, currentIndex, selectedAnswer, answers, isSubmitted, mode, isReviewMode,
    elapsedTime, markedQuestions, lockedAnswers, firstAnswers, sessionTestId,
    questionDurations, showQuestionList, strikeouts, modal, isEnding, isLoading,
    answerHistory, sessionLogs, tutorReveals,
    // Derived
    currentQuestion, totalQuestions,
    // setters
    setCurrentIndex, setSelectedAnswer, setAnswers, setIsSubmitted, setElapsedTime, setQuestionDurations, setShowQuestionList, setModal,
    // Helpers
    handleSelectAnswer, toggleStrikeout, handleSubmit, handleNext, handlePrevious,
    toggleMark, handleSuspend, handleEndBlock
  };
}
</file>

<file path="src/lib/server-db.js">
import Database from 'better-sqlite3';
import path from 'path';
import fs from 'fs';
import crypto from 'crypto';

// Database file path - stored in project root
const findDbPath = () => {
    // Priority 1: Current working directory
    const cwdPath = path.join(process.cwd(), 'medbank.db');
    if (fs.existsSync(cwdPath)) return cwdPath;
    
    // Priority 2: One level up (if running from src or app)
    const upPath = path.join(process.cwd(), '..', 'medbank.db');
    if (fs.existsSync(upPath)) return upPath;
    
    // Default to root
    return cwdPath;
};

export const DB_PATH = findDbPath();

let db = null;

export function getDb() {
  if (!db) {
    console.log('DB: Opening database at:', DB_PATH);
    db = new Database(DB_PATH);
    db.pragma('journal_mode = WAL');
    db.pragma('synchronous = NORMAL');
    db.pragma('cache_size = 1000000');
    db.pragma('busy_timeout = 5000');
    db.pragma('foreign_keys = ON');
    initializeSchema();
    seedDemoUsers();
    console.log('DB: Connection established and schemas verified');
  }
  return db;
}

function hashPassword(password) {
  return crypto.createHash('sha256').update(password).digest('hex');
}

function seedDemoUsers() {
  const db = getDb();
  const userCount = db.prepare('SELECT COUNT(*) as count FROM users').get().count;

  if (userCount === 0) {
    console.log('Seeding demo users...');
    const adminId = 'cc06b8c9-76e9-4e78-be75-2d4e9d722de8'; // Consistent UUIDs
    const studentId = 'cc06b8c9-76e9-4e78-be75-2d4e9d722de9';
    const iskandarId = 'd80c2827-f876-4755-9b1f-c2a6e54e8231';

    const stmt = db.prepare(`
      INSERT INTO users (id, name, email, passwordHash, role, subscriptionStatus, createdAt, subscriptionDuration, productName)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `);

    stmt.run(adminId, 'Admin', 'admin@medbank.local', hashPassword('admin123'), 'admin', 'active', new Date().toISOString(), 365, 'Admin Access');
    stmt.run(studentId, 'Student', 'student@medbank.local', hashPassword('student123'), 'student', 'trial', new Date().toISOString(), 3, 'Free Trial');
    stmt.run(iskandarId, 'Iskandar', 'e@medbank.local', hashPassword('student123'), 'student', 'trial', new Date().toISOString(), 3, 'Free Trial');
    console.log('Demo users seeded');
  }

  // Independent Seed for subscription_packages
  try {
    const packageCount = db.prepare('SELECT COUNT(*) as count FROM subscription_packages').get().count;
    if (packageCount === 0) {
      console.log('Seeding subscription packages...');
      const stmt = db.prepare('INSERT INTO subscription_packages (name, duration_days, price, description, createdAt) VALUES (?, ?, ?, ?, ?)');
      stmt.run('90-Day QBank Subscription', 90, 49.99, 'Full access to medical QBank for 90 days.', new Date().toISOString());
      stmt.run('180-Day QBank Subscription', 180, 89.99, 'Full access to medical QBank for 180 days.', new Date().toISOString());
      stmt.run('365-Day QBank Subscription', 365, 149.99, 'Full access to medical QBank for 365 days.', new Date().toISOString());
      console.log('Subscription packages seeded');
    }
  } catch (err) {
    console.error('Error seeding subscription packages:', err.message);
  }
}

function initializeSchema() {
  const database = db;

  // Users table
  database.exec(`
    CREATE TABLE IF NOT EXISTS users (
      id TEXT PRIMARY KEY,
      name TEXT NOT NULL,
      email TEXT UNIQUE NOT NULL,
      passwordHash TEXT NOT NULL,
      role TEXT DEFAULT 'student',
      subscriptionStatus TEXT DEFAULT 'trial',
      purchased INTEGER DEFAULT 0,
      activatedByPurchase INTEGER DEFAULT 0,
      hasPendingPurchase INTEGER DEFAULT 0,
      trialUsed INTEGER DEFAULT 0,
      activatedAt TEXT,
      expiresAt TEXT,
      lastRenewedAt TEXT,
      createdAt TEXT NOT NULL,
      updatedAt TEXT,
      isBanned INTEGER DEFAULT 0,
      stats TEXT DEFAULT '{"attempted":0,"correct":0,"tests":0}',
      pendingDuration INTEGER DEFAULT 0,
      subscriptionDuration INTEGER DEFAULT 0,
      productName TEXT
    )
  `);

  // Migrate users table for existing databases (add new columns if missing)
  const userColumnsToAdd = [
    { name: 'pendingDuration', type: 'INTEGER DEFAULT 0' },
    { name: 'subscriptionDuration', type: 'INTEGER DEFAULT 0' },
    { name: 'productName', type: 'TEXT' },
    { name: 'purchasedProducts', type: "TEXT DEFAULT '[]'" }
  ];
  const existingUserCols = database.prepare("PRAGMA table_info(users)").all().map(c => c.name);
  for (const col of userColumnsToAdd) {
    if (!existingUserCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE users ADD COLUMN ${col.name} ${col.type}`);
        console.log(`Added column ${col.name} to users table`);
      } catch (err) {
        console.warn(`Could not add column ${col.name} to users:`, err.message);
      }
    }
  }

  // Questions table (global library) - Expanded for Authoring
  database.exec(`
    CREATE TABLE IF NOT EXISTS questions (
      id TEXT PRIMARY KEY,
      stem TEXT NOT NULL,
      stemImage TEXT DEFAULT '{}',
      choices TEXT NOT NULL,
      correct TEXT NOT NULL,
      explanation TEXT,
      explanationCorrect TEXT,
      explanationCorrectImage TEXT DEFAULT '{}',
      explanationWrong TEXT,
      explanationWrongImage TEXT DEFAULT '{}',
      summary TEXT,
      summaryImage TEXT DEFAULT '{}',
      subject TEXT,
      system TEXT,
      topic TEXT,
      difficulty TEXT DEFAULT 'medium',
      cognitiveLevel TEXT DEFAULT 'understanding',
      type TEXT DEFAULT 'multiple-choice',
      published INTEGER DEFAULT 0,
      createdAt TEXT NOT NULL,
      updatedAt TEXT,
      "references" TEXT,
      tags TEXT DEFAULT '[]',
      version INTEGER DEFAULT 1,
      stemImageMode TEXT DEFAULT 'auto',
      explanationImageMode TEXT DEFAULT 'auto',
      packageId TEXT,
      productId TEXT,
      conceptId TEXT, -- Link to eternal Question Concept
      status TEXT DEFAULT 'draft', -- draft, published, archived, deprecated
      versionNumber INTEGER DEFAULT 1,
      isLatest INTEGER DEFAULT 1,
      globalAttempts INTEGER DEFAULT 0,
      globalCorrect INTEGER DEFAULT 0,
      choiceDistribution TEXT DEFAULT '{}',
      totalTimeSpent INTEGER DEFAULT 0, -- Total seconds across all users
      totalVolatility INTEGER DEFAULT 0, -- Total answer changes across all users
      totalStrikes INTEGER DEFAULT 0,
      totalMarks INTEGER DEFAULT 0
    )
  `);

  // NEW: Question Concepts Table (The eternal learning objective)
  database.exec(`
    CREATE TABLE IF NOT EXISTS question_concepts (
      id TEXT PRIMARY KEY,
      packageId TEXT,
      productId TEXT,
      system TEXT,
      subject TEXT,
      topic TEXT,
      tags TEXT DEFAULT '[]',
      createdAt TEXT NOT NULL,
      updatedAt TEXT
    )
  `);

  // Migrate schema for existing databases (idempotent addition of new columns)
  const columnsToAdd = [
    { name: 'stemImage', type: 'TEXT DEFAULT "{}"' },
    { name: 'explanationCorrect', type: 'TEXT' },
    { name: 'explanationCorrectImage', type: 'TEXT DEFAULT "{}"' },
    { name: 'explanationWrong', type: 'TEXT' },
    { name: 'explanationWrongImage', type: 'TEXT DEFAULT "{}"' },
    { name: 'summary', type: 'TEXT' },
    { name: 'summaryImage', type: 'TEXT DEFAULT "{}"' },
    { name: 'topic', type: 'TEXT' },
    { name: 'cognitiveLevel', type: 'TEXT DEFAULT "understanding"' },
    { name: 'type', type: 'TEXT DEFAULT "multiple-choice"' },
    { name: 'references', type: 'TEXT' },
    { name: 'tags', type: 'TEXT DEFAULT "[]"' },
    { name: 'version', type: 'INTEGER DEFAULT 1' },
    { name: 'stemImageMode', type: 'TEXT DEFAULT "auto"' },
    { name: 'explanationImageMode', type: 'TEXT DEFAULT "auto"' },
    { name: 'packageId', type: 'TEXT' },
    { name: 'productId', type: 'TEXT' }
  ];

  const existingCols = database.prepare("PRAGMA table_info(questions)").all().map(c => c.name);
  for (const col of columnsToAdd) {
    if (!existingCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE questions ADD COLUMN "${col.name}" ${col.type}`);
        console.log(`Added column ${col.name} to questions table`);
      } catch (err) {
        console.warn(`Could not add column ${col.name}:`, err.message);
      }
    }
  }

  // Lifecycle & Versioning columns
  const lifecycleCols = [
      { name: 'conceptId', type: 'TEXT' },
      { name: 'status', type: "TEXT DEFAULT 'draft'" },
      { name: 'versionNumber', type: 'INTEGER DEFAULT 1' },
      { name: 'isLatest', type: 'INTEGER DEFAULT 1' },
      { name: 'globalAttempts', type: 'INTEGER DEFAULT 0' },
      { name: 'globalCorrect', type: 'INTEGER DEFAULT 0' },
      { name: 'choiceDistribution', type: "TEXT DEFAULT '{}'" },
      { name: 'totalTimeSpent', type: 'INTEGER DEFAULT 0' },
      { name: 'totalVolatility', type: 'INTEGER DEFAULT 0' },
      { name: 'totalStrikes', type: 'INTEGER DEFAULT 0' },
      { name: 'totalMarks', type: 'INTEGER DEFAULT 0' }
  ];
  for (const col of lifecycleCols) {
      if (!existingCols.includes(col.name)) {
          database.exec(`ALTER TABLE questions ADD COLUMN ${col.name} ${col.type}`);
      }
  }

  // ONE-TIME MIGRATION: Bind existing questions to concepts
  const unlinkedCount = database.prepare("SELECT COUNT(*) as count FROM questions WHERE conceptId IS NULL").get().count;
  if (unlinkedCount > 0) {
      console.log(`MIGRATION: Linking ${unlinkedCount} questions to parent concepts...`);
      const questions = database.prepare("SELECT id, packageId, system, subject, topic, tags, createdAt, published FROM questions WHERE conceptId IS NULL").all();
      
      const insertConcept = database.prepare(`
          INSERT INTO question_concepts (id, packageId, system, subject, topic, tags, createdAt)
          VALUES (?, ?, ?, ?, ?, ?, ?)
      `);
      const updateVersion = database.prepare(`
          UPDATE questions SET conceptId = ?, status = ?, versionNumber = ?, isLatest = 1 WHERE id = ?
      `);

      database.transaction(() => {
          for (const q of questions) {
              const conceptId = `concept_${q.id}`; // Stable legacy mapping
              insertConcept.run(conceptId, q.packageId, q.system, q.subject, q.topic, q.tags, q.createdAt);
              updateVersion.run(conceptId, q.published ? 'published' : 'draft', 1, q.id);
          }
      })();
      console.log("MIGRATION: Concept mapping complete.");
  }

  // User question progress (per-user stats for each question)
  database.exec(`
    CREATE TABLE IF NOT EXISTS user_questions (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      userId TEXT NOT NULL,
      questionId TEXT NOT NULL,
      packageId TEXT,
      productId TEXT,
      status TEXT, -- NULL (in-progress), 'correct', 'incorrect', 'omitted'
      isMarked INTEGER DEFAULT 0,
      userAnswer TEXT,
      userHistory TEXT DEFAULT '[]',

      -- NEW: Usage-State Logic (Professional QBank Semantics)
      firstResponse TEXT,       -- Frozen at first attempt
      firstIsCorrect INTEGER,   -- Frozen at first attempt
      totalAttempts INTEGER DEFAULT 0,
      timeSpent INTEGER DEFAULT 0,
      lastAnswer TEXT,
      lastSeenAt TEXT,
      updatedAt TEXT,
      lastUpdated TEXT,

      UNIQUE(userId, questionId, packageId, productId)
    )
  `);

  // Migrate user_questions table
  const uqCols = database.prepare("PRAGMA table_info(user_questions)").all().map(c => c.name);
  const uqColsToAdd = [
    { name: 'packageId', type: 'TEXT' },
    { name: 'totalAttempts', type: 'INTEGER DEFAULT 0' },
    { name: 'timeSpent', type: 'INTEGER DEFAULT 0' },
    { name: 'lastAnswer', type: 'TEXT' },
    { name: 'lastSeenAt', type: 'TEXT' },
    { name: 'updatedAt', type: 'TEXT' },
    { name: 'lastUpdated', type: 'TEXT' }
  ];
  for (const col of uqColsToAdd) {
    if (!uqCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE user_questions ADD COLUMN ${col.name} ${col.type}`);
      } catch(e) {
        console.warn(`Migration: Could not add ${col.name} to user_questions:`, e.message);
      }
    }
  }

  // Ensure productId exists in user_questions
  if (!uqCols.includes('productId')) {
    try { database.exec('ALTER TABLE user_questions ADD COLUMN productId TEXT'); } catch(e) {}
  }

  // Intelligence Engine: Student Cognition Profiles
  database.exec(`
    CREATE TABLE IF NOT EXISTS student_cognition_profiles (
      userId TEXT NOT NULL,
      packageId TEXT NOT NULL,
      readinessScore REAL DEFAULT 0,
      overthinkingIndex REAL DEFAULT 0,
      impulsivityIndex REAL DEFAULT 0,
      fatigueFactor REAL DEFAULT 0,
      systemPerformance TEXT DEFAULT '{}',
      topWeaknessConcepts TEXT DEFAULT '[]',
      updatedAt TEXT,
      PRIMARY KEY (userId, packageId),
      FOREIGN KEY (userId) REFERENCES users(id)
    )
  `);

  // Intelligence Engine: Calibrated Item Intelligence
  database.exec(`
    CREATE TABLE IF NOT EXISTS calibrated_item_intelligence (
      questionId TEXT PRIMARY KEY,
      trapOption TEXT,
      confusionIndex REAL DEFAULT 0,
      misleadingSignal INTEGER DEFAULT 0,
      updatedAt TEXT,
      FOREIGN KEY (questionId) REFERENCES questions(id)
    )
  `);

  // Intelligence Engine: Calibrated Item Intelligence
  database.exec(`
    CREATE TABLE IF NOT EXISTS calibrated_item_intelligence (
      questionId TEXT PRIMARY KEY,
      trapOption TEXT,
      confusionIndex REAL DEFAULT 0,
      misleadingSignal INTEGER DEFAULT 0,
      updatedAt TEXT,
      FOREIGN KEY (questionId) REFERENCES questions(id)
    )
  `);

  // Tests table
  database.exec(`
    CREATE TABLE IF NOT EXISTS tests (
      testId TEXT PRIMARY KEY,
      testNumber INTEGER,
      userId TEXT NOT NULL,
      mode TEXT,
      pool TEXT, -- JSON of all eligible IDs at creation
      questions TEXT NOT NULL, -- JSON array of selected IDs
      answers TEXT DEFAULT '{}',
      firstAnswers TEXT DEFAULT '{}',
      markedIds TEXT DEFAULT '[]',
      currentIndex INTEGER DEFAULT 0,
      elapsedTime INTEGER DEFAULT 0,
      isSuspended INTEGER DEFAULT 0,
      packageId TEXT,
      createdAt TEXT NOT NULL,
      date TEXT NOT NULL,

      -- NEW: Exam Runtime Engine
      sessionState TEXT DEFAULT '{}', -- Full JSON state (history, strikes, logs)
      
      FOREIGN KEY (userId) REFERENCES users(id)
    )
  `);

  
  // Student Answers (Per-product isolation)
  database.exec(`
    CREATE TABLE IF NOT EXISTS student_answers (
      id TEXT PRIMARY KEY,
      studentId TEXT NOT NULL,
      testId TEXT NOT NULL,
      productId TEXT NOT NULL,
      packageId TEXT,
      questionId TEXT NOT NULL,
      answer TEXT,
      isCorrect INTEGER,
      answeredAt TEXT DEFAULT CURRENT_TIMESTAMP,
      answerData TEXT,
      submittedAt TEXT
    );
  `);

  // Migrate tests table
  const tCols = database.prepare("PRAGMA table_info(tests)").all().map(c => c.name);
  const tColsToAdd = [
    { name: 'universeSize', type: 'INTEGER' },
    { name: 'eligiblePoolSize', type: 'INTEGER' },
    { name: 'poolLogic', type: 'TEXT' },
    { name: 'sessionState', type: "TEXT DEFAULT '{}'" }
  ];
  for (const col of tColsToAdd) {
    if (!tCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE tests ADD COLUMN ${col.name} ${col.type}`);
      } catch(e) {
        console.warn(`Migration: Could not add ${col.name} to tests:`, e.message);
      }
    }
  }

  // Migrate tests table
  const testColsToAdd = [
    { name: 'packageId', type: 'TEXT' },
    { name: 'packageName', type: 'TEXT' },
    { name: 'productId', type: 'TEXT' }
  ];
  const existingTestCols = database.prepare("PRAGMA table_info(tests)").all().map(c => c.name);
  for (const col of testColsToAdd) {
    if (!existingTestCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE tests ADD COLUMN ${col.name} ${col.type}`);
      } catch (e) {}
    }
  }

  // Planner table
  database.exec(`
    CREATE TABLE IF NOT EXISTS planner (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL,
      title TEXT NOT NULL,
      description TEXT,
      dueDate TEXT,
      completed INTEGER DEFAULT 0,
      createdAt TEXT NOT NULL,
      FOREIGN KEY (userId) REFERENCES users(id)
    )
  `);

  // Archive Tables for Data Retention & Restoration
  database.exec(`
    CREATE TABLE IF NOT EXISTS user_questions_archive (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      userId TEXT NOT NULL,
      questionId TEXT NOT NULL,
      packageId TEXT,
      status TEXT,
      isMarked INTEGER,
      userAnswer TEXT,
      userHistory TEXT,
      archivedAt TEXT NOT NULL
    );

    CREATE TABLE IF NOT EXISTS tests_archive (
      testId TEXT PRIMARY KEY,
      testNumber INTEGER,
      userId TEXT NOT NULL,
      mode TEXT,
      pool TEXT,
      questions TEXT NOT NULL,
      answers TEXT,
      firstAnswers TEXT,
      markedIds TEXT,
      currentIndex INTEGER,
      elapsedTime INTEGER,
      isSuspended INTEGER,
      packageId TEXT,
      createdAt TEXT NOT NULL,
      date TEXT NOT NULL,
      archivedAt TEXT NOT NULL
    );
  `);

  // Migrate user_questions_archive
  const uqaCols = database.prepare("PRAGMA table_info(user_questions_archive)").all().map(c => c.name);
  if (!uqaCols.includes('packageId')) {
      try {
          database.exec(`ALTER TABLE user_questions_archive ADD COLUMN packageId TEXT`);
      } catch(e) {}
  }

  // Migrate tests_archive table
  const existingArchiveCols = database.prepare("PRAGMA table_info(tests_archive)").all().map(c => c.name);
  const archiveColsToAdd = [{ name: 'packageId', type: 'TEXT' }, { name: 'packageName', type: 'TEXT' }];
  for (const col of archiveColsToAdd) {
    if (!existingArchiveCols.includes(col.name)) {
        try {
            database.exec(`ALTER TABLE tests_archive ADD COLUMN ${col.name} ${col.type}`);
        } catch (e) {}
    }
  }

  // Products table (The central offering)
  database.exec(`
    CREATE TABLE IF NOT EXISTS products (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      slug TEXT UNIQUE,
      name TEXT NOT NULL,
      description TEXT,
      price REAL DEFAULT 0,
      isActive INTEGER DEFAULT 1,
      is_published INTEGER DEFAULT 1,
      isDeleted INTEGER DEFAULT 0,
      createdAt TEXT NOT NULL,
      updatedAt TEXT,
      deletedAt TEXT,
      duration_days INTEGER DEFAULT 0,
      templateType TEXT DEFAULT 'DEFAULT',
      defaultCreateTestConfig TEXT DEFAULT '{}',
      systems TEXT DEFAULT '[]',
      subjects TEXT DEFAULT '[]',
      plans TEXT DEFAULT '[]'
    )
  `);

  // Migrate products table for existing databases
  const prodCols = database.prepare("PRAGMA table_info(products)").all().map(c => c.name);
  const prodColsToAdd = [
    { name: 'is_published', type: 'INTEGER DEFAULT 1' },
    { name: 'isDeleted', type: 'INTEGER DEFAULT 0' },
    { name: 'deletedAt', type: 'TEXT' },
    { name: 'templateType', type: "TEXT DEFAULT 'DEFAULT'" },
    { name: 'defaultCreateTestConfig', type: "TEXT DEFAULT '{}'" }
  ];
  for (const col of prodColsToAdd) {
    if (!prodCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE products ADD COLUMN ${col.name} ${col.type}`);
      } catch (e) { }
    }
  }

  // Subscription Packages table - Multi-plan support
  database.exec(`
    CREATE TABLE IF NOT EXISTS subscription_packages (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      name TEXT NOT NULL,
      duration_days INTEGER NOT NULL,
      price REAL NOT NULL,
      description TEXT,
      systems TEXT DEFAULT '[]',
      subjects TEXT DEFAULT '[]',
      plans TEXT DEFAULT '[]',
      defaultCreateTestConfig TEXT,
      is_published INTEGER DEFAULT 1,
      createdAt TEXT NOT NULL
    )
  `);

  // Migrate subscription_packages for custom systems/subjects/plans
  const packageColsToAdd = [
    { name: 'systems', type: "TEXT DEFAULT '[]'" },
    { name: 'subjects', type: "TEXT DEFAULT '[]'" },
    { name: 'plans', type: "TEXT DEFAULT '[]'" },
    { name: 'defaultCreateTestConfig', type: 'TEXT' }
  ];
  const existingPkgCols = database.prepare("PRAGMA table_info(subscription_packages)").all().map(c => c.name);
  for (const col of packageColsToAdd) {
    if (!existingPkgCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE subscription_packages ADD COLUMN ${col.name} ${col.type}`);
        console.log(`Added column ${col.name} to subscription_packages table`);
      } catch (err) {
        console.warn(`Could not add column ${col.name} to subscription_packages:`, err.message);
      }
    }
  }


  // Notifications table
  database.exec(`
    CREATE TABLE IF NOT EXISTS notifications (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      type TEXT NOT NULL, -- 'registration', 'purchase', 'alert'
      message TEXT NOT NULL,
      userId TEXT,
      metadata TEXT,
      isRead INTEGER DEFAULT 0,
      createdAt TEXT NOT NULL
    )
  `);

  // NEW: Governance History Table
  database.exec(`
    CREATE TABLE IF NOT EXISTS governance_history (
      id INTEGER PRIMARY KEY AUTOINCREMENT,
      versionId TEXT NOT NULL,
      conceptId TEXT NOT NULL,
      fromState TEXT,
      toState TEXT NOT NULL,
      performedBy TEXT NOT NULL,
      performedAt TEXT NOT NULL,
      notes TEXT,
      FOREIGN KEY (versionId) REFERENCES questions(id),
      FOREIGN KEY (conceptId) REFERENCES question_concepts(id)
    )
  `);

 
  // --- START: Standardized Subscription Registry (Multi-subscription support) ---

  // Migration: Rename old table if exists
  const tableCheck = database
    .prepare("SELECT name FROM sqlite_master WHERE type='table' AND name='user_subscriptions'")
    .get();

  if (tableCheck) {
    try {
      database.exec(`ALTER TABLE user_subscriptions RENAME TO subscriptions;`);
      console.log('Renamed user_subscriptions to subscriptions');

      // Rename purchaseDate if needed
      const subCols = database.prepare("PRAGMA table_info(subscriptions)").all().map(c => c.name);
      if (subCols.includes('createdAt') && !subCols.includes('purchaseDate')) {
        database.exec(`ALTER TABLE subscriptions RENAME COLUMN createdAt TO purchaseDate;`);
        console.log('Renamed subscriptions.createdAt to purchaseDate');
      }
    } catch (e) {
      console.warn('Migration warning:', e.message);
    }
  }

  // Ensure subscriptions table exists
  database.exec(`
    CREATE TABLE IF NOT EXISTS subscriptions (
      id TEXT PRIMARY KEY,
      userId TEXT NOT NULL,
      packageId TEXT,
      productName TEXT,
      durationDays INTEGER NOT NULL,
      amount REAL DEFAULT 0,
      startDate TEXT,
      expiresAt TEXT,
      status TEXT DEFAULT 'pending'
    );
  `);

  // Add packageId column if it doesn't exist
  const columnExists = database
    .prepare("PRAGMA table_info(subscriptions);")
    .all()
    .some(col => col.name === "packageId");

  if (!columnExists) {
    database.exec(`ALTER TABLE subscriptions ADD COLUMN packageId TEXT;`);
    console.log("Column packageId added to subscriptions table.");
  } else {
    console.log("Column packageId already exists.");
  }

  // Optional: check type of packageId for safety
  const subInfo = database.prepare("PRAGMA table_info(subscriptions)").all();
  const pkgIdCol = subInfo.find(c => c.name === 'packageId');
  if (pkgIdCol && pkgIdCol.type.toUpperCase() === 'INTEGER') {
    console.warn('Subscriptions.packageId is INTEGER, treating as TEXT in code.');
  }

  // --- END: Subscription Registry ---

  // Add isDeleted column for soft delete functionality
  const productColsToAdd = [
    { name: 'isDeleted', type: 'INTEGER DEFAULT 0' },
    { name: 'deletedAt', type: 'TEXT' },
    { name: 'templateType', type: "TEXT DEFAULT 'DEFAULT'" }
  ];
  const existingProductCols = database.prepare("PRAGMA table_info(products)").all().map(c => c.name);
  for (const col of productColsToAdd) {
    if (!existingProductCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE products ADD COLUMN ${col.name} ${col.type}`);
        console.log(`Added column ${col.name} to products table`);
      } catch (err) {
        console.warn(`Could not add column ${col.name} to products:`, err.message);
      }
    }
  }

  // Indexes for Performance and Governance
  database.exec(`
    CREATE INDEX IF NOT EXISTS idx_questions_conceptId ON questions(conceptId);
    CREATE INDEX IF NOT EXISTS idx_questions_status ON questions(status);
    CREATE INDEX IF NOT EXISTS idx_questions_packageId ON questions(packageId);
    CREATE INDEX IF NOT EXISTS idx_questions_productId ON questions(productId);
    CREATE INDEX IF NOT EXISTS idx_governance_history_versionId ON governance_history(versionId);
    CREATE INDEX IF NOT EXISTS idx_subscriptions_userId ON subscriptions(userId);
    CREATE INDEX IF NOT EXISTS idx_subscriptions_packageId ON subscriptions(packageId);
    CREATE INDEX IF NOT EXISTS idx_subscriptions_productId ON subscriptions(productId);
    CREATE INDEX IF NOT EXISTS idx_tests_productId ON tests(productId);
    CREATE INDEX IF NOT EXISTS idx_tests_packageId ON tests(packageId);
    CREATE INDEX IF NOT EXISTS idx_student_answers_productId ON student_answers(productId);
  `);

  // NEW: Test Attempts (Per-session results snapshot)
  database.exec(`
    CREATE TABLE IF NOT EXISTS test_attempts (
      id TEXT PRIMARY KEY,
      productId TEXT NOT NULL,
      userId TEXT NOT NULL,
      testId TEXT, -- Link to original test session
      startedAt TEXT NOT NULL,
      finishedAt TEXT,
      FOREIGN KEY (userId) REFERENCES users(id)
    )
  `);

  // Migrate test_attempts snapshot columns
  const taCols = database.prepare("PRAGMA table_info(test_attempts)").all().map(c => c.name);
  const taColsToAdd = [
    { name: 'questionIds', type: 'TEXT' },
    { name: 'markedIds', type: 'TEXT' },
    { name: 'timeSpent', type: 'TEXT' },
    { name: 'elapsedTime', type: 'INTEGER DEFAULT 0' },
    { name: 'questionSnapshots', type: 'TEXT' }
  ];
  for (const col of taColsToAdd) {
    if (!taCols.includes(col.name)) {
      try {
        database.exec(`ALTER TABLE test_attempts ADD COLUMN ${col.name} ${col.type}`);
      } catch (e) {
        console.warn(`Migration: Could not add ${col.name} to test_attempts:`, e.message);
      }
    }
  }

  // NEW: Test Answers (Detailed question-level breakdown for an attempt)
  database.exec(`
    CREATE TABLE IF NOT EXISTS test_answers (
      testAttemptId TEXT NOT NULL,
      questionId TEXT NOT NULL,
      selectedOption TEXT,
      isCorrect INTEGER,
      isFlagged INTEGER,
      FOREIGN KEY (testAttemptId) REFERENCES test_attempts(id)
    )
  `);

  // Migrate test_answers for timeSpent tracking
  const ansCols = database.prepare("PRAGMA table_info(test_answers)").all().map(c => c.name);
  if (!ansCols.includes('correctOption')) {
    try {
      database.exec('ALTER TABLE test_answers ADD COLUMN correctOption TEXT');
    } catch (e) {
      console.warn('Migration: Could not add correctOption to test_answers:', e.message);
    }
  }
  if (!ansCols.includes('timeSpentSec')) {
    try {
      database.exec('ALTER TABLE test_answers ADD COLUMN timeSpentSec INTEGER DEFAULT 0');
    } catch (e) {
      console.warn('Migration: Could not add timeSpentSec to test_answers:', e.message);
    }
  }

  database.exec(`
    CREATE INDEX IF NOT EXISTS idx_test_answers_attemptId ON test_answers(testAttemptId);
  `);

  // Unique constraint to prevent duplicate active subscriptions
  // Removed UNIQUE index to allow subscription extension logic
  try {
    database.exec(`DROP INDEX IF EXISTS idx_unique_active_subscription`);
  } catch (e) {}

  // View for product-isolated student answers (joins with tests for consistency)
  database.exec(`
    CREATE VIEW IF NOT EXISTS student_answers_per_product AS
    SELECT sa.*, t.packageName, t.mode, t.date as testDate
    FROM student_answers sa
    JOIN tests t ON sa.testId = t.testId;
  `);

  console.log('Database schema initialized');
}

export function createUser(user) {
  const db = getDb();
  const stmt = db.prepare(`
    INSERT INTO users (id, name, email, passwordHash, role, subscriptionStatus, createdAt, stats, pendingDuration, subscriptionDuration, productName)
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `);
  stmt.run(
    user.id,
    user.name,
    user.email,
    user.passwordHash,
    user.role || 'student',
    user.subscriptionStatus || 'trial',
    user.createdAt || new Date().toISOString(),
    JSON.stringify(user.stats || { attempted: 0, correct: 0, tests: 0 }),
    user.pendingDuration || 0,
    user.subscriptionDuration || 0,
    user.productName || null
  );
  return user;
}

export function getUserByEmail(email) {
  const db = getDb();
  const stmt = db.prepare('SELECT * FROM users WHERE LOWER(email) = LOWER(?)');
  const user = stmt.get(email);
  if (user) {
    user.stats = JSON.parse(user.stats || '{}');
    user.purchased = !!user.purchased;
    user.activatedByPurchase = !!user.activatedByPurchase;
    user.hasPendingPurchase = !!user.hasPendingPurchase;
    user.trialUsed = !!user.trialUsed;
    user.isBanned = !!user.isBanned;
  }
  return user;
}

export function getUserById(id) {
  const db = getDb();
  const stmt = db.prepare('SELECT * FROM users WHERE id = ?');
  const user = stmt.get(id);
  if (user) {
    user.stats = JSON.parse(user.stats || '{}');
    user.purchased = !!user.purchased;
    user.activatedByPurchase = !!user.activatedByPurchase;
    user.hasPendingPurchase = !!user.hasPendingPurchase;
    user.trialUsed = !!user.trialUsed;
    user.isBanned = !!user.isBanned;
  }
  return user;
}

export function getAllUsers() {
  const db = getDb();
  const stmt = db.prepare('SELECT * FROM users');
  return stmt.all().map(user => {
    user.stats = JSON.parse(user.stats || '{}');
    user.purchased = !!user.purchased;
    user.activatedByPurchase = !!user.activatedByPurchase;
    user.hasPendingPurchase = !!user.hasPendingPurchase;
    user.trialUsed = !!user.trialUsed;
    user.isBanned = !!user.isBanned;
    return user;
  });
}

export function updateUser(user) {
  const db = getDb();
  console.log('DB: Updating user record for ID:', user.id);
  
  if (!user.id) {
    throw new Error('Database error: User ID is required for update');
  }

  // Handle stats stringification defensively
  let statsString = '{}';
  if (user.stats) {
    if (typeof user.stats === 'string') {
      statsString = user.stats; // Already a string
    } else {
      statsString = JSON.stringify(user.stats);
    }
  }

  const stmt = db.prepare(`
    UPDATE users SET
      name = ?, email = ?, passwordHash = ?, role = ?,
      subscriptionStatus = ?, purchased = ?, activatedByPurchase = ?,
      hasPendingPurchase = ?, trialUsed = ?, activatedAt = ?,
      expiresAt = ?, lastRenewedAt = ?, updatedAt = ?, isBanned = ?, stats = ?,
      pendingDuration = ?, subscriptionDuration = ?, productName = ?
    WHERE id = ?
  `);

  const params = [
    user.name || '',
    user.email || '',
    user.passwordHash || '',
    user.role || 'student',
    user.subscriptionStatus || 'trial',
    user.purchased ? 1 : 0,
    user.activatedByPurchase ? 1 : 0,
    user.hasPendingPurchase ? 1 : 0,
    user.trialUsed ? 1 : 0,
    user.activatedAt || null,
    user.expiresAt || null,
    user.lastRenewedAt || null,
    new Date().toISOString(),
    user.isBanned ? 1 : 0,
    statsString,
    user.pendingDuration || 0,
    user.subscriptionDuration || 0,
    user.productName || null,
    user.id
  ];

  console.log('DB: Executing UPDATE with', params.length, 'parameters');
  const result = stmt.run(...params);
  
  if (result.changes === 0) {
    console.warn('DB: Update completed but 0 rows were affected for ID:', user.id);
  }

  return user;
}

export function deleteUser(id) {
  try {
    const db = getDb();

    // Check if user exists
    const user = db.prepare('SELECT * FROM users WHERE id = ?').get(id);
    if (!user) {
      throw new Error('User not found');
    }

    // Start transaction to ensure atomic deletion of related data
    const deleteTx = db.transaction((userId) => {
      // 1. Cleanup related data (tests, student_answers, subscriptions, etc.)
      // These must be deleted BEFORE the user to avoid foreign key violations
      db.prepare('DELETE FROM subscriptions WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM user_questions WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM notifications WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM student_cognition_profiles WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM planner WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM user_questions_archive WHERE userId = ?').run(userId);
      db.prepare('DELETE FROM tests_archive WHERE userId = ?').run(userId);

      // Handle tests and student_answers carefully
      const testIds = db.prepare('SELECT testId FROM tests WHERE userId = ?').all(userId).map(t => t.testId);
      if (testIds.length > 0) {
        const placeholders = testIds.map(() => '?').join(',');
        db.prepare(`DELETE FROM student_answers WHERE testId IN (${placeholders})`).run(...testIds);
        db.prepare('DELETE FROM tests WHERE userId = ?').run(userId);
      }

      // Handle test_attempts and related answer tables
      const attemptIds = db.prepare('SELECT id FROM test_attempts WHERE userId = ?').all(userId).map(a => a.id);
      if (attemptIds.length > 0) {
        const placeholders = attemptIds.map(() => '?').join(',');
        db.prepare(`DELETE FROM test_answers WHERE testAttemptId IN (${placeholders})`).run(...attemptIds);
        // Also check for legacy or alternate attempt answer tables
        try {
          db.prepare(`DELETE FROM test_attempt_answers WHERE attempt_id IN (${placeholders})`).run(...attemptIds);
        } catch (e) { }
        db.prepare('DELETE FROM test_attempts WHERE userId = ?').run(userId);
      }

      // 2. FINALLY: Delete user record once all dependencies are cleared
      db.prepare('DELETE FROM users WHERE id = ?').run(userId);
    });

    deleteTx(id);
    console.log(`User ${id} ("${user.name}") PERMANENTLY purged from registry`);
    return true;
  } catch (err) {
    console.error(`DB: Failed to permanently delete user ${id}:`, err.message);
    throw err;
  }
}

// User Subscription Operations
export function createUserSubscription({ userId, packageId, productId, durationDays, amount = 0, status = 'pending' }) {
    const db = getDb();
    
    // Standardize IDs as Strings
    const uidStr = String(userId);
    const pidStr = String(packageId || productId);
    
    console.log(`[Subscription Registry] Processing sub for user ${uidStr}, product ${pidStr}`);

    // Check if product is deleted (prevent new subscriptions)
    const product = db.prepare('SELECT isDeleted FROM products WHERE id = ?').get(pidStr);
    if (product && product.isDeleted) {
        throw new Error('Cannot create subscription for deleted product');
    }

    // Goal 1: Prevent duplicate subscriptions; extend existing if same userId + packageId
    const existing = db.prepare(`
        SELECT * FROM subscriptions 
        WHERE userId = ? AND packageId = ? AND status = 'active'
        ORDER BY expiresAt DESC LIMIT 1
    `).get(uidStr, pidStr);

    if (existing) {
        // Check if the product is deleted before allowing renewal
        const existingProduct = db.prepare('SELECT isDeleted FROM products WHERE id = ?').get(pidStr);
        if (existingProduct && existingProduct.isDeleted) {
            throw new Error('Cannot renew subscription for deleted product');
        }
        
        console.log(`[Subscription Registry] Found existing active sub ${existing.id}. Extending by ${durationDays} days.`);
        const currentExpiry = new Date(existing.expiresAt);
        const newExpiry = new Date(currentExpiry.getTime() + (Number(durationDays) * 24 * 60 * 60 * 1000));
        
        db.prepare('UPDATE subscriptions SET expiresAt = ?, durationDays = durationDays + ?, amount = amount + ? WHERE id = ?')
          .run(newExpiry.toISOString(), Number(durationDays), Number(amount), existing.id);
          
        return { ...existing, expiresAt: newExpiry.toISOString(), extended: true };
    }

    const id = crypto.randomUUID();
    const now = new Date();
    const purchaseDate = now.toISOString();

    let expiresAt = null;
    if (status === 'active') {
        expiresAt = new Date(now.getTime() + (Number(durationDays) * 24 * 60 * 60 * 1000)).toISOString();
    }

    console.log(`[Subscription Registry] Inserting new sub ${id} (Status: ${status})`);
    db.prepare(`
        INSERT INTO subscriptions (id, userId, packageId, productId, status, expiresAt, purchaseDate, amount, durationDays)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(id, uidStr, pidStr, pidStr, status, expiresAt, purchaseDate, amount, durationDays);

    return { id, userId: uidStr, packageId: pidStr, productId: pidStr, durationDays, amount, status, expiresAt, purchaseDate };
}

export function getUserSubscriptions(userId) {
    const db = getDb();
    const uidStr = String(userId);
    // Get only latest subscription per product, including deleted products for existing users
    console.log(`[Subscription Registry] Fetching subs for user ${uidStr}`);
    return db.prepare(`
        SELECT s.*, pr.name as productName, pr.isDeleted as productDeleted
        FROM subscriptions s
        LEFT JOIN products pr ON s.packageId = CAST(pr.id AS TEXT) OR s.productId = CAST(pr.id AS TEXT)
        WHERE s.userId = ? 
        AND s.id IN (
            SELECT MAX(id) 
            FROM subscriptions 
            WHERE userId = ? 
            GROUP BY packageId
        )
        ORDER BY s.purchaseDate DESC
    `).all(uidStr, uidStr);
}

export function getActiveSubscriptionByUserAndProduct(userId, packageId) {
    const db = getDb();
    const pidStr = String(packageId);
    const uidStr = String(userId);
    return db.prepare(`
        SELECT * FROM subscriptions 
        WHERE userId = ? 
        AND (packageId = ? OR productId = ?)
        AND status = 'active'
        ORDER BY expiresAt DESC
        LIMIT 1
    `).get(uidStr, pidStr, pidStr);
}

export function activateSubscription(subscriptionId) {
    const db = getDb();
    const sub = db.prepare('SELECT * FROM subscriptions WHERE id = ?').get(subscriptionId);
    if (!sub) throw new Error('Subscription not found');

    const now = new Date();
    const startDate = now.toISOString();
    const expiresAt = new Date(now.getTime() + (sub.durationDays * 24 * 60 * 60 * 1000)).toISOString();

    db.prepare(`
        UPDATE subscriptions SET
            status = 'active',
            expiresAt = ?
        WHERE id = ?
    `).run(expiresAt, subscriptionId);

    // Backward Compatibility: Update the users table
    const uidStr = String(sub.userId);
    const pidStr = String(sub.packageId);
    
    const user = db.prepare('SELECT purchasedProducts FROM users WHERE id = ?').get(uidStr);
    let ids = [];
    try {
        ids = JSON.parse(user?.purchasedProducts || '[]');
        if (!Array.isArray(ids)) ids = [];
    } catch(e) { ids = []; }

    if (!ids.includes(pidStr)) {
        ids.push(pidStr);
        db.prepare("UPDATE users SET purchasedProducts = ?, purchased = 1, activatedByPurchase = 1 WHERE id = ?")
          .run(JSON.stringify(ids), uidStr);
    }

    return { ...sub, status: 'active', startDate, expiresAt };
}

export function extendSubscription(subscriptionId, additionalDays) {
    const db = getDb();
    const sub = db.prepare('SELECT * FROM subscriptions WHERE id = ?').get(subscriptionId);
    if (!sub) throw new Error('Subscription not found');

    const now = new Date();
    let newExpiresAt;
    
    // If current subscription is still active, extend from current expiry
    // If expired, extend from now
    if (sub.expiresAt && new Date(sub.expiresAt) > now) {
        newExpiresAt = new Date(new Date(sub.expiresAt).getTime() + (Number(additionalDays) * 24 * 60 * 60 * 1000));
    } else {
        newExpiresAt = new Date(now.getTime() + (Number(additionalDays) * 24 * 60 * 60 * 1000));
    }

    db.prepare(`
        UPDATE subscriptions SET
            status = 'active',
            expiresAt = ?
        WHERE id = ?
    `).run(newExpiresAt.toISOString(), subscriptionId);

    return { ...sub, status: 'active', expiresAt: newExpiresAt.toISOString() };
}


// User Question Progress
export function getUserQuestions(userId, productId) {
  const db = getDb();
  
  if (!productId || productId === 'null' || productId === 'undefined') {
    console.warn('getUserQuestions called without valid productId');
    return [];
  }

  try {
    const pidStr = productId.toString();
    const pidInt = parseInt(productId);

    // Attempt is the single source of truth: derive status from latest FINISHED attempt only
    const latestPerQuestion = db.prepare(`
      SELECT questionId, selectedOption, isCorrect, isFlagged
      FROM (
        SELECT 
          a.questionId as questionId,
          a.selectedOption as selectedOption,
          a.isCorrect as isCorrect,
          a.isFlagged as isFlagged,
          ta.finishedAt as finishedAt,
          ROW_NUMBER() OVER (PARTITION BY a.questionId ORDER BY ta.finishedAt DESC) as rn
        FROM test_attempts ta
        JOIN test_answers a ON a.testAttemptId = ta.id
        WHERE ta.userId = ? AND ta.productId = ? AND ta.finishedAt IS NOT NULL
      )
      WHERE rn = 1
    `).all(String(userId), pidStr);

    const latestMap = new Map(latestPerQuestion.map(r => [String(r.questionId), r]));

    // Product-specific question pool: Strictly published and latest only for students
    const allQuestions = db.prepare(`
      SELECT * FROM questions 
      WHERE status = 'published' 
      AND isLatest = 1 
      AND (productId = ? OR packageId = ?)
    `).all(pidStr, pidStr);

    return allQuestions.map(q => {
      const latest = latestMap.get(String(q.id));

      // UNUSED = never appeared in any finished attempt
      let computedStatus = 'unused';
      let userAnswer = null;
      let isMarked = false;

      if (latest) {
        userAnswer = latest.selectedOption ?? null;
        isMarked = !!latest.isFlagged;

        // Correct/Incorrect/Omitted are computed per attempt snapshot
        if (userAnswer === null || userAnswer === undefined || userAnswer === '') {
          // Only mark as omitted if the question was previously unused
          const existingUserQuestion = db.prepare(
            'SELECT status FROM user_questions WHERE userId = ? AND questionId = ? AND (productId = ? OR packageId = ?)'
          ).get(String(userId), String(q.id), String(productId), String(productId));
          
          if (existingUserQuestion && existingUserQuestion.status === 'unused') {
            computedStatus = 'omitted';
          } else if (existingUserQuestion) {
            // Keep the previous status (correct/incorrect) for questions from those pools
            computedStatus = existingUserQuestion.status;
          } else {
            // New question, mark as omitted
            computedStatus = 'omitted';
          }
        } else {
          computedStatus = Number(latest.isCorrect) === 1 ? 'correct' : 'incorrect';
        }
      }

      return {
        ...q,
        choices: JSON.parse(q.choices || '[]'),
        status: computedStatus,
        isMarked,
        userAnswer,
        userHistory: [],
        lifecycleStatus: q.status
      };
    });
  } catch (err) {
    console.error('getUserQuestions error:', err);
    return [];
  }
}

/**
 * NEW: Initialize questions as "used" during test creation
 */
export function initializeUserQuestions(userId, packageId, questionIds) {
  const db = getDb();
  const uidStr = String(userId);
  const pidStr = String(packageId);
  const now = new Date().toISOString();
  
  console.log(`[Content Engine] Initializing ${questionIds.length} questions for user ${uidStr} in product ${pidStr}`);

  const stmt = db.prepare(`
    INSERT OR IGNORE INTO user_questions (userId, questionId, packageId, productId, status, totalAttempts, updatedAt)
    VALUES (?, ?, ?, ?, NULL, 0, ?)
  `);

  const transaction = db.transaction((ids) => {
    for (const qid of ids) {
      stmt.run(uidStr, String(qid), pidStr, pidStr, now);
    }
  });

  transaction(questionIds);
  return true;
}

export function updateUserQuestion({ 
  userId, 
  questionId, 
  productId, 
  selectedAnswer = null, 
  newStatus = null, 
  toggleFlag = false, 
  timeSpent = 0 
}) {
  const db = getDb();
  const uidStr = String(userId);
  const qidStr = String(questionId);
  const pidStr = String(productId);
  
  if (!productId) {
    throw new Error('Database Error: productId (packageId) is required for updating user question progress.');
  }

  const now = new Date().toISOString();
  const timeSpentDelta = Number.isFinite(timeSpent) ? timeSpent : (Number(timeSpent) || 0);

  console.log(`[Content Engine] Updating progress for user ${uidStr}, question ${qidStr}, product ${pidStr}`);

  const existing = db.prepare(
    'SELECT status, isMarked FROM user_questions WHERE userId = ? AND questionId = ? AND (productId = ? OR packageId = ?)'
  ).get(uidStr, qidStr, pidStr, pidStr);

  if (!existing) {
    console.log(`[Content Engine] Progress record missing. Creating record.`);
    db.prepare(`
      INSERT INTO user_questions (
        userId, questionId, productId, packageId, status, isMarked, userAnswer, 
        totalAttempts, timeSpent, lastAnswer, lastSeenAt, updatedAt, lastUpdated
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
      uidStr, qidStr, pidStr, pidStr,
      newStatus, toggleFlag ? 1 : 0, selectedAnswer,
      newStatus ? 1 : 0, timeSpentDelta, selectedAnswer, now, now, now
    );
    return true;
  }

  const finalMarked = toggleFlag ? (existing.isMarked ? 0 : 1) : existing.isMarked;
  
  // Only allow status to become 'omitted' if it was previously 'unused'
  let finalStatus = newStatus;
  if (newStatus === 'omitted' && existing.status && existing.status !== 'unused') {
    // Keep the original status (correct/incorrect) if not unused
    finalStatus = existing.status;
  }
  
  db.prepare(`
    UPDATE user_questions SET
      status = COALESCE(?, status),
      isMarked = ?,
      userAnswer = COALESCE(?, userAnswer),
      lastAnswer = ?,
      totalAttempts = totalAttempts + ?,
      timeSpent = timeSpent + ?,
      lastSeenAt = ?,
      updatedAt = ?,
      lastUpdated = ?
    WHERE userId = ? AND questionId = ? AND (productId = ? OR packageId = ?)
  `).run(
    finalStatus, 
    finalMarked, 
    selectedAnswer,
    selectedAnswer,
    newStatus ? 1 : 0, 
    timeSpentDelta, 
    now, now, now,
    uidStr, qidStr, pidStr, pidStr
  );

  return true;
}

export function getEligiblePool(userId, packageId, filters = {}, limit = null) {
  const db = getDb();
  const uidStr = String(userId);
  const pidStr = String(packageId);

  console.log(`[Content Engine] Calculating eligible pool for user ${uidStr} in product ${pidStr}`);
  
  let query = `
    WITH latest AS (
      SELECT questionId, selectedOption, isCorrect, isFlagged
      FROM (
        SELECT 
          a.questionId as questionId,
          a.selectedOption as selectedOption,
          a.isCorrect as isCorrect,
          a.isFlagged as isFlagged,
          ta.finishedAt as finishedAt,
          ROW_NUMBER() OVER (PARTITION BY a.questionId ORDER BY ta.finishedAt DESC) as rn
        FROM test_attempts ta
        JOIN test_answers a ON a.testAttemptId = ta.id
        WHERE ta.userId = ? AND ta.productId = ? AND ta.finishedAt IS NOT NULL
      )
      WHERE rn = 1
    )
    SELECT q.id
    FROM questions q
    LEFT JOIN latest l ON l.questionId = q.id
    WHERE (q.packageId = ? OR q.productId = ?)
      AND q.status = 'published'
      AND q.isLatest = 1
  `;

  const params = [uidStr, pidStr, pidStr, pidStr];

  if (filters.systems && filters.systems.length > 0) {
    query += ` AND q.system IN (${filters.systems.map(() => '?').join(',')})`;
    params.push(...filters.systems);
  }

  if (filters.subjects && filters.subjects.length > 0) {
    query += ` AND q.subject IN (${filters.subjects.map(() => '?').join(',')})`;
    params.push(...filters.subjects);
  }

  if (filters.usageState === 'unused') {
    query += ` AND l.questionId IS NULL`;
  } else if (filters.usageState === 'incorrect') {
    query += ` AND l.selectedOption IS NOT NULL AND l.selectedOption != '' AND l.isCorrect = 0`;
  } else if (filters.usageState === 'correct') {
    query += ` AND l.selectedOption IS NOT NULL AND l.selectedOption != '' AND l.isCorrect = 1`;
  } else if (filters.usageState === 'omitted') {
    query += ` AND l.questionId IS NOT NULL AND (l.selectedOption IS NULL OR l.selectedOption = '')`;
  } else if (filters.usageState === 'marked') {
    query += ` AND l.isFlagged = 1`;
  }

  if (limit) {
    query += ` ORDER BY RANDOM() LIMIT ?`;
    params.push(limit);
  }

  const results = db.prepare(query).all(...params);
  console.log(`[Content Engine] Pool size calculated: ${results.length} questions`);
  return results.map(r => String(r.id));
}

export function getUniverseSize(packageId) {
  const db = getDb();
  const pidStr = String(packageId);
  const res = db.prepare(
    `
    SELECT COUNT(*) as count
    FROM questions
    WHERE (packageId = ? OR productId = ?) AND status = 'published' AND isLatest = 1
    `
  ).get(pidStr, pidStr);
  return res ? res.count : 0;
}

export function resetUserQuestions(userId) {
  const db = getDb();
  const now = new Date().toISOString();
  
  const transaction = db.transaction(() => {
    // Archive existing data
    db.prepare(`
      INSERT INTO user_questions_archive 
      (userId, questionId, status, isMarked, userAnswer, userHistory, archivedAt)
      SELECT userId, questionId, status, isMarked, userAnswer, userHistory, ?
      FROM user_questions WHERE userId = ?
    `).run(now, userId);

    // Delete current data
    db.prepare('DELETE FROM user_questions WHERE userId = ?').run(userId);

    // Cleanup: Remove archives older than 30 days
    const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
    db.prepare('DELETE FROM user_questions_archive WHERE archivedAt < ?').run(thirtyDaysAgo);
  });

  transaction();
  return true;
}

export function restoreUserQuestions(userId) {
  const db = getDb();
  
  // Find the most recent archive timestamp for this user
  const latest = db.prepare('SELECT MAX(archivedAt) as lastArchived FROM user_questions_archive WHERE userId = ?').get(userId);
  
  if (!latest.lastArchived) return false;

  const transaction = db.transaction(() => {
    // Restore from archive (Upserting to overwrite any current progress if conflicts)
    // Note: We need to handle potential conflicts if user started new progress. 
    // Requirement implies "Restoration", assume overwriting empty state usually.
    
    // We select items from the LATEST archive batch.
    const records = db.prepare('SELECT * FROM user_questions_archive WHERE userId = ? AND archivedAt = ?').all(userId, latest.lastArchived);
    
    const insertStmt = db.prepare(`
      INSERT OR REPLACE INTO user_questions (userId, questionId, status, isMarked, userAnswer, userHistory)
      VALUES (?, ?, ?, ?, ?, ?)
    `);

    for (const rec of records) {
      insertStmt.run(rec.userId, rec.questionId, rec.status, rec.isMarked, rec.userAnswer, rec.userHistory);
    }
  });

  transaction();
  return true;
}

// Test CRUD operations
export function saveTest(test) {
  const db = getDb();
  const uidStr = String(test.userId);
  const tidStr = String(test.testId);
  const pidStr = String(test.productId || test.packageId);
  
  if (!pidStr || pidStr === 'null') {
    throw new Error('Database Error: productId (packageId) is required for saving or updating a test.');
  }

  console.log(`[Exam Runtime] Saving test ${tidStr} for user ${uidStr} in product ${pidStr}`);

  const existing = db.prepare('SELECT * FROM tests WHERE testId = ? AND userId = ?').get(tidStr, uidStr);
  
  if (existing) {
    db.prepare(`
      UPDATE tests SET
        questions = ?, answers = ?, firstAnswers = ?, markedIds = ?,
        currentIndex = ?, elapsedTime = ?, isSuspended = ?, date = ?, 
        packageId = ?, packageName = ?, productId = ?,
        universeSize = ?, eligiblePoolSize = ?, poolLogic = ?,
        sessionState = ?
      WHERE testId = ? AND userId = ?
    `).run(
      JSON.stringify(test.questions),
      JSON.stringify(test.answers || {}),
      JSON.stringify(test.firstAnswers || {}),
      JSON.stringify(test.markedIds || []),
      test.currentIndex || 0,
      test.elapsedTime || 0,
      test.isSuspended ? 1 : 0,
      test.date || new Date().toISOString(),
      pidStr,
      test.packageName || null,
      pidStr, 
      test.universeSize || existing.universeSize,
      test.eligiblePoolSize || existing.eligiblePoolSize,
      JSON.stringify(test.poolLogic || {}),
      JSON.stringify(test.sessionState || {}),
      tidStr,
      uidStr
    );
  } else {
    db.prepare(`
      INSERT INTO tests (
        testId, testNumber, userId, mode, pool, questions, answers, firstAnswers, 
        markedIds, currentIndex, elapsedTime, isSuspended, createdAt, date, 
        packageId, packageName, productId, universeSize, eligiblePoolSize, poolLogic, sessionState
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
      tidStr,
      test.testNumber || 1,
      uidStr,
      test.mode || 'tutor',
      JSON.stringify(test.pool || []),
      JSON.stringify(test.questions),
      JSON.stringify(test.answers || {}),
      JSON.stringify(test.firstAnswers || {}),
      JSON.stringify(test.markedIds || []),
      test.currentIndex || 0,
      test.elapsedTime || 0,
      test.isSuspended ? 1 : 0,
      new Date().toISOString(),
      test.date || new Date().toISOString(),
      pidStr,
      test.packageName || null,
      pidStr,
      test.universeSize || 0,
      test.eligiblePoolSize || 0,
      JSON.stringify(test.poolLogic || {}),
      JSON.stringify(test.sessionState || {})
    );
  }

  // Refactor: Per-attempt result lockdown
  // In the new architecture, we pre-create AttemptAnswer rows for all selected questions.
  const isSuspendedFlag = (test.isSuspended === true || test.isSuspended === 1 || test.isSuspended === '1');
  if (!isSuspendedFlag && !test.testAttemptId) {
    const existingUnfinished = db
      .prepare('SELECT id FROM test_attempts WHERE testId = ? AND finishedAt IS NULL ORDER BY startedAt DESC LIMIT 1')
      .get(tidStr);

    if (existingUnfinished?.id) {
      test.testAttemptId = existingUnfinished.id;
    } else {
      const attemptId = crypto.randomUUID();
      console.log(`[Exam Runtime] Creating Attempt ${attemptId} for test ${tidStr}`);

      db.prepare(`
        INSERT INTO test_attempts (id, productId, userId, testId, startedAt, finishedAt)
        VALUES (?, ?, ?, ?, ?, ?)
      `).run(attemptId, pidStr, uidStr, tidStr, test.date || new Date().toISOString(), null); // finishedAt is NULL initially

      const insertAnswer = db.prepare(`
        INSERT INTO test_answers (testAttemptId, questionId, selectedOption, isCorrect, isFlagged, correctOption, timeSpentSec)
        VALUES (?, ?, ?, ?, ?, ?, ?)
      `);

      // We pre-create rows with null/false values.
      const questionsArray = Array.isArray(test.questions) ? test.questions : [];
      const answersMap = test.answers || {};
      const markedIds = new Set(test.markedIds || []);

      questionsArray.forEach(qItem => {
        const qId = typeof qItem === 'object' ? qItem.id : qItem;
        let correctOption = typeof qItem === 'object' ? qItem.correct : null;

        if (!correctOption) {
          const row = db.prepare('SELECT correct FROM questions WHERE id = ?').get(String(qId));
          correctOption = row?.correct || null;
        }
        
        const selected = (answersMap[qId] === undefined || answersMap[qId] === '') ? null : answersMap[qId];
        const isCorrectVal = selected === null || !correctOption ? null : (selected === correctOption ? 1 : 0);

        insertAnswer.run(
          attemptId,
          qId,
          selected,
          isCorrectVal,
          markedIds.has(qId) ? 1 : 0,
          correctOption,
          0
        );
      });

      // Baseline snapshot on attempt creation (Attempt is single source of truth)
      try {
        const qIds = questionsArray.map(qItem => String(typeof qItem === 'object' ? qItem.id : qItem)).filter(Boolean);
        const qSnap = qIds.map((qid) => {
          const fromPayload = questionsArray.find(x => typeof x === 'object' && x && String(x.id) === qid);
          if (fromPayload && typeof fromPayload === 'object') return fromPayload;

          const row = db.prepare('SELECT * FROM questions WHERE id = ?').get(String(qid));
          if (!row) return { id: qid };
          return {
            ...row,
            id: String(row.id),
            choices: (() => { try { return JSON.parse(row.choices || '[]'); } catch { return []; } })(),
            tags: (() => { try { return JSON.parse(row.tags || '[]'); } catch { return []; } })(),
            stemImage: (() => { try { return JSON.parse(row.stemImage || '{}'); } catch { return {}; } })(),
            explanationCorrectImage: (() => { try { return JSON.parse(row.explanationCorrectImage || '{}'); } catch { return {}; } })(),
            explanationWrongImage: (() => { try { return JSON.parse(row.explanationWrongImage || '{}'); } catch { return {}; } })(),
            summaryImage: (() => { try { return JSON.parse(row.summaryImage || '{}'); } catch { return {}; } })(),
          };
        }).filter(Boolean);

        db.prepare(`
          UPDATE test_attempts SET
            questionIds = ?,
            questionSnapshots = ?
          WHERE id = ?
        `).run(JSON.stringify(qIds), JSON.stringify(qSnap), attemptId);
      } catch (e) {
        console.error('[Exam Runtime] Failed to store baseline attempt snapshot:', e);
      }

      test.testAttemptId = attemptId;
    }
  }

  return test;
}

export function updateAttemptAnswer(attemptId, questionId, selectedOption) {
  const db = getDb();
  const selected = (selectedOption === undefined || selectedOption === '') ? null : selectedOption;
  const correct = db.prepare('SELECT correctOption FROM test_answers WHERE testAttemptId = ? AND questionId = ?').get(attemptId, String(questionId));
  const correctOption = correct?.correctOption || null;
  const isCorrectVal = selected === null || !correctOption ? null : (selected === correctOption ? 1 : 0);
  return db.prepare(`
    UPDATE test_answers 
    SET selectedOption = ?, isCorrect = ?
    WHERE testAttemptId = ? AND questionId = ?
  `).run(selected, isCorrectVal, attemptId, questionId);
}

export function updateAttemptFlag(attemptId, questionId, isFlagged) {
  const db = getDb();
  return db.prepare(`
    UPDATE test_answers 
    SET isFlagged = ?
    WHERE testAttemptId = ? AND questionId = ?
  `).run(isFlagged ? 1 : 0, attemptId, questionId);
}

export function snapshotAttempt(attemptId, snapshot) {
  const db = getDb();
  const attempt = db.prepare('SELECT id, finishedAt FROM test_attempts WHERE id = ?').get(attemptId);
  if (!attempt) throw new Error('Attempt not found');
  if (attempt.finishedAt) throw new Error('Attempt already finished');

  const questionIds = Array.isArray(snapshot?.questionIds) ? snapshot.questionIds.map(String) : [];
  const markedIds = Array.isArray(snapshot?.markedIds) ? snapshot.markedIds.map(String) : [];
  const timeSpent = snapshot?.timeSpent && typeof snapshot.timeSpent === 'object' ? snapshot.timeSpent : {};
  const elapsedTime = Number.isFinite(snapshot?.elapsedTime) ? snapshot.elapsedTime : (Number(snapshot?.elapsedTime) || 0);
  const answersMap = snapshot?.answers && typeof snapshot.answers === 'object' ? snapshot.answers : {};
  const questionSnapshots = Array.isArray(snapshot?.questionSnapshots) ? snapshot.questionSnapshots : null;

  const updateAttemptStmt = db.prepare(`
    UPDATE test_attempts SET
      questionIds = ?,
      markedIds = ?,
      timeSpent = ?,
      elapsedTime = ?,
      questionSnapshots = ?
    WHERE id = ?
  `);

  const updateAnswerStmt = db.prepare(`
    UPDATE test_answers SET
      selectedOption = ?,
      isCorrect = ?,
      isFlagged = ?,
      timeSpentSec = ?
    WHERE testAttemptId = ? AND questionId = ?
  `);

  const tx = db.transaction(() => {
    updateAttemptStmt.run(
      JSON.stringify(questionIds),
      JSON.stringify(markedIds),
      JSON.stringify(timeSpent),
      elapsedTime,
      questionSnapshots ? JSON.stringify(questionSnapshots) : null,
      attemptId
    );

    const markedSet = new Set(markedIds);
    for (const qId of questionIds) {
      const selected = (answersMap[qId] === undefined || answersMap[qId] === '') ? null : answersMap[qId];
      const flagged = markedSet.has(qId) ? 1 : 0;
      const ts = Number(timeSpent[qId] || 0);

      const correctRow = db.prepare('SELECT correctOption FROM test_answers WHERE testAttemptId = ? AND questionId = ?').get(attemptId, qId);
      const correctOption = correctRow?.correctOption || null;
      const isCorrectVal = selected === null || !correctOption ? null : (selected === correctOption ? 1 : 0);

      updateAnswerStmt.run(selected, isCorrectVal, flagged, ts, attemptId, qId);
    }
  });

  tx();
  return { success: true };
}

export function finishAttempt(attemptId) {
  const db = getDb();
  const existing = db.prepare('SELECT id, finishedAt FROM test_attempts WHERE id = ?').get(attemptId);
  if (!existing) throw new Error('Attempt not found');
  if (existing.finishedAt) return { success: true, alreadyFinished: true };

  // Mark the attempt as finished
  db.prepare(`
    UPDATE test_attempts 
    SET finishedAt = ?
    WHERE id = ?
  `).run(new Date().toISOString(), attemptId);

  // Get the attempt details to update user_questions
  const attempt = db.prepare(`
    SELECT ta.*, t.userId, t.packageId, t.productId 
    FROM test_attempts ta
    JOIN tests t ON ta.testId = t.testId
    WHERE ta.id = ?
  `).get(attemptId);

  if (attempt) {
    // Get all answers for this attempt
    const answers = db.prepare('SELECT * FROM test_answers WHERE testAttemptId = ?').all(attemptId);
    
    answers.forEach(answer => {
      const userId = attempt.userId;
      const productId = attempt.productId || attempt.packageId;
      
      // Get the current status of this question in user_questions
      const currentStatus = db.prepare(
        'SELECT status FROM user_questions WHERE userId = ? AND questionId = ? AND (productId = ? OR packageId = ?)'
      ).get(String(userId), String(answer.questionId), String(productId), String(productId))?.status || 'unused';
      
      // Determine the new status
      let newStatus;
      if (answer.selectedOption === null || answer.selectedOption === undefined || answer.selectedOption === '') {
        // Only mark as omitted if it was previously unused
        if (currentStatus === 'unused') {
          newStatus = 'omitted';
        } else {
          // Keep the previous status for questions from correct/incorrect pools
          newStatus = currentStatus;
        }
      } else {
        // Question was answered, update based on correctness
        newStatus = answer.isCorrect ? 'correct' : 'incorrect';
      }
      
      // Update user_questions with the new status
      db.prepare(`
        INSERT OR REPLACE INTO user_questions 
        (userId, questionId, productId, packageId, status, userAnswer, totalAttempts, lastSeenAt, updatedAt, lastUpdated)
        VALUES (?, ?, ?, ?, ?, ?, 1, ?, ?, ?)
      `).run(
        String(userId),
        String(answer.questionId),
        String(productId),
        String(productId),
        newStatus,
        answer.selectedOption,
        new Date().toISOString(),
        new Date().toISOString(),
        new Date().toISOString()
      );
    });
  }

  return { success: true, alreadyFinished: false };
}

export function getTestAttempt(attemptId) {
  const db = getDb();
  const attempt = db.prepare('SELECT * FROM test_attempts WHERE id = ?').get(attemptId);
  if (!attempt) return null;

  // Link back to original test for metadata (questions list, mode, etc.)
  const test = db.prepare('SELECT * FROM tests WHERE testId = ?').get(attempt.testId);
  const answers = db.prepare('SELECT * FROM test_answers WHERE testAttemptId = ?').all(attemptId);

  // Reconstruct answer map consistent with frozen attempt logic
  // Step 1: preserved nulls for Omitted logic
  const answersMap = {};
  const markedIds = [];
  answers.forEach(a => {
    answersMap[a.questionId] = a.selectedOption;
    if (a.isFlagged) markedIds.push(a.questionId);
  });

  // Step 7: Unused formula uses total product universe
  const pidStr = attempt.productId.toString();
  const universe = db.prepare('SELECT COUNT(*) as count FROM questions WHERE (productId = ? OR packageId = ?) AND status = "published" AND isLatest = 1').get(pidStr, pidStr);

  const safeParse = (str, fallback) => {
    if (!str) return fallback;
    try {
      let parsed = JSON.parse(str);
      if (typeof parsed === 'string') parsed = JSON.parse(parsed);
      return parsed;
    } catch (e) { return fallback; }
  };

  const questionIds = safeParse(attempt.questionIds, null);
  const questionSnapshots = safeParse(attempt.questionSnapshots, null);
  const questionsInTest = questionSnapshots || questionIds || safeParse(test?.questions, []);

  const totalQuestions = Array.isArray(questionIds)
    ? questionIds.length
    : (Array.isArray(questionsInTest) ? questionsInTest.length : 0);

  const attemptAnswers = answers.map(a => {
    // Get question details for subject, system, topic, and global stats
    const question = db.prepare('SELECT subject, system, topic, globalAttempts, globalCorrect FROM questions WHERE id = ?').get(a.questionId);
    
    // Calculate % correct others
    let percentCorrectOthers = '--';
    if (question && question.globalAttempts > 0) {
      percentCorrectOthers = Math.round((question.globalCorrect / question.globalAttempts) * 100) + '%';
    }
    
    return {
      questionId: a.questionId,
      selectedOption: a.selectedOption,
      isCorrect: a.isCorrect,
      isFlagged: a.isFlagged,
      correctOption: a.correctOption ?? null,
      timeSpentSec: a.timeSpentSec ?? 0,
      subject: question?.subject || null,
      system: question?.system || null,
      topic: question?.topic || null,
      percentCorrectOthers
    };
  });

  return {
    ...test,
    testAttemptId: attempt.id,
    id: attempt.id,
    testId: attempt.testId,
    answers: answersMap,
    attemptAnswers,
    markedIds: markedIds,
    questions: questionsInTest,
    questionIds: Array.isArray(questionIds) ? questionIds : null,
    totalQuestions,
    elapsedTime: attempt.elapsedTime || test?.elapsedTime || 0,
    timeSpent: safeParse(attempt.timeSpent, {}),
    finishedAt: attempt.finishedAt,
    startedAt: attempt.startedAt,
    isAttempt: true,
    totalProductQuestions: universe?.count || 0
  };
}

export function getTestAttemptStats(attemptId) {
  const db = getDb();
  const attempt = db.prepare('SELECT finishedAt FROM test_attempts WHERE id = ?').get(attemptId);
  const rows = db.prepare('SELECT selectedOption, isCorrect, isFlagged FROM test_answers WHERE testAttemptId = ?').all(attemptId);
  
  let correct = 0;
  let incorrect = 0;
  let omitted = 0;
  let flagged = 0;
  
  rows.forEach(r => {
    if (r.isFlagged) flagged++;
    
    // Step 6: Derive status
    const hasAnswer = r.selectedOption !== null && r.selectedOption !== undefined && r.selectedOption !== '';
    
    if (hasAnswer) {
      if (r.isCorrect) correct++;
      else incorrect++;
    } else if (attempt?.finishedAt) {
      omitted++;
    }
  });

  const total = rows.length;
  const percentage = total > 0 ? Math.round((correct / total) * 100) : 0;

  return { correct, incorrect, omitted, flagged, total, percentage };
}

export function getUserTests(userId, packageId) {
  const db = getDb();
  
  if (!packageId) {
    console.warn('getUserTests called without packageId');
    return [];
  }

  const pidStr = packageId.toString();

  const tests = db.prepare(`
    SELECT 
      t.*,
      la.id as latestAttemptId,
      COALESCE(s.total, 0) as attemptTotal,
      COALESCE(s.correct, 0) as attemptCorrect,
      COALESCE(s.incorrect, 0) as attemptIncorrect,
      COALESCE(s.omitted, 0) as attemptOmitted,
      COALESCE(s.flagged, 0) as attemptFlagged
    FROM tests t
    LEFT JOIN test_attempts la ON la.id = (
      SELECT id FROM test_attempts
      WHERE testId = t.testId AND finishedAt IS NOT NULL
      ORDER BY finishedAt DESC
      LIMIT 1
    )
    LEFT JOIN (
      SELECT 
        testAttemptId,
        COUNT(*) as total,
        SUM(CASE WHEN selectedOption IS NOT NULL AND selectedOption != '' AND isCorrect = 1 THEN 1 ELSE 0 END) as correct,
        SUM(CASE WHEN selectedOption IS NOT NULL AND selectedOption != '' AND isCorrect = 0 THEN 1 ELSE 0 END) as incorrect,
        SUM(CASE WHEN (selectedOption IS NULL OR selectedOption = '') THEN 1 ELSE 0 END) as omitted,
        SUM(CASE WHEN isFlagged = 1 THEN 1 ELSE 0 END) as flagged
      FROM test_answers
      GROUP BY testAttemptId
    ) s ON s.testAttemptId = la.id
    WHERE t.userId = ? AND (t.productId = ? OR t.packageId = ?) 
    ORDER BY t.createdAt DESC
  `).all(userId, pidStr, pidStr);

  return tests.map(t => {
    try {
      const safeParse = (str, fallback) => {
        if (!str) return fallback;
        try {
          let parsed = JSON.parse(str);
          // Handle double-stringification
          if (typeof parsed === 'string') parsed = JSON.parse(parsed);
          return parsed;
        } catch (e) { return fallback; }
      };

      return {
        ...t,
        questions: safeParse(t.questions, []),
        answers: safeParse(t.answers, {}),
        firstAnswers: safeParse(t.firstAnswers, {}),
        markedIds: safeParse(t.markedIds, []),
        pool: safeParse(t.pool, []),
        poolLogic: safeParse(t.poolLogic, {}),
        sessionState: safeParse(t.sessionState, {}),
        isSuspended: !!t.isSuspended,
        latestAttemptId: t.latestAttemptId || null,
        attemptStats: {
          total: Number(t.attemptTotal || 0),
          correct: Number(t.attemptCorrect || 0),
          incorrect: Number(t.attemptIncorrect || 0),
          omitted: Number(t.attemptOmitted || 0),
          flagged: Number(t.attemptFlagged || 0)
        }
      };
    } catch (e) {
      console.error(`Error parsing test ${t.testId}:`, e);
      return { ...t, questions: [], answers: {}, firstAnswers: {}, markedIds: [], pool: [], isSuspended: !!t.isSuspended };
    }
  });
}

export function getTestById(testId, productId) {
  const db = getDb();
  const tidStr = String(testId);
  const pidStr = String(productId);

  console.log(`[Exam Runtime] Fetching details for test ${tidStr}`);

  // Primary lookup by testId. Unique constraint ensures isolation.
  const t = db.prepare('SELECT * FROM tests WHERE testId = ?').get(tidStr);
  if (t) {
    try {
      const safeParse = (str, fallback) => {
        if (!str) return fallback;
        try {
          let parsed = JSON.parse(str);
          if (typeof parsed === 'string') parsed = JSON.parse(parsed);
          return parsed;
        } catch (e) { return fallback; }
      };

      t.questions = safeParse(t.questions, []);
      t.answers = safeParse(t.answers, {});
      t.firstAnswers = safeParse(t.firstAnswers, {});
      t.markedIds = safeParse(t.markedIds, []);
      t.pool = safeParse(t.pool, []);
      t.poolLogic = safeParse(t.poolLogic, {});
      t.sessionState = safeParse(t.sessionState, {});
      t.isSuspended = !!t.isSuspended;
    } catch (e) {
      console.error(`[Exam Runtime] Error parsing test ${t.testId}:`, e);
      t.questions = []; t.answers = {}; t.firstAnswers = {}; t.markedIds = []; t.pool = []; t.isSuspended = !!t.isSuspended;
    }
  }
  return t;
}

export function deleteTest(testId) {
  const db = getDb();
  db.prepare('DELETE FROM tests WHERE testId = ?').run(testId);
  return true;
}

export function clearUserTests(userId) {
  const db = getDb();
  const now = new Date().toISOString();

  try {
    const transaction = db.transaction(() => {
      // Archive tests
      db.prepare(`
        INSERT INTO tests_archive 
        (testId, testNumber, userId, mode, pool, questions, answers, firstAnswers, markedIds, currentIndex, elapsedTime, isSuspended, packageId, packageName, createdAt, date, archivedAt)
        SELECT testId, testNumber, userId, mode, pool, questions, answers, firstAnswers, markedIds, currentIndex, elapsedTime, isSuspended, packageId, packageName, createdAt, date, ?
        FROM tests WHERE userId = ?
      `).run(now, userId);

      // Date delete
      db.prepare('DELETE FROM tests WHERE userId = ?').run(userId);

      // Cleanup: Remove archives older than 30 days
      const thirtyDaysAgo = new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString();
      db.prepare('DELETE FROM tests_archive WHERE archivedAt < ?').run(thirtyDaysAgo);
    });

    transaction();
    return true;
  } catch (err) {
    console.error(`DB: Failed to clear tests for user ${userId}:`, err.message);
    throw err;
  }
}

export function restoreUserTests(userId) {
  const db = getDb();
  try {
    const latest = db.prepare('SELECT MAX(archivedAt) as lastArchived FROM tests_archive WHERE userId = ?').get(userId);
    
    if (!latest || !latest.lastArchived) return false;

    const transaction = db.transaction(() => {
      // Restore tests
      db.prepare(`
        INSERT OR REPLACE INTO tests 
        (testId, testNumber, userId, mode, pool, questions, answers, firstAnswers, markedIds, currentIndex, elapsedTime, isSuspended, packageId, packageName, createdAt, date)
        SELECT testId, testNumber, userId, mode, pool, questions, answers, firstAnswers, markedIds, currentIndex, elapsedTime, isSuspended, packageId, packageName, createdAt, date
        FROM tests_archive WHERE userId = ? AND archivedAt = ?
      `).run(userId, latest.lastArchived);
    });

    transaction();
    return true;
  } catch (err) {
    console.error(`DB: Failed to restore tests for user ${userId}:`, err.message);
    return false;
  }
}

// NEW: Universe Forensics & Analytics
export function getProductUniverseAnalytics(packageId) {
    const db = getDb();
    const pidStr = packageId.toString();

    // 1. Core Inventory - check both productId and packageId
    const totalQuestions = db.prepare("SELECT COUNT(*) as count FROM questions WHERE productId = ? OR packageId = ?").get(pidStr, pidStr).count;
    const publishedQuestions = db.prepare("SELECT COUNT(*) as count FROM questions WHERE (productId = ? OR packageId = ?) AND status = 'published' AND isLatest = 1").get(pidStr, pidStr).count;
    
    // 2. Exposure Distribution (Aggregate across all students in this product)
    const exposure = db.prepare(`
        SELECT 
            COUNT(DISTINCT userId) as activeStudents,
            SUM(totalAttempts) as totalProductEngagements,
            AVG(totalAttempts) as avgExposurePerQuestion
        FROM user_questions 
        WHERE (productId = ? OR packageId = ?)
    `).get(pidStr, pidStr);

    // 3. System-level Sizing (For authoring visibility)
    // 3. Behavioral Aggregates (Forensics for Calibration)
    const forensics = db.prepare(`
        SELECT 
            AVG(totalTimeSpent / CAST(NULLIF(globalAttempts, 0) AS REAL)) as avgSecondsPerQuestion,
            AVG(totalVolatility / CAST(NULLIF(globalAttempts, 0) AS REAL)) as avgVolatility,
            AVG(totalStrikes / CAST(NULLIF(globalAttempts, 0) AS REAL)) as avgStrikes,
            SUM(globalCorrect) * 100.0 / SUM(globalAttempts) as aggregateCorrectRate
        FROM questions 
        WHERE (productId = ? OR packageId = ?) AND status = 'published' AND isLatest = 1
    `).get(pidStr, pidStr);

    // 4. System-level Sizing
    const systems = db.prepare(`
        SELECT system, COUNT(*) as count 
        FROM questions 
        WHERE (productId = ? OR packageId = ?) AND status = 'published' AND isLatest = 1
        GROUP BY system
    `).all(pidStr, pidStr);

    return {
        inventory: {
            total: totalQuestions,
            published: publishedQuestions,
            systems
        },
        engagement: exposure,
        forensics: forensics
    };
}


// Analytics functions
export function getGlobalStats(packageId) {
  const db = getDb();
  const pidStr = packageId ? String(packageId) : null;

  console.log(`[Summary Engine] Generating global stats (Product: ${pidStr || 'Full Platform'})`);
  
  const totalUsers = db.prepare('SELECT COUNT(*) as count FROM users').get().count;
  
  let questionsCountQuery = 'SELECT COUNT(*) as count FROM questions';
  let testsCountQuery = 'SELECT COUNT(*) as count FROM tests';
  let timeQuery = 'SELECT SUM(elapsedTime) as total FROM tests';
  
  if (pidStr) {
    // Goal 4: Filter by packageId for global aggregates
    questionsCountQuery += ' WHERE productId = ? OR packageId = ?';
    testsCountQuery += ' WHERE productId = ? OR packageId = ?';
    timeQuery += ' WHERE productId = ? OR packageId = ?';
  }

  const totalQuestions = pidStr ? db.prepare(questionsCountQuery).get(pidStr, pidStr).count : db.prepare(questionsCountQuery).get().count;
  const totalTests = pidStr ? db.prepare(testsCountQuery).get(pidStr, pidStr).count : db.prepare(testsCountQuery).get().count;
  
  // Last 24h active users
  const last24h = new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString();
  const dau = db.prepare('SELECT COUNT(*) as count FROM users WHERE updatedAt > ? OR createdAt > ?').get(last24h, last24h).count;
  const paidUsersCount = db.prepare("SELECT COUNT(*) as count FROM users WHERE subscriptionStatus = 'active' AND purchased = 1").get().count;
  
  const totalTime = (pidStr ? db.prepare(timeQuery).get(pidStr, pidStr).total : db.prepare(timeQuery).get().total) || 0;
  const avgSeconds = totalTests > 0 ? totalTime / totalTests : 0;
  
  const behavioralQuery = `
    SELECT 
        AVG(totalTimeSpent / CAST(NULLIF(globalAttempts, 0) AS REAL)) as avgSeconds,
        AVG(totalVolatility / CAST(NULLIF(globalAttempts, 0) AS REAL)) as avgVolatility,
        SUM(globalCorrect) * 100.0 / CAST(NULLIF(SUM(globalAttempts), 0) AS REAL) as avgDifficulty
    FROM questions
    ${pidStr ? 'WHERE productId = ? OR packageId = ?' : ''}
  `;
  const behavioral = pidStr ? db.prepare(behavioralQuery).get(pidStr, pidStr) : db.prepare(behavioralQuery).get();

  return {
    totalUsers,
    paidUsers: paidUsersCount,
    dau,
    avgSession: `${Math.floor(avgSeconds / 60)}m ${Math.round(avgSeconds % 60)}s`,
    totalQuestions,
    totalTests,
    behavioral: behavioral || { avgSeconds: 0, avgVolatility: 0, avgDifficulty: 0 }
  };
}

export function getEngagementData(packageId) {
  if (!packageId) {
    console.warn('getEngagementData called without packageId - failing closed');
    return [];
  }
  const db = getDb();
  let stmt;
  const pidStr = packageId ? packageId.toString() : null;
  if (pidStr) {
    stmt = db.prepare('SELECT createdAt FROM tests WHERE productId = ?');
  } else {
    stmt = db.prepare('SELECT createdAt FROM tests');
  }

  const tests = pidStr ? stmt.all(pidStr) : stmt.all();
  
  // Group by month (simplified)
  const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  const currentMonth = new Date().getMonth();
  const last7Months = [];

  for (let i = 6; i >= 0; i--) {
      const m = (currentMonth - i + 12) % 12;
      last7Months.push({ name: months[m], val: 0 });
  }

  tests.forEach(t => {
      const date = new Date(t.createdAt);
      const mName = months[date.getMonth()];
      const entry = last7Months.find(e => e.name === mName || e.name === months[date.getUTCMonth()]);
      if (entry) entry.val += 1;
  });

  return last7Months;
}

// NEW: Cognition & Intelligence Operations
export function updateCognitionProfile(userId, packageId, sessionAnalytics) {
  const db = getDb();
  const now = new Date().toISOString();

  // 1. Fetch current profile to average-in new signals
  let profile = db.prepare('SELECT * FROM student_cognition_profiles WHERE userId = ? AND packageId = ?').get(userId, packageId.toString());

  if (!profile) {
    db.prepare(`
      INSERT INTO student_cognition_profiles (userId, packageId, readinessScore, overthinkingIndex, impulsivityIndex, fatigueFactor, updatedAt)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).run(userId, packageId.toString(), 0, sessionAnalytics.overthinkingScore, sessionAnalytics.impulsivityScore, sessionAnalytics.fatigueFactor, now);
    profile = { overthinkingIndex: sessionAnalytics.overthinkingScore, impulsivityIndex: sessionAnalytics.impulsivityScore, fatigueFactor: sessionAnalytics.fatigueFactor };
  } else {
    // Cumulative Moving Average for indices
    const alpha = 0.3; // Weight for new session
    const newOverthinking = (profile.overthinkingIndex * (1 - alpha)) + (sessionAnalytics.overthinkingScore * alpha);
    const newImpulsivity = (profile.impulsivityIndex * (1 - alpha)) + (sessionAnalytics.impulsivityScore * alpha);
    const newFatigue = (profile.fatigueFactor * (1 - alpha)) + (sessionAnalytics.fatigueFactor * alpha);

    db.prepare(`
      UPDATE student_cognition_profiles SET
        overthinkingIndex = ?,
        impulsivityIndex = ?,
        fatigueFactor = ?,
        updatedAt = ?
      WHERE userId = ? AND packageId = ?
    `).run(newOverthinking, newImpulsivity, newFatigue, now, userId, packageId.toString());
  }

  // 2. Recalculate Readiness (simplified version for now)
  // Calculate aggregate accuracy for THIS product
  const stats = db.prepare(`
    SELECT 
      SUM(CASE WHEN status = 'correct' THEN 1 ELSE 0 END) as correct,
      COUNT(*) as total,
      COUNT(DISTINCT questionId) as uniqueUsed
    FROM user_questions 
    WHERE userId = ? AND packageId = ?
  `).get(userId, packageId.toString());

  const productUniverse = db.prepare('SELECT COUNT(*) as count FROM questions WHERE packageId = ? AND status = "published"').get(packageId).count;
  
  const accuracy = stats.total > 0 ? stats.correct / stats.total : 0;
  const exposure = productUniverse > 0 ? stats.uniqueUsed / productUniverse : 0;
  
  // Readiness Score Logic: Accuracy scaled by exposure
  const readiness = Math.round(accuracy * 100 * (0.7 + (0.3 * exposure)));

  db.prepare('UPDATE student_cognition_profiles SET readinessScore = ? WHERE userId = ? AND packageId = ?')
    .run(readiness, userId, packageId.toString());

  return true;
}

export function getUserProductStats(userId, packageId) {
  if (!userId || !packageId) {
    console.warn('getUserProductStats called without userId or packageId');
    return { accuracy: 0, usage: 0, completedTests: 0, totalQuestions: 0, attemptedQuestions: 0 };
  }
  
  const db = getDb();
  const pidStr = packageId.toString();
  const pidInt = parseInt(packageId);

  // 1. Get total published questions for this product
  const productUniverse = db.prepare('SELECT COUNT(*) as count FROM questions WHERE (productId = ? OR packageId = ?) AND status = "published" AND isLatest = 1').get(pidStr, pidStr).count;

  // 2. Get user progress for this product
  const userProgress = db.prepare(`
    SELECT 
      SUM(CASE WHEN status = 'correct' THEN 1 ELSE 0 END) as correct,
      SUM(CASE WHEN status = 'incorrect' THEN 1 ELSE 0 END) as incorrect,
      SUM(CASE WHEN status = 'omitted' THEN 1 ELSE 0 END) as omitted,
      COUNT(DISTINCT questionId) as uniqueUsed
    FROM user_questions 
    WHERE userId = ? AND (productId = ? OR packageId = ?)
  `).get(userId, pidStr, pidStr);

  // 3. Get completed tests count
  const completedTests = db.prepare('SELECT COUNT(*) as count FROM tests WHERE userId = ? AND (productId = ? OR packageId = ?) AND isSuspended = 0').get(userId, pidStr, pidStr).count;

  const attempted = (userProgress.correct || 0) + (userProgress.incorrect || 0);
  const totalAnswered = attempted + (userProgress.omitted || 0);
  const accuracy = attempted > 0 ? Math.round((userProgress.correct / attempted) * 100) : 0;
  const usagePerc = productUniverse > 0 ? Math.round((userProgress.uniqueUsed / productUniverse) * 100) : 0;

  return {
    accuracy,
    usage: usagePerc,
    completedTests,
    totalQuestions: productUniverse,
    attemptedQuestions: attempted,
    totalAnswered,
    correctAnswers: userProgress.correct || 0,
    incorrectAnswers: userProgress.incorrect || 0,
    omittedAnswers: userProgress.omitted || 0,
    usedQuestions: userProgress.uniqueUsed || 0,
    unusedQuestions: Math.max(0, productUniverse - (userProgress.uniqueUsed || 0))
  };
}

// Phase 2: Content Governance Logic (Standardized on governance_history)
export function logGovernanceAction(entry) {
  let conceptId = entry.conceptId;
  
  // Auto-resolve conceptId if missing (often occurs in status transitions)
  if (!conceptId && entry.questionId) {
    const db = getDb();
    const q = db.prepare('SELECT conceptId FROM questions WHERE id = ?').get(entry.questionId);
    if (q) conceptId = q.conceptId;
  }

  logGovernanceHistory({
    versionId: entry.questionId,
    conceptId: conceptId,
    fromState: entry.fromState,
    toState: entry.toState,
    performedBy: entry.actorId,
    notes: entry.reason
  });
  return true;
}

// Product operations
export function getAllProducts() {
  try {
    const db = getDb();
    const rows = db.prepare('SELECT * FROM products WHERE isDeleted = 0 ORDER BY name ASC').all();
    return rows.map(mapProductRow);
  } catch (err) {
    console.error('DB: Failed to get all products:', err.message);
    return [];
  }
}

export function getPublishedProducts() {
  try {
    const db = getDb();
    const rows = db.prepare('SELECT * FROM products WHERE isActive = 1 AND isDeleted = 0 ORDER BY name ASC').all();
    return rows.map(mapProductRow);
  } catch (err) {
    console.error('DB: Failed to get published products:', err.message);
    return [];
  }
}

export function getProductById(id) {
  try {
    const db = getDb();
    const p = db.prepare('SELECT * FROM products WHERE id = ? AND isDeleted = 0').get(id);
    return mapProductRow(p);
  } catch (err) {
    console.error(`DB: Failed to get product ${id}:`, err.message);
    return null;
  }
}

// New function to get product including deleted ones (for existing user access)
export function getProductByIdIncludeDeleted(id) {
  try {
    const db = getDb();
    const p = db.prepare('SELECT * FROM products WHERE id = ?').get(id);
    return mapProductRow(p);
  } catch (err) {
    console.error(`DB: Failed to get product ${id}:`, err.message);
    return null;
  }
}

export function createProduct(product) {
  const db = getDb();
  const stmt = db.prepare('INSERT INTO products (name, slug, duration_days, price, description, templateType, systems, subjects, plans, createdAt, isActive) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)');
  const info = stmt.run(
    product.name, 
    product.slug || product.name.toLowerCase().replace(/\s+/g, '-'),
    product.duration_days || 0, 
    product.price || 0, 
    product.description || '', 
    product.templateType || 'DEFAULT',
    JSON.stringify(product.systems || []),
    JSON.stringify(product.subjects || []),
    JSON.stringify(product.plans || []),
    new Date().toISOString(),
    1
  );
  return getProductById(info.lastInsertRowid);
}

export function updateProduct(product) {
  const db = getDb();
  const stmt = db.prepare(`
    UPDATE products SET
      name = ?, duration_days = ?, price = ?, description = ?, isActive = ?, templateType = ?, systems = ?, subjects = ?, plans = ?, updatedAt = ?
    WHERE id = ?
  `);
  stmt.run(
    product.name, 
    product.duration_days || 0, 
    product.price || 0, 
    product.description, 
    product.isActive ? 1 : 0, 
    product.templateType || 'DEFAULT',
    JSON.stringify(product.systems || []),
    JSON.stringify(product.subjects || []),
    JSON.stringify(product.plans || []),
    new Date().toISOString(),
    product.id
  );
  return getProductById(product.id);
}

export function deleteProduct(id) {
  try {
    const db = getDb();
    
    // Check if product exists
    const product = db.prepare('SELECT * FROM products WHERE id = ?').get(id);
    if (!product) {
      throw new Error('Product not found');
    }
    
    // PERMANENT DELETE: Remove from database completely
    const result = db.prepare('DELETE FROM products WHERE id = ?').run(id);
    
    if (result.changes === 0) {
      throw new Error('Failed to delete product from database');
    }
    
    // Also cleanup related mappings if necessary
    // Note: If you want to delete questions linked to this product, you'd add that here.
    // However, usually questions might belong to multiple products via packageId.

    console.log(`Product ${id} ("${product.name}") PERMANENTLY deleted from database`);
    return true;
  } catch (err) {
    console.error(`DB: Failed to permanently delete product ${id}:`, err.message);
    throw err;
  }
}

// Notification Operations
export function createNotification(type, message, userId = null, metadata = null) {
  try {
    const db = getDb();
    const stmt = db.prepare(`
      INSERT INTO notifications (type, message, userId, metadata, createdAt)
      VALUES (?, ?, ?, ?, ?)
    `);
    const info = stmt.run(
      type,
      message,
      userId,
      metadata ? JSON.stringify(metadata) : null,
      new Date().toISOString()
    );
    return info.lastInsertRowid;
  } catch (err) {
    console.error('DB: Failed to create notification:', err.message);
    return null;
  }
}

export function getNotifications(limit = 50, onlyUnread = false) {
  try {
    const db = getDb();
    let query = 'SELECT * FROM notifications';
    if (onlyUnread) query += ' WHERE isRead = 0';
    query += ' ORDER BY createdAt DESC LIMIT ?';
    
    const stmt = db.prepare(query);
    return stmt.all(limit).map(n => ({
      ...n,
      isRead: !!n.isRead,
      metadata: n.metadata ? JSON.parse(n.metadata) : null
    }));
  } catch (err) {
    console.error('DB: Failed to fetch notifications:', err.message);
    return [];
  }
}

export function markNotificationRead(id) {
  try {
    const db = getDb();
    db.prepare('UPDATE notifications SET isRead = 1 WHERE id = ?').run(id);
    return true;
  } catch (err) {
    console.error('DB: Failed to mark notification as read:', err.message);
    return false;
  }
}

/**
 * Get Governance History for a specific version or concept
 */
export function getGovernanceHistory(versionId, conceptId) {
    const db = getDb();
    let query = 'SELECT * FROM governance_history';
    let params = [];
    
    if (versionId) {
        query += ' WHERE versionId = ?';
        params.push(versionId);
    } else if (conceptId) {
        query += ' WHERE conceptId = ?';
        params.push(conceptId);
    } else {
        return [];
    }
    
    query += ' ORDER BY performedAt DESC';
    return db.prepare(query).all(...params);
}

/**
 * SAFE DB WRAPPER
 * Use this to debug database connection issues without modifying existing code.
 * Wraps getDb() with comprehensive error logging.
 */
export function safeGetDb() {
  try {
    console.log("üß† safeGetDb() called");
    const database = getDb();
    console.log("‚úÖ DB instance ready:", !!database);
    return database;
  } catch (e) {
    console.error("üî• DATABASE CRASH ORIGIN:", e.message);
    console.error("üìç Stack trace:", e.stack);
    throw e;
  }
}

// Question CRUD operations
export function getAllQuestions(productId = null, includeUnpublished = false) {
  const db = getDb();
  let query = `
    SELECT q.*, p.name as productName 
    FROM questions q 
    LEFT JOIN products p ON q.productId = p.id
  `;
  const params = [];
  
  if (productId) {
    query += ` WHERE (q.productId = ? OR q.packageId = ?)`;
    params.push(productId, productId);
  }
  
  if (!includeUnpublished) {
    query += productId ? ` AND q.status = 'published' AND q.isLatest = 1` : ` WHERE q.status = 'published' AND q.isLatest = 1`;
  }
  
  query += ` ORDER BY q.createdAt DESC`;
  
  const questions = db.prepare(query).all(...params);
  return questions.map(q => ({
    ...q,
    choices: JSON.parse(q.choices || '[]'),
    stemImage: JSON.parse(q.stemImage || '{}'),
    explanationCorrectImage: JSON.parse(q.explanationCorrectImage || '{}'),
    explanationWrongImage: JSON.parse(q.explanationWrongImage || '{}'),
    summaryImage: JSON.parse(q.summaryImage || '{}'),
    tags: JSON.parse(q.tags || '[]'),
    choiceDistribution: JSON.parse(q.choiceDistribution || '{}'),
    published: !!q.published,
    isLatest: !!q.isLatest
  }));
}

export function getQuestionById(id) {
  const db = getDb();
  const q = db.prepare('SELECT * FROM questions WHERE id = ?').get(id);
  if (!q) return null;
  
  return {
    ...q,
    choices: JSON.parse(q.choices || '[]'),
    stemImage: JSON.parse(q.stemImage || '{}'),
    explanationCorrectImage: JSON.parse(q.explanationCorrectImage || '{}'),
    explanationWrongImage: JSON.parse(q.explanationWrongImage || '{}'),
    summaryImage: JSON.parse(q.summaryImage || '{}'),
    tags: JSON.parse(q.tags || '[]'),
    choiceDistribution: JSON.parse(q.choiceDistribution || '{}'),
    published: !!q.published,
    isLatest: !!q.isLatest
  };
}

export function createQuestion(question) {
  const db = getDb();
  const stmt = db.prepare(`
    INSERT INTO questions (
      id, stem, stemImage, choices, correct, explanation, explanationCorrect, explanationCorrectImage,
      explanationWrong, explanationWrongImage, summary, summaryImage, subject, system, topic,
      difficulty, cognitiveLevel, type, published, createdAt, updatedAt, packageId, productId,
      conceptId, status, versionNumber, isLatest, globalAttempts, globalCorrect,
      choiceDistribution, totalTimeSpent, totalVolatility, totalStrikes, totalMarks, tags
    )
    VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
  `);
  
  stmt.run(
    question.id,
    question.stem,
    JSON.stringify(question.stemImage || {}),
    JSON.stringify(question.choices || []),
    question.correct,
    question.explanation || null,
    question.explanationCorrect || null,
    JSON.stringify(question.explanationCorrectImage || {}),
    question.explanationWrong || null,
    JSON.stringify(question.explanationWrongImage || {}),
    question.summary || null,
    JSON.stringify(question.summaryImage || {}),
    question.subject || null,
    question.system || null,
    question.topic || null,
    question.difficulty || 'medium',
    question.cognitiveLevel || 'understanding',
    question.type || 'multiple-choice',
    question.published ? 1 : 0,
    question.createdAt || new Date().toISOString(),
    question.updatedAt || new Date().toISOString(),
    question.packageId || null,
    question.productId || null,
    question.conceptId || null,
    question.status || 'draft',
    question.versionNumber || 1,
    question.isLatest ? 1 : 0,
    question.globalAttempts || 0,
    question.globalCorrect || 0,
    JSON.stringify(question.choiceDistribution || {}),
    question.totalTimeSpent || 0,
    question.totalVolatility || 0,
    question.totalStrikes || 0,
    question.totalMarks || 0,
    JSON.stringify(question.tags || [])
  );
  
  return question;
}

export function updateQuestion(id, updates) {
  const db = getDb();

  // WHITELIST: Only editable question content fields
  // NEVER update: id, conceptId, packageId, productId, createdAt, versionNumber
  const EDITABLE_FIELDS = [
    'stem', 'stemImage', 'stemImageMode',
    'choices', 'correct',
    'explanationCorrect', 'explanationCorrectImage',
    'explanationWrong', 'explanationWrongImage',
    'summary', 'summaryImage',
    'explanationImageMode',
    'system', 'subject', 'topic',
    'difficulty', 'cognitiveLevel', 'type',
    'references', 'tags',
    'status', 'published', 'isLatest',
    'globalAttempts', 'globalCorrect', 'choiceDistribution',
    'totalTimeSpent', 'totalVolatility', 'totalStrikes', 'totalMarks'
  ];

  const fields = [];
  const params = [];
  
  // First, fetch the existing question to preserve relational fields
  const existing = getQuestionById(id);
  if (!existing) {
    throw new Error(`Question ${id} not found`);
  }

  Object.keys(updates).forEach(key => {
    // Skip non-editable fields
    if (!EDITABLE_FIELDS.includes(key)) {
      console.warn(`updateQuestion: Ignoring non-editable field "${key}"`);
      return;
    }

    // Skip null/undefined values to prevent overwriting existing data
    if (updates[key] === null || updates[key] === undefined) {
      console.warn(`updateQuestion: Skipping null/undefined value for "${key}"`);
      return;
    }

    // JSON fields
    if (['choices', 'stemImage', 'explanationCorrectImage', 'explanationWrongImage', 'summaryImage', 'tags', 'choiceDistribution'].includes(key)) {
      fields.push(`"${key}" = ?`);
      params.push(JSON.stringify(updates[key]));
    }
    // Boolean/Integer fields
    else if (['published', 'isLatest'].includes(key)) {
      fields.push(`"${key}" = ?`);
      params.push(updates[key] ? 1 : 0);
    }
    // Regular fields
    else {
      fields.push(`"${key}" = ?`);
      params.push(updates[key]);
    }
  });
  
  // Always update the timestamp
  fields.push('updatedAt = ?');
  params.push(new Date().toISOString());
  params.push(id);
  
  if (fields.length === 1) {
    // Only updatedAt would be set, nothing else to update
    console.warn('updateQuestion: No valid editable fields to update');
    return existing;
  }

  console.log(`updateQuestion: Updating question ${id} with fields:`, fields.map(f => f.split(' = ')[0]));
  db.prepare(`UPDATE questions SET ${fields.join(', ')} WHERE id = ?`).run(...params);

  return getQuestionById(id);
}

export function deleteQuestion(id) {
  const db = getDb();
  db.prepare('DELETE FROM questions WHERE id = ?').run(id);
  return true;
}

export function updateQuestionStats(questionId, stats) {
  const db = getDb();
  const stmt = db.prepare(`
    UPDATE questions SET
      globalAttempts = COALESCE(globalAttempts, 0) + ?,
      globalCorrect = COALESCE(globalCorrect, 0) + ?,
      totalTimeSpent = COALESCE(totalTimeSpent, 0) + ?,
      totalVolatility = COALESCE(totalVolatility, 0) + ?,
      totalStrikes = COALESCE(totalStrikes, 0) + ?,
      totalMarks = COALESCE(totalMarks, 0) + ?,
      choiceDistribution = ?,
      updatedAt = ?
    WHERE id = ?
  `);
  
  stmt.run(
    stats.globalAttempts || 0,
    stats.globalCorrect || 0,
    stats.totalTimeSpent || 0,
    stats.totalVolatility || 0,
    stats.totalStrikes || 0,
    stats.totalMarks || 0,
    JSON.stringify(stats.choiceDistribution || {}),
    new Date().toISOString(),
    questionId
  );
  
  return true;
}

// Governance functions (stubs for now)
export function submitQuestionForReview(questionId, userId) {
  logGovernanceAction({
    questionId,
    conceptId: null,
    fromState: 'draft',
    toState: 'review',
    actorId: userId,
    reason: 'Submitted for review'
  });
  return updateQuestion(questionId, { status: 'review' });
}

export function approveQuestion(questionId, userId) {
  logGovernanceAction({
    questionId,
    conceptId: null,
    fromState: 'review',
    toState: 'published',
    actorId: userId,
    reason: 'Approved'
  });
  return updateQuestion(questionId, { status: 'published' });
}

export function publishQuestion(questionId, userId) {
  return approveQuestion(questionId, userId);
}

export function deprecateQuestion(questionId, userId) {
  logGovernanceAction({
    questionId,
    conceptId: null,
    fromState: 'published',
    toState: 'deprecated',
    actorId: userId,
    reason: 'Deprecated'
  });
  return updateQuestion(questionId, { status: 'deprecated' });
}

export function reviseQuestion(questionId, updates, userId) {
  logGovernanceAction({
    questionId,
    conceptId: null,
    fromState: 'published',
    toState: 'draft',
    actorId: userId,
    reason: 'Revised'
  });
  return updateQuestion(questionId, { ...updates, status: 'draft' });
}

// Internal helper for product data normalization
function mapProductRow(p) {
  if (!p) return null;
  
  const safeParse = (str, fallback) => {
    if (!str) return fallback;
    try {
      let parsed = JSON.parse(str);
      // Double parsing in case it was double-stringified
      if (typeof parsed === 'string') parsed = JSON.parse(parsed);
      return parsed;
    } catch (e) {
      console.warn('DB Mapping: Failed to parse JSON column:', e.message, str);
      return fallback; 
    }
  };

  return {
    ...p,
    isActive: !!p.isActive,
    is_published: !!(p.isActive || p.is_published),
    templateType: p.templateType || 'DEFAULT',
    systems: safeParse(p.systems, []),
    subjects: safeParse(p.subjects, []),
    plans: safeParse(p.plans, []),
    defaultCreateTestConfig: safeParse(p.defaultCreateTestConfig, {
      columns: ["system", "difficulty"],
      modes: ["timed", "tutor"],
      blockSize: 40,
      negativeMarking: false
    })
  };
}

export function logGovernanceHistory(entry) {
  const db = getDb();
  const stmt = db.prepare(`
    INSERT INTO governance_history (versionId, conceptId, fromState, toState, performedBy, performedAt, notes)
    VALUES (?, ?, ?, ?, ?, ?, ?)
  `);
  stmt.run(
    entry.versionId,
    entry.conceptId,
    entry.fromState,
    entry.toState,
    entry.performedBy,
    entry.performedAt || new Date().toISOString(),
    entry.notes || null
  );
  return true;
}

/**
 * SAFE QUESTION CREATE WRAPPER
 * Wraps createQuestion() with comprehensive error logging.
 */
export function safeCreateQuestion(q) {
  try {
    const pidStr = String(q.packageId || q.productId);
    console.log("üìù safeCreateQuestion() called with:", {
      id: q.id,
      packageId: pidStr,
      system: q.system,
      subject: q.subject,
      choicesCount: q.choices?.length
    });
    const result = createQuestion({ ...q, packageId: pidStr, productId: pidStr });
    console.log("‚úÖ Question created successfully:", result.id);
    return result;
  } catch (e) {
    console.error("üî• CREATE QUESTION CRASH:", e.message);
    console.error("üìç Stack trace:", e.stack);
    throw e;
  }
}
export function addStudentAnswer({ userId, testId, productId, questionId, answer, isCorrect }) {
  const db = getDb();
  const id = crypto.randomUUID();
  const pidStr = String(productId);
  const uidStr = String(userId);
  const qidStr = String(questionId);
  const tidStr = String(testId);
  
  try {
      db.prepare(`
        INSERT INTO student_answers (id, studentId, testId, productId, packageId, questionId, answer, isCorrect)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?)
      `).run(id, uidStr, tidStr, pidStr, pidStr, qidStr, answer, isCorrect ? 1 : 0);
      return true;
  } catch (e) {
      console.error('[Summary Engine] Error adding student answer:', e);
      return false;
  }
}

// Fetch student results per product using the view for full isolation
export function fetchResultsByProduct(userId, productId) {
  const db = getDb();
  const uidStr = String(userId);
  const pidStr = String(productId);
  return db.prepare(`
    SELECT *
    FROM student_answers_per_product
    WHERE studentId = ? AND (productId = ? OR packageId = ?)
  `).all(uidStr, pidStr, pidStr);
}

// 1Ô∏è‚É£ Fetch all active subscriptions for a student
export function fetchActiveSubscriptions(userId) {
  const db = getDb();
  return db.prepare(`
    SELECT *
    FROM subscriptions
    WHERE userId = ? AND status = 'active'
  `).all(userId);
}

// 2Ô∏è‚É£ Update test creation/save to use the selected subscription
export function saveStudentAnswer(answer) {
  const db = getDb();
  const id = crypto.randomUUID();

  // Ensure we always have a valid packageId
  const packageIdStr = String(answer.packageId || answer.productId || '');
  if (!packageIdStr) throw new Error('No packageId specified for this answer');

  const userIdStr = String(answer.studentId || answer.userId);
  const testIdStr = String(answer.testId);

  try {
    db.prepare(`
      INSERT INTO student_answers (id, studentId, testId, answerData, productId, packageId, submittedAt, questionId, answer, isCorrect)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).run(
      id,
      userIdStr,
      testIdStr,
      JSON.stringify(answer.answerData || {}),
      packageIdStr,
      packageIdStr,
      answer.submittedAt || new Date().toISOString(),
      String(answer.questionId || ''),
      answer.answer || null,
      answer.isCorrect ? 1 : 0
    );
    console.log(`[Summary Engine] Saved answer for student ${userIdStr} under product ${packageIdStr}`);
    return true;
  } catch (e) {
    console.error('[Summary Engine] Error saving student answer:', e);
    return false;
  }
}

// 3Ô∏è‚É£ Update student dashboard to list all active products
export function fetchStudentProducts(userId) {
  const db = getDb();
  return db.prepare(`
    SELECT s.*, p.name AS productName
    FROM subscriptions s
    LEFT JOIN subscription_packages p ON CAST(p.id AS TEXT) = s.packageId
    WHERE s.userId = ? AND s.status = 'active'
  `).all(userId);
}
</file>

<file path="src/app/student/(dashboard)/qbank/create-test/page.jsx">
"use client";

import { useEffect, useState, useContext } from "react";
import { AppContext } from "@/context/AppContext";
import { getAllQuestions } from "@/services/question.service";
import { getProductById } from "@/services/product.service";
import CreateTestTemplateA from "./CreateTestTemplateA";
import CreateTestTemplateB from "./CreateTestTemplateB";

export default function CreateTestPage() {
  const [questions, setQuestions] = useState([]);
  const [productConfig, setProductConfig] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const { selectedStudentProduct } = useContext(AppContext);
  const userId = typeof window !== 'undefined' ? localStorage.getItem("medbank_user") : null;

  useEffect(() => {
    async function initPage() {
      setIsLoading(true);
      try {
        if (!userId) return;

        // Determine active product context
        const activeProduct = selectedStudentProduct || 
                             JSON.parse(localStorage.getItem("medbank_focused_product") || "null");

        const packageId = activeProduct?.id || "14"; 
        const packageName = activeProduct?.name || "Standard QBank";

        console.log(`[CreateTest] Initializing for Product: ${packageName} (ID: ${packageId})`);

        localStorage.setItem("medbank_selected_package", packageId);
        localStorage.setItem("medbank_selected_package_name", packageName);

        const [p, allFetched] = await Promise.all([
          getProductById(packageId),
          getAllQuestions(packageId)
        ]);

        setProductConfig(p || null);

        const fetchedArray = Array.isArray(allFetched) ? allFetched : [];
        const validQuestions = fetchedArray.filter(q => 
          (q.lifecycleStatus === 'published' || q.status === 'published') && 
          q.system && q.system.trim() !== '' &&
          q.subject && q.subject.trim() !== ''
        );

        setQuestions(validQuestions);
      } catch (error) {
        console.error("Error initializing create test page:", error);
      } finally {
        setIsLoading(false);
      }
    }
    initPage();
  }, [selectedStudentProduct, userId]);

  if (isLoading) {
    return (
      <div className="min-h-screen bg-background flex items-center justify-center">
        <div className="text-zinc-500 animate-pulse font-bold tracking-widest uppercase">Loading Product...</div>
      </div>
    );
  }

  const isTemplateB = productConfig?.templateType === 'ECG';

  return (
    <div className="min-h-screen bg-background text-foreground font-sans select-none overflow-x-hidden">
      <div className="max-w-[1600px] mx-auto px-4 py-6">
        {isTemplateB ? (
          <CreateTestTemplateB
            questions={questions}
            userId={userId}
            productConfig={productConfig}
          />
        ) : (
            <CreateTestTemplateA
              questions={questions}
              userId={userId}
            />
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/app/student/(dashboard)/qbank/take-test/page.jsx">
"use client";

import dynamic from "next/dynamic";
import Image from "next/image";

import { useEffect, useState, useRef, useMemo } from "react";
import { useRouter } from "next/navigation";
import { getAllQuestions } from "@/services/question.service";
import { saveTest, getTestById, updateAttemptAnswer, updateAttemptFlag, snapshotAttempt, finishAttempt } from "@/services/test.service";
import { motion, AnimatePresence } from "framer-motion";
import { 
  Menu, Flag, ChevronLeft, ChevronRight, Maximize2, 
  HelpCircle, FlaskConical, StickyNote, Calculator, 
  Contrast, ZoomIn, Settings, Layers, 
  MessageSquare, PauseCircle, LogOut, AlertTriangle,
  Power, Pause, Check, X, BarChart2, Clock
 } from "lucide-react";

export default function TakeTestPage() {
  const [questions, setQuestions] = useState([]);
  const [currentIndex, setCurrentIndex] = useState(0);
  const [selectedAnswer, setSelectedAnswer] = useState(null);
  const [answers, setAnswers] = useState({}); // { questionId: selection }
  const [isSubmitted, setIsSubmitted] = useState(false); 
  const [mode, setMode] = useState("tutor");
  const [isReviewMode, setIsReviewMode] = useState(false);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [markedQuestions, setMarkedQuestions] = useState(new Set());
  const [originalTestId, setOriginalTestId] = useState(null);
  const [lockedAnswers, setLockedAnswers] = useState({}); // To identify answers that cannot be changed
  const [firstAnswers, setFirstAnswers] = useState({}); // To track first choice for change analysis
  const [sessionTestId, setSessionTestId] = useState(null);
  const [questionDurations, setQuestionDurations] = useState({}); // { questionId: seconds }
  const [showQuestionList, setShowQuestionList] = useState(false);
  const [strikeouts, setStrikeouts] = useState({}); // { questionId: Set of letters }
  const [modal, setModal] = useState({ show: false, title: "", message: "", onConfirm: null });
  const [isEnding, setIsEnding] = useState(false);
  const [testAttemptId, setTestAttemptId] = useState(null); // NEW: Track strict attempt ID
  const router = useRouter();
  const handleEndBlockRef = useRef(null);

  // Auto-save answers and flags to localStorage
  const saveToLocalStorage = (updates) => {
    const testData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
    const updated = { ...testData, ...updates };
    localStorage.setItem("medbank_current_test", JSON.stringify(updated));
  };

  // Auto-save currentIndex and elapsedTime to localStorage
  useEffect(() => {
    saveToLocalStorage({ currentIndex, elapsedTime });
  }, [currentIndex, elapsedTime]);

  // Load saved state from localStorage on mount
  const loadSavedState = () => {
    const saved = localStorage.getItem("medbank_current_test");
    if (!saved) return {};
    try {
      const parsed = JSON.parse(saved);
      return {
        answers: parsed.answers || {},
        markedIds: parsed.markedIds || [],
        elapsedTime: parsed.elapsedTime || 0,
        currentIndex: parsed.currentIndex || 0
      };
    } catch {
      return {};
    }
  };

  // Load test configuration
  useEffect(() => {
    const testData = JSON.parse(localStorage.getItem("medbank_current_test"));
    if (!testData || !testData.questions) {
      router.push("/student/qbank/create-test");
      return;
    }

    const testMode = testData.mode || "tutor";
    setMode(testMode);
    setIsReviewMode(!!testData.isReview);
    // NEW: Capture attempt ID
    setTestAttemptId(testData.testAttemptId);
    
    // Load saved state from localStorage for resume
    const savedState = loadSavedState();
    
    async function fetchQuestions() {
      const effectivePackageId = String(testData.packageId || localStorage.getItem("medbank_selected_package"));
      console.log(`[Exam Runtime] Fetching questions for product: ${effectivePackageId}`);

      let ordered = null;
      let selectedIds = null;
      let sourceAnswers = null;
      let usingAttemptSnapshot = false;

      if (!testData.isReview && !testData.testAttemptId) {
        try {
          const toSave = {
            ...testData,
            testId: String(testData.testId || ''),
            userId: testData.userId || localStorage.getItem("medbank_user"),
            packageId: testData.packageId || localStorage.getItem("medbank_selected_package") || "14",
            packageName: testData.packageName || localStorage.getItem("medbank_selected_package_name") || null,
            questions: (Array.isArray(testData.questions) ? testData.questions : []).map(q => {
              if (typeof q === 'object' && q !== null) return String(q.id);
              return String(q);
            }),
            isSuspended: false
          };

          const saved = await saveTest(toSave);
          const attemptId = saved?.testAttemptId || saved?.latestAttemptId || null;
          if (attemptId) {
            setTestAttemptId(attemptId);
            localStorage.setItem(
              "medbank_current_test",
              JSON.stringify({
                ...testData,
                ...(saved || {}),
                testAttemptId: attemptId
              })
            );
          }
        } catch (e) {
          console.error('[Exam Runtime] Failed to ensure testAttemptId:', e);
        }
      }
      
      // Attempt is the single source of truth: load question snapshots + answers from attempt when possible
      const attemptId = testData.testAttemptId || JSON.parse(localStorage.getItem('medbank_current_test') || '{}')?.testAttemptId || null;
      if (attemptId) {
        try {
          const attempt = await getTestById(attemptId, effectivePackageId);
          if (attempt && Array.isArray(attempt.questions) && attempt.questions.length > 0) {
            ordered = attempt.questions;
            selectedIds = ordered.map(q => String(q.id)).filter(Boolean);
            sourceAnswers = attempt.answers || {};
            usingAttemptSnapshot = true;

            setQuestions(ordered);
            setAnswers(sourceAnswers);

            // Restore lock state
            if (testData.isReview) {
              setLockedAnswers(sourceAnswers);
            } else if ((testMode || '').toLowerCase() === 'tutor') {
              setLockedAnswers(testData.lockedAnswers || {});
            } else if (testData.resumeData?.isOmittedResume && !testData.resumeData?.isSuspended) {
              setLockedAnswers(sourceAnswers);
            } else {
              setLockedAnswers({});
            }
          }
        } catch (e) {
          console.error('[Exam Runtime] Failed to load attempt snapshot; falling back to product universe', e);
        }
      }

      if (!usingAttemptSnapshot) {
        const all = await getAllQuestions(effectivePackageId);
        const rawIds = testData.questions || [];
        selectedIds = rawIds.map(id => {
          if (typeof id === 'object' && id !== null) return String(id.id);
          return String(id);
        });
        
        console.log(`[Exam Runtime] Questions to load:`, selectedIds);
        
        const selected = all.filter(q => selectedIds.includes(String(q.id)));
        ordered = selectedIds.map(id => selected.find(q => String(q.id) === id)).filter(Boolean);
        sourceAnswers = testData.answers || testData.resumeData?.answers || {};

        if (ordered.length === 0 && selectedIds.length > 0) {
          console.error(`[Exam Runtime] CRITICAL: No questions found from universe match selected IDs. IDs requested:`, selectedIds);
        }

        setQuestions(ordered);
      }
      
      // Handle Resumption, Review, or Persistence from Refresh
      const savedFirstAnswers = testData.firstAnswers || testData.resumeData?.firstAnswers || {};
      setFirstAnswers(savedFirstAnswers);
      const savedIndex = testData.currentIndex ?? testData.resumeData?.currentIndex ?? 0;
      let savedTime = testData.elapsedTime ?? testData.resumeData?.elapsedTime ?? 0;
      const savedDurations = testData.questionDurations || testData.resumeData?.questionDurations || {};
      setQuestionDurations(savedDurations);

      // If resuming a TIMED test that expired, grant "appropriate time" (e.g. 60s per omitted)
      if (testMode === "timed" && testData.resumeData?.isOmittedResume) {
        const timeLimit = (selectedIds || []).length * 90;
        if (savedTime >= timeLimit) {
          const omittedCount = (selectedIds || []).filter(id => !sourceAnswers?.[id]).length;
          // Set elapsed time so they have 60s per omitted question left
          savedTime = Math.max(0, timeLimit - (omittedCount * 60));
        }
      }

      const savedMarked = testData.markedIds ?? testData.resumeData?.markedIds ?? savedState.markedIds ?? [];

      if (!usingAttemptSnapshot) {
        setAnswers({ ...sourceAnswers, ...savedState.answers });
      }

      // Lock answers based on mode and session state
      const isActuallyTimed = (testData.mode || "").toLowerCase() === 'timed';
      const isActuallyTutor = (testData.mode || "").toLowerCase() === 'tutor';

      if (testData.isReview) {
        setLockedAnswers(sourceAnswers);
      } else if (isActuallyTutor) {
        setLockedAnswers(testData.lockedAnswers || {});
      } else if (testData.resumeData?.isOmittedResume && !testData.resumeData?.isSuspended) {
        // Resuming omitted questions from a FINISHED test - lock already answered ones
        setLockedAnswers(sourceAnswers);
      } else {
        setLockedAnswers({});
      }

      // Handle Landing Index
      let targetIndex = savedIndex;
      if (testData.resumeData?.isOmittedResume) {
        const firstOmittedIdx = ordered.findIndex(qObj => !sourceAnswers[qObj.id]);
        if (firstOmittedIdx !== -1) {
          targetIndex = firstOmittedIdx;
        }
      }

      setCurrentIndex(savedState.currentIndex || targetIndex);
      setElapsedTime(savedState.elapsedTime || savedTime);
      setMarkedQuestions(new Set(savedMarked));

      // Safety Check: Ensure this test belongs to the current user
      const currentUser = localStorage.getItem("medbank_user");
      if (testData.userId && testData.userId !== currentUser) {
        localStorage.removeItem("medbank_current_test");
        router.push("/student/qbank/create-test");
        return;
      }

      // Ensure test has unique ID early and it persists
      const persistentId = String(testData.testId || testData.resumeData?.originalTestId || Date.now());
      setSessionTestId(persistentId);

      if (String(testData.testId) !== persistentId || !testData.userId) {
        testData.testId = persistentId;
        testData.userId = currentUser;
        localStorage.setItem("medbank_current_test", JSON.stringify(testData));
      }

      const activeQuestion = ordered[targetIndex];
      if (activeQuestion) {
        const currentAnswer = sourceAnswers[activeQuestion.id];
        if (testData.isReview || (isActuallyTutor && currentAnswer)) {
          setSelectedAnswer(currentAnswer);
          setIsSubmitted(true);
        } else if (currentAnswer) {
          setSelectedAnswer(currentAnswer);
          setIsSubmitted(false);
        } else {
          setSelectedAnswer(null);
          setIsSubmitted(false);
        }
      }

      if (testData.resumeData?.originalTestId) {
        setOriginalTestId(testData.resumeData.originalTestId);
      }
    }
    fetchQuestions();
  }, [router]);

  // Sync state to localStorage AND History for robust persistence
  useEffect(() => {
    if (questions.length === 0 || isReviewMode || isEnding) return;

    const userId = localStorage.getItem("medbank_user");
    const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");

    // 1. Update Current Session (Use currentTestData.testId which is now guaranteed by load effect)
    const activeTestId = sessionTestId || String(currentTestData.testId || currentTestData.resumeData?.originalTestId || "");
    if (!activeTestId) return; // Prevent sync if ID isn't ready

    // Only persist non-answer UI/session fields here.
    // Answer + flag writes must be persisted together with DB writes (see syncQuestionProgress/toggleMark).
    const updatedTestData = {
      ...currentTestData,
      testId: activeTestId,
      currentIndex,
      elapsedTime,
      firstAnswers,
      questionDurations
    };
    localStorage.setItem("medbank_current_test", JSON.stringify(updatedTestData));
  }, [currentIndex, elapsedTime, questions.length, isReviewMode, questionDurations, firstAnswers, isEnding]);

  // Real-time synchronization helper - NOW ATTEMPT SCOPED
  const ensureAttemptId = async () => {
    const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
    const existing = testAttemptId || currentTestData.testAttemptId || null;
    if (existing) return existing;

    // Create attempt immediately via saveTest and persist
    try {
      const activeTestId = sessionTestId || String(currentTestData.testId || currentTestData.resumeData?.originalTestId || "");
      const saved = await saveTest({
        ...currentTestData,
        testId: activeTestId,
        userId: currentTestData.userId || localStorage.getItem("medbank_user"),
        packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package") || "14",
        packageName: currentTestData.packageName || localStorage.getItem("medbank_selected_package_name") || null,
        isSuspended: false
      });
      const attemptId = saved?.testAttemptId || saved?.latestAttemptId || null;
      if (attemptId) {
        setTestAttemptId(attemptId);
        localStorage.setItem(
          "medbank_current_test",
          JSON.stringify({ ...currentTestData, ...(saved || {}), testAttemptId: attemptId })
        );
      }
      return attemptId;
    } catch (e) {
      console.error('[Exam Runtime] Failed to create attemptId on-demand:', e);
      return null;
    }
  };

  const persistAttemptAnswerForCurrentQuestion = async (letter, nextAnswers) => {
    if (isReviewMode || isEnding) return false;

    const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
    const attemptId = await ensureAttemptId();
    if (!attemptId) {
      console.error("[Exam Runtime] No testAttemptId found for attempt-scoped write.");
      return false;
    }

    const q = questions[currentIndex];
    if (!q) return false;

    const ok = await updateAttemptAnswer(attemptId, q.id, letter || null);
    if (!ok) {
      console.error('[Exam Runtime] Failed to persist attempt answer to DB', { attemptId, questionId: q.id });
      return false;
    }

    // DB write succeeded; persist localStorage together
    const updated = { ...currentTestData, answers: nextAnswers };
    localStorage.setItem('medbank_current_test', JSON.stringify(updated));
    return true;
  };

  const q = questions[currentIndex];
  const totalQuestions = questions.length;

  // Global Timer
  useEffect(() => {
    if (isReviewMode) return;
    if (mode === "tutor" && isSubmitted) return;

    const timer = setInterval(() => {
      setElapsedTime(prev => prev + 1);

      const currentQId = questions[currentIndex]?.id;
      if (currentQId) {
        setQuestionDurations(prev => ({
          ...prev,
          [currentQId]: (prev[currentQId] || 0) + 1
        }));
      }
    }, 1000);
    return () => clearInterval(timer);
  }, [isReviewMode, mode, isSubmitted, questions, currentIndex]);

  // Auto-end side effect for Timed Mode
  useEffect(() => {
    if (mode === "timed" && !isReviewMode && totalQuestions > 0 && !modal.show && !isEnding) {
      const timeLimit = totalQuestions * 90;
      if (elapsedTime >= timeLimit) {
        setModal({
          show: true,
          title: "Time Expired!",
          message: "The time for this block has run out. You can choose to end and submit the test now, or suspend it to finish unanswered questions later from your history.",
          type: "warning",
          confirmText: "End Block Now",
          onConfirm: () => handleEndBlock(true),
          secondaryAction: {
            label: "Suspend & Resume Later",
            onClick: () => handleSuspend(false)
          }
        });
      }
    }
  }, [elapsedTime, mode, isReviewMode, totalQuestions, modal.show, isEnding]);

  // Sync state to handleEndBlockRef
  useEffect(() => {
    handleEndBlockRef.current = handleEndBlock;
  });

  // Handle Browser Back Button as End Block
  useEffect(() => {
    if (isReviewMode) return;

    const handlePopState = (e) => {
      // Re-push state to stay on page initially
      window.history.pushState(null, "", window.location.href);

      // Treat back button as "End Block"
      if (handleEndBlockRef.current) {
        handleEndBlockRef.current();
      }
    };

    // Push initial entry to intercept the first 'back' click
    window.history.pushState(null, "", window.location.href);

    window.addEventListener("popstate", handlePopState);

    return () => {
      window.removeEventListener("popstate", handlePopState);
    };
  }, [isReviewMode, router]);


  const formatTime = (seconds) => {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
  };

  const handleSelectAnswer = async (letter) => {
    if (isReviewMode) return;
    if (isSubmitted) return;
    if (lockedAnswers[q.id]) return;

    // Track the first answer ever picked for this session
    if (!firstAnswers[q.id]) {
      setFirstAnswers(prev => ({ ...prev, [q.id]: letter }));
    }

    if (selectedAnswer === letter) {
      // Unchoose
      // Remove strikeout if selecting
      if (strikeouts[q.id]?.has(letter)) {
        toggleStrikeout(letter);
      }

      const nextAnswers = { ...answers };
      delete nextAnswers[q.id];
      const persisted = await persistAttemptAnswerForCurrentQuestion(null, nextAnswers);
      if (!persisted) return;

      setSelectedAnswer(null);
      setAnswers(nextAnswers);
      // Auto-save to localStorage
      saveToLocalStorage({ answers: nextAnswers });
      return;
    }

    // Choose or Change
    setSelectedAnswer(letter);

    const nextAnswers = { ...answers, [q.id]: letter };
    const persisted = await persistAttemptAnswerForCurrentQuestion(letter, nextAnswers);
    if (!persisted) {
      setSelectedAnswer(answers[q.id] || null);
      return;
    }

    setAnswers(nextAnswers);
    // Auto-save to localStorage
    saveToLocalStorage({ answers: nextAnswers });
  };

  const toggleStrikeout = async (letter) => {
    if (isReviewMode || isSubmitted) return;

    // If striking out the selected option, treat as an UNSELECT action and persist to DB+localStorage.
    if (selectedAnswer === letter && answers[q.id] === letter) {
      const nextAnswers = { ...answers };
      delete nextAnswers[q.id];
      const persisted = await persistAttemptAnswerForCurrentQuestion(null, nextAnswers);
      if (!persisted) return;
      setSelectedAnswer(null);
      setAnswers(nextAnswers);
    }

    setStrikeouts(prev => {
      const qStrikeouts = new Set(prev[q.id] || []);
      if (qStrikeouts.has(letter)) {
        qStrikeouts.delete(letter);
      } else {
        qStrikeouts.add(letter);
      }
      return { ...prev, [q.id]: qStrikeouts };
    });
  };

  const handleSubmit = () => {
    if (isReviewMode) return;
    if (!selectedAnswer) return;
    
    if (mode === "tutor") {
      (async () => {
        const nextAnswers = { ...answers, [q.id]: selectedAnswer };
        const persisted = await persistAttemptAnswerForCurrentQuestion(selectedAnswer, nextAnswers);
        if (!persisted) {
          console.error('[Exam Runtime] Tutor submit failed to persist answer; keeping session unsubmitted');
          return;
        }
        setAnswers(nextAnswers);

        // Lock after submit (tutor semantics)
        const nextLocked = { ...lockedAnswers, [q.id]: selectedAnswer };
        setLockedAnswers(nextLocked);
        setIsSubmitted(true);

        try {
          const currentTestData = JSON.parse(localStorage.getItem('medbank_current_test') || '{}');
          localStorage.setItem('medbank_current_test', JSON.stringify({ ...currentTestData, lockedAnswers: nextLocked }));
        } catch (e) {
          console.error('[Exam Runtime] Failed to persist lockedAnswers to localStorage:', e);
        }
      })();
    } else {
      handleNext();
    }
  };

  const handleNext = () => {
    if (currentIndex < totalQuestions - 1) {
      const nextIdx = currentIndex + 1;
      setCurrentIndex(nextIdx);
      const previousAnswer = answers[questions[nextIdx]?.id] || null;
      setSelectedAnswer(previousAnswer);
      const nextQId = questions[nextIdx]?.id;
      setIsSubmitted(isReviewMode || ((mode === 'tutor') && !!lockedAnswers[nextQId]));
    } else if (!isReviewMode) {
      handleEndBlock();
    }
  };

  const handlePrevious = () => {
    if (currentIndex > 0) {
      const prevIdx = currentIndex - 1;
      setCurrentIndex(prevIdx);
      const previousAnswer = answers[questions[prevIdx]?.id] || null;
      setSelectedAnswer(previousAnswer);
      const prevQId = questions[prevIdx]?.id;
      setIsSubmitted(isReviewMode || ((mode === 'tutor') && !!lockedAnswers[prevQId]));
    }
  };

  const toggleMark = async () => {
    const newMarked = new Set(markedQuestions);
    const isNowMarked = !newMarked.has(q.id);

    // Allow flag/unflag during review as well
    if (!isReviewMode) {
      // Atomic attempt update + localStorage sync (together)
      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const attemptId = currentTestData.testAttemptId || testAttemptId;
      if (!attemptId) {
        console.error('[Exam Runtime] No attemptId for flag update');
        return;
      }

      const ok = await updateAttemptFlag(attemptId, q.id, isNowMarked);
      if (!ok) {
        console.error('[Exam Runtime] Failed to persist attempt flag to DB', { attemptId, questionId: q.id });
        return;
      }
    }

    // Update React state + localStorage together
    if (newMarked.has(q.id)) newMarked.delete(q.id);
    else newMarked.add(q.id);
    setMarkedQuestions(newMarked);
    // Auto-save to localStorage
    saveToLocalStorage({ markedIds: Array.from(newMarked) });

    try {
      // Optional: Dispatch progress refresh for UI sync
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new Event("medbank_progress_refresh"));
      }
    } catch (err) {
      console.warn('[Exam Runtime] Failed to dispatch progress refresh:', err);
    }
  };

  const handleSuspend = (showConfirm = true) => {
    if (isReviewMode) {
      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const payload = {
        testId: testAttemptId || currentTestData.testAttemptId || sessionTestId || currentTestData.testId,
        packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package"),
        packageName: currentTestData.packageName || null,
        mode: currentTestData.mode || 'tutor'
      };
      localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
      router.push("/student/qbank/test-summary");
      return;
    }

    const executeSuspend = async () => {
      setIsEnding(true);
      const testData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const activeTestId = sessionTestId || String(testData.testId || "");

      // Persist attempt snapshot before suspending (mandatory)
      try {
        const attemptId = await ensureAttemptId();
        if (attemptId) {
          const snap = {
            questionIds: questions.map(qObj => String(qObj?.id)).filter(Boolean),
            answers: { ...answers },
            markedIds: Array.from(markedQuestions).map(String),
            timeSpent: { ...questionDurations },
            elapsedTime,
            questionSnapshots: questions
          };
          const ok = await snapshotAttempt(attemptId, snap);
          if (!ok) {
            console.error('[Exam Runtime] snapshotAttempt failed during suspend; aborting suspend to prevent DB/local mismatch');
            setIsEnding(false);
            return;
          }
        }
      } catch (e) {
        console.error('[Exam Runtime] Failed to snapshot attempt during suspend:', e);
      }

      const sessionToSave = {
        testId: activeTestId,
        testNumber: testData.testNumber || Date.now() % 10000,
        userId: testData.userId || localStorage.getItem("medbank_user"),
        packageId: testData.packageId || localStorage.getItem("medbank_selected_package") || "14",
        packageName: testData.packageName || localStorage.getItem("medbank_selected_package_name") || "Premium Stream",
        date: testData.date || new Date().toISOString(),
        questions: questions.map(q => ({
          id: q?.id,
          correct: q?.correct,
          userAnswer: answers[q?.id] || null,
          subject: q?.subject,
          system: q?.system,
          timeSpent: questionDurations[q?.id] || 0
        })),
        mode,
        pool: testData.pool || "All Questions",
        answers,
        firstAnswers,
        questionDurations,
        currentIndex,
        elapsedTime,
        markedIds: Array.from(markedQuestions),
        isSuspended: true,
        universeSize: testData.universeSize || questions.length,
        eligiblePoolSize: testData.eligiblePoolSize || questions.length,
        poolLogic: testData.poolLogic || {}
      };

      await saveTest(sessionToSave);
      localStorage.removeItem("medbank_current_test");
      router.push("/student/qbank");
    };

    if (showConfirm) {
      setModal({
        show: true,
        title: "Suspend Test session",
        message: "Are you sure you want to suspend this test? You will be able to resume this session exactly where you left off from your Previous Tests history.",
        onConfirm: executeSuspend
      });
    } else {
      executeSuspend();
    }
  };

  const handleEndBlock = (isAuto = false) => {
    const processSubmission = async () => {
      setIsEnding(true);
      
      const currentTestData = JSON.parse(localStorage.getItem("medbank_current_test") || "{}");
      const activeTestId = sessionTestId || String(currentTestData.testId || "");
      let attemptIdToFinish = testAttemptId || currentTestData.testAttemptId || null;
      
      if (isReviewMode) {
        const payload = {
          testId: attemptIdToFinish || activeTestId,
          packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package"),
          packageName: currentTestData.packageName || null,
          mode: currentTestData.mode || 'tutor'
        };
        localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
        router.push("/student/qbank/test-summary");
        return;
      }

      if (!attemptIdToFinish && !isReviewMode) {
        try {
          const saved = await saveTest({
            ...currentTestData,
            testId: activeTestId,
            userId: currentTestData.userId || localStorage.getItem("medbank_user"),
            packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package") || "14",
            packageName: currentTestData.packageName || localStorage.getItem("medbank_selected_package_name") || null,
            isSuspended: false
          });
          attemptIdToFinish = saved?.testAttemptId || saved?.latestAttemptId || null;
          if (attemptIdToFinish) {
            setTestAttemptId(attemptIdToFinish);
            localStorage.setItem(
              "medbank_current_test",
              JSON.stringify({
                ...currentTestData,
                ...(saved || {}),
                testAttemptId: attemptIdToFinish
              })
            );
          }
        } catch (e) {
          console.error('[Exam Runtime] Failed to create attempt during submission:', e);
        }
      }

      if (attemptIdToFinish) {
        const snapshot = {
          questionIds: questions.map(qObj => String(qObj?.id)).filter(Boolean),
          answers: { ...answers },
          markedIds: Array.from(markedQuestions).map(String),
          timeSpent: { ...questionDurations },
          elapsedTime,
          questionSnapshots: questions
        };

        const ok = await finishAttempt(attemptIdToFinish, snapshot);
        if (!ok) {
          console.error('[Exam Runtime] finishAttempt failed; aborting redirect to prevent DB/local mismatch');
          return;
        }

        localStorage.setItem("medbank_last_attempt_id", attemptIdToFinish);
      } else {
        console.error("CRITICAL: No testAttemptId found during submission!");
      }

      // 3. Set full payload for summary page source-of-truth
      const payload = {
        testId: attemptIdToFinish || activeTestId,
        packageId: currentTestData.packageId || localStorage.getItem("medbank_selected_package") || "14",
        packageName: currentTestData.packageName || localStorage.getItem("medbank_selected_package_name") || null,
        mode: currentTestData.mode || 'tutor'
      };
      localStorage.setItem("medbank_last_test_info", JSON.stringify(payload));
      localStorage.setItem("medbank_last_test_id", activeTestId);
      localStorage.removeItem("medbank_current_test");
      
      // Clear the testId from sessionStorage since test is completed
      sessionStorage.removeItem('current_test_id');
      
      // Dispatch refresh event
      if (typeof window !== 'undefined') {
        window.dispatchEvent(new Event("medbank_progress_refresh"));
      }

      router.push("/student/qbank/test-summary");
    };

    if (isAuto) {
      processSubmission();
    } else {
      let msg, title, type;
      if (isReviewMode) {
        title = "End Review Session";
        msg = "Are you sure you want to exit this review session?";
        type = "info";
      } else {
        const unansweredCount = questions.length - Object.keys(answers).length;
        if (unansweredCount > 0) {
          title = "End Test Block Permanently";
          msg = `Warning: You still have ${unansweredCount} unanswered questions. If you end this block now, it will be marked as finished. You can resume the omitted questions later from your history, but your current answers will be saved permanently and cannot be changed.`;
          type = "danger";
        } else {
          title = "End Test Session";
          msg = "Great job finishing all questions! Are you sure you want to end this block? This will calculate your final score and record the results permanently.";
          type = "confirm";
        }
      }

      setModal({
        show: true,
        title: title,
        message: msg,
        type: type,
        confirmText: isReviewMode ? "End Review" : "End Block Permanently",
        onConfirm: processSubmission,
      });
    }
  };

  if (questions.length === 0 || !q) {
    return (
      <div className="fixed inset-0 bg-white flex items-center justify-center z-[9999]">
        <div className="animate-spin rounded-full h-12 w-12 border-b-2 border-[#002b5c]"></div>
      </div>
    );
  }

  return (
    <div className="fixed inset-0 bg-[#f3f4f6] dark:bg-[#0F0F12] flex flex-col z-[9999] font-sans overflow-hidden select-none text-[#333] dark:text-zinc-300 transition-colors duration-300">
      
      {/* HEADER */}
      <header className="bg-[#002b5c] text-white h-[45px] flex items-center px-4 shrink-0 shadow-lg z-50 font-medium relative border-b border-white/10">
        <div className="flex items-center gap-5">
          <div className="flex gap-4">
            <Menu 
              size={18} 
              className="cursor-pointer hover:text-blue-300 transition-colors opacity-70" 
              onClick={() => setShowQuestionList(!showQuestionList)}
            />
            <div className="flex items-center gap-3 ml-2 border-l border-white/10 pl-4">
              <span className="text-[10px] font-black text-white/40 uppercase tracking-[0.2em]">Item ID:</span>
              <span className="text-[14px] font-bold text-white tracking-tight leading-none">{q.id}</span>
            </div>
          </div>
          <div 
            onClick={toggleMark}
            className="flex items-center gap-1.5 cursor-pointer group ml-2 hover:text-orange-400 transition-colors"
          >
            <Flag size={14} className={markedQuestions.has(q?.id) ? "fill-orange-500 text-orange-500" : "text-white/50 group-hover:text-white"} />
            <span className={`text-[11px] font-bold uppercase tracking-wider ${markedQuestions.has(q?.id) ? "text-orange-500" : "text-white/80"}`}>Mark</span>
          </div>
        </div>

        <div className="flex-1 flex justify-center items-center">
          <span className="text-[13px] font-bold">
            {currentIndex + 1}/{totalQuestions}
          </span>
        </div>

        <div className="flex items-center gap-5">
          <div className="flex items-center gap-4 mr-4">
            {[
              { Icon: ZoomIn, label: 'Zoom' },
              { Icon: Settings, label: 'Settings' },
              { Icon: HelpCircle, label: 'Help' },
              { Icon: Maximize2, label: 'Full' }
            ].map((tool, i) => (
              <tool.Icon key={i} size={18} className="cursor-pointer hover:text-blue-300 transition-colors opacity-70" />
            ))}
          </div>

          <div className="flex items-center gap-2 font-mono text-[16px] font-bold tracking-tight bg-black/20 px-3 py-1 rounded border border-white/5">
            {mode === "timed"
              ? formatTime(Math.max(0, (totalQuestions * 90) - elapsedTime))
              : formatTime(elapsedTime)
            }
          </div>
        </div>
      </header>

      <div className="flex flex-1 overflow-hidden relative">

        {/* NAV BAR SIDEBAR (QUESTION LIST) */}
        <aside
          className={`bg-[#002b5c] border-r border-[#16368a] transition-all duration-300 overflow-y-auto no-scrollbar flex flex-col ${showQuestionList ? 'w-[64px]' : 'w-0'}`}
        >
          {questions.map((_, idx) => {
            const isCurrent = idx === currentIndex;
            const qItem = questions[idx];
            if (!qItem) return null;
            const qId = qItem.id;
            const userAnswer = answers[qId];
            const hasAnswer = !!userAnswer;
            const isMarked = markedQuestions.has(qId);

            // Show correctness in Review mode or Tutor mode after answering
            const showResult = isReviewMode || (mode === "tutor" && hasAnswer);
            const isCorrect = showResult && hasAnswer && userAnswer === qItem.correct;
            const isWrong = showResult && hasAnswer && userAnswer !== qItem.correct;

            return (
              <button
                key={idx}
                onClick={() => {
                  setCurrentIndex(idx);
                  const previousAnswer = answers[questions[idx]?.id] || null;
                  setSelectedAnswer(previousAnswer);
                  setIsSubmitted(isReviewMode || !!previousAnswer);
                }}
                className={`w-full py-4 flex flex-col items-center justify-center transition-all border-l-4 relative ${isCurrent
                  ? 'bg-blue-400/10 border-amber-400'
                  : 'border-transparent hover:bg-white/5 hover:text-white'
                  }`}
              >
                <div className="flex flex-col items-center gap-0.5">
                  <span className={`text-[15px] font-black tracking-tighter ${isCurrent ? 'text-amber-400' : 'text-white/40'}`}>
                    {idx + 1}
                  </span>
                  <div className="flex gap-1 items-center h-1.5">
                    {showResult ? (
                      hasAnswer && (
                        <div className={`w-1.5 h-1.5 rounded-full ${isCorrect ? 'bg-emerald-400' : 'bg-red-500'}`} title={isCorrect ? "Correct" : "Incorrect"} />
                      )
                    ) : (
                      hasAnswer && (
                        <div className="w-1.5 h-1.5 rounded-full bg-blue-400" title="Answered" />
                      )
                    )}
                    {isMarked && <Flag size={9} className="text-orange-500 fill-orange-500" title="Marked" />}
                  </div>
                </div>
              </button>
            );
          })}
        </aside>

        {/* MAIN CONTENT */}
        <main className="flex-1 overflow-y-auto bg-white dark:bg-[#16161a] p-6 lg:p-8 transition-colors duration-300">
          <div className="w-full flex flex-col gap-10">
          
            {/* TOP SECTION: Question Context (Stem) */}
            <div className="w-full space-y-6">
              <div className="text-[18px] leading-relaxed text-zinc-800 dark:text-zinc-200 font-medium whitespace-pre-wrap">
              {q.stem}
              {q.stemImage?.data && (
                <div className="mt-8 flex justify-center">
                  <Image src={q.stemImage.data} alt="stem" width={400} height={300} loading="lazy" className="max-w-full rounded border-2 border-zinc-100 shadow-sm" />
                </div>
              )}
            </div>
          </div>

            {/* BOTTOM SECTION: Choices and Rest of Parts */}
            <div className="w-full space-y-10">
            {/* Choices */}
              <div className="space-y-4">
              {q.choices.map((choice, i) => {
                const letter = String.fromCharCode(65 + i);
                const isSelected = selectedAnswer === letter;
                const isCorrect = q.correct === letter;
                const isStruck = strikeouts[q.id]?.has(letter);
                
                const isLocked = !!lockedAnswers[q.id];
                
                let choiceStyle = "border-zinc-200 dark:border-zinc-800 bg-white dark:bg-zinc-900/50";
                let radioStyle = "border-zinc-400 dark:border-zinc-600 border-[3px]";

                if (isLocked) {
                  choiceStyle = "opacity-80 border-zinc-100 dark:border-zinc-800 bg-zinc-50 dark:bg-zinc-900/20 cursor-not-allowed";
                }
                
                if (isSelected) {
                  radioStyle = "border-[#0072bc] bg-[#0072bc]";
                }

                if (isReviewMode || (mode === "tutor" && isSubmitted)) {
                  choiceStyle = "border-transparent bg-transparent pointer-events-none";
                  if (isSelected) {
                    radioStyle = "border-[#0072bc] bg-[#0072bc]";
                  } else if (isCorrect) {
                    radioStyle = "border-zinc-300 border-[3px]";
                  } else {
                    radioStyle = "border-zinc-200 border-[2px] opacity-40";
                  }
                }

                const showFeedback = isReviewMode || (mode === "tutor" && isSubmitted);

                // Real Stats Calculation
                const dist = q.choiceDistribution || {};
                const totalPicks = Object.values(dist).reduce((a, b) => a + b, 0);
                const pickCount = dist[letter] || 0;
                const percentage = totalPicks > 0 ? Math.round((pickCount / totalPicks) * 100) : 0;

                return (
                  <div 
                    key={i}
                    className={`flex items-start gap-2 rounded-md transition-all border ${choiceStyle} relative group`}
                  >
                    {/* Feedback Icons (X or Check) */}
                    {showFeedback && (
                      <div className="w-6 shrink-0 flex items-center justify-center mt-1.5">
                        {isCorrect && <Check size={20} className="text-green-500 stroke-[4px]" />}
                        {isSelected && !isCorrect && <X size={20} className="text-red-500 stroke-[4px]" />}
                      </div>
                    )}

                    <div className="flex flex-1 items-start gap-4 p-4 py-2.5">
                      <div
                        onClick={(e) => {
                          e.stopPropagation();
                          handleSelectAnswer(letter);
                        }}
                        className={`w-5 h-5 rounded-full flex items-center justify-center shrink-0 mt-0.5 cursor-pointer transition-all ${radioStyle} ${isStruck ? 'opacity-20' : ''}`}
                      >
                        {isSelected && <div className="w-2 h-2 rounded-full bg-white shadow-sm" />}
                      </div>
                      <div
                        className="flex-1 flex flex-col gap-2 cursor-pointer relative"
                        onClick={() => toggleStrikeout(letter)}
                      >
                        <span className={`text-[15px] select-none ${isStruck ? 'line-through text-zinc-400 dark:text-zinc-600' : isSelected ? "font-bold text-zinc-900 dark:text-[#f8fafc]" : "font-medium text-zinc-700 dark:text-zinc-300"}`}>
                          {letter}. {choice.text}
                          {showFeedback && (
                            <span className="ml-2 text-zinc-400 dark:text-zinc-500 font-normal text-[14px]">
                              ({percentage}%)
                            </span>
                          )}
                        </span>
                        {choice.image?.data && (
                          <Image src={choice.image.data} alt={`choice-${letter}`} width={400} height={300} loading="lazy" className="max-w-xs rounded border mt-2" />
                        )}
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Submit / Action Button */}
            {!isReviewMode && (
              <div className="pt-2">
                <button 
                  onClick={handleSubmit}
                  disabled={!selectedAnswer || (mode === "tutor" && isSubmitted)}
                  className="w-full sm:w-auto bg-[#0072bc] hover:bg-[#005a96] text-white px-12 py-3 rounded shadow-lg font-bold text-[13px] uppercase tracking-wider transition-all active:scale-95 disabled:opacity-30 disabled:hover:bg-[#0072bc]"
                >
                  {mode === "tutor" ? "Submit" : "Next"}
                </button>
              </div>
            )}

            {/* Explanation (Tutor or Review Mode) */}
            {(isReviewMode || (mode === "tutor" && isSubmitted)) && (
                <div className="p-8 lg:p-10 bg-white dark:bg-zinc-900/50 rounded-2xl border-2 border-zinc-100 dark:border-zinc-800 shadow-sm transition-colors duration-300">
                <div className="space-y-8">
                    <div className="max-w-none">
                    <div className={`flex items-center gap-10 p-6 rounded-lg mb-8 bg-[#1e1e24] dark:bg-zinc-800/50 border-l-[6px] transition-all ${selectedAnswer === q.correct ? 'border-green-500' : 'border-red-500'}`}>
                      <div className="flex flex-col min-w-[100px]">
                        <span className={`text-[20px] font-bold ${selectedAnswer === q.correct ? 'text-green-500' : 'text-red-500'}`}>
                          {!selectedAnswer ? 'Omitted' : (selectedAnswer === q.correct ? 'Correct' : 'Incorrect')}
                        </span>
                      </div>
                      
                      <div className="flex items-center gap-3 border-l border-zinc-700/50 pl-10 h-10">
                        <BarChart2 size={24} className="text-zinc-400 opacity-60" strokeWidth={1.5} />
                        <div className="flex flex-col">
                          <span className="text-zinc-100 dark:text-zinc-200 font-bold leading-none text-lg">
                            {(() => {
                              const dist = q.choiceDistribution || {};
                              const totalPicks = Object.values(dist).reduce((a, b) => a + b, 0);
                              const correctPicks = dist[q.correct] || 0;
                              return totalPicks > 0 ? Math.round((correctPicks / totalPicks) * 100) : 0;
                            })()}%
                          </span>
                          <span className="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mt-1">Answered correctly</span>
                        </div>
                      </div>

                      <div className="flex items-center gap-3 border-l border-zinc-700/50 pl-10 h-10">
                        <Clock size={24} className="text-zinc-400 opacity-60" strokeWidth={1.5} />
                        <div className="flex flex-col">
                          <span className="text-zinc-100 dark:text-zinc-200 font-bold leading-none text-lg">
                            {questionDurations[q.id] || 0} secs
                          </span>
                          <span className="text-zinc-500 text-[11px] font-bold uppercase tracking-wider mt-1">Time Spent</span>
                        </div>
                      </div>
                    </div>
                    
                      <div className="text-[17px] leading-relaxed text-zinc-800 dark:text-zinc-200 space-y-4">
                        {q.explanationCorrect?.split('\n').map((para, i) => <p key={i}>{para}</p>)}
                    </div>
                  </div>

                  {q.explanationWrong && (
                      <div className="pt-8 border-t border-zinc-100">
                        <h4 className="text-[11px] font-black uppercase tracking-widest text-zinc-400 dark:text-zinc-600 mb-4">Incorrect Explanations</h4>
                        <div className="text-[15px] leading-relaxed text-zinc-500 dark:text-zinc-400 italic space-y-3">
                          {q.explanationWrong.split('\n').map((para, i) => <p key={i}>{para}</p>)}
                        </div>
                    </div>
                  )}

                  {q.summary && (
                      <div className="mt-8 p-6 bg-zinc-50 dark:bg-zinc-800/50 rounded-xl border border-zinc-100 dark:border-zinc-800">
                        <span className="text-[10px] font-black uppercase tracking-[0.2em] text-[#002b5c]/50 dark:text-blue-400/30 block mb-3">Key Summary</span>
                        <p className="font-bold text-[16px] text-zinc-900 dark:text-zinc-200 italic">"{q.summary}"</p>
                    </div>
                  )}
                </div>


                </div>
              )}
            </div>
          </div>
        </main>
      </div>



      {/* FOOTER */}
      <footer className="bg-[#002b5c] text-white h-[45px] flex items-center px-0 shrink-0 shadow-[0_-10px_30px_rgba(0,0,0,0.15)] z-50 border-t border-white/10">
        <div className="flex items-center h-full">
          <button
            onClick={() => handleEndBlock()}
            className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group"
          >
            <Power size={18} className="text-white/70 group-hover:text-white" />
            <span className="text-[13px] font-medium leading-none">{isReviewMode ? "Exit" : "End"}</span>
          </button>

          <div className="w-px h-6 bg-white/20" />

          <button
            onClick={() => handleSuspend()}
            className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group"
          >
            <Pause size={18} className="text-white/70 group-hover:text-white" />
            <span className="text-[13px] font-medium leading-none">Suspend</span>
          </button>
        </div>

        <div className="flex-1 flex justify-center h-full">
          <button className="flex items-center gap-2 px-4 h-full hover:bg-white/10 transition-colors group">
            <MessageSquare size={16} className="text-white/70 group-hover:text-white" />
            <span className="text-[13px] font-medium leading-none">Feedback</span>
          </button>
        </div>

        <div className="flex items-center h-full">
          <button 
            onClick={handlePrevious}
            disabled={currentIndex === 0}
            className="flex items-center gap-2 px-6 h-full hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors group border-l border-white/10"
          >
            <ChevronLeft size={20} />
            <span className="text-[13px] font-medium leading-none">Previous</span>
          </button>
          <button
            onClick={handleNext}
            disabled={currentIndex === totalQuestions - 1 && (mode === "tutor" || isReviewMode)}
            className="flex items-center gap-2 px-6 h-full hover:bg-white/10 disabled:opacity-30 disabled:hover:bg-transparent transition-colors group border-l border-white/10"
          >
            <span className="text-[13px] font-medium leading-none">Next</span>
            <ChevronRight size={20} />
          </button>
        </div>
      </footer>

      <style jsx global>{`
        body { overflow: hidden; }
        ::selection { background: #bfdbfe; color: #1e3a8a; }
      `}</style>

      {/* CUSTOM CONFIRMATION MODAL */}
      {modal.show && (
        <div className="fixed inset-0 z-[10000] flex items-center justify-center p-4">
          <div className="absolute inset-0 bg-[#001b3d]/60 backdrop-blur-[2px] animate-in fade-in duration-300" onClick={() => setModal({ ...modal, show: false })} />
          <div className="bg-white dark:bg-[#16161a] rounded-[1.5rem] shadow-[0_20px_50px_rgba(0,0,0,0.4)] relative max-w-[400px] w-full overflow-hidden animate-in zoom-in-95 fade-in duration-300 border-none">
            {/* Header section based on type */}
            {modal.type === 'danger' && (
              <div className="bg-[#fffbeb] p-8 flex flex-col items-center border-b border-amber-100">
                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(217,119,6,0.15)]">
                  <AlertTriangle size={32} className="text-amber-500" strokeWidth={2.5} />
                </div>
                <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-[#92400e] text-center">
                  {modal.title}
                </h3>
              </div>
            )}
            {modal.type === 'confirm' && (
              <div className="bg-emerald-50 p-8 flex flex-col items-center border-b border-emerald-100">
                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(16,185,129,0.15)]">
                  <Check size={32} className="text-emerald-500" strokeWidth={2.5} />
                </div>
                <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-emerald-800 text-center">
                  {modal.title}
                </h3>
              </div>
            )}
            {modal.type === 'info' && (
              <div className="bg-blue-50 p-8 flex flex-col items-center border-b border-blue-100">
                <div className="w-16 h-16 bg-white rounded-full flex items-center justify-center mb-5 shadow-[0_4px_10px_rgba(59,130,246,0.15)]">
                  <LogOut size={32} className="text-blue-500" strokeWidth={2.5} />
                </div>
                <h3 className="text-[13px] font-black uppercase tracking-[0.2em] text-blue-800 text-center">
                  {modal.title}
                </h3>
              </div>
            )}

            <div className="p-10 pt-8 bg-[#1e1e24] dark:bg-[#16161a]">
              <p className="text-[15px] font-medium leading-relaxed text-zinc-400 text-center mb-10">
                {modal.message}
              </p>

              <div className="flex flex-col gap-4">
                <button
                  onClick={() => {
                    modal.onConfirm();
                    setModal({ ...modal, show: false });
                  }}
                  className={`w-full py-4 rounded-xl text-[12px] font-black uppercase tracking-[0.2em] transition-all active:scale-95 shadow-xl ${modal.type === 'danger'
                    ? 'bg-red-600 text-white hover:bg-red-700 shadow-red-500/30'
                    : modal.type === 'confirm'
                    ? 'bg-emerald-600 text-white hover:bg-emerald-700 shadow-emerald-500/30'
                    : 'bg-[#1d46af] text-white hover:bg-[#16368a] shadow-blue-500/30'
                    }`}
                >
                  {modal.confirmText || 'Confirm & Continue'}
                </button>
                <button
                  onClick={() => setModal({ ...modal, show: false })}
                  className="w-full py-3 text-[11px] font-black uppercase tracking-[0.2em] text-zinc-500 hover:text-zinc-200 transition-colors"
                >
                  Go Back
                </button>
              </div>
            </div>
          </div>
        </div>
      )}
    </div>
  );
}
</file>

</files>
